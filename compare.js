"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[44],{12:(e,t,n)=>{n.d(t,{Dz:()=>f,F8:()=>g,FP:()=>m,KM:()=>l,RZ:()=>w,gn:()=>b,ld:()=>v,n7:()=>y,oN:()=>k,rq:()=>d,t6:()=>o,up:()=>a,v_:()=>r,xb:()=>u});var i=n(4922),r=new i.Pq0(0,0,0),a=new i.Pq0(0,0,1);function o(e){return new i.Pq0(e.x,e.y,e.z)}var s=new i.Pq0;function l(e){return s.copy(a).cross(e)}var c=new i.Pq0;function u(e){return c.copy(e).normalize()}var h=new i.Pq0;function d(e,t){return h.copy(e).add(t).dot(e)<=0}function f(e){return new i.Pq0(1,0,0).applyAxisAngle(a,e)}function p(e){return Math.sign(e)*Math.floor(1e4*(Math.abs(e)+Number.EPSILON))/1e4}function v(e){return e.x=p(e.x),e.y=p(e.y),e.z=p(e.z),e}function m(e,t){return Math.fround(Math.atan2(e,t))}function y(e,t){return Math.fround(Math.pow(e,t))}function g(e){return Math.sin(e)}function b(e){return Math.cos(e)}function w(e){return Math.sqrt(e)}function k(e){return Math.exp(e)}},91:(e,t,n)=>{n.d(t,{f:()=>u});var i=n(4922),r=n(3982),a=n(8385),o=n(665),s=n(5418);function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"scaleToRadius",value:function(t){e.PX=o.P.tableX+1.6*t,e.PY=o.P.tableY+1.6*t,e.knuckleInset=1.6*t/.5,e.knuckleRadius=.31*t/.5,e.middleKnuckleInset=1.385*t/.5,e.middleKnuckleRadius=.2*t/.5,e.cornerRadius=1.1*t/.5,e.middleRadius=.9*t/.5,e.pocketLayout(t),e.enumerateCenters(),e.enumerateKnuckles()}},{key:"enumerateKnuckles",value:function(){e.knuckles=[e.pockets.pocketNW.knuckleNE,e.pockets.pocketNW.knuckleSW,e.pockets.pocketN.knuckleNW,e.pockets.pocketN.knuckleNE,e.pockets.pocketS.knuckleSW,e.pockets.pocketS.knuckleSE,e.pockets.pocketNE.knuckleNW,e.pockets.pocketNE.knuckleSE,e.pockets.pocketSE.knuckleNE,e.pockets.pocketSE.knuckleSW,e.pockets.pocketSW.knuckleSE,e.pockets.pocketSW.knuckleNW]}},{key:"enumerateCenters",value:function(){e.pocketCenters=[e.pockets.pocketNW.pocket,e.pockets.pocketSW.pocket,e.pockets.pocketN.pocket,e.pockets.pocketS.pocket,e.pockets.pocketNE.pocket,e.pockets.pocketSE.pocket]}},{key:"pocketLayout",value:function(t){e.pockets={pocketNW:{pocket:new a.Z(new i.Pq0(-e.PX,e.PY,0),e.cornerRadius),knuckleNE:new r.O(new i.Pq0(-o.P.X+e.knuckleInset,o.P.Y+e.knuckleRadius,0),e.knuckleRadius),knuckleSW:new r.O(new i.Pq0(-o.P.X-e.knuckleRadius,o.P.Y-e.knuckleInset,0),e.knuckleRadius)},pocketN:{pocket:new a.Z(new i.Pq0(0,e.PY+.7*t/.5,0),e.middleRadius),knuckleNE:new r.O(new i.Pq0(e.middleKnuckleInset,o.P.Y+e.middleKnuckleRadius,0),e.middleKnuckleRadius),knuckleNW:new r.O(new i.Pq0(-e.middleKnuckleInset,o.P.Y+e.middleKnuckleRadius,0),e.middleKnuckleRadius)},pocketS:{pocket:new a.Z(new i.Pq0(0,-e.PY-.7*t/.5,0),e.middleRadius),knuckleSE:new r.O(new i.Pq0(e.middleKnuckleInset,-o.P.Y-e.middleKnuckleRadius,0),e.middleKnuckleRadius),knuckleSW:new r.O(new i.Pq0(-e.middleKnuckleInset,-o.P.Y-e.middleKnuckleRadius,0),e.middleKnuckleRadius)},pocketNE:{pocket:new a.Z(new i.Pq0(e.PX,e.PY,0),e.cornerRadius),knuckleNW:new r.O(new i.Pq0(o.P.X-e.knuckleInset,o.P.Y+e.knuckleRadius,0),e.knuckleRadius),knuckleSE:new r.O(new i.Pq0(o.P.X+e.knuckleRadius,o.P.Y-e.knuckleInset,0),e.knuckleRadius)},pocketSE:{pocket:new a.Z(new i.Pq0(e.PX,-e.PY,0),e.cornerRadius),knuckleNE:new r.O(new i.Pq0(o.P.X+e.knuckleRadius,-o.P.Y+e.knuckleInset,0),e.knuckleRadius),knuckleSW:new r.O(new i.Pq0(o.P.X-e.knuckleInset,-o.P.Y-e.knuckleRadius,0),e.knuckleRadius)},pocketSW:{pocket:new a.Z(new i.Pq0(-e.PX,-e.PY,0),e.cornerRadius),knuckleSE:new r.O(new i.Pq0(-o.P.X+e.knuckleInset,-o.P.Y-e.knuckleRadius,0),e.knuckleRadius),knuckleNW:new r.O(new i.Pq0(-o.P.X-e.knuckleRadius,-o.P.Y+e.knuckleInset,0),e.knuckleRadius)}}}}],null&&l(t.prototype,null),n&&l(t,n),e}();c(u,"PX",void 0),c(u,"PY",void 0),c(u,"knuckleInset",void 0),c(u,"knuckleRadius",void 0),c(u,"middleKnuckleInset",void 0),c(u,"middleKnuckleRadius",void 0),c(u,"cornerRadius",void 0),c(u,"middleRadius",void 0),c(u,"pockets",void 0),c(u,"knuckles",void 0),c(u,"pocketCenters",void 0),u.scaleToRadius(s.R)},128:(e,t,n)=>{n.d(t,{KP:()=>Re,Ro:()=>Ae});var i=n(4922);const r={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class a{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register((function(e){return new w(e)})),this.register((function(e){return new k(e)})),this.register((function(e){return new M(e)})),this.register((function(e){return new T(e)})),this.register((function(e){return new E(e)})),this.register((function(e){return new C(e)})),this.register((function(e){return new P(e)})),this.register((function(e){return new x(e)})),this.register((function(e){return new S(e)})),this.register((function(e){return new R(e)})),this.register((function(e){return new A(e)})),this.register((function(e){return new I(e)})),this.register((function(e){return new O(e)})),this.register((function(e){return new B(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,i){const r=new b,a=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)a.push(this.pluginCallbacks[e](r));r.setPlugins(a),r.setTextureUtils(this.textureUtils),r.writeAsync(e,t,i).catch(n)}parseAsync(e,t){const n=this;return new Promise((function(i,r){n.parse(e,i,r,t)}))}}const o=5120,s=5121,l=5122,c=5123,u=34962,h="KHR_mesh_quantization",d={};d[i.hxR]=9728,d[i.pHI]=9984,d[i.Cfg]=9986,d[i.k6q]=9729,d[i.kRr]=9985,d[i.$_I]=9987,d[i.ghU]=33071,d[i.GJx]=10497,d[i.kTW]=33648;const f={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},p=new i.Q1f;function v(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}function m(e){return 4*Math.ceil(e/4)}function y(e,t=0){const n=m(e.byteLength);if(n!==e.byteLength){const i=new Uint8Array(n);if(i.set(new Uint8Array(e)),0!==t)for(let r=e.byteLength;r<n;r++)i[r]=t;return i.buffer}return e}function g(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class b{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+i.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);const i=this,r=i.buffers,a=i.json;n=i.options;const o=i.extensionsUsed,s=i.extensionsRequired,l=new Blob(r,{type:"application/octet-stream"}),c=Object.keys(o),u=Object.keys(s);if(c.length>0&&(a.extensionsUsed=c),u.length>0&&(a.extensionsRequired=u),a.buffers&&a.buffers.length>0&&(a.buffers[0].byteLength=l.size),!0===n.binary){const e=new FileReader;e.readAsArrayBuffer(l),e.onloadend=function(){const n=y(e.result),i=new DataView(new ArrayBuffer(8));i.setUint32(0,n.byteLength,!0),i.setUint32(4,5130562,!0);const r=y((o=JSON.stringify(a),(new TextEncoder).encode(o).buffer),32);var o;const s=new DataView(new ArrayBuffer(8));s.setUint32(0,r.byteLength,!0),s.setUint32(4,1313821514,!0);const l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,1179937895,!0),c.setUint32(4,2,!0);const u=12+s.byteLength+r.byteLength+i.byteLength+n.byteLength;c.setUint32(8,u,!0);const h=new Blob([l,s,r,i,n],{type:"application/octet-stream"}),d=new FileReader;d.readAsArrayBuffer(h),d.onloadend=function(){t(d.result)}}}else if(a.buffers&&a.buffers.length>0){const e=new FileReader;e.readAsDataURL(l),e.onloadend=function(){const n=e.result;a.buffers[0].uri=n,t(a)}}else t(a)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const n=this.options,i=this.extensionsUsed;try{const r=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&r.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in r.gltfExtensions)t.extensions[e]=r.gltfExtensions[e],i[e]=!0;delete r.gltfExtensions}Object.keys(r).length>0&&(t.extras=r)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new i.Pq0;for(let n=0,i=e.count;n<i;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const n=e.clone(),r=new i.Pq0;for(let e=0,t=n.count;e<t;e++)r.fromBufferAttribute(n,e),0===r.x&&0===r.y&&0===r.z?r.setX(1):r.normalize(),n.setXYZ(e,r.x,r.y,r.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1;const i={};0===t.offset.x&&0===t.offset.y||(i.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(i.rotation=t.rotation,n=!0),1===t.repeat.x&&1===t.repeat.y||(i.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===i.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof i.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof i.FvD&&(t=await this.decompressTextureAsync(t));const r=e?e.image:null,a=t?t.image:null,o=Math.max(r?r.width:0,a?a.width:0),s=Math.max(r?r.height:0,a?a.height:0),l=g();l.width=o,l.height=s;const c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,o,s);const u=c.getImageData(0,0,o,s);if(r){c.drawImage(r,0,0,o,s);const t=n(e),i=c.getImageData(0,0,o,s).data;for(let e=2;e<i.length;e+=4)u.data[e]=256*t(i[e]/256)}if(a){c.drawImage(a,0,0,o,s);const e=n(t),i=c.getImageData(0,0,o,s).data;for(let t=1;t<i.length;t+=4)u.data[t]=256*e(i[t]/256)}c.putImageData(u,0,0);const h=(e||t).clone();return h.source=new i.kLi(l),h.colorSpace=i.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){const t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,r,a){const h=this.json;let d;switch(h.bufferViews||(h.bufferViews=[]),t){case o:case s:d=1;break;case l:case c:d=2;break;default:d=4}let f=e.itemSize*d;a===u&&(f=4*Math.ceil(f/4));const p=m(r*f),v=new DataView(new ArrayBuffer(p));let y=0;for(let a=n;a<n+r;a++){for(let n=0;n<e.itemSize;n++){let r;e.itemSize>4?r=e.array[a*e.itemSize+n]:(0===n?r=e.getX(a):1===n?r=e.getY(a):2===n?r=e.getZ(a):3===n&&(r=e.getW(a)),!0===e.normalized&&(r=i.cj9.normalize(r,e.array))),5126===t?v.setFloat32(y,r,!0):5124===t?v.setInt32(y,r,!0):5125===t?v.setUint32(y,r,!0):t===l?v.setInt16(y,r,!0):t===c?v.setUint16(y,r,!0):t===o?v.setInt8(y,r):t===s&&v.setUint8(y,r),y+=d}y%f!=0&&(y+=f-y%f)}const g={buffer:this.processBuffer(v.buffer),byteOffset:this.byteOffset,byteLength:p};return void 0!==a&&(g.target=a),a===u&&(g.byteStride=f),this.byteOffset+=p,h.bufferViews.push(g),{id:h.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise((function(i){const r=new FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){const e=y(r.result),a={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,i(n.bufferViews.push(a)-1)}}))}processAccessor(e,t,n,r){const a=this.json;let h;if(e.array.constructor===Float32Array)h=5126;else if(e.array.constructor===Int32Array)h=5124;else if(e.array.constructor===Uint32Array)h=5125;else if(e.array.constructor===Int16Array)h=l;else if(e.array.constructor===Uint16Array)h=c;else if(e.array.constructor===Int8Array)h=o;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);h=s}if(void 0===n&&(n=0),void 0!==r&&r!==1/0||(r=e.count),0===r)return null;const d=function(e,t,n){const r={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let a=t;a<t+n;a++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[a*e.itemSize+t]:(0===t?n=e.getX(a):1===t?n=e.getY(a):2===t?n=e.getZ(a):3===t&&(n=e.getW(a)),!0===e.normalized&&(n=i.cj9.normalize(n,e.array))),r.min[t]=Math.min(r.min[t],n),r.max[t]=Math.max(r.max[t],n)}return r}(e,n,r);let f;void 0!==t&&(f=e===t.index?34963:u);const p=this.processBufferView(e,h,n,r,f),v={bufferView:p.id,byteOffset:p.byteOffset,componentType:h,count:r,max:d.max,min:d.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(v.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(v)-1}processImage(e,t,n,r="image/png"){if(null!==e){const a=this,o=a.cache,s=a.json,l=a.options,c=a.pending;o.images.has(e)||o.images.set(e,{});const u=o.images.get(e),h=r+":flipY/"+n.toString();if(void 0!==u[h])return u[h];s.images||(s.images=[]);const d={mimeType:r},f=g();f.width=Math.min(e.width,l.maxTextureSize),f.height=Math.min(e.height,l.maxTextureSize);const p=f.getContext("2d",{willReadFrequently:!0});if(!0===n&&(p.translate(0,f.height),p.scale(1,-1)),void 0!==e.data){t!==i.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];p.putImageData(new ImageData(n,e.width,e.height),0,0)}else{if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas))throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");p.drawImage(e,0,0,f.width,f.height)}!0===l.binary?c.push(function(e,t){if(void 0!==e.toBlob)return new Promise((n=>e.toBlob(n,t)));let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}(f,r).then((e=>a.processBufferViewImage(e))).then((e=>{d.bufferView=e}))):d.uri=i.HgN.getDataURL(f,r);const v=s.images.push(d)-1;return u[h]=v,v}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const n={magFilter:d[e.magFilter],minFilter:d[e.minFilter],wrapS:d[e.wrapS],wrapT:d[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){const t=this.options,n=this.cache,r=this.json;if(n.textures.has(e))return n.textures.get(e);r.textures||(r.textures=[]),e instanceof i.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let a=e.userData.mimeType;"image/webp"===a&&(a="image/png");const o={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,a)};e.name&&(o.name=e.name),await this._invokeAllAsync((async function(t){t.writeTexture&&await t.writeTexture(e,o)}));const s=r.textures.push(o)-1;return n.textures.set(e,s),s}async processMaterialAsync(e){const t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);const r={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const a=e.color.toArray().concat([e.opacity]);if(v(a,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=a),e.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=0,r.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){const t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),r.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){const t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),r.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(r.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),r.emissiveTexture=t}}if(e.normalMap){const t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),r.normalTexture=t}if(e.aoMap){const t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),r.occlusionTexture=t}e.transparent?r.alphaMode="BLEND":e.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=e.alphaTest),e.side===i.$EB&&(r.doubleSided=!0),""!==e.name&&(r.name=e.name),this.serializeUserData(e,r),await this._invokeAllAsync((async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,r)}));const o=n.materials.push(r)-1;return t.materials.set(e,o),o}async processMeshAsync(e){const t=this.cache,n=this.json,r=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)r.push(e.material[t].uuid);else r.push(e.material.uuid);const o=r.join(":");if(t.meshes.has(o))return t.meshes.get(o);const s=e.geometry;let l;l=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;const c={},u={},h=[],d=[],f={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},p=s.getAttribute("normal");void 0===p||this.isNormalizedNormalAttribute(p)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),s.setAttribute("normal",this.createNormalizedNormalAttribute(p)));let v=null;for(let e in s.attributes){if("morph"===e.slice(0,5))continue;const n=s.attributes[e];if(e=f[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),t.attributes.has(this.getUID(n))){u[e]=t.attributes.get(this.getUID(n));continue}v=null;const r=n.array;"JOINTS_0"!==e||r instanceof Uint16Array||r instanceof Uint8Array?(r instanceof Uint32Array||r instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=a.Utils.toFloat32BufferAttribute(n)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new i.THS(new Uint16Array(r),n.itemSize,n.normalized));const o=this.processAccessor(v||n,s);null!==o&&(e.startsWith("_")||this.detectMeshQuantization(e,n),u[e]=o,t.attributes.set(this.getUID(n),o))}if(void 0!==p&&s.setAttribute("normal",p),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const n=[],i=[],r={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)r[e.morphTargetDictionary[t]]=t;for(let a=0;a<e.morphTargetInfluences.length;++a){const o={};let l=!1;for(const e in s.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}const n=s.morphAttributes[e][a],i=e.toUpperCase(),r=s.attributes[e];if(t.attributes.has(this.getUID(n,!0))){o[i]=t.attributes.get(this.getUID(n,!0));continue}const c=n.clone();if(!s.morphTargetsRelative)for(let e=0,t=n.count;e<t;e++)for(let t=0;t<n.itemSize;t++)0===t&&c.setX(e,n.getX(e)-r.getX(e)),1===t&&c.setY(e,n.getY(e)-r.getY(e)),2===t&&c.setZ(e,n.getZ(e)-r.getZ(e)),3===t&&c.setW(e,n.getW(e)-r.getW(e));o[i]=this.processAccessor(c,s),t.attributes.set(this.getUID(r,!0),o[i])}d.push(o),n.push(e.morphTargetInfluences[a]),void 0!==e.morphTargetDictionary&&i.push(r[a])}c.weights=n,i.length>0&&(c.extras={},c.extras.targetNames=i)}const m=Array.isArray(e.material);if(m&&0===s.groups.length)return null;let y=!1;if(m&&null===s.index){const e=[];for(let t=0,n=s.attributes.position.count;t<n;t++)e[t]=t;s.setIndex(e),y=!0}const g=m?e.material:[e.material],b=m?s.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,n=b.length;e<n;e++){const n={mode:l,attributes:u};if(this.serializeUserData(s,n),d.length>0&&(n.targets=d),null!==s.index){let i=this.getUID(s.index);void 0===b[e].start&&void 0===b[e].count||(i+=":"+b[e].start+":"+b[e].count),t.attributes.has(i)?n.indices=t.attributes.get(i):(n.indices=this.processAccessor(s.index,s,b[e].start,b[e].count),t.attributes.set(i,n.indices)),null===n.indices&&delete n.indices}const i=await this.processMaterialAsync(g[b[e].materialIndex]);null!==i&&(n.material=i),h.push(n)}!0===y&&s.setIndex(null),c.primitives=h,n.meshes||(n.meshes=[]),await this._invokeAllAsync((function(t){t.writeMesh&&t.writeMesh(e,c)}));const w=n.meshes.push(c)-1;return t.meshes.set(o,w),w}detectMeshQuantization(e,t){if(this.extensionsUsed[h])return;let n;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");const i=e.split("_",1)[0];r[i]&&r[i].includes(n)&&(this.extensionsUsed[h]=!0,this.extensionsRequired[h]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const n=e.isOrthographicCamera,r={type:n?"orthographic":"perspective"};return n?r.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:i.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(r.name=e.type),t.cameras.push(r)-1}processAnimation(e,t){const n=this.json,r=this.nodeMap;n.animations||(n.animations=[]);const o=(e=a.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,s=[],l=[];for(let e=0;e<o.length;++e){const n=o[e],a=i.Nwf.parseTrackName(n.name);let c=i.Nwf.findNode(t,a.nodeName);const u=f[a.propertyName];if("bones"===a.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(a.objectIndex):void 0),!c||!u){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',n.name);continue}const h=1;let d,p=n.values.length/n.times.length;u===f.morphTargetInfluences&&(p/=c.morphTargetInfluences.length),!0===n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(d="CUBICSPLINE",p/=3):d=n.getInterpolation()===i.ljd?"STEP":"LINEAR",l.push({input:this.processAccessor(new i.THS(n.times,h)),output:this.processAccessor(new i.THS(n.values,p)),interpolation:d}),s.push({sampler:l.length-1,target:{node:r.get(c),path:u}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:l,channels:s}),n.animations.length-1}processSkin(e){const t=this.json,n=this.nodeMap,r=t.nodes[n.get(e)],a=e.skeleton;if(void 0===a)return null;const o=e.skeleton.bones[0];if(void 0===o)return null;const s=[],l=new Float32Array(16*a.bones.length),c=new i.kn4;for(let t=0;t<a.bones.length;++t)s.push(n.get(a.bones[t])),c.copy(a.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new i.THS(l,16)),joints:s,skeleton:n.get(o)}),r.skin=t.skins.length-1}async processNodeAsync(e){const t=this.json,n=this.options,i=this.nodeMap;t.nodes||(t.nodes=[]);const r={};if(n.trs){const t=e.quaternion.toArray(),n=e.position.toArray(),i=e.scale.toArray();v(t,[0,0,0,1])||(r.rotation=t),v(n,[0,0,0])||(r.translation=n),v(i,[1,1,1])||(r.scale=i)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===v(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(r.matrix=e.matrix.elements);if(""!==e.name&&(r.name=String(e.name)),this.serializeUserData(e,r),e.isMesh||e.isLine||e.isPoints){const t=await this.processMeshAsync(e);null!==t&&(r.mesh=t)}else e.isCamera&&(r.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);const a=t.nodes.push(r)-1;if(i.set(e,a),e.children.length>0){const t=[];for(let i=0,r=e.children.length;i<r;i++){const r=e.children[i];if(r.visible||!1===n.onlyVisible){const e=await this.processNodeAsync(r);null!==e&&t.push(e)}}t.length>0&&(r.children=t)}return await this._invokeAllAsync((function(t){t.writeNode&&t.writeNode(e,r)})),a}async processSceneAsync(e){const t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);const i={};""!==e.name&&(i.name=e.name),t.scenes.push(i);const r=[];for(let t=0,i=e.children.length;t<i;t++){const i=e.children[t];if(i.visible||!1===n.onlyVisible){const e=await this.processNodeAsync(i);null!==e&&r.push(e)}}r.length>0&&(i.nodes=r),this.serializeUserData(e,i)}async processObjectsAsync(e){const t=new i.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){const t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync((function(t){t.beforeParse&&t.beforeParse(e)}));const n=[];for(let t=0;t<e.length;t++)e[t]instanceof i.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync((function(t){t.afterParse&&t.afterParse(e)}))}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class w{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const n=this.writer,i=n.json,r=n.extensionsUsed,a={};e.name&&(a.name=e.name),a.color=e.color.toArray(),a.intensity=e.intensity,e.isDirectionalLight?a.type="directional":e.isPointLight?(a.type="point",e.distance>0&&(a.range=e.distance)):e.isSpotLight&&(a.type="spot",e.distance>0&&(a.range=e.distance),a.spot={},a.spot.innerConeAngle=(1-e.penumbra)*e.angle,a.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),r[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},r[this.name]=!0);const o=i.extensions[this.name].lights;o.push(a),t.extensions=t.extensions||{},t.extensions[this.name]={light:o.length-1}}}class k{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;const n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class P{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),r.clearcoatTexture=t}if(r.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),r.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),r.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class x{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;const n=this.writer.extensionsUsed,i={};i.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),r.iridescenceTexture=t}if(r.iridescenceIor=e.iridescenceIOR,r.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],r.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),r.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class M{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.transmissionFactor=e.transmission,e.transmissionMap){const t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),r.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.thicknessFactor=e.thickness,e.thicknessMap){const t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),r.thicknessTexture=t}e.attenuationDistance!==1/0&&(r.attenuationDistance=e.attenuationDistance),r.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const n=this.writer.extensionsUsed,i={};i.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class C{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(p)&&!e.specularIntensityMap&&!e.specularColorMap)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.specularIntensityMap){const t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),r.specularTexture=t}if(e.specularColorMap){const t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),r.specularColorTexture=t}r.specularFactor=e.specularIntensity,r.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.sheenRoughnessMap){const t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),r.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),r.sheenColorTexture=t}r.sheenRoughnessFactor=e.sheenRoughness,r.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class A{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.anisotropyMap){const t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),r.anisotropyTexture=t}r.anisotropyStrength=e.anisotropy,r.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class I{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const n=this.writer.extensionsUsed,i={};i.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.bumpMap){const t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),r.bumpTexture=t}r.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class B{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;const n=this.writer,r=e,a=new Float32Array(3*r.count),o=new Float32Array(4*r.count),s=new Float32Array(3*r.count),l=new i.kn4,c=new i.Pq0,u=new i.PTz,h=new i.Pq0;for(let e=0;e<r.count;e++)r.getMatrixAt(e,l),l.decompose(c,u,h),c.toArray(a,3*e),u.toArray(o,4*e),h.toArray(s,3*e);const d={TRANSLATION:n.processAccessor(new i.THS(a,3)),ROTATION:n.processAccessor(new i.THS(o,4)),SCALE:n.processAccessor(new i.THS(s,3))};r.instanceColor&&(d._COLOR_0=n.processAccessor(r.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:d},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function _(e,t){if(t===i.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===i.rYR||t===i.O49){let n=e.getIndex();if(null===n){const t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const r=n.count-2,a=[];if(t===i.rYR)for(let e=1;e<=r;e++)a.push(n.getX(0)),a.push(n.getX(e)),a.push(n.getX(e+1));else for(let e=0;e<r;e++)e%2==0?(a.push(n.getX(e)),a.push(n.getX(e+1)),a.push(n.getX(e+2))):(a.push(n.getX(e+2)),a.push(n.getX(e+1)),a.push(n.getX(e)));a.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=e.clone();return o.setIndex(a),o.clearGroups(),o}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}a.Utils={insertKeyframe:function(e,t){const n=.001,i=e.getValueSize(),r=new e.TimeBufferType(e.times.length+1),a=new e.ValueBufferType(e.values.length+i),o=e.createInterpolant(new e.ValueBufferType(i));let s;if(0===e.times.length){r[0]=t;for(let e=0;e<i;e++)a[e]=0;s=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<n)return 0;r[0]=t,r.set(e.times,1),a.set(o.evaluate(t),0),a.set(e.values,i),s=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<n)return e.times.length-1;r[r.length-1]=t,r.set(e.times,0),a.set(e.values,0),a.set(o.evaluate(t),e.values.length),s=r.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<n)return l;if(e.times[l]<t&&e.times[l+1]>t){r.set(e.times.slice(0,l+1),0),r[l+1]=t,r.set(e.times.slice(l+1),l+2),a.set(e.values.slice(0,(l+1)*i),0),a.set(o.evaluate(t),(l+1)*i),a.set(e.values.slice((l+1)*i),(l+2)*i),s=l+1;break}}return e.times=r,e.values=a,s},mergeMorphTargetTracks:function(e,t){const n=[],r={},a=e.tracks;for(let e=0;e<a.length;++e){let o=a[e];const s=i.Nwf.parseTrackName(o.name),l=i.Nwf.findNode(t,s.nodeName);if("morphTargetInfluences"!==s.propertyName||void 0===s.propertyIndex){n.push(o);continue}if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),o=o.clone(),o.setInterpolation(i.PJ3)}const c=l.morphTargetInfluences.length,u=l.morphTargetDictionary[s.propertyIndex];if(void 0===u)throw new Error("THREE.GLTFExporter: Morph target name not found: "+s.propertyIndex);let h;if(void 0===r[l.uuid]){h=o.clone();const e=new h.ValueBufferType(c*h.times.length);for(let t=0;t<h.times.length;t++)e[t*c+u]=h.values[t];h.name=(s.nodeName||"")+".morphTargetInfluences",h.values=e,r[l.uuid]=h,n.push(h);continue}const d=o.createInterpolant(new o.ValueBufferType(1));h=r[l.uuid];for(let e=0;e<h.times.length;e++)h.values[e*c+u]=d.evaluate(h.times[e]);for(let e=0;e<o.times.length;e++){const t=this.insertKeyframe(h,o.times[e]);h.values[t*c+u]=o.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){const t=new i.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,i=e.count;n<i;n++)for(let i=0;i<e.itemSize;i++)t.setComponent(n,i,e.getComponent(n,i));return t}};class L extends i.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new z(e)})),this.register((function(e){return new G(e)})),this.register((function(e){return new Q(e)})),this.register((function(e){return new Z(e)})),this.register((function(e){return new $(e)})),this.register((function(e){return new U(e)})),this.register((function(e){return new V(e)})),this.register((function(e){return new K(e)})),this.register((function(e){return new W(e)})),this.register((function(e){return new H(e)})),this.register((function(e){return new X(e)})),this.register((function(e){return new q(e)})),this.register((function(e){return new J(e)})),this.register((function(e){return new Y(e)})),this.register((function(e){return new F(e)})),this.register((function(e){return new ee(e)})),this.register((function(e){return new te(e)}))}load(e,t,n,r){const a=this;let o;if(""!==this.resourcePath)o=this.resourcePath;else if(""!==this.path){const t=i.r6x.extractUrlBase(e);o=i.r6x.resolveURL(t,this.path)}else o=i.r6x.extractUrlBase(e);this.manager.itemStart(e);const s=function(t){r?r(t):console.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},l=new i.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(n){try{a.parse(n,o,(function(n){t(n),a.manager.itemEnd(e)}),s)}catch(e){s(e)}}),n,s)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,i){let r;const a={},o={},s=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(s.decode(new Uint8Array(e,0,4))===ne){try{a[N.KHR_BINARY_GLTF]=new ie(e)}catch(e){return void(i&&i(e))}r=JSON.parse(a[N.KHR_BINARY_GLTF].content)}else r=JSON.parse(s.decode(e));else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Me(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),o[t.name]=t,a[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],n=r.extensionsRequired||[];switch(t){case N.KHR_MATERIALS_UNLIT:a[t]=new D;break;case N.KHR_DRACO_MESH_COMPRESSION:a[t]=new re(r,this.dracoLoader);break;case N.KHR_TEXTURE_TRANSFORM:a[t]=new ae;break;case N.KHR_MESH_QUANTIZATION:a[t]=new oe;break;default:n.indexOf(t)>=0&&void 0===o[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(a),l.setPlugins(o),l.parse(n,i)}parseAsync(e,t){const n=this;return new Promise((function(i,r){n.parse(e,t,i,r)}))}}function j(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const N={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class F{constructor(e){this.parser=e,this.name=N.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let r=t.cache.get(n);if(r)return r;const a=t.json,o=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e];let s;const l=new i.Q1f(16777215);void 0!==o.color&&l.setRGB(o.color[0],o.color[1],o.color[2],i.Zr2);const c=void 0!==o.range?o.range:0;switch(o.type){case"directional":s=new i.ZyN(l),s.target.position.set(0,0,-1),s.add(s.target);break;case"point":s=new i.HiM(l),s.distance=c;break;case"spot":s=new i.nCl(l),s.distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,s.angle=o.spot.outerConeAngle,s.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,s.target.position.set(0,0,-1),s.add(s.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return s.position.set(0,0,0),be(s,o),void 0!==o.intensity&&(s.intensity=o.intensity),s.name=t.createUniqueName(o.name||"light_"+e),r=Promise.resolve(s),t.cache.add(n,r),r}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,i=n.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return n._getNodeRef(t.cache,r,e)}))}}class D{constructor(){this.name=N.KHR_MATERIALS_UNLIT}getMaterialType(){return i.V9B}extendParams(e,t,n){const r=[];e.color=new i.Q1f(1,1,1),e.opacity=1;const a=t.pbrMetallicRoughness;if(a){if(Array.isArray(a.baseColorFactor)){const t=a.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],i.Zr2),e.opacity=t[3]}void 0!==a.baseColorTexture&&r.push(n.assignTexture(e,"map",a.baseColorTexture,i.er$))}return Promise.all(r)}}class H{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class z{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[],o=r.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&a.push(n.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&a.push(n.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(a.push(n.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new i.I9Y(e,e)}return Promise.all(a)}}class G{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.dispersion=void 0!==i.dispersion?i.dispersion:0,Promise.resolve()}}class q{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],a=i.extensions[this.name];return void 0!==a.iridescenceFactor&&(t.iridescence=a.iridescenceFactor),void 0!==a.iridescenceTexture&&r.push(n.assignTexture(t,"iridescenceMap",a.iridescenceTexture)),void 0!==a.iridescenceIor&&(t.iridescenceIOR=a.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==a.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=a.iridescenceThicknessMinimum),void 0!==a.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=a.iridescenceThicknessMaximum),void 0!==a.iridescenceThicknessTexture&&r.push(n.assignTexture(t,"iridescenceThicknessMap",a.iridescenceThicknessTexture)),Promise.all(r)}}class U{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[];t.sheenColor=new i.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;const o=r.extensions[this.name];if(void 0!==o.sheenColorFactor){const e=o.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],i.Zr2)}return void 0!==o.sheenRoughnessFactor&&(t.sheenRoughness=o.sheenRoughnessFactor),void 0!==o.sheenColorTexture&&a.push(n.assignTexture(t,"sheenColorMap",o.sheenColorTexture,i.er$)),void 0!==o.sheenRoughnessTexture&&a.push(n.assignTexture(t,"sheenRoughnessMap",o.sheenRoughnessTexture)),Promise.all(a)}}class V{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],a=i.extensions[this.name];return void 0!==a.transmissionFactor&&(t.transmission=a.transmissionFactor),void 0!==a.transmissionTexture&&r.push(n.assignTexture(t,"transmissionMap",a.transmissionTexture)),Promise.all(r)}}class K{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[],o=r.extensions[this.name];t.thickness=void 0!==o.thicknessFactor?o.thicknessFactor:0,void 0!==o.thicknessTexture&&a.push(n.assignTexture(t,"thicknessMap",o.thicknessTexture)),t.attenuationDistance=o.attenuationDistance||1/0;const s=o.attenuationColor||[1,1,1];return t.attenuationColor=(new i.Q1f).setRGB(s[0],s[1],s[2],i.Zr2),Promise.all(a)}}class W{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class X{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const a=[],o=r.extensions[this.name];t.specularIntensity=void 0!==o.specularFactor?o.specularFactor:1,void 0!==o.specularTexture&&a.push(n.assignTexture(t,"specularIntensityMap",o.specularTexture));const s=o.specularColorFactor||[1,1,1];return t.specularColor=(new i.Q1f).setRGB(s[0],s[1],s[2],i.Zr2),void 0!==o.specularColorTexture&&a.push(n.assignTexture(t,"specularColorMap",o.specularColorTexture,i.er$)),Promise.all(a)}}class Y{constructor(e){this.parser=e,this.name=N.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],a=i.extensions[this.name];return t.bumpScale=void 0!==a.bumpFactor?a.bumpFactor:1,void 0!==a.bumpTexture&&r.push(n.assignTexture(t,"bumpMap",a.bumpTexture)),Promise.all(r)}}class J{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],a=i.extensions[this.name];return void 0!==a.anisotropyStrength&&(t.anisotropy=a.anisotropyStrength),void 0!==a.anisotropyRotation&&(t.anisotropyRotation=a.anisotropyRotation),void 0!==a.anisotropyTexture&&r.push(n.assignTexture(t,"anisotropyMap",a.anisotropyTexture)),Promise.all(r)}}class Q{constructor(e){this.parser=e,this.name=N.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],a=t.options.ktx2Loader;if(!a){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,a)}}class Z{constructor(e){this.parser=e,this.name=N.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const a=r.extensions[t],o=i.images[a.source];let s=n.textureLoader;if(o.uri){const e=n.options.manager.getHandler(o.uri);null!==e&&(s=e)}return n.loadTextureImage(e,a.source,s)}}class ${constructor(e){this.parser=e,this.name=N.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const a=r.extensions[t],o=i.images[a.source];let s=n.textureLoader;if(o.uri){const e=n.options.manager.getHandler(o.uri);null!==e&&(s=e)}return n.loadTextureImage(e,a.source,s)}}class ee{constructor(e){this.name=N.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then((function(t){const n=e.byteOffset||0,i=e.byteLength||0,a=e.count,o=e.byteStride,s=new Uint8Array(t,n,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(a,o,s,e.mode,e.filter).then((function(e){return e.buffer})):r.ready.then((function(){const t=new ArrayBuffer(a*o);return r.decodeGltfBuffer(new Uint8Array(t),a,o,s,e.mode,e.filter),t}))}))}return null}}class te{constructor(e){this.name=N.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const r=t.meshes[n.mesh];for(const e of r.primitives)if(e.mode!==ue.TRIANGLES&&e.mode!==ue.TRIANGLE_STRIP&&e.mode!==ue.TRIANGLE_FAN&&void 0!==e.mode)return null;const a=n.extensions[this.name].attributes,o=[],s={};for(const e in a)o.push(this.parser.getDependency("accessor",a[e]).then((t=>(s[e]=t,s[e]))));return o.length<1?null:(o.push(this.parser.createNodeMesh(e)),Promise.all(o).then((e=>{const t=e.pop(),n=t.isGroup?t.children:[t],r=e[0].count,a=[];for(const e of n){const t=new i.kn4,n=new i.Pq0,o=new i.PTz,l=new i.Pq0(1,1,1),c=new i.ZLX(e.geometry,e.material,r);for(let e=0;e<r;e++)s.TRANSLATION&&n.fromBufferAttribute(s.TRANSLATION,e),s.ROTATION&&o.fromBufferAttribute(s.ROTATION,e),s.SCALE&&l.fromBufferAttribute(s.SCALE,e),c.setMatrixAt(e,t.compose(n,o,l));for(const t in s)if("_COLOR_0"===t){const e=s[t];c.instanceColor=new i.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,s[t]);i.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),a.push(c)}return t.isGroup?(t.clear(),t.add(...a),t):a[0]})))}}const ne="glTF";class ie{constructor(e){this.name=N.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ne)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,r=new DataView(e,12);let a=0;for(;a<i;){const t=r.getUint32(a,!0);a+=4;const i=r.getUint32(a,!0);if(a+=4,1313821514===i){const i=new Uint8Array(e,12+a,t);this.content=n.decode(i)}else if(5130562===i){const n=12+a;this.body=e.slice(n,n+t)}a+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class re{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=N.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,r=this.dracoLoader,a=e.extensions[this.name].bufferView,o=e.extensions[this.name].attributes,s={},l={},c={};for(const e in o){const t=ve[e]||e.toLowerCase();s[t]=o[e]}for(const t in e.attributes){const i=ve[t]||t.toLowerCase();if(void 0!==o[t]){const r=n.accessors[e.attributes[t]],a=he[r.componentType];c[i]=a.name,l[i]=!0===r.normalized}}return t.getDependency("bufferView",a).then((function(e){return new Promise((function(t,n){r.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],i=l[t];void 0!==i&&(n.normalized=i)}t(e)}),s,c,i.Zr2,n)}))}))}}class ae{constructor(){this.name=N.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class oe{constructor(){this.name=N.KHR_MESH_QUANTIZATION}}class se extends i.lGw{constructor(e,t,n,i){super(e,t,n,i)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let e=0;e!==i;e++)t[e]=n[r+e];return t}interpolate_(e,t,n,i){const r=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=2*o,l=3*o,c=i-t,u=(n-t)/c,h=u*u,d=h*u,f=e*l,p=f-l,v=-2*d+3*h,m=d-h,y=1-v,g=m-h+u;for(let e=0;e!==o;e++){const t=a[p+e+o],n=a[p+e+s]*c,i=a[f+e+o],l=a[f+e]*c;r[e]=y*t+g*n+v*i+m*l}return r}}const le=new i.PTz;class ce extends se{interpolate_(e,t,n,i){const r=super.interpolate_(e,t,n,i);return le.fromArray(r).normalize().toArray(r),r}}const ue={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},he={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},de={9728:i.hxR,9729:i.k6q,9984:i.pHI,9985:i.kRr,9986:i.Cfg,9987:i.$_I},fe={33071:i.ghU,33648:i.kTW,10497:i.GJx},pe={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ve={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},me={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},ye={CUBICSPLINE:void 0,LINEAR:i.PJ3,STEP:i.ljd};function ge(e,t,n){for(const i in n.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=n.extensions[i])}function be(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function we(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,i=t.weights.length;n<i;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,i=n.length;t<i;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ke(e){let t;const n=e.extensions&&e.extensions[N.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+Pe(n.attributes):e.indices+":"+Pe(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+Pe(e.targets[n]);return t}function Pe(e){let t="";const n=Object.keys(e).sort();for(let i=0,r=n.length;i<r;i++)t+=n[i]+":"+e[n[i]]+";";return t}function xe(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const Se=new i.kn4;class Me{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new j,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,r=-1,a=!1,o=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);r=n&&t?parseInt(t[1],10):-1,a=e.indexOf("Firefox")>-1,o=a?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||n&&r<17||a&&o<98?this.textureLoader=new i.Tap(this.options.manager):this.textureLoader=new i.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new i.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const a={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:n,userData:{}};return ge(r,a,i),be(a,i),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(a)}))).then((function(){for(const e of a.scenes)e.updateMatrixWorld();e(a)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){const i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(n[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const i=n.clone(),r=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[n,i]of e.children.entries())r(i,t.children[n])};return r(n,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const i=e(t[n]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&n.push(r)}return n}getDependency(e,t){const n=e+":"+t;let i=this.cache.get(n);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})),!i)throw new Error("Unknown type: "+e)}this.cache.add(n,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return n.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[N.KHR_BINARY_GLTF].body);const r=this.options;return new Promise((function(e,a){n.load(i.r6x.resolveURL(t.uri,r.path),e,void 0,(function(){a(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+n)}))}loadAccessor(e){const t=this,n=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse){const e=pe[r.type],t=he[r.componentType],n=!0===r.normalized,a=new t(r.count*e);return Promise.resolve(new i.THS(a,e,n))}const a=[];return void 0!==r.bufferView?a.push(this.getDependency("bufferView",r.bufferView)):a.push(null),void 0!==r.sparse&&(a.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),a.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(a).then((function(e){const a=e[0],o=pe[r.type],s=he[r.componentType],l=s.BYTES_PER_ELEMENT,c=l*o,u=r.byteOffset||0,h=void 0!==r.bufferView?n.bufferViews[r.bufferView].byteStride:void 0,d=!0===r.normalized;let f,p;if(h&&h!==c){const e=Math.floor(u/h),n="InterleavedBuffer:"+r.bufferView+":"+r.componentType+":"+e+":"+r.count;let c=t.cache.get(n);c||(f=new s(a,e*h,r.count*h/l),c=new i.eB$(f,h/l),t.cache.add(n,c)),p=new i.eHs(c,o,u%h/l,d)}else f=null===a?new s(r.count*o):new s(a,u,r.count*o),p=new i.THS(f,o,d);if(void 0!==r.sparse){const t=pe.SCALAR,n=he[r.sparse.indices.componentType],l=r.sparse.indices.byteOffset||0,c=r.sparse.values.byteOffset||0,u=new n(e[1],l,r.sparse.count*t),h=new s(e[2],c,r.sparse.count*o);null!==a&&(p=new i.THS(p.array.slice(),p.itemSize,p.normalized)),p.normalized=!1;for(let e=0,t=u.length;e<t;e++){const t=u[e];if(p.setX(t,h[e*o]),o>=2&&p.setY(t,h[e*o+1]),o>=3&&p.setZ(t,h[e*o+2]),o>=4&&p.setW(t,h[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}p.normalized=d}return p}))}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e].source,r=t.images[i];let a=this.textureLoader;if(r.uri){const e=n.manager.getHandler(r.uri);null!==e&&(a=e)}return this.loadTextureImage(e,i,a)}loadTextureImage(e,t,n){const r=this,a=this.json,o=a.textures[e],s=a.images[t],l=(s.uri||s.bufferView)+":"+o.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,n).then((function(t){t.flipY=!1,t.name=o.name||s.name||"",""===t.name&&"string"==typeof s.uri&&!1===s.uri.startsWith("data:image/")&&(t.name=s.uri);const n=(a.samplers||{})[o.sampler]||{};return t.magFilter=de[n.magFilter]||i.k6q,t.minFilter=de[n.minFilter]||i.$_I,t.wrapS=fe[n.wrapS]||i.GJx,t.wrapT=fe[n.wrapT]||i.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==i.hxR&&t.minFilter!==i.k6q,r.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[l]=c,c}loadImageSource(e,t){const n=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const a=n.images[e],o=self.URL||self.webkitURL;let s=a.uri||"",l=!1;if(void 0!==a.bufferView)s=this.getDependency("bufferView",a.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:a.mimeType});return s=o.createObjectURL(t),s}));else if(void 0===a.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(s).then((function(e){return new Promise((function(n,a){let o=n;!0===t.isImageBitmapLoader&&(o=function(e){const t=new i.gPd(e);t.needsUpdate=!0,n(t)}),t.load(i.r6x.resolveURL(e,r.path),o,void 0,a)}))})).then((function(e){var t;return!0===l&&o.revokeObjectURL(s),be(e,a),e.userData.mimeType=a.mimeType||((t=a.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",s),e}));return this.sourceCache[e]=c,c}assignTexture(e,t,n,i){const r=this;return this.getDependency("texture",n.index).then((function(a){if(!a)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((a=a.clone()).channel=n.texCoord),r.extensions[N.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[N.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(a);a=r.extensions[N.KHR_TEXTURE_TRANSFORM].extendTexture(a,e),r.associations.set(a,t)}}return void 0!==i&&(a.colorSpace=i),e[t]=a,a}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const r=void 0===t.attributes.tangent,a=void 0!==t.attributes.color,o=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new i.BH$,i.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new i.mrM,i.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(r||a||o){let e="ClonedMaterial:"+n.uuid+":";r&&(e+="derivative-tangents:"),a&&(e+="vertex-colors:"),o&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),a&&(t.vertexColors=!0),o&&(t.flatShading=!0),r&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return i._4j}loadMaterial(e){const t=this,n=this.json,r=this.extensions,a=n.materials[e];let o;const s={},l=[];if((a.extensions||{})[N.KHR_MATERIALS_UNLIT]){const e=r[N.KHR_MATERIALS_UNLIT];o=e.getMaterialType(),l.push(e.extendParams(s,a,t))}else{const n=a.pbrMetallicRoughness||{};if(s.color=new i.Q1f(1,1,1),s.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;s.color.setRGB(e[0],e[1],e[2],i.Zr2),s.opacity=e[3]}void 0!==n.baseColorTexture&&l.push(t.assignTexture(s,"map",n.baseColorTexture,i.er$)),s.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,s.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(l.push(t.assignTexture(s,"metalnessMap",n.metallicRoughnessTexture)),l.push(t.assignTexture(s,"roughnessMap",n.metallicRoughnessTexture))),o=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,s)}))))}!0===a.doubleSided&&(s.side=i.$EB);const c=a.alphaMode||"OPAQUE";if("BLEND"===c?(s.transparent=!0,s.depthWrite=!1):(s.transparent=!1,"MASK"===c&&(s.alphaTest=void 0!==a.alphaCutoff?a.alphaCutoff:.5)),void 0!==a.normalTexture&&o!==i.V9B&&(l.push(t.assignTexture(s,"normalMap",a.normalTexture)),s.normalScale=new i.I9Y(1,1),void 0!==a.normalTexture.scale)){const e=a.normalTexture.scale;s.normalScale.set(e,e)}if(void 0!==a.occlusionTexture&&o!==i.V9B&&(l.push(t.assignTexture(s,"aoMap",a.occlusionTexture)),void 0!==a.occlusionTexture.strength&&(s.aoMapIntensity=a.occlusionTexture.strength)),void 0!==a.emissiveFactor&&o!==i.V9B){const e=a.emissiveFactor;s.emissive=(new i.Q1f).setRGB(e[0],e[1],e[2],i.Zr2)}return void 0!==a.emissiveTexture&&o!==i.V9B&&l.push(t.assignTexture(s,"emissiveMap",a.emissiveTexture,i.er$)),Promise.all(l).then((function(){const n=new o(s);return a.name&&(n.name=a.name),be(n,a),t.associations.set(n,{materials:e}),a.extensions&&ge(r,n,a),n}))}createUniqueName(e){const t=i.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,r=this.primitiveCache;function a(e){return n[N.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return Te(n,e,t)}))}const o=[];for(let n=0,s=e.length;n<s;n++){const s=e[n],l=ke(s),c=r[l];if(c)o.push(c.promise);else{let e;e=s.extensions&&s.extensions[N.KHR_DRACO_MESH_COMPRESSION]?a(s):Te(new i.LoY,s,t),r[l]={primitive:s,promise:e},o.push(e)}}return Promise.all(o)}loadMesh(e){const t=this,n=this.json,r=this.extensions,a=n.meshes[e],o=a.primitives,s=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new i._4j({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:i.hB5})),l.DefaultMaterial):this.getDependency("material",o[e].material);s.push(t)}var l;return s.push(t.loadGeometries(o)),Promise.all(s).then((function(n){const s=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){const u=l[n],h=o[n];let d;const f=s[n];if(h.mode===ue.TRIANGLES||h.mode===ue.TRIANGLE_STRIP||h.mode===ue.TRIANGLE_FAN||void 0===h.mode)d=!0===a.isSkinnedMesh?new i.I46(u,f):new i.eaF(u,f),!0===d.isSkinnedMesh&&d.normalizeSkinWeights(),h.mode===ue.TRIANGLE_STRIP?d.geometry=_(d.geometry,i.O49):h.mode===ue.TRIANGLE_FAN&&(d.geometry=_(d.geometry,i.rYR));else if(h.mode===ue.LINES)d=new i.DXC(u,f);else if(h.mode===ue.LINE_STRIP)d=new i.N1A(u,f);else if(h.mode===ue.LINE_LOOP)d=new i.FCc(u,f);else{if(h.mode!==ue.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);d=new i.ONl(u,f)}Object.keys(d.geometry.morphAttributes).length>0&&we(d,a),d.name=t.createUniqueName(a.name||"mesh_"+e),be(d,a),h.extensions&&ge(r,d,h),t.assignFinalMaterial(d),c.push(d)}for(let n=0,i=c.length;n<i;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return a.extensions&&ge(r,c[0],a),c[0];const u=new i.YJl;a.extensions&&ge(r,u,a),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u}))}loadCamera(e){let t;const n=this.json.cameras[e],r=n[n.type];if(r)return"perspective"===n.type?t=new i.ubm(i.cj9.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(t=new i.qUd(-r.xmag,r.xmag,r.ymag,-r.ymag,r.znear,r.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),be(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n=[];for(let e=0,i=t.joints.length;e<i;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then((function(e){const n=e.pop(),r=e,a=[],o=[];for(let e=0,s=r.length;e<s;e++){const s=r[e];if(s){a.push(s);const t=new i.kn4;null!==n&&t.fromArray(n.array,16*e),o.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new i.EAD(a,o)}))}loadAnimation(e){const t=this.json,n=this,r=t.animations[e],a=r.name?r.name:"animation_"+e,o=[],s=[],l=[],c=[],u=[];for(let e=0,t=r.channels.length;e<t;e++){const t=r.channels[e],n=r.samplers[t.sampler],i=t.target,a=i.node,h=void 0!==r.parameters?r.parameters[n.input]:n.input,d=void 0!==r.parameters?r.parameters[n.output]:n.output;void 0!==i.node&&(o.push(this.getDependency("node",a)),s.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",d)),c.push(n),u.push(i))}return Promise.all([Promise.all(o),Promise.all(s),Promise.all(l),Promise.all(c),Promise.all(u)]).then((function(e){const t=e[0],r=e[1],o=e[2],s=e[3],l=e[4],c=[];for(let e=0,i=t.length;e<i;e++){const i=t[e],a=r[e],u=o[e],h=s[e],d=l[e];if(void 0===i)continue;i.updateMatrix&&i.updateMatrix();const f=n._createAnimationTracks(i,a,u,h,d);if(f)for(let e=0;e<f.length;e++)c.push(f[e])}return new i.tz3(a,void 0,c)}))}createNodeMesh(e){const t=this.json,n=this,i=t.nodes[e];return void 0===i.mesh?null:n.getDependency("mesh",i.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=i.weights.length;t<n;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this,n=this.json.nodes[e],i=t._loadNodeShallow(e),r=[],a=n.children||[];for(let e=0,n=a.length;e<n;e++)r.push(t.getDependency("node",a[e]));const o=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([i,Promise.all(r),o]).then((function(e){const t=e[0],n=e[1],i=e[2];null!==i&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(i,Se)}));for(let e=0,i=n.length;e<i;e++)t.add(n[e]);return t}))}_loadNodeShallow(e){const t=this.json,n=this.extensions,r=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const a=t.nodes[e],o=a.name?r.createUniqueName(a.name):"",s=[],l=r._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return l&&s.push(l),void 0!==a.camera&&s.push(r.getDependency("camera",a.camera).then((function(e){return r._getNodeRef(r.cameraCache,a.camera,e)}))),r._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){s.push(e)})),this.nodeCache[e]=Promise.all(s).then((function(t){let s;if(s=!0===a.isBone?new i.$Kf:t.length>1?new i.YJl:1===t.length?t[0]:new i.B69,s!==t[0])for(let e=0,n=t.length;e<n;e++)s.add(t[e]);if(a.name&&(s.userData.name=a.name,s.name=o),be(s,a),a.extensions&&ge(n,s,a),void 0!==a.matrix){const e=new i.kn4;e.fromArray(a.matrix),s.applyMatrix4(e)}else void 0!==a.translation&&s.position.fromArray(a.translation),void 0!==a.rotation&&s.quaternion.fromArray(a.rotation),void 0!==a.scale&&s.scale.fromArray(a.scale);if(r.associations.has(s)){if(void 0!==a.mesh&&r.meshCache.refs[a.mesh]>1){const e=r.associations.get(s);r.associations.set(s,{...e})}}else r.associations.set(s,{});return r.associations.get(s).nodes=e,s})),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],r=this,a=new i.YJl;n.name&&(a.name=r.createUniqueName(n.name)),be(a,n),n.extensions&&ge(t,a,n);const o=n.nodes||[],s=[];for(let e=0,t=o.length;e<t;e++)s.push(r.getDependency("node",o[e]));return Promise.all(s).then((function(e){for(let t=0,n=e.length;t<n;t++)a.add(e[t]);return r.associations=(e=>{const t=new Map;for(const[e,n]of r.associations)(e instanceof i.imn||e instanceof i.gPd)&&t.set(e,n);return e.traverse((e=>{const n=r.associations.get(e);null!=n&&t.set(e,n)})),t})(a),a}))}_createAnimationTracks(e,t,n,r,a){const o=[],s=e.name?e.name:e.uuid,l=[];let c;switch(me[a.path]===me.weights?e.traverse((function(e){e.morphTargetInfluences&&l.push(e.name?e.name:e.uuid)})):l.push(s),me[a.path]){case me.weights:c=i.Hit;break;case me.rotation:c=i.MBL;break;case me.translation:case me.scale:c=i.RiT;break;default:c=1===n.itemSize?i.Hit:i.RiT}const u=void 0!==r.interpolation?ye[r.interpolation]:i.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=l.length;e<n;e++){const n=new c(l[e]+"."+me[a.path],t.array,h,u);"CUBICSPLINE"===r.interpolation&&this._createCubicSplineTrackInterpolant(n),o.push(n)}return o}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=xe(t.constructor),n=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)n[i]=t[i]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof i.MBL?ce:se)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Te(e,t,n){const r=t.attributes,a=[];function o(t,i){return n.getDependency("accessor",t).then((function(t){e.setAttribute(i,t)}))}for(const t in r){const n=ve[t]||t.toLowerCase();n in e.attributes||a.push(o(r[t],n))}if(void 0!==t.indices&&!e.index){const i=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));a.push(i)}return i.ppV.workingColorSpace!==i.Zr2&&"COLOR_0"in r&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${i.ppV.workingColorSpace}" not supported.`),be(e,t),function(e,t,n){const r=t.attributes,a=new i.NRn;if(void 0===r.POSITION)return;{const e=n.json.accessors[r.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(a.set(new i.Pq0(t[0],t[1],t[2]),new i.Pq0(o[0],o[1],o[2])),e.normalized){const t=xe(he[e.componentType]);a.min.multiplyScalar(t),a.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new i.Pq0,t=new i.Pq0;for(let i=0,r=o.length;i<r;i++){const r=o[i];if(void 0!==r.POSITION){const i=n.json.accessors[r.POSITION],a=i.min,o=i.max;if(void 0!==a&&void 0!==o){if(t.setX(Math.max(Math.abs(a[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(a[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(a[2]),Math.abs(o[2]))),i.normalized){const e=xe(he[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}a.expandByVector(e)}e.boundingBox=a;const s=new i.iyt;a.getCenter(s.center),s.radius=a.min.distanceTo(a.max)/2,e.boundingSphere=s}(e,t,n),Promise.all(a).then((function(){return void 0!==t.targets?function(e,t,n){let i=!1,r=!1,a=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(i=!0),void 0!==n.NORMAL&&(r=!0),void 0!==n.COLOR_0&&(a=!0),i&&r&&a)break}if(!i&&!r&&!a)return Promise.resolve(e);const o=[],s=[],l=[];for(let c=0,u=t.length;c<u;c++){const u=t[c];if(i){const t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;o.push(t)}if(r){const t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;s.push(t)}if(a){const t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(o),Promise.all(s),Promise.all(l)]).then((function(t){const n=t[0],o=t[1],s=t[2];return i&&(e.morphAttributes.position=n),r&&(e.morphAttributes.normal=o),a&&(e.morphAttributes.color=s),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}var Ee=n(5418),Ce=console.error;function Re(e){(new a).parse(e,(function(e){var t,n;t=e,(n=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),n.setAttribute("download","scene.gltf"),document.body.appendChild(n),n.click(),n.remove()}),Ce)}function Ae(e,t){(new L).load(e,(function(n){n.scene.scale.set(Ee.R/.5,Ee.R/.5,Ee.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)}),(function(t){return console.log(e+" "+t.loaded+" bytes loaded")}),Ce)}},363:(e,t,n)=>{n.d(t,{l:()=>s});var i=n(5418),r=n(4922);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"indicateValid",value:function(t){e.placermaterial.color.setHex(t?13434828:16711680)}},{key:"createPlacer",value:function(){var t=new r.Ho_(.01*i.R/.5,i.R,i.R,4),n=new r.eaF(t,e.placermaterial);return n.geometry.applyMatrix4((new r.kn4).identity().makeRotationAxis(new r.Pq0(1,0,0),-Math.PI/2)).applyMatrix4((new r.kn4).identity().makeTranslation(0,0,.7*i.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(t,n,i){var a=new r.YJl;a.name="cueShaft";var o=2.2*t,s=Math.max(i-o,8*t),l=new r.Ho_(t,n,s,24);l.translate(0,-(s/2+o),0);var c=new r.eaF(l,e.material);c.castShadow=!1,a.add(c);var u=1.08*t,h=1.18*t,d=new r.Ho_(u,h,o,24),f=new r.eaF(d,e.ferruleMaterial);f.position.y=-o/2,f.castShadow=!1,a.add(f);var p=.98*u,v=new r.Gu$(p,24,16,0,2*Math.PI,0,Math.PI/2);v.translate(0,-p,0);var m=new r.eaF(v,e.tipMaterial);return m.castShadow=!1,m.renderOrder=2,a.add(m),a}},{key:"createHitPoint",value:function(){var e=new r.Gu$(1.05*i.R,32,32,0,2*Math.PI,0,.125*Math.PI);e.rotateX(Math.PI/2),e.translate(0,0,1.05*-i.R);var t=new r.BKk({uniforms:{hitColor:{value:new r.Pq0(72/255,72/255,206/255)},spotSize:{value:.3},sphereCenter:{value:new r.Pq0(0,0,1.05*-i.R)}},vertexShader:"\n        varying vec3 vPosition;\n        varying vec3 vNormal;\n\n        void main() {\n          vPosition = position;\n          vNormal = normalize(normalMatrix * normal);\n          gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);\n        }\n      ",fragmentShader:"\n        uniform vec3 hitColor;\n        uniform float spotSize;\n        uniform vec3 sphereCenter;\n        varying vec3 vPosition;\n        varying vec3 vNormal;\n\n        void main() {\n          // Calculate position relative to sphere center (after geometry.translate)\n          vec3 pos = normalize(vPosition - sphereCenter);\n          vec3 northPole = vec3(0.0, 0.0, 1.0);\n          float dotProduct = dot(pos, northPole);\n          float angularDist = acos(clamp(dotProduct, -1.0, 1.0)) / 3.14159;\n          float normalizedDist = angularDist / spotSize;\n          float alpha = 1.0 - smoothstep(0.7, 1.0, normalizedDist);\n          float glow = pow(1.0 - clamp(normalizedDist, 0.0, 1.0), 2.0) * 0.8;\n          vec3 finalColor = hitColor + vec3(glow);\n          if (alpha < 0.05) discard;\n          gl_FragColor = vec4(finalColor, alpha * 0.9);\n        }\n      ",transparent:!0,depthTest:!0,depthWrite:!1,side:r.$EB}),n=new r.eaF(e,t);return n.renderOrder=10,n.visible=!0,n}},{key:"createVirtualCue",value:function(){var e=7.5/30.75*i.R,t=100/30.75*i.R,n=new r.Ho_(e,e,t,16);n.translate(0,-t/2,0);var a=new r.tXL({color:65280,emissive:65280,emissiveIntensity:.5,transparent:!0,opacity:.85,shininess:100}),o=new r.eaF(n,a);return o.renderOrder=998,o.visible=!0,o}},{key:"createCueMaterial",value:function(){var t="undefined"!=typeof document||void 0!==globalThis.OffscreenCanvas,n={color:16777215,transparent:!0,opacity:.65,depthWrite:!1,shininess:30,emissive:new r.Q1f(4859926),emissiveIntensity:.6};if(t)try{n.map=e.getWoodTexture()}catch(e){}var i=new r.tXL(n);return i.needsUpdate=!0,i}},{key:"getWoodTexture",value:function(){if(!e.woodTexture){var t;if("undefined"!=typeof document)(t=document.createElement("canvas")).width=512,t.height=32;else{if(void 0===globalThis.OffscreenCanvas){var n,i=null===(n=globalThis.document)||void 0===n?void 0:n.createElement;if(i){var a=i.call(globalThis.document,"canvas");return a.width=1,a.height=1,e.woodTexture=new r.GOR(a),e.woodTexture}throw new Error("No canvas available for cue texture")}t=new globalThis.OffscreenCanvas(512,32)}var o=t.getContext("2d");if(!o)throw new Error("Unable to create canvas context for cue texture");var s=o.createLinearGradient(0,0,t.width,0);s.addColorStop(0,"#8b5a2b"),s.addColorStop(.25,"#a4703a"),s.addColorStop(.5,"#c58b4b"),s.addColorStop(.75,"#a4703a"),s.addColorStop(1,"#8b5a2b"),o.fillStyle=s,o.fillRect(0,0,t.width,t.height);for(var l=0;l<40;l++){var c=4+16*Math.random(),u=Math.random()*t.width,h=.04+.05*Math.random();o.fillStyle="rgba(60, 30, 15, ".concat(h.toFixed(3),")"),o.fillRect(u,0,c,t.height)}e.woodTexture=new r.GOR(t),e.woodTexture.wrapS=r.GJx,e.woodTexture.wrapT=r.GJx,e.woodTexture.magFilter=r.k6q,e.woodTexture.minFilter=r.k6q,e.woodTexture.repeat.set(6,1),e.woodTexture.needsUpdate=!0}return e.woodTexture}}],null&&a(t.prototype,null),n&&a(t,n),e}();o(s,"mesh",void 0),o(s,"woodTexture",null),o(s,"material",s.createCueMaterial()),o(s,"ferruleMaterial",new r.tXL({color:15987180,emissive:new r.Q1f(2763306),emissiveIntensity:.35,transparent:!0,opacity:.7,depthWrite:!1,shininess:60})),o(s,"tipMaterial",new r.tXL({color:7317208,emissive:new r.Q1f(1715007),emissiveIntensity:.6,transparent:!0,opacity:.75,depthWrite:!1,shininess:80})),o(s,"placermaterial",new r.tXL({color:13434828,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5}))},665:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){var t=43*e,n=21*e;return{tableX:t,tableY:n,X:t+e,Y:n+e}}n.d(t,{P:()=>s});var o=a(n(5418).R),s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"scaleToRadius",value:function(t){var n=a(t);e.tableX=n.tableX,e.tableY=n.tableY,e.X=n.X,e.Y=n.Y,e.hasPockets=!0}},{key:"setCaromDimensions",value:function(e,t,n){this.hasPockets=!1,this.X=e/2,this.Y=t/2,this.tableX=this.X-n,this.tableY=this.Y-n}}],null&&i(t.prototype,null),n&&i(t,n),e}();r(s,"tableX",o.tableX),r(s,"tableY",o.tableY),r(s,"X",o.X),r(s,"Y",o.Y),r(s,"hasPockets",!0)},772:(e,t,n)=>{n.d(t,{s:()=>l});var i=n(3413),r=n(2617),a=n.n(r);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"pressed",{}),s(this,"released",{}),s(this,"interactable",null),s(this,"element",null),s(this,"dragEnabled",!0),s(this,"keydown",(function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()})),s(this,"keyup",(function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()})),s(this,"mousetouch",(function(e){if(n.dragEnabled){var t,i,r=n.released,a=e.client.y<e.rect.height/2||e.ctrlKey?.5:1,o=e.dx*a,s=.8*e.dy;r.movementY=(null!==(t=r.movementY)&&void 0!==t?t:0)+s,r.movementX=(null!==(i=r.movementX)&&void 0!==i?i:0)+o,Math.abs(r.movementX)>Math.abs(r.movementY)&&(r.movementY=0)}})),this.addHandlers(t),/Android|iPhone/i.test(navigator.userAgent)||(t.contentEditable="true")}var t,n;return t=e,(n=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter((function(e){return!/Shift/.test(e)})).filter((function(e){return!/Control/.test(e)})),n=Object.keys(this.pressed).some((function(e){return/Shift/.test(e)})),r=Object.keys(this.pressed).some((function(e){return/Control/.test(e)})),a=[];return t.forEach((function(t){var o=performance.now()-e.pressed[t];a.push(new i.p(r?o/3:o,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())})),Object.keys(this.released).forEach((function(t){return a.push(new i.p(e.released[t],t+"Up"))})),this.released={},a}},{key:"addHandlers",value:function(e){var t=this;this.element=e,e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),this.interactable=a()(e),this.interactable.draggable({listeners:{move:function(e){t.mousetouch(e)}}}),this.interactable.gesturable({onmove:function(e){e.dx/=3,t.mousetouch(e)}})}},{key:"disableDragControls",value:function(){this.dragEnabled=!1,this.interactable&&(this.interactable.draggable(!1),this.interactable.gesturable(!1)),this.pressed={},this.released={}}},{key:"enableDragControls",value:function(){var e=this;this.dragEnabled=!0,this.interactable&&this.element&&(this.interactable.draggable({listeners:{move:function(t){e.mousetouch(t)}}}),this.interactable.gesturable({onmove:function(t){t.dx/=3,e.mousetouch(t)}}))}}])&&o(t.prototype,n),e}()},803:(e,t,n)=>{n.d(t,{d:()=>k});var i=n(7009),r=n(2522),a=n(4368),o=n(2518),s=n(1943),l=n(5556),c=n(3206),u=n(9915);function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function p(e,t){return p=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},p(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(v=function(){return!!e})()}var m=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),d(e=function(e,t,n){return t=f(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,v()?Reflect.construct(t,n||[],f(e).constructor):t.apply(e,n))}(this,t),"clientResendFrom",void 0),d(e,"serverResendFrom",void 0),e.type=i.B.REJOIN,e.clientResendFrom=n,e.serverResendFrom=r,e}var n,r,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&p(e,t)}(t,e),n=t,a=[{key:"fromJson",value:function(e){return new t(e.clientResendFrom,e.serverResendFrom)}}],(r=[{key:"applyToController",value:function(e){return e.handleRejoin(this)}}])&&h(n.prototype,r),a&&h(n,a),t}(n(8279).F),y=n(7387),g=n(9419),b=n(2582);function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"serialise",value:function(e){return JSON.stringify(e)}},{key:"fromJson",value:function(e){switch(e.type){case i.B.BEGIN:return new c.u;case i.B.AIM:return r.w.fromJson(e);case i.B.BREAK:return l.W.fromJson(e);case i.B.WATCHAIM:return a.Q.fromJson(e.json);case i.B.HIT:return o.Q.fromJson(e);case i.B.CHAT:return u.b.fromJson(e);case i.B.REJOIN:return m.fromJson(e);case i.B.ABORT:return new s.h;case i.B.PLACEBALL:return y.z.fromJson(e);case i.B.RERACK:return g.x.fromJson(e);case i.B.STARTAIM:return b.M.fromJson(e);default:throw Error("Unknown GameEvent :"+e)}}},{key:"fromSerialised",value:function(t){var n=JSON.parse(t),i=e.fromJson(n);return"sequence"in n&&(i.sequence=n.sequence),"clientId"in n&&(i.clientId=n.clientId),i}}],null&&w(t.prototype,null),n&&w(t,n),e}()},1185:(e,t,n)=>{n.d(t,{e:()=>b});var i=n(2518),r=n(5615),a=n(2522),o=n(5556),s=n(4853),l=n(7009),c=n(9419),u=n(4005),h=n(9915);function d(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function v(e){return v=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},v(e)}function m(e,t){return m=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},m(e,t)}function y(e){return function(e){if(Array.isArray(e))return d(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return d(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?d(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function g(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(g=function(){return!!e})()}var b=function(e){function t(e,n,i){var r,a=arguments.length>3&&void 0!==arguments[3]&&arguments[3],s=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1500;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),p(r=function(e,t,n){return t=v(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,g()?Reflect.construct(t,n||[],v(e).constructor):t.apply(e,n))}(this,t,[e]),"delay",void 0),p(r,"shots",void 0),p(r,"firstShot",void 0),p(r,"timer",void 0),p(r,"init",void 0),p(r,"waitingForClick",!1),p(r,"clickHandler",void 0),r.init=n,r.shots=y(i),r.firstShot=r.shots[0],r.delay=s,r.container.table.showTraces(!0),r.container.isDebugModeEnabled()||r.container.table.showVirtualCue(!1),r.container.table.updateFromShortSerialised(r.init),a){var l=new o.W(n,i);l.retry=!0,r.container.eventQueue.push(l)}else r.container.view.camera.forceMode(r.container.view.camera.topView),r.waitForClick();return r}var n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&m(e,t)}(t,e),n=t,(r=[{key:"waitForClick",value:function(){var e=this;this.waitingForClick=!0,this.container.eventQueue.push(new h.b(null,"Click on the screen to start replay")),this.clickHandler=function(t){if(e.waitingForClick){e.waitingForClick=!1;var n=document.getElementById("viewP1");n&&n.removeEventListener("click",e.clickHandler),e.playNextShot(1.5*e.delay)}};var t=document.getElementById("viewP1");t&&t.addEventListener("click",this.clickHandler)}},{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift();if((null==n?void 0:n.type)===l.B.RERACK)return c.x.fromJson(n.ballinfo).applyToController(this),void(this.shots.length>0&&this.playNextShot(e));var r=a.w.fromJson(n);this.container.table.cueball=this.container.table.balls[r.i],this.container.table.cueball.pos.copy(r.pos),this.container.table.cue.aim=r,this.container.table.cue.elevation=r.elevation,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,clearTimeout(this.timer),this.timer=setTimeout((function(){t.container.eventQueue.push(new i.Q(t.container.table.cue.aim)),t.timer=void 0}),e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){return this.shots.length>0&&void 0===this.timer&&this.playNextShot(this.delay),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}},{key:"handleBreak",value:function(e){if(this.waitingForClick){this.waitingForClick=!1;var t=document.getElementById("viewP1");t&&this.clickHandler&&t.removeEventListener("click",this.clickHandler)}return this.container.table.updateFromShortSerialised(e.init),this.shots=y(e.shots),this.container.table.showSpin(!0),e.retry?this.retry():(this.playNextShot(this.delay),this)}},{key:"handleAbort",value:function(e){if(console.log("Replay aborted"),this.waitingForClick){this.waitingForClick=!1;var t=document.getElementById("viewP1");t&&this.clickHandler&&t.removeEventListener("click",this.clickHandler)}return new u.o(this.container)}},{key:"retry",value:function(){if(this.waitingForClick){this.waitingForClick=!1;var e=document.getElementById("viewP1");e&&this.clickHandler&&e.removeEventListener("click",this.clickHandler)}clearTimeout(this.timer),this.timer=void 0,this.container.table.updateFromShortSerialised(this.init);var t=a.w.fromJson(this.firstShot);return this.container.table.cueball=this.container.table.balls[t.i],this.container.rules.cueball=this.container.table.cueball,this.container.table.cueball.pos.copy(t.pos),this.container.table.cue.aim=t,this.container.table.cue.elevation=t.elevation,this.container.view.camera.forceMode(this.container.view.camera.aimView),new s.m(this.container)}}])&&f(n.prototype,r),t}(r.y)},1279:(e,t,n)=>{n.d(t,{O:()=>h});var i=n(4853),r=n(8938),a=n(5615),o=n(4110);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var h=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,u()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t,[e])).container.table.outcome=[],n.container.table.hit(),n}var n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,(a=[{key:"handleStartAim",value:function(e){return"function"==typeof this.container.rules.prepareForLocalTurn&&this.container.rules.prepareForLocalTurn(),!this.container.rules.cueball&&this.container.table.balls.length>0&&(this.container.rules.cueball=this.container.table.balls[0]),new i.m(this.container)}},{key:"handlePlaceBall",value:function(e){return new o.x(this.container)}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("Respot"),this.container.table.updateFromSerialised(e.json),this):(this.container.table.cueball&&(this.container.rules.cueball=this.container.table.cueball),"whiteScore"in e.json&&"yellowScore"in e.json&&"function"==typeof this.container.rules.setScores&&this.container.rules.setScores(e.json.whiteScore,e.json.yellowScore),new r.r(this.container))}}])&&s(n.prototype,a),t}(a.y)},1624:(e,t,n)=>{var i=n(8207),r=n(8765),a=n(8090);document.addEventListener("DOMContentLoaded",(function(){for(var e=document.getElementsByClassName("replaydiagram"),t=0;t<e.length;t++){var n=e.item(t),o=r.n.fromDiamgramElement(n);o.cushionModel=a.Qy,o.start()}new i.r}))},1842:(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),r.forEach((function(t){i(e,t,n[t])}))}return e}function a(e,t){return t=null!=t?t:{},Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))})),e}n.d(t,{CH:()=>m,Hh:()=>y,Q6:()=>g});var o,s="undefined"!=typeof window,l="undefined"!=typeof performance,c=function(){return l?performance.now():Date.now()},u=1e3/30+5,h={active:!1,frames:[],catapultFrames:[],startedAt:0},d=function(e){return Math.round(1e3*e)/1e3},f=function(e,t){var n=e.map((function(e){return e[t]}));if(0===n.length)return{avg:0,max:0,p95:0};n.sort((function(e,t){return e-t}));var i=n.reduce((function(e,t){return e+t}),0),r=Math.min(n.length-1,Math.floor(.95*n.length));return{avg:d(i/n.length),max:d(n[n.length-1]),p95:d(n[r])}},p=function(e){var t=[];return e.dtMs>u&&t.push("dt>".concat(d(u))),e.deltaClamped&&t.push("deltaClamped"),e.hitMaxSubSteps&&t.push("hitMaxSubSteps"),(e.accumulatorClamped||e.accumulatorTrimmedPostStep)&&t.push("backlogClamped"),t},v=function(e,t,n){var i={};n.forEach((function(e){e.reasons.forEach((function(e){var t;i[e]=(null!==(t=i[e])&&void 0!==t?t:0)+1}))}));var r,a=n.reduce((function(e,t){return e?t.dtMs>e.dtMs?t:e:t}),void 0);return{frames:e.length,durationMs:d(t),metrics:{physics:f(e,"physics"),process:f(e,"process"),render:f(e,"render"),total:f(e,"total"),dt:f(e,"dtMs"),delta:f(e,"deltaMs"),steps:f(e,"steps"),simulated:f(e,"simulatedMs"),backlogBefore:f(e,"backlogBefore"),backlogAfter:f(e,"backlogAfter")},catapult:{frames:n.length,reasons:i,worst:a?(r=a,{frame:r.frame,dtMs:d(r.dtMs),rawElapsedMs:d(r.rawElapsedMs),deltaMs:d(r.deltaMs),steps:r.steps,simulatedMs:d(r.simulatedMs),physics:d(r.physics),process:d(r.process),render:d(r.render),total:d(r.total),reasons:r.reasons.slice(),accumulatorBefore:d(r.accumulatorBefore),accumulatorAfterAdd:d(r.accumulatorAfterAdd),accumulatorAfter:d(r.accumulatorAfter),backlogBefore:d(r.backlogBefore),backlogAfter:d(r.backlogAfter)}):void 0}}};function m(){s&&(h.active&&g(),h.active=!0,h.frames=[],h.catapultFrames=[],h.startedAt=c())}function y(e){if(h.active){var t=h.frames.length,n=a(r({},e),{frame:t});h.frames.push(n);var i=p(n);i.length>0&&h.catapultFrames.push(a(r({},n),{reasons:i}))}}function g(){if(!h.active)return o;h.active=!1;var e=h.frames.slice(),t=h.catapultFrames.slice(),n=c()-h.startedAt,i={summary:v(e,n,t),frames:e,catapultFrames:t};return o=i,s&&(window.lastShotStats=i),h.frames=[],h.catapultFrames=[],i}},1943:(e,t,n)=>{n.d(t,{h:()=>c});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t)).type=r.B.ABORT,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,(i=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}])&&a(n.prototype,i),t}(i.F)},2072:(__unused_webpack_module,__webpack_exports__,__webpack_require__)=>{var __dirname="/";function asyncGeneratorStep(e,t,n,i,r,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(i,r)}function _async_to_generator(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var a=e.apply(t,n);function o(e){asyncGeneratorStep(a,i,r,o,s,"next",e)}function s(e){asyncGeneratorStep(a,i,r,o,s,"throw",e)}o(void 0)}))}}function _type_of(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function _ts_generator(e,t){var n,i,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}__webpack_require__.d(__webpack_exports__,{uP:()=>trace});var fs=null,path=null,logFilePath=null,helperBuffer=[];function initNodeModules(){if(null===fs)try{"undefined"==typeof window&&"undefined"!=typeof process&&(fs=eval("require('fs')"),path=eval("require('path')"))}catch(e){}}function getSessionId(){try{var e="undefined"!=typeof window?window:null;if(e){if(!e.__trajectorySessionId){var t=Math.random().toString(36).slice(2,8),n=Date.now().toString(36);e.__trajectorySessionId="s-".concat(n,"-").concat(t)}return e.__trajectorySessionId}var i=void 0!==__webpack_require__.g?__webpack_require__.g:null;if(i){if(!i.__trajectorySessionId){var r=Math.random().toString(36).slice(2,8),a=Date.now().toString(36);i.__trajectorySessionId="s-".concat(a,"-").concat(r)}return i.__trajectorySessionId}}catch(e){}return"s-".concat(Date.now().toString(36))}function getBrowserId(){try{var e="undefined"!=typeof window?window:null;if(e&&!e.__trajectoryBrowserId){var t=new Date,n=t.getFullYear(),i=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0"),a=String(t.getHours()).padStart(2,"0"),o=String(t.getMinutes()).padStart(2,"0"),s=String(t.getSeconds()).padStart(2,"0"),l=Math.random().toString(36).slice(2,6);e.__trajectoryBrowserId="".concat(n).concat(i).concat(r).concat(a).concat(o).concat(s,"-").concat(l)}return(null==e?void 0:e.__trajectoryBrowserId)||"unknown"}catch(e){}return"unknown"}function getOrCreateLogFile(){if(!fs||!path)return null;if(logFilePath)return logFilePath;try{for(var e=__dirname,t=null,n=0;n<10;n++){var i=path.join(e,"package.json");if(fs.existsSync(i)){t=path.join(e,"logs");break}e=path.dirname(e)}t||(t=path.resolve(process.cwd(),"logs")),fs.existsSync(t)||fs.mkdirSync(t,{recursive:!0});var r=new Date,a=r.getFullYear(),o=String(r.getMonth()+1).padStart(2,"0"),s=String(r.getDate()).padStart(2,"0"),l=String(r.getHours()).padStart(2,"0"),c=String(r.getMinutes()).padStart(2,"0"),u=String(r.getSeconds()).padStart(2,"0"),h=Math.random().toString(36).slice(2,6),d=getSessionId();return logFilePath=path.join(t,"test-trajectory-".concat(a).concat(o).concat(s).concat(l).concat(c).concat(u,"-").concat(h,"-").concat(d,".log"))}catch(e){return null}}function writeToNodeFile(e){if(fs)try{var t=getOrCreateLogFile();if(!t)return void console.log("[trace] could not get log file path");fs.appendFileSync(t,e+"\n","utf8")}catch(e){}else console.log("[trace] fs not available, skipping file write")}function simplifyVectorXYZ(e){return e&&"object"===(void 0===e?"undefined":_type_of(e))&&"x"in e&&"y"in e&&"z"in e&&"number"==typeof e.x&&"number"==typeof e.y&&"number"==typeof e.z?{x:e.x,y:e.y,z:e.z}:null}function safeStringify(e){var t=new WeakSet;return JSON.stringify(e,(function(e,n){var i=simplifyVectorXYZ(n);if(i)return i;if(n&&"object"===(void 0===n?"undefined":_type_of(n))){if(t.has(n))return"[Circular]";t.add(n)}return n}))}function postLog(e){return _async_to_generator((function(){return _ts_generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,fetch("/__log",{method:"POST",headers:{"Content-Type":"application/json"},body:e})];case 1:case 2:return t.sent(),[3,3];case 3:return[2]}}))}))()}function trace(e,t){try{var n="undefined"!=typeof window?window:null,i=void 0!==__webpack_require__.g?__webpack_require__.g:null,r=(null==n?void 0:n.__trajectoryTrace)||(null==i?void 0:i.__trajectoryTrace);if(!r)return;if("helper_shot"===e)return void(helperBuffer=[{label:e,data:t}]);if("helper_event"===e)return 0===helperBuffer.length&&helperBuffer.push({label:"helper_shot",data:void 0}),void helperBuffer.push({label:e,data:t});if("shot"===e){if(helperBuffer.length>0){var a=!0,o=!1,s=void 0;try{for(var l,c=helperBuffer[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){var u=l.value;if(u){var h=u.label,d=u.data;h&&writeTraceEntry(h,d,n,i,r)}}}catch(e){o=!0,s=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw s}}helperBuffer=[]}return void writeTraceEntry(e,t,n,i,r)}writeTraceEntry(e,t,n,i,r)}catch(e){}}function writeTraceEntry(e,t,n,i,r){try{var a=(null==n?void 0:n.__trajectoryTraceWrite)||(null==i?void 0:i.__trajectoryTraceWrite);if(a&&"function"==typeof a)return void a(e,t);var o=getSessionId(),s=Date.now(),l=n?getBrowserId():void 0,c=l?{label:e,data:t,sid:o,ts:s,bid:l}:{label:e,data:t,sid:o,ts:s};if(!0===r)return void console.log("[trace]",e,t);var u=safeStringify(c);if("json"===r)return void console.log(u);if("file"===r){if(n)return void postLog(u);if(i&&fs)return void writeToNodeFile(u)}}catch(e){}}"undefined"==typeof window&&initNodeModules();var __WEBPACK_DEFAULT_EXPORT__=trace},2518:(e,t,n)=>{n.d(t,{Q:()=>c});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(e){var n,i,a,s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t),s=void 0,(a="tablejson")in(i=n)?Object.defineProperty(i,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):i[a]=s,n.type=r.B.HIT,n.tablejson=e,n}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){return new t(e.tablejson)}}],(i=[{key:"applyToController",value:function(e){return e.handleHit(this)}}])&&a(n.prototype,i),c&&a(n,c),t}(i.F)},2522:(e,t,n)=>{n.d(t,{w:()=>d});var i=n(8279),r=n(7009),a=n(12),o=n(4922);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(h=function(){return!!e})()}var d=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),l(e=function(e,t,n){return t=c(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,h()?Reflect.construct(t,n||[],c(e).constructor):t.apply(e,n))}(this,t),"offset",new o.Pq0(0,0,0)),l(e,"angle",0),l(e,"power",0),l(e,"pos",new o.Pq0(0,0,0)),l(e,"i",0),l(e,"elevation",.17),e.type=r.B.AIM,e}var n,i,d;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(t,e),n=t,d=[{key:"fromJson",value:function(e){var n=new t;return n.pos=(0,a.t6)(e.pos),n.angle=e.angle,n.offset=(0,a.t6)(e.offset),n.power=e.power,void 0!==e.i&&(n.i=e.i),void 0!==e.elevation&&(n.elevation=e.elevation),n}}],(i=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return t.fromJson(this)}}])&&s(n.prototype,i),d&&s(n,d),t}(i.F)},2582:(e,t,n)=>{n.d(t,{M:()=>c});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e,n,i,a=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t),(i="foul")in(n=e)?Object.defineProperty(n,i,{value:0,enumerable:!0,configurable:!0,writable:!0}):n[i]=0,e.type=r.B.STARTAIM,e.foul=a,e}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){return new t(e.foul)}}],(i=[{key:"applyToController",value:function(e){return e.handleStartAim(this)}}])&&a(n.prototype,i),c&&a(n,c),t}(i.F)},2765:(e,t,n)=>{n.d(t,{J:()=>x});var i=n(4368),r=n(8938),a=n(5615),o=n(4110),s=n(1185),l=n(7236),c=n(8738),u=n(803);function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function f(e){return f=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},f(e)}function p(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function v(e,t){return v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},v(e,t)}function m(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(m=function(){return!!e})()}var y=function(e){function t(e,n,i){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),d(r=function(e,t,n){return t=f(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,m()?Reflect.construct(t,n||[],f(e).constructor):t.apply(e,n))}(this,t,[e]),"messageRelay",void 0),d(r,"tableId",void 0),d(r,"messages",[]),r.messageRelay=n,r.tableId=i,r.messageRelay.subscribe(r.tableId,(function(e){console.log(e);var t=u.d.fromSerialised(e);r.messages.push(t),(p(t,c.Qe)||p(t,c.wG))&&r.container.eventQueue.push(t)})),console.log("Spectate"),r}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(t,e),n=t,(i=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}])&&h(n.prototype,i),t}(a.y),g=n(9034);function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function k(e,t){return k=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},k(e,t)}function P(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(P=function(){return!!e})()}var x=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=this,i=arguments,n=w(n=t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,P()?Reflect.construct(n,i||[],w(e).constructor):n.apply(e,i));var e,n,i}var n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&k(e,t)}(t,e),n=t,(a=[{key:"handleBegin",value:function(e){return l.N.isSpectator()?new y(this.container,new g.p,l.N.getInstance().tableId):(this.container.chat.showMessage("Start"),this.container.sendEvent(new i.Q(this.container.table.serialise())),new o.x(this.container))}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),this.container.table.cueball&&(this.container.rules.cueball=this.container.table.cueball),"whiteScore"in e.json&&"yellowScore"in e.json&&"function"==typeof this.container.rules.setScores&&this.container.rules.setScores(e.json.whiteScore,e.json.yellowScore),new r.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new s.e(this.container,e.init,e.shots)):new o.x(this.container)}}])&&b(n.prototype,a),t}(a.y)},2899:(e,t,n)=>{n.d(t,{Bl:()=>l,gI:()=>c});var i=n(4922),r=n(12),a=n(8660),o=n(8090),s=n(5418);function l(e,t,n){var a=(0,r.Dz)(t.angle+Math.PI),o=new i.Pq0(a.x*Math.cos(n),a.y*Math.cos(n),Math.sin(n)).normalize(),s=function(e){return Math.max(-1,Math.min(1,e))},l=new i.Pq0(a.x,a.y,0),c=-Math.asin(s(t.offset.x));l.applyAxisAngle(new i.Pq0(0,0,1),c);var u=(0,r.KM)(a).normalize(),h=-Math.asin(s(t.offset.y));return l.applyAxisAngle(u,h),l.normalize(),{cueDir:o,hitPointWorld:e.pos.clone().addScaledVector(l,e.radius),elevation:n,power:t.power}}function c(e,t){var n=t.cueDir,i=t.hitPointWorld,r=t.elevation,l=t.power;e.state=a.U.Sliding;var c=n.clone();if(Math.abs(r)>.001){var u=Math.max(0,Math.min(1,s.D$));c.z*=u;var h=i.clone().sub(e.pos).normalize(),d=Math.min(1,Math.abs(r)/Math.max(1e-6,s.Xf)),f=1+s.wD*h.z*d;c.z*=f,c.lengthSq()>0&&c.normalize()}var p=c.multiplyScalar(-l);e.vel.copy(p);try{e.initialShotSpeed=Math.max(0,p.length())}catch(e){}e.rvel.copy((0,o.Gf)(i,e.pos,e.vel)),e.magnusEnabled=r>.2,e.magnusElevation=r}},3206:(e,t,n)=>{n.d(t,{u:()=>c});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t)).type=r.B.BEGIN,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,(i=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}])&&a(n.prototype,i),t}(i.F)},3413:(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{p:()=>r});var r=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i(this,"t",void 0),i(this,"key",void 0),this.t=t,this.key=n}},3467:(e,t,n)=>{n.d(t,{m:()=>ot});var i=n(5159),r=n(4922),a=n(12),o=n(4979),s=n(5418);function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*s.R),c(this,"baseHeight",8*s.R),c(this,"targetHeight",8*s.R),c(this,"aimDistance",18*s.R),c(this,"baseAimDistance",18*s.R),c(this,"targetAimDistance",18*s.R),c(this,"rotationOffset",0),c(this,"targetRotationOffset",0),c(this,"trackingLookAt",new r.Pq0(0,0,0)),c(this,"targetTrackingLookAt",new r.Pq0(0,0,0)),c(this,"backwardOffset",new r.Pq0(0,0,0)),c(this,"targetBackwardOffset",new r.Pq0(0,0,0)),c(this,"lookAtHeightFactor",.5),c(this,"targetLookAtHeightFactor",.5),c(this,"elapsed",void 0),this.camera=new r.ubm(45,t,s.R,1e3*s.R),this.trackingLookAt.set(0,0,0),this.targetTrackingLookAt.set(0,0,0)}var t,n;return t=e,n=[{key:"update",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.elapsed=e,n&&this.mode===this.aimView?this.aimView(t,.35):this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=o.v.fov,this.camera.position.lerp(o.v.viewPoint(this.camera.aspect,this.camera.fov),.9),this.camera.up=a.up,this.camera.lookAt(a.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08;this.height=r.cj9.lerp(this.height,this.targetHeight,.04);var n,i=this.height,o=this.camera.aspect<.8;if(this.camera.fov=o?60:40,i<10*s.R){var l=100*(10*s.R-i);this.camera.fov-=l*(o?3:1)}if(this.aimDistance=r.cj9.lerp(this.aimDistance,this.targetAimDistance,.08),this.rotationOffset=r.cj9.lerp(this.rotationOffset,this.targetRotationOffset,.08),this.trackingLookAt.set(r.cj9.lerp(this.trackingLookAt.x,this.targetTrackingLookAt.x,.08),r.cj9.lerp(this.trackingLookAt.y,this.targetTrackingLookAt.y,.16),r.cj9.lerp(this.trackingLookAt.z,this.targetTrackingLookAt.z,.08)),this.backwardOffset.lerp(this.targetBackwardOffset,.04),this.lookAtHeightFactor=r.cj9.lerp(this.lookAtHeightFactor,this.targetLookAtHeightFactor,.12),this.backwardOffset.length()>.1)n=e.pos.clone().addScaledVector((0,a.Dz)(e.angle),-this.aimDistance).add(this.backwardOffset);else{var c=e.angle+this.rotationOffset;n=e.pos.clone().addScaledVector((0,a.Dz)(c),-this.aimDistance).add(this.backwardOffset)}this.camera.position.lerp(n,t),this.camera.position.z=i,this.camera.up=a.up;var u=this.trackingLookAt.clone().addScaledVector(a.up,i*this.lookAtHeightFactor);this.camera.lookAt(u)}},{key:"adjustHeight",value:function(e){e=this.height<10*s.R?e/8:e,this.height=r.cj9.clamp(this.height+e,6*s.R,120*s.R),this.height>110*s.R&&this.suggestMode(this.topView),this.height<105*s.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}},{key:"adjustAimDistance",value:function(e){var t=Math.max(this.baseAimDistance,e);this.targetAimDistance=t}},{key:"resetAimDistance",value:function(){this.targetAimDistance=this.baseAimDistance}},{key:"getCurrentAimDistance",value:function(){return this.aimDistance}},{key:"getBaseAimDistance",value:function(){return this.baseAimDistance}},{key:"adjustRotation",value:function(e,t){this.targetRotationOffset=e,this.targetTrackingLookAt.copy(t)}},{key:"resetRotation",value:function(e){this.targetRotationOffset=0,this.targetTrackingLookAt.copy(e)}},{key:"getCurrentRotationOffset",value:function(){return this.rotationOffset}},{key:"adjustTrackingCamera",value:function(e,t,n){this.adjustAimDistance(e),this.adjustRotation(t,n)}},{key:"resetDynamicAdjustments",value:function(e){this.resetAimDistance(),this.resetRotation(e),this.resetHeight(),this.resetBackwardOffset(),this.resetLookAtHeightFactor()}},{key:"raiseHeightForTracking",value:function(e){var t=20*e;this.targetHeight=this.height+t}},{key:"resetHeight",value:function(){this.targetHeight=this.baseHeight}},{key:"moveBackwardToTableEdge",value:function(e,t,n,i){var a=t-e.x,o=t+e.x,s=n-e.y,l=n+e.y,c=Math.min(a,o,s,l),u=new r.Pq0(0,0,0);c===a?u.set(1,0,0):c===o?u.set(-1,0,0):c===s?u.set(0,1,0):u.set(0,-1,0);var h=c+17*i;this.targetBackwardOffset.copy(u.multiplyScalar(h))}},{key:"resetBackwardOffset",value:function(){this.targetBackwardOffset.set(0,0,0)}},{key:"setLookAtHeightFactor",value:function(e){var t=r.cj9.clamp(e,.2,.6);this.targetLookAtHeightFactor=t}},{key:"resetLookAtHeightFactor",value:function(){this.targetLookAtHeightFactor=.5}}],n&&l(t.prototype,n),e}(),h=n(665);function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var f=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"createMarkings",value:function(){return h.P.hasPockets?this.createPoolGrid():this.createCaromDiamonds()}},{key:"createPoolGrid",value:function(){return new r.YJl}},{key:"createCaromDiamonds",value:function(){for(var e=new r.YJl,t=h.P.X,n=h.P.Y,i=2*s.R,a=1.25*s.R,o=2.4*s.R,l=.15*s.R,c=a,u=-s.R+c,d=n+i+l+o/2,f=t+i+l+o/2,p=new r.tXL({color:15921906,emissive:1710618,emissiveIntensity:.18,shininess:4}),v=new r.tcD(s.R/4,16),m=u+.001,y=function(t,n){var i=new r.eaF(v,p);i.position.set(t,n,m),e.add(i)},g=d,b=-4;b<=4;b++){var w=b/4,k=Math.abs(b)/4*.009,P=t*w-Math.sign(b)*k;y(P,g),y(P,-g)}for(var x=f,S=-2;S<=2;S++){var M=S/2,T=Math.abs(S)/2*.001,E=n*M-Math.sign(S)*T;y(x,E),y(-x,E)}for(var C=new r.V9B({color:16777215,transparent:!0,opacity:.051}),R=-s.R,A=-4;A<=4;A++){var I=t*(A/4),O=new r.iNn(.004,2*n,.001),B=new r.eaF(O,C);B.position.set(I,0,R),e.add(B)}for(var _=-2;_<=2;_++){var L=n*(_/2),j=new r.iNn(2*t,.004,.001),N=new r.eaF(j,C);N.position.set(0,L,R),e.add(N)}return e}}],null&&d(t.prototype,null),n&&d(t,n),e}(),p=n(9437),v=n(4017);function m(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){y(e,t,n[t])}))}return e}var b=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),y(this,"scene",new r.Z58),y(this,"renderer",void 0),y(this,"camera",void 0),y(this,"windowWidth",1),y(this,"windowHeight",1),y(this,"element",void 0),y(this,"table",void 0),y(this,"loadAssets",!0),y(this,"assets",void 0),y(this,"spotLight",null),y(this,"lightTarget",new r.Pq0(0,0,0)),y(this,"currentLighting",g({},v.h)),y(this,"orbitGuide",null),y(this,"orbitGuideSegments",96),y(this,"debugModeActive",!1),y(this,"lightConfigSubscription",void 0),y(this,"ballToCheck",0),this.element=t,this.table=n,this.assets=i,this.renderer=function(e){if("undefined"==typeof process){var t=new p.JeP({antialias:!0});t.shadowMap.enabled=!0,t.shadowMap.type=r.RyA,t.shadowMap.autoUpdate=!0,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight);var n=Math.min(window.devicePixelRatio,2);return t.setPixelRatio(n),t.outputColorSpace=r.er$,e.appendChild(t.domElement),t}}(t),this.camera=new u(t?t.offsetWidth/t.offsetHeight:1),this.initialiseScene()}var t,n;return t=e,n=[{key:"update",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.camera.update(e,t,n)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null===(e=this.element)||void 0===e?void 0:e.offsetWidth)||this.windowHeight!=(null===(t=this.element)||void 0===t?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null===(e=this.element)||void 0===e?void 0:e.offsetWidth,this.windowHeight=null===(t=this.element)||void 0===t?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t;if(this.updateSize()){var n,i,r,a,o=this.windowWidth,s=this.windowHeight;null===(n=this.renderer)||void 0===n||n.setSize(o,s),null===(i=this.renderer)||void 0===i||i.setViewport(0,0,o,s),null===(r=this.renderer)||void 0===r||r.setScissor(0,0,o,s),null===(a=this.renderer)||void 0===a||a.setScissorTest(!0),e.camera.aspect=o/s}e.camera.updateProjectionMatrix(),this.updateOrbitGuideVisibility(),null===(t=this.renderer)||void 0===t||t.render(this.scene,e.camera)}},{key:"setDebugMode",value:function(e){this.debugModeActive=e,this.updateOrbitGuideVisibility()}},{key:"initialiseScene",value:function(){var e,t=new r.Q1f(855828);this.scene.background=t,null===(e=this.renderer)||void 0===e||e.setClearColor(t,1),this.setupLighting(),this.assets.background&&(this.assets.background.visible=!1),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.configureTableShadows(),this.updateLightTargetFromTable(),this.updateOrbitGuideGeometry(this.currentLighting),this.scene.add(f.createMarkings())}},{key:"setupLighting",value:function(){this.currentLighting=v.J.getLightingConfig();var e=new r.nCl(16777215,this.currentLighting.intensity,0,r.cj9.degToRad(this.currentLighting.coneDeg),.8,.6);e.castShadow=this.currentLighting.castShadow,this.spotLight=e,this.scene.add(e),this.scene.add(e.target),this.createOrbitGuide(),this.registerLightingBindings()}},{key:"registerLightingBindings",value:function(){var e,t=this;null===(e=this.lightConfigSubscription)||void 0===e||e.call(this),this.lightConfigSubscription=v.J.onLightingConfigChanged((function(e){t.applyLightingConfig(e)}))}},{key:"createOrbitGuide",value:function(){if(!this.orbitGuide){var e=new r.LoY,t=new Float32Array(3*this.orbitGuideSegments);e.setAttribute("position",new r.qtW(t,3));var n=new r.mrM({color:16777215,transparent:!0,opacity:.4});n.depthTest=!1,n.depthWrite=!1;var i=new r.FCc(e,n);i.frustumCulled=!1,i.visible=!1,i.renderOrder=-1,this.orbitGuide=i,this.scene.add(i),this.updateOrbitGuideVisibility()}}},{key:"updateOrbitGuideGeometry",value:function(e){if(this.orbitGuide){var t=this.orbitGuide.geometry,n=t.getAttribute("position");if(!n||n.count!==this.orbitGuideSegments){var i=new Float32Array(3*this.orbitGuideSegments);t.setAttribute("position",new r.qtW(i,3)),n=t.getAttribute("position")}for(var a=n,o=2*s.R,l=Math.max(.01,e.distanceInDiameters*o),c=r.cj9.degToRad(e.elevationDeg),u=Math.max(.01,Math.cos(c)*l),h=Math.sin(c)*l+this.lightTarget.z,d=0;d<this.orbitGuideSegments;d++){var f=d/this.orbitGuideSegments*Math.PI*2,p=Math.cos(f)*u+this.lightTarget.x,v=Math.sin(f)*u+this.lightTarget.y;a.setXYZ(d,p,v,h)}a.needsUpdate=!0,t.computeBoundingSphere()}}},{key:"applyLightingConfig",value:function(e){var t;if(this.spotLight){this.currentLighting=g({},e);var n=this.spotLight;n.intensity=e.intensity,n.decay=e.decay,n.distance=e.decay>0?250:0,n.angle=r.cj9.degToRad(e.coneDeg),n.color.set(e.color),n.color.convertSRGBToLinear(),n.castShadow=e.castShadow;var i=r.cj9.clamp(e.shadowBlur/1e3,0,1);n.shadow.radius=r.cj9.lerp(0,80,i),n.penumbra=r.cj9.clamp(i,0,1),n.shadow.mapSize.width===e.shadowMapSize&&n.shadow.mapSize.height===e.shadowMapSize||(n.shadow.mapSize.set(e.shadowMapSize,e.shadowMapSize),n.shadow.map=null),"blurSamples"in n.shadow&&(n.shadow.blurSamples=e.shadowBlurSamples),n.shadow.bias=e.shadowBias,n.shadow.normalBias=e.shadowNormalBias;var a=n.shadow.camera;a.near=e.shadowNear,a.far=e.shadowFar,a.updateProjectionMatrix(),this.updateSpotLightPosition(e),this.updateOrbitGuideGeometry(e),n.shadow.needsUpdate=!0,(null===(t=this.renderer)||void 0===t?void 0:t.shadowMap)&&(this.renderer.shadowMap.needsUpdate=!0)}}},{key:"updateSpotLightPosition",value:function(e){if(this.spotLight){var t=r.cj9.degToRad(e.orbitAngleDeg),n=r.cj9.degToRad(e.elevationDeg),i=2*s.R,a=Math.max(.01,e.distanceInDiameters*i),o=Math.cos(n)*a,l=this.lightTarget.x+Math.cos(t)*o,c=this.lightTarget.y+Math.sin(t)*o,u=this.lightTarget.z+Math.sin(n)*a;u=Math.max(this.lightTarget.z+.6*s.R,u),this.spotLight.position.set(l,c,u),this.spotLight.target.position.copy(this.lightTarget),this.spotLight.target.updateMatrixWorld()}}},{key:"updateOrbitGuideVisibility",value:function(){this.orbitGuide&&(this.orbitGuide.visible=this.debugModeActive)}},{key:"updateLightTargetFromTable",value:function(){this.spotLight&&this.assets.table&&((new r.NRn).setFromObject(this.assets.table).getCenter(this.lightTarget),this.spotLight.target.position.copy(this.lightTarget),this.spotLight.target.updateMatrixWorld(),this.updateSpotLightPosition(this.currentLighting),this.updateOrbitGuideGeometry(this.currentLighting))}},{key:"configureTableShadows",value:function(){var e=this.assets.table;e&&"function"==typeof e.traverse&&e.traverse((function(e){var t=e;t.isMesh&&(t.castShadow=!0,t.receiveShadow=!0)}))}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustrum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustrum",value:function(){var e=this.camera.camera,t=new r.PPD;return t.setFromProjectionMatrix((new r.kn4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}},{key:"worldToScreen",value:function(e){var t=e.clone();return t.project(this.camera.camera),{x:t.x,y:t.y}}},{key:"distanceToScreenEdge",value:function(e){var t=1-Math.abs(e.x),n=1-Math.abs(e.y);return Math.min(t,n)}},{key:"getScreenDirection",value:function(e){var t=Math.sqrt(e.x*e.x+e.y*e.y);return t<1e-6?{x:0,y:0}:{x:e.x/t,y:e.y/t}}}],n&&m(t.prototype,n),e}(),w=n(2765),k=n(3413);function P(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),x(this,"line",new r.cZY),x(this,"balls",void 0),this.balls=t}var t,n;return t=e,(n=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,a.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var i=new r.Pq0,o=this.balls.map((function(t){return n.line.closestPointToPoint(t.pos,!0,i),{ball:t,perpendicular:i.distanceTo(t.pos),distance:i.distanceTo(e.pos)}})).filter((function(e){return e.perpendicular<2*e.ball.radius})).filter((function(t){return t.ball!==e}));return o.reduce((function(e,t){return e.distance<t.distance?e:t}),o[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var i=n.ball.pos.clone().sub(e.pos),r=n.perpendicular*Math.sign(i.cross(t).z)/n.ball.radius;return{ball:n.ball,overlap:r}}}}])&&P(t.prototype,n),e}();function M(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function T(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function C(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(i=n.next()).done)&&(a.push(i.value),!t||a.length!==t);o=!0);}catch(e){s=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw r}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return M(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?M(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var R=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),E(this,"cueBallElement",void 0),E(this,"cueBallCanvas",void 0),E(this,"ctx",void 0),E(this,"cueElevationElement",void 0),E(this,"cuePowerElement",void 0),E(this,"cueHitElement",void 0),E(this,"container",void 0),E(this,"overlap",void 0),E(this,"radius",0),E(this,"cx",0),E(this,"cy",0),E(this,"pitch",Math.PI/2),E(this,"hitPoint",[0,0,1]),E(this,"targetPoint",[0,0,1]),E(this,"hitPointRatio",.021),E(this,"targetPointRatio",.003),E(this,"greyRatio",.75),E(this,"blendWidth",2*this.hitPointRatio*1.2),E(this,"lightDir",[.6,-.7,.4]),E(this,"lightNorm",void 0),E(this,"ambientLight",.35),E(this,"diffuseLight",.65),E(this,"inputsEnabled",!0),E(this,"npcAllowedOverlayVisible",!1),E(this,"isDragging",!1),E(this,"onMouseDown",(function(e){n.inputsEnabled&&(n.isDragging=!0,n.updateHitPoint(e))})),E(this,"onMouseUp",(function(){n.inputsEnabled&&(n.isDragging=!1)})),E(this,"onMouseLeave",(function(){n.inputsEnabled&&(n.isDragging=!1)})),E(this,"onMouseMove",(function(e){n.inputsEnabled&&n.isDragging&&n.updateHitPoint(e)})),E(this,"onClick",(function(e){n.inputsEnabled&&n.updateHitPoint(e)})),E(this,"elevationChanged",(function(e){var t;if(n.inputsEnabled){var i=e.target,r=parseFloat(i.value)*Math.PI/180;n.container.table.cue.elevation=r,n.container.table.cue.aim.elevation=r,n.pitch=Math.PI/2-r,n.hitPoint=n.pushToWhiteArea(n.hitPoint),n.syncHitPointToCue(),null===(t=n.container.precisionPanel)||void 0===t||t.syncFromOriginal(),n.drawSphere(),n.container.lastEventTime=performance.now(),n.container.updateTrajectoryPrediction()}})),E(this,"powerChanged",(function(e){var t;n.inputsEnabled&&(n.container.table.cue.setPower(n.cuePowerElement.value),null===(t=n.container.precisionPanel)||void 0===t||t.syncFromOriginal(),n.container.lastEventTime=performance.now(),n.container.updateTrajectoryPrediction())})),E(this,"hit",(function(e){var t;n.container.table.cue.setPower(null===(t=n.cuePowerElement)||void 0===t?void 0:t.value),n.container.inputQueue.push(new k.p(0,"SpaceUp"))})),E(this,"mousewheel",(function(e){n.inputsEnabled&&n.cuePowerElement&&(n.cuePowerElement.value-=Math.sign(e.deltaY)/10,n.container.table.cue.setPower(n.cuePowerElement.value),n.container.lastEventTime=performance.now(),n.container.updateTrajectoryPrediction())})),this.container=t,this.cueBallElement=document.getElementById("cueBall"),this.cueBallCanvas=document.getElementById("cueBallCanvas"),this.ctx=this.cueBallCanvas.getContext("2d",{alpha:!1}),this.cueElevationElement=document.getElementById("cueElevation"),this.cuePowerElement=document.getElementById("cuePower"),this.cueHitElement=document.getElementById("cueHit"),this.overlap=new S(this.container.table.balls);var i=Math.sqrt(Math.pow(this.lightDir[0],2)+Math.pow(this.lightDir[1],2)+Math.pow(this.lightDir[2],2));this.lightNorm=[this.lightDir[0]/i,this.lightDir[1]/i,this.lightDir[2]/i],this.initializeCanvas(),this.addListeners(),this.initializePower()}var t,n;return t=e,(n=[{key:"disableInputs",value:function(){this.inputsEnabled=!1,this.isDragging=!1}},{key:"enableInputs",value:function(){this.inputsEnabled=!0}},{key:"initializeCanvas",value:function(){var e=this.cueBallElement.getBoundingClientRect(),t=Math.min(e.width,e.height);this.cueBallCanvas.width=t,this.cueBallCanvas.height=t,this.cx=t/2,this.cy=t/2,this.radius=Math.floor(.51*t);var n=180*this.container.table.cue.elevation/Math.PI;this.cueElevationElement.value=n.toString(),this.pitch=Math.PI/2-this.container.table.cue.elevation,this.container.table.cue.aim.elevation=this.container.table.cue.elevation,this.drawSphere()}},{key:"addListeners",value:function(){var e,t,n,i,r,a,o,s,l;null===(e=this.cueBallCanvas)||void 0===e||e.addEventListener("mousedown",this.onMouseDown),null===(t=this.cueBallCanvas)||void 0===t||t.addEventListener("mouseup",this.onMouseUp),null===(n=this.cueBallCanvas)||void 0===n||n.addEventListener("mouseleave",this.onMouseLeave),null===(i=this.cueBallCanvas)||void 0===i||i.addEventListener("mousemove",this.onMouseMove),null===(r=this.cueBallCanvas)||void 0===r||r.addEventListener("click",this.onClick),null===(a=this.cueElevationElement)||void 0===a||a.addEventListener("input",this.elevationChanged),null===(o=this.cueHitElement)||void 0===o||o.addEventListener("click",this.hit),null===(s=this.cuePowerElement)||void 0===s||s.addEventListener("input",this.powerChanged),"ontouchstart"in window||null===(l=document.getElementById("viewP1"))||void 0===l||l.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"updateHitPoint",value:function(e){var t=this.cueBallCanvas.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,a=n-this.cx,o=i-this.cy,s=this.radius*this.radius;if(a*a+o*o<=s){var l=Math.sqrt(Math.max(0,s-a*a-o*o)),c=a/this.radius,u=o/this.radius,h=[c,u,l/this.radius];if(this.isInWhiteArea(h)){var d;this.hitPoint=h;var f=-c,p=-u;this.container.table.cue.setSpin(new r.Pq0(f,p,0),this.container.table),null===(d=this.container.precisionPanel)||void 0===d||d.syncFromOriginal(),this.drawSphere(),this.container.lastEventTime=performance.now(),this.container.updateTrajectoryPrediction()}}}},{key:"syncHitPointToCue",value:function(){var e=-this.hitPoint[0],t=-this.hitPoint[1];this.container.table.cue.setSpin(new r.Pq0(e,t,0),this.container.table)}},{key:"rotateX",value:function(e,t){var n=Math.sin(t),i=Math.cos(t);return[e[0],i*e[1]-n*e[2],n*e[1]+i*e[2]]}},{key:"smoothstep",value:function(e,t,n){var i=(n-e)/(t-e);return(i=Math.max(0,Math.min(1,i)))*i*(3-2*i)}},{key:"isInWhiteArea",value:function(e){var t=C(this.rotateX(e,this.pitch),3),n=(t[0],t[1]);return t[2],.5*(n+1)<1-this.greyRatio}},{key:"pushToWhiteArea",value:function(e){var t=C(this.rotateX(e,this.pitch),3),n=t[0],i=t[1],r=t[2],a=.5*(i+1),o=1-this.greyRatio;if(a>=o){var s=2*(o-.02)-1,l=Math.sin(this.pitch),c=Math.cos(this.pitch),u=c*s+l*r,h=-l*s+c*r,d=Math.sqrt(n*n+u*u+h*h);return[n/d,u/d,h/d]}return e}},{key:"applyLighting",value:function(e,t){var n=Math.max(0,t[0]*this.lightNorm[0]+t[1]*this.lightNorm[1]+t[2]*this.lightNorm[2]),i=this.ambientLight+this.diffuseLight*n;return[Math.min(255,e[0]*i),Math.min(255,e[1]*i),Math.min(255,e[2]*i)]}},{key:"drawSphere",value:function(){if(this.ctx){var e=this.cueBallCanvas.width,t=this.cueBallCanvas.height,n=this.ctx.createLinearGradient(0,0,0,t);n.addColorStop(0,"rgb(0, 64, 94)"),n.addColorStop(1,"#000214"),this.ctx.fillStyle=n,this.ctx.fillRect(0,0,e,t);var i=this.ctx.createImageData(e,t),r=i.data,a=this.radius*this.radius,o=!0===this.npcAllowedOverlayVisible,s=0,l=0,c=0,u=0;if(o){var h,d=null===(h=this.container)||void 0===h?void 0:h.npcConfig;d&&!0===d.enabled?(s=Math.max(0,Math.min(1,Number(d.minSpin)||0)),l=Math.max(0,Math.min(1,Number(d.maxSpin)||0)),c=0,u=Math.cos(this.pitch)):o=!1}for(var f=[0,64,94],p=0;p<r.length;p+=4)r[p]=f[0],r[p+1]=f[1],r[p+2]=f[2],r[p+3]=255;for(var v=-this.radius;v<=this.radius;v++){var m=v,y=this.cy+m|0;if(!(y<0||y>=t))for(var g=Math.floor(Math.sqrt(Math.max(0,a-m*m))),b=-g;b<=g;b++){var w=b,k=this.cx+w|0,P=Math.sqrt(Math.max(0,a-w*w-m*m)),x=w/this.radius,S=m/this.radius,M=P/this.radius,T=C(this.rotateX([x,S,M],this.pitch),3),E=(T[0],T[1]),R=(T[2],x*this.hitPoint[0]+S*this.hitPoint[1]+M*this.hitPoint[2]),A=1-2*this.hitPointRatio,I=x*this.targetPoint[0]+S*this.targetPoint[1]+M*this.targetPoint[2],O=1-2*this.targetPointRatio,B=void 0,_=void 0,L=void 0;if(R>=A){var j=[0,64,94],N=(R-A)/(1-A),F=this.smoothstep(0,.3,N),D=.5*(E+1),H=1-this.greyRatio,z=[217,217,217],G=[144,144,144],q=this.smoothstep(H-this.blendWidth,H,D);B=(z[0]*(1-q)+G[0]*q)*(1-F)+j[0]*F,_=(z[1]*(1-q)+G[1]*q)*(1-F)+j[1]*F,L=(z[2]*(1-q)+G[2]*q)*(1-F)+j[2]*F}else{var U=.5*(E+1),V=1-this.greyRatio,K=[217,217,217],W=[144,144,144],X=this.smoothstep(V-this.blendWidth,V,U);B=K[0]*(1-X)+W[0]*X,_=K[1]*(1-X)+W[1]*X,L=K[2]*(1-X)+W[2]*X}if(I>=O){var Y=[255,0,0],J=(I-O)/(1-O),Q=.3*this.smoothstep(0,.3,J);B=B*(1-Q)+Y[0]*Q,_=_*(1-Q)+Y[1]*Q,L=L*(1-Q)+Y[2]*Q}if(o&&this.isInWhiteArea([x,S,M])){var Z=-x-c,$=-S-u,ee=Math.hypot(Z,$);if(ee>=s&&ee<=l){var te=.42;B=B*(1-te)+107.1,_=_*(1-te)+13.44,L=L*(1-te)+13.44}}var ne=this.applyLighting([B,_,L],[x,S,M]);B=ne[0],_=ne[1],L=ne[2];var ie=4*(y*e+k);r[ie]=0|B,r[ie+1]=0|_,r[ie+2]=0|L,r[ie+3]=255}}if(this.ctx.putImageData(i,0,0),o)try{var re,ae,oe=String((null===(ae=this.container)||void 0===ae||null===(re=ae.npcConfig)||void 0===re?void 0:re.searchDensity)||"medium"),se="low"===oe?24:"high"===oe?96:48,le=this.buildNpcSpinSamples(this.container.table.cue.elevation,s,l,se),ce=Math.max(1,Math.floor(this.radius*(.5*this.hitPointRatio)));this.ctx.save(),this.ctx.strokeStyle="rgba(0,255,0,0.9)",this.ctx.lineWidth=Math.max(1,Math.floor(.25*ce));var ue=!0,he=!1,de=void 0;try{for(var fe,pe=le[Symbol.iterator]();!(ue=(fe=pe.next()).done);ue=!0){var ve=fe.value,me=-ve.x,ye=-ve.y,ge=me*me+ye*ye;if(!(ge>1||Math.sqrt(Math.max(0,1-ge))<1e-6)){var be=this.cx+me*this.radius,we=this.cy+ye*this.radius;this.ctx.beginPath(),this.ctx.arc(be,we,ce,0,2*Math.PI),this.ctx.stroke()}}}catch(e){he=!0,de=e}finally{try{ue||null==pe.return||pe.return()}finally{if(he)throw de}}this.ctx.restore()}catch(e){}this.updateTargetPoint()}}},{key:"buildNpcSpinSamples",value:function(e,t,n,i){for(var r,a=function(){var e=(f+.5)/u,t=Math.sqrt((1-e)*l*l+e*c*c),n=s*f,i=-t*Math.cos(n),a=-(d+t*Math.sin(n)),p=i*i+a*a;if(p>=1){var v=Math.sqrt(p)||1;i=i/v*.999,a=a/v*.999}var m=Math.sqrt(Math.max(0,1-i*i-a*a));if(.5*(r.rotateX([i,a,m],o)[1]+1)<1-r.greyRatio){var y={x:-i,y:-a};h.some((function(e){return Math.abs(e.x-y.x)<.001&&Math.abs(e.y-y.y)<.001}))||h.push(y)}f++},o=Math.PI/2-e,s=Math.PI*(3-Math.sqrt(5)),l=Math.max(0,Math.min(1,t)),c=Math.max(l,Math.min(1,n)),u=Math.max(1,Math.floor(i)),h=[],d=Math.cos(o),f=0,p=40*u;h.length<u&&f<p;)r=this,a();for(var v=.02;h.length<u&&v<.15;){for(var m,y=function(e){var t=f+e,n=(t+.5)/u,i=Math.sqrt((1-n)*g*g+n*b*b),r=s*t,a=-i*Math.cos(r),l=-(d+i*Math.sin(r)),c=a*a+l*l;if(c>=1){var p=Math.sqrt(c)||1;a=a/p*.999,l=l/p*.999}var v=Math.sqrt(Math.max(0,1-a*a-l*l));if(.5*(m.rotateX([a,l,v],o)[1]+1)<1-m.greyRatio){var y={x:-a,y:-l};h.some((function(e){return Math.abs(e.x-y.x)<.001&&Math.abs(e.y-y.y)<.001}))||h.push(y)}},g=Math.max(0,l-v),b=Math.min(1,c+v),w=u-h.length,k=0;k<w;k++)m=this,y(k);f+=w,v+=.02}return h}},{key:"setNpcAllowedSpinOverlayVisible",value:function(e){this.npcAllowedOverlayVisible=!!e;try{this.drawSphere()}catch(e){}}},{key:"updateTargetPoint",value:function(){var e,t=this.container.table,n=(0,a.Dz)(t.cue.aim.angle),i=this.overlap.getOverlapOffset(t.cueball,n);this.targetPoint=i?[0,0,1]:[0,0,-1],null===(e=this.container.precisionPanel)||void 0===e||e.updateTargetPoint(this.targetPoint)}},{key:"updateVisualState",value:function(e,t){var n=-e,i=-t,r=n*n+i*i;if(r<=1){var a=Math.sqrt(1-r);this.hitPoint=[n,i,a]}this.drawSphere()}},{key:"showOverlap",value:function(){this.drawSphere()}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null===(t=this.cuePowerElement)||void 0===t?void 0:t.value)&&(this.cuePowerElement.value=e)}},{key:"updateElevationSlider",value:function(e){if(this.cueElevationElement){var t=180*e/Math.PI;this.cueElevationElement.value=t.toString(),this.pitch=Math.PI/2-e,this.hitPoint=this.pushToWhiteArea(this.hitPoint),this.drawSphere()}}},{key:"initializePower",value:function(){if(this.cuePowerElement){var e=parseFloat(this.cuePowerElement.value),t=Number.isFinite(e)?e:0;t<.01&&(t=.5,this.cuePowerElement.value=t.toString()),this.container.table.cue.setPower(t)}}}])&&T(t.prototype,n),e}(),A=n(4853),I=n(8938),O=n(6940),B=n(1279),_=n(1185),L=n(4005),j=n(4110);function N(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function F(e){return N(e,w.J)?"Init":N(e,j.x)?"PlaceBall":N(e,A.m)?"Aim":N(e,I.r)?"WatchAim":N(e,O.H)?"PlayShot":N(e,B.O)?"WatchShot":N(e,_.e)?"Replay":N(e,L.o)?"End":"UNKNOWN"}function D(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function H(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var z=function(){function e(t){var n,i=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),H(this,"chatoutput",void 0),H(this,"chatInput",void 0),H(this,"chatSend",void 0),H(this,"chatInputText",void 0),H(this,"send",void 0),H(this,"container",void 0),H(this,"sendClicked",(function(e){var t,n;i.send(null===(t=i.chatInputText)||void 0===t?void 0:t.value),i.showMessage(null===(n=i.chatInputText)||void 0===n?void 0:n.value)})),this.chatoutput=document.getElementById("chatoutput"),this.chatInputText=document.getElementById("chatinputtext"),this.chatSend=document.getElementById("chatsend"),null===(n=this.chatSend)||void 0===n||n.addEventListener("click",this.sendClicked),this.send=t,this.container=r}var t,n;return t=e,(n=[{key:"showMessage",value:function(e){var t,n;if("threecushion"===(null===(n=this.container)||void 0===n||null===(t=n.rules)||void 0===t?void 0:t.rulename)){var i=this.getScoreButtonTarget(e);i?this.shouldFilterScoreButton(e)?this.chatoutput&&(this.chatoutput.innerHTML+=e):this.addToScoreHighlight(i,e):this.chatoutput&&(this.chatoutput.innerHTML+=e)}else this.chatoutput&&(this.chatoutput.innerHTML+=e);this.updateScroll()}},{key:"shouldFilterScoreButton",value:function(e){return!1}},{key:"getScoreButtonTarget",value:function(e){if(e.includes("break(")||e.includes("hi score")||e.includes("⏹️")||e.includes("🏆")){var t=e.match(/style="color:\s*(#[0-9a-fA-F]{6})/);if(t)return this.getTargetFromColor(t[1]);if(e.includes("break(")||e.includes("⏹️"))return"scoreHighlightLeft";if(e.includes("hi score")||e.includes("🏆"))return"scoreHighlightRight"}var n=e.match(/style="color:\s*(#[0-9a-fA-F]{6})/);return n?this.getTargetFromColor(n[1],e):null}},{key:"getTargetFromColor",value:function(e,t){var n,i=e.toLowerCase(),r=parseInt(i.substr(1,2),16),a=parseInt(i.substr(3,2),16),o=parseInt(i.substr(5,2),16),s=!!t&&(t.includes("⚈")||/>\d+</.test(t));return t&&(t.includes("break(")||t.includes("hi score")||t.includes("⏹️")||t.includes("🏆")),n=r>=240&&a>=240&&o>=240?"scoreHighlightRight":r>=200&&a>=180&&o<=100||(r+a)/2-o>Math.min(r,a,o)?"scoreHighlightLeft":"scoreHighlightRight",s?"scoreHighlightLeft"===n?"scoreHighlightRight":"scoreHighlightLeft":n}},{key:"addToScoreHighlight",value:function(e,t){var n=document.getElementById(e);if(n){n.querySelector(".score-buttons-container")||(n.innerHTML='<div class="score-buttons-container"></div>');var i=n.querySelector(".score-buttons-container");if(i){var r=document.createElement("div");r.innerHTML=t,i.appendChild(r),this.applyScoreButtonFontToPills(e)}}}},{key:"applyScoreButtonFontToPills",value:function(e){var t="scoreHighlightLeft"===e?"customBtnLeft":"customBtnRight",n=document.getElementById(t),i=document.getElementById(e);if(n&&i){var r=window.getComputedStyle(n);i.querySelectorAll(".score-buttons-container a.pill").forEach((function(e){e.style.fontSize=r.fontSize,e.style.fontFamily=r.fontFamily,e.style.fontWeight="bold",e.style.lineHeight=r.lineHeight}))}}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}},{key:"clearScoreButtons",value:function(e){if(e){var t=document.getElementById(e),n=null==t?void 0:t.querySelector(".score-buttons-container");n&&(n.innerHTML="")}else this.clearScoreButtons("scoreHighlightLeft"),this.clearScoreButtons("scoreHighlightRight")}}])&&D(t.prototype,n),e}(),G=n(9915),q=n(7009);function U(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function V(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var K=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),V(this,"period",void 0),V(this,"pending",null),V(this,"sentTime",0),V(this,"apply",(function(e){})),this.period=t,this.apply=n}var t,n;return t=e,(n=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(e){if(performance.now()>this.sentTime+this.period||e.type!==q.B.AIM)return this.flush(),this.apply(e),void(this.sentTime=performance.now());this.pending=e}}])&&U(t.prototype,n),e}(),W=n(8207),X=n(2072),Y=n(3645),J=n(8192),Q=n(9419);function Z(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function $(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var ee=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),$(this,"container",void 0),$(this,"shots",[]),$(this,"states",[]),$(this,"start",Date.now()),$(this,"breakStart",void 0),$(this,"breakStartTime",void 0),$(this,"replayUrl",void 0),$(this,"hiScoreUrl","https://scoreboard-osmane-billiards.vercel.app/hiscore.html"),this.container=t}var t,n;return t=e,n=[{key:"record",value:function(e){e.type===q.B.WATCHAIM&&"rerack"in e.json&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(Q.x.fromJson({balls:e.json.balls}))),e.type===q.B.HIT&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(e.tablejson.aim))}},{key:"wholeGame",value:function(){return this.state(this.states[0],this.shots,this.start,this.container.rules.score,!0)}},{key:"last",value:function(){var e=this.states.length-1;return e>0&&"RERACK"===this.shots[e].type&&e--,e}},{key:"lastShot",value:function(){var e=this.last();return this.state(this.states[e],[this.shots[e]])}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart)return this.state(this.states[this.breakStart],this.shots.slice(this.breakStart),this.breakStartTime,this.container.rules.previousBreak)}},{key:"state",value:function(e,t){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return{init:e,shots:t,start:arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,now:Date.now(),score:n,wholeGame:i,v:1}}},{key:"updateBreak",value:function(e){var t=this.container.rules.isPartOfBreak(e),n=this.container.rules.isEndOfGame(e),i=Y.P.potCount(e);t||this.breakLink(n),this.lastShotLink(t||n,i,Y.P.pots(e)),n&&this.breakLink(n),t?void 0===this.breakStart&&(this.breakStart=this.last(),this.breakStartTime=Date.now()):this.breakStart=void 0}},{key:"lastShotLink",value:function(e,t,n){var i,r="#000000";if(n.length>0)r="#"+n[n.length-1].ballmesh.color.getHexString();else if("threecushion"===this.container.rules.rulename){var a=this.container.rules.cueball;a&&(r="#"+a.ballmesh.color.getHexString())}i=e&&t>0?t.toString():e?this.container.rules.currentBreak.toString():"⚆";var o=JSON.stringify(this.lastShot());this.generateLink(i,o,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t&&(e||t.shots.pop(),1!==t.shots.length)){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;t.score=n;var i="threecushion"===this.container.rules.rulename?"⏹️":"break(".concat(n,")"),r=JSON.stringify(t),a=J.A.crush(r),o="black",s=this.container.rules.cueball;s&&(o="#"+s.ballmesh.color.getHexString()),this.generateLink(i,a,o),n>=2&&this.generateHiScoreLink(a,o)}}},{key:"wholeGameLink",value:function(){var e=this.wholeGame(),t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),i=J.A.crush(n);this.generateLink(t,i,"black")}},{key:"shotCount",value:function(e){return e.filter((function(e){return"RERACK"!==e.type})).length}},{key:"generateLink",value:function(e,t,n){var i="".concat(this.replayUrl).concat(this.fullyEncodeURI(t)),r='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(i,'">').concat(e,"</a>");this.container.eventQueue.push(new G.b(null,"".concat(r)))}},{key:"generateHiScoreLink",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"black",n="threecushion"===this.container.rules.rulename?"🏆":"hi score 🏆",i="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(this.fullyEncodeURI(e)),r='<a class="pill" style="color: '.concat(t,'" target="_blank" href="').concat(i,'">').concat(n,"</a>");this.container.eventQueue.push(new G.b(null,"".concat(r)))}},{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\!/g,"%21").replace(/\*/g,"%2A")}}],n&&Z(t.prototype,n),e}(),te=n(9588),ne=n(5556);var ie=n(5597),re=n(2899),ae=n(9241);function oe(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function se(e,t,n,i,r,a,o){try{var s=e[a](o),l=s.value}catch(e){return void n(e)}s.done?t(l):Promise.resolve(l).then(i,r)}function le(e){return function(){var t=this,n=arguments;return new Promise((function(i,r){var a=e.apply(t,n);function o(e){se(a,i,r,o,s,"next",e)}function s(e){se(a,i,r,o,s,"throw",e)}o(void 0)}))}}function ce(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function ue(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function he(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(i=n.next()).done)&&(a.push(i.value),!t||a.length!==t);o=!0);}catch(e){s=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw r}}return a}}(e,t)||function(e,t){if(e){if("string"==typeof e)return oe(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?oe(e,t):void 0}}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function de(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function fe(e,t){var n,i,r,a={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},o=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return o.next=s(0),o.throw=s(1),o.return=s(2),"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(l){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(n=1,i&&(r=2&s[0]?i.return:s[0]?i.throw||((r=i.return)&&r.call(i),0):i.next)&&!(r=r.call(i,s[1])).done)return r;switch(i=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,i=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!((r=(r=a.trys).length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){a.label=s[1];break}if(6===s[0]&&a.label<r[1]){a.label=r[1],r=s;break}if(r&&a.label<r[2]){a.label=r[2],a.ops.push(s);break}r[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(e){s=[6,e],i=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,l])}}}var pe=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,i;return t=e,i=[{key:"pitchFromElevation",value:function(e){return Math.PI/2-e}},{key:"rotateX",value:function(e,t){var n=Math.sin(t),i=Math.cos(t);return[e[0],i*e[1]-n*e[2],n*e[1]+i*e[2]]}},{key:"isInWhiteArea",value:function(e,t){return.5*(he(this.rotateX(e,t),2)[1]+1)<1-this.greyRatio}},{key:"pushToWhiteArea",value:function(e,t){var n=he(this.rotateX(e,t),3),i=n[0],r=n[1],a=n[2],o=.5*(r+1),s=1-this.greyRatio;if(o>=s){var l=2*(s-.02)-1,c=Math.sin(t),u=Math.cos(t),h=u*l+c*a,d=-c*l+u*a,f=Math.sqrt(i*i+h*h+d*d)||1;return[i/f,h/f,d/f]}return e}},{key:"offsetToHitPoint",value:function(e){var t=-e.x,n=-e.y,i=t*t+n*n;if(i>=1){var r=Math.sqrt(i);t=t/r*.999,n=n/r*.999}return[t,n,Math.sqrt(Math.max(0,1-t*t-n*n))]}},{key:"hitPointToOffset",value:function(e){return{x:-e[0],y:-e[1]}}},{key:"buildOffsetsAroundWhiteCenter",value:function(e,t,n){for(var i,r=function(){var e=(p+.5)/h,t=Math.sqrt((1-e)*s*s+e*l*l),n=u*p,r=-t*Math.cos(n),a=-(c+t*Math.sin(n)),f=r*r+a*a;if(f>=1){var v=Math.sqrt(f)||1;r=r/v*.999,a=a/v*.999}var m=Math.sqrt(Math.max(0,1-r*r-a*a));if(i.isInWhiteArea([r,a,m],o)){var y={x:-r,y:-a};d.some((function(e){return Math.abs(e.x-y.x)<.001&&Math.abs(e.y-y.y)<.001}))||d.push(y)}p++},a=arguments.length>3&&void 0!==arguments[3]?arguments[3]:48,o=this.pitchFromElevation(e),s=Math.max(0,Math.min(1,t)),l=Math.max(s,Math.min(1,n)),c=Math.cos(o),u=Math.PI*(3-Math.sqrt(5)),h=Math.max(1,Math.floor(a)),d=[],f=40*h,p=0;d.length<h&&p<f;)i=this,r();for(var v=.02;d.length<h&&v<.15;){for(var m,y=function(e){var t=p+e,n=(t+.5)/h,i=Math.sqrt((1-n)*g*g+n*b*b),r=u*t,a=-i*Math.cos(r),s=-(c+i*Math.sin(r)),l=a*a+s*s;if(l>=1){var f=Math.sqrt(l)||1;a=a/f*.999,s=s/f*.999}var v=Math.sqrt(Math.max(0,1-a*a-s*s));if(m.isInWhiteArea([a,s,v],o)){var y={x:-a,y:-s};d.some((function(e){return Math.abs(e.x-y.x)<.001&&Math.abs(e.y-y.y)<.001}))||d.push(y)}},g=Math.max(0,s-v),b=Math.min(1,l+v),w=h-d.length,k=0;k<w;k++)m=this,y(k);p+=w,v+=.02}return d}},{key:"getDefaultConfig",value:function(e){var t,n=e.table.cue;return{minElevation:0,maxElevation:Math.max(.17,null!==(t=n.defaultElevation)&&void 0!==t?t:.17)+.1,minPowerPct:.4,maxPowerPct:.85,minSpin:0,maxSpin:.22,avoidKissStrict:!1,searchDensity:"medium",enabled:!1}}},{key:"readConfig",value:function(e){var t=e.npcConfig;if(!t)return this.getDefaultConfig(e);var n,i,r,a,o=this.getDefaultConfig(e),s=function(e,t,n){return Math.max(t,Math.min(n,e))},l={minElevation:s(t.minElevation,0,Math.PI/2),maxElevation:s(t.maxElevation,0,Math.PI/2),minPowerPct:s(t.minPowerPct,0,1),maxPowerPct:s(t.maxPowerPct,0,1),minSpin:s(t.minSpin,0,1),maxSpin:s(t.maxSpin,0,1),avoidKissStrict:!!t.avoidKissStrict,searchDensity:null!==(n=t.searchDensity)&&void 0!==n?n:o.searchDensity,enabled:!0===t.enabled};return l.minElevation>l.maxElevation&&(i=[l.maxElevation,l.minElevation],l.minElevation=i[0],l.maxElevation=i[1]),l.minPowerPct>l.maxPowerPct&&(r=[l.maxPowerPct,l.minPowerPct],l.minPowerPct=r[0],l.maxPowerPct=r[1]),l.minSpin>l.maxSpin&&(a=[l.maxSpin,l.minSpin],l.minSpin=a[0],l.maxSpin=a[1]),l}},{key:"sleep",value:function(e){return new Promise((function(t){return setTimeout(t,e)}))}},{key:"waitNextFrame",value:function(){return new Promise((function(e){return"undefined"!=typeof requestAnimationFrame?requestAnimationFrame((function(){return e()})):setTimeout(e,0)}))}},{key:"interpolateAngle",value:function(e,t,n){e=(e%(2*Math.PI)+2*Math.PI)%(2*Math.PI);var i=(t=(t%(2*Math.PI)+2*Math.PI)%(2*Math.PI))-e;return i>Math.PI&&(i-=2*Math.PI),i<-Math.PI&&(i+=2*Math.PI),e+i*n}},{key:"easeInOutCubic",value:function(e){return e<.5?4*e*e*e:1-Math.pow(-2*e+2,3)/2}},{key:"setThinkingUI",value:function(e,t){try{if("undefined"==typeof document)return;var n=document.getElementById("npc");n&&n.classList.toggle("is-busy",t);var i,r=e.rules,a=e.table,o=null!==(i=null==r?void 0:r.cueball)&&void 0!==i?i:null==a?void 0:a.cueball,s=document.getElementById("customBtnLeft"),l=document.getElementById("customBtnRight");if(o&&a){var c,u,h=o===(null===(c=a.balls)||void 0===c?void 0:c[0]),d=o===(null===(u=a.balls)||void 0===u?void 0:u[1]);s&&(h||!h&&!d)&&s.classList.toggle("is-busy",t),l&&d&&l.classList.toggle("is-busy",t)}var f=document.querySelector(".panel");f&&f.classList.toggle("is-disabled",t);try{var p,v,m,y;null===(y=e.table)||void 0===y||null===(m=y.cue)||void 0===m||null===(v=m.aimInputs)||void 0===v||null===(p=v.setNpcAllowedSpinOverlayVisible)||void 0===p||p.call(v,t)}catch(e){}}catch(e){}}},{key:"setPanelDisabled",value:function(e,t){try{if("undefined"==typeof document)return;var n=document.querySelector(".panel");n&&n.classList.toggle("is-disabled",!!t)}catch(e){}}},{key:"takeShot",value:function(t){return le((function(){var i,a,o,s,l,c,u,h,d,f,p,v,m,y,g,b,w,k,P,x,S,M,T,E,C,R,A,I,O,B,_,L,j,N,F,D,H,z,G,q,U,V,K,W,X,Y,J,Q,Z,$,ee;return fe(this,(function(te){switch(te.label){case 0:if(te.trys.push([0,11,,12]),!t.isSinglePlayer)return null==t||null===(h=t.chat)||void 0===h||null===(u=h.showMessage)||void 0===u||u.call(h,"NPC: Sadece tek oyunculu pratik modunda çalışır."),[2];if(!(null==t?void 0:t.table)||!t.table.allStationary())return null==t||null===(f=t.chat)||void 0===f||null===(d=f.showMessage)||void 0===d||d.call(f,"NPC: Bekliyorum, toplar hareket ediyor."),[2];if("threecushion"!==(null!==(p=null==t||null===(i=t.rules)||void 0===i?void 0:i.rulename)&&void 0!==p?p:""))return null==t||null===(m=t.chat)||void 0===m||null===(v=m.showMessage)||void 0===v||v.call(m,"NPC: Şimdilik yalnızca 3-bant modunda destekleniyor."),[2];null===(o=t.chat)||void 0===o||null===(a=o.showMessage)||void 0===a||a.call(o,"NPC: En güvenli 3-bant atışı arıyorum...");try{if(t.isSinglePlayer||null===(b=t.rules)||void 0===b||null===(g=b.prepareForLocalTurn)||void 0===g||g.call(b),k=null!==(w=null===(y=t.rules)||void 0===y?void 0:y.cueball)&&void 0!==w?w:t.table.cueball){t.table.cueball=k,P=t.table.balls.indexOf(k),t.table.cue.aim.i=P;try{t.table.cue.aim.pos.copy(k.pos),t.table.cue.moveTo(k.pos),t.table.cue.updateAimInput(),t.updateTrajectoryPrediction()}catch(e){}}}catch(e){}return e.setThinkingUI(t,!0),[4,new Promise((function(e){return"undefined"!=typeof requestAnimationFrame?requestAnimationFrame((function(){return e(null)})):setTimeout(e,0)}))];case 1:return te.sent(),[4,e.sleep(50)];case 2:return te.sent(),[4,e.computeBestShotInWorkers(t)];case 3:return(x=te.sent())?[3,5]:[4,e.computeBestShotCooperative(t)];case 4:x=te.sent(),te.label=5;case 5:if(!x)return e.setThinkingUI(t,!1),null===(M=t.chat)||void 0===M||null===(S=M.showMessage)||void 0===S||S.call(M,"NPC: Uygun deterministik sayı atışı bulamadım."),[2];e.setThinkingUI(t,!1),e.setPanelDisabled(t,!0);try{null===(T=t.lockCameraControls)||void 0===T||T.call(t,!0)}catch(e){}E=t.table.cue,C=t.table,A=null!==(R=null===(s=t.rules)||void 0===s?void 0:s.cueball)&&void 0!==R?R:C.cueball,E.aim.i=C.balls.indexOf(A);try{t.table.cueball=A}catch(e){}I=!1;try{null===(O=t.lockCameraControls)||void 0===O||O.call(t,!0),(B=t.view.camera).mode===B.aimView&&(I=!0,null===(_=t.setNpcAnimating)||void 0===_||_.call(t,!0),B.forceMode(B.aimView),B.resetDynamicAdjustments(A.pos))}catch(e){}if(L=E.aim.angle,j=x.angle,E.elevation=x.elevation,E.aim.elevation=x.elevation,E.aim.power=Math.max(0,Math.min(E.maxPower,x.power)),E.aim.offset.copy(new r.Pq0(x.offset.x,x.offset.y,0)),E.aim.angle=L,E.moveTo(A.pos),E.updateAimInput(),t.updateTrajectoryPrediction(),!I)return[3,10];N=3e3,F="undefined"!=typeof performance?performance.now():Date.now(),te.label=6;case 6:return D="undefined"!=typeof performance?performance.now():Date.now(),(H=D-F)>=N?[3,8]:(z=Math.min(H/N,1),G=this.easeInOutCubic(z),q=this.interpolateAngle(L,j,G),E.aim.angle=q,E.moveTo(A.pos),E.updateAimInput(),t.updateTrajectoryPrediction(),[4,this.waitNextFrame()]);case 7:return te.sent(),[3,6];case 8:return[4,this.sleep(200)];case 9:te.sent(),te.label=10;case 10:E.aim.angle=j,E.moveTo(A.pos),E.updateAimInput(),t.updateTrajectoryPrediction();try{null===(U=t.setNpcAnimating)||void 0===U||U.call(t,!1)}catch(e){}V=t.table.cueball,t.rules&&(t.rules.cueball=V),K=n(2518).Q,W=n(6940).H,X=new K(t.table.serialise()),t.sendEvent(X),t.recorder.record(X),t.updateController(new W(t));try{null===(Y=t.lockCameraControls)||void 0===Y||Y.call(t,!1)}catch(e){}try{e.setPanelDisabled(t,!1)}catch(e){}return null===(c=t.chat)||void 0===c||null===(l=c.showMessage)||void 0===l||l.call(c,"NPC: Atis yapildi. Bol sans!"),[3,12];case 11:J=te.sent();try{e.setThinkingUI(t,!1)}catch(e){}try{null===(Q=t.setNpcAnimating)||void 0===Q||Q.call(t,!1)}catch(e){}try{null===(Z=t.lockCameraControls)||void 0===Z||Z.call(t,!1)}catch(e){}try{e.setPanelDisabled(t,!1)}catch(e){}try{null==t||null===(ee=t.chat)||void 0===ee||null===($=ee.showMessage)||void 0===$||$.call(ee,"NPC: Hata olustu, atis iptal.")}catch(e){}return console.error("NPC bot error:",J),[3,12];case 12:return[2]}}))})).call(this)}},{key:"checkMemoryPressure",value:function(){try{var e=performance.memory;if(e&&e.usedJSHeapSize&&e.jsHeapSizeLimit)return e.usedJSHeapSize/e.jsHeapSizeLimit>.85}catch(e){}return!1}},{key:"calculateOptimalWorkers",value:function(e,t){if(!this.workerStats.adaptiveEnabled)return Math.max(2,Math.min(16,Math.floor(.75*e)));var n=this.workerStats,i=n.lastWorkerCount,r=n.lastDuration,a=n.memoryPressure;if(0===n.callCount||0===i)return Math.max(2,Math.min(16,Math.floor(.75*e)));if(a)return Math.max(2,Math.floor(.6*i));if(r<2e3){var o=Math.min(e,Math.floor(1.3*i));return Math.min(32,o)}return r>8e3?Math.max(2,Math.floor(.8*i)):i}},{key:"initWorkerPool",value:function(e){return le((function(){var t,n;return fe(this,(function(i){for(;this.workerPool.length>e;){t=this.workerPool.pop();try{null==t||t.terminate()}catch(e){}}for(;this.workerPool.length<e;)try{n=new Worker("npcworker.js"),this.workerPool.push(n)}catch(e){console.warn("[NPC] Failed to create worker:",e);break}return this.workerPoolSize=this.workerPool.length,[2,this.workerPoolSize]}))})).call(this)}},{key:"cleanupWorkerPool",value:function(){this.workerPool.forEach((function(e){try{e.terminate()}catch(e){}})),this.workerPool=[],this.workerPoolSize=0}},{key:"serializeTableForWorker",value:function(e){try{var t,n,i,r,a=function(e){if(!e||"object"!==(void 0===e?"undefined":de(e)))return e;var t={};for(var n in e){var i=e[n];"function"!=typeof i&&(null==i||"number"==typeof i||"string"==typeof i||"boolean"==typeof i?t[n]=i:Array.isArray(i)?t[n]=i.map((function(e){return"object"===(void 0===e?"undefined":de(e))?a(e):e})):"object"===(void 0===i?"undefined":de(i))&&(t[n]=a(i)))}return t};return{balls:e.balls.map((function(e){return{pos:{x:e.pos.x,y:e.pos.y,z:e.pos.z},vel:e.vel?{x:e.vel.x,y:e.vel.y,z:e.vel.z}:{x:0,y:0,z:0},rvel:e.rvel?{x:e.rvel.x,y:e.rvel.y,z:e.rvel.z}:{x:0,y:0,z:0},id:e.id,radius:e.radius,physicsContext:a(e.physicsContext)}})),aim:(null===(t=e.cue)||void 0===t?void 0:t.aim)?{angle:e.cue.aim.angle,power:e.cue.aim.power,offset:e.cue.aim.offset?{x:e.cue.aim.offset.x,y:e.cue.aim.offset.y,z:e.cue.aim.offset.z}:{x:0,y:0,z:0},elevation:e.cue.aim.elevation,i:e.cue.aim.i}:null,cueballId:null===(n=e.cueball)||void 0===n?void 0:n.id,cue:{maxPower:null===(i=e.cue)||void 0===i?void 0:i.maxPower,defaultElevation:null===(r=e.cue)||void 0===r?void 0:r.defaultElevation}}}catch(e){return console.error("[NPC] Failed to serialize table for worker:",e),null}}},{key:"setAdaptiveMode",value:function(e){this.workerStats.adaptiveEnabled=e,e?console.log("[NPC] Adaptive worker management ENABLED"):console.log("[NPC] Adaptive worker management DISABLED (fallback to 75% strategy)")}},{key:"getWorkerStats",value:function(){return{poolSize:this.workerPoolSize,lastWorkerCount:this.workerStats.lastWorkerCount,lastDuration:this.workerStats.lastDuration,memoryPressure:this.workerStats.memoryPressure,adaptiveEnabled:this.workerStats.adaptiveEnabled,callCount:this.workerStats.callCount,hardwareConcurrency:"undefined"!=typeof navigator?navigator.hardwareConcurrency:"unknown"}}},{key:"buildCandidateSet",value:function(e){for(var t,n,i=e.table,r=i.cue,a=this.readConfig(e),o=function(){switch(a.searchDensity){case"low":return 16;case"high":return 36;default:return 24}}(),s=[],l=0;l<o;l++)s.push(2*l*Math.PI/o);var c=null!==(n=null===(t=e.rules)||void 0===t?void 0:t.cueball)&&void 0!==n?n:i.cueball,u=s.slice(8),h=function(e){return(e%(2*Math.PI)+2*Math.PI)%(2*Math.PI)},d=i.balls.filter((function(e){return e!==c})),f=[];try{for(var p,v=Math.max(1e-6,null!==(p=null==c?void 0:c.radius)&&void 0!==p?p:.028),m=[.5,.2],y=0;y<Math.min(2,d.length);y++){var g=d[y];if(g){var b=g.pos.x-c.pos.x,w=g.pos.y-c.pos.y,k=Math.hypot(b,w),P=Math.max(v,g.radius||v),x=Math.atan2(w,b),S=!0,M=!1,T=void 0;try{for(var E,C=m[Symbol.iterator]();!(S=(E=C.next()).done);S=!0){var R=E.value,A=Math.asin(Math.min(.95,P*R/Math.max(1e-6,k)));(!isFinite(A)||A<=0)&&(A=.2===R?.12:.28),f.push(h(x-A),h(x+A))}}catch(e){M=!0,T=e}finally{try{S||null==C.return||C.return()}finally{if(M)throw T}}}}}catch(e){}var I=[],O=function(e){I.some((function(t){return Math.abs(Math.atan2(Math.sin(e-t),Math.cos(e-t)))<.001}))||I.push(e)};if(f.forEach(O),u.forEach(O),!a.enabled){var B,_=[Math.max(0,null!==(B=r.defaultElevation)&&void 0!==B?B:.17)],L=[.5*r.maxPower,.7*r.maxPower,.85*r.maxPower];return{angles:I,offsets:[{x:0,y:0},{x:.15,y:0},{x:-.15,y:0},{x:0,y:.15},{x:0,y:-.15},{x:.12,y:.12},{x:-.12,y:.12}],elevations:_,powers:L}}var j=[0,Math.PI/4,Math.PI/2,3*Math.PI/4,Math.PI,-3*Math.PI/4,-Math.PI/2,-Math.PI/4],N=[],F=function(e){var t=Math.max(0,Math.min(1,e));N.includes(t)||N.push(t)},D=a.minSpin,H=a.maxSpin,z=.5*(D+H),G=.75*D+.25*H,q=.25*D+.75*H;F(D),F(G),F(z),F(q),F(H),0===D&&F(0);var U=[],V=!0,K=!1,W=void 0;try{for(var X,Y=N[Symbol.iterator]();!(V=(X=Y.next()).done);V=!0){var J=X.value,Q=!0,Z=!1,$=void 0;try{for(var ee,te=j[Symbol.iterator]();!(Q=(ee=te.next()).done);Q=!0){var ne=ee.value;U.push({x:J*Math.cos(ne),y:J*Math.sin(ne)})}}catch(e){Z=!0,$=e}finally{try{Q||null==te.return||te.return()}finally{if(Z)throw $}}}}catch(e){K=!0,W=e}finally{try{V||null==Y.return||Y.return()}finally{if(K)throw W}}var ie=[.5*(a.minElevation+a.maxElevation)],re=Math.max(0,Math.min(1,a.minPowerPct))*r.maxPower,ae=Math.max(0,Math.min(1,a.maxPowerPct))*r.maxPower;return{angles:I,offsets:U,elevations:ie,powers:[.5*(re+ae)]}}},{key:"computeBestShotInWorker",value:function(e){return le((function(){var t,n,i,r,a,o,s,l,c,u,h,d,f;return fe(this,(function(p){if("undefined"==typeof Worker)return[2,this.findBestThreeCushionShot(e)];if(!(i=this.serializeTableForWorker(e.table)))return[2,null];try{i&&"object"===(void 0===i?"undefined":de(i))&&"cushionModel"in i&&delete i.cushionModel}catch(e){}return a=null!==(r=null===(t=e.rules)||void 0===t?void 0:t.rulename)&&void 0!==r?r:"unknown",o=this.readConfig(e),l=null!==(s=null===(n=e.rules)||void 0===n?void 0:n.cueball)&&void 0!==s?s:e.table.cueball,c=l.id,(u=e.table.balls.indexOf(l))<0&&(u=Math.max(0,Math.min(e.table.balls.length-1,null!==(f=null===(d=e.table.cue)||void 0===d||null===(h=d.aim)||void 0===h?void 0:h.i)&&void 0!==f?f:-1))),u<0?[2,null]:[2,new Promise((function(e,t){try{var n=new Worker("npcworker.js");n.addEventListener("message",(function(t){try{n.terminate()}catch(t){}var i=t.data||{};i&&"result"===i.type?e(i.best||null):e(null)})),n.addEventListener("error",(function(e){try{n.terminate()}catch(e){}t(e)})),n.postMessage({type:"compute",table:i,rulesName:a,config:o,cueIndex:u,cueBallId:c})}catch(e){t(e)}}))]}))})).call(this)}},{key:"computeBestShotInWorkers",value:function(e){return le((function(){var t,n,i,r,a,o,s,l,c,u,h,d,f,p,v,m,y,g,b,w,k,P,x,S,M,T,E,C,R,A,I,O,B,_,L,j;return fe(this,(function(N){switch(N.label){case 0:return t=this,"undefined"==typeof Worker?[2,this.computeBestShotCooperative(e)]:(r="undefined"!=typeof performance?performance.now():Date.now(),(a=this.serializeTableForWorker(e.table))?(s=null!==(o=null===(n=e.rules)||void 0===n?void 0:n.rulename)&&void 0!==o?o:"unknown",l=this.readConfig(e),u=null!==(c=null===(i=e.rules)||void 0===i?void 0:i.cueball)&&void 0!==c?c:e.table.cueball,h=u.id,(d=e.table.balls.indexOf(u))<0&&(d=Math.max(0,Math.min(e.table.balls.length-1,null!==(v=null===(p=e.table.cue)||void 0===p||null===(f=p.aim)||void 0===f?void 0:f.i)&&void 0!==v?v:-1))),d<0?[2,null]:(m="undefined"!=typeof navigator&&navigator.hardwareConcurrency?navigator.hardwareConcurrency:4,this.workerStats.memoryPressure=this.checkMemoryPressure(),y=this.calculateOptimalWorkers(m,l),g=function(){switch(l.searchDensity){case"low":return 16;case"high":return 36;default:return 24}}(),b=Math.min(y,g),[4,this.initWorkerPool(y)])):(console.error("[NPC] Failed to serialize table data for workers"),[2,this.computeBestShotCooperative(e)]));case 1:if(0===(w=N.sent()))return console.warn("[NPC] No workers available, falling back to cooperative mode"),[2,this.computeBestShotCooperative(e)];try{x=this.workerStats.memoryPressure?"YÜKSEK":"Normal",S=this.workerStats.adaptiveEnabled?" (adaptive: ".concat(this.workerStats.callCount>0?"aktif":"ilk çağrı",")"):"",null===(P=e.chat)||void 0===P||null===(k=P.showMessage)||void 0===k||k.call(P,"NPC: ".concat(w,"/").concat(m," çekirdek").concat(S,", RAM: ").concat(x,", yoğunluk: ").concat(l.searchDensity))}catch(e){}N.label=2;case 2:return N.trys.push([2,4,,5]),M=this.workerPool.slice(0,b).map((function(e,n){return new Promise((function(i){var r=setTimeout((function(){console.warn("[NPC] Worker ".concat(n," timeout after ").concat(t.WORKER_TIMEOUT_MS,"ms")),i(null)}),t.WORKER_TIMEOUT_MS);e.addEventListener("message",(function(e){clearTimeout(r);var t=e.data||{};i(t&&t.best?t.best:null)}),{once:!0}),e.addEventListener("error",(function(e){clearTimeout(r),console.warn("[NPC] Worker ".concat(n," error:"),e),i(null)}),{once:!0}),e.postMessage({type:"compute",table:a,rulesName:s,config:l,cueIndex:d,cueBallId:h,sliceIndex:n,sliceCount:b})}))})),[4,Promise.all(M)];case 3:T=N.sent(),E=null,C=!0,R=!1,A=void 0;try{for(I=T[Symbol.iterator]();!(C=(O=I.next()).done);C=!0)(B=O.value)&&(!E||"number"==typeof B.score&&B.score>(null!==(_=E.score)&&void 0!==_?_:-1/0))&&(E=B)}catch(e){R=!0,A=e}finally{try{C||null==I.return||I.return()}finally{if(R)throw A}}return L=("undefined"!=typeof performance?performance.now():Date.now())-r,this.workerStats.lastWorkerCount=w,this.workerStats.lastDuration=L,this.workerStats.callCount++,console.log("[NPC Performance] Workers: ".concat(w,"/").concat(m,", Duration: ").concat(L.toFixed(0),"ms, ")+"Memory: ".concat(this.workerStats.memoryPressure?"HIGH":"OK",", ")+"Result: ".concat(E?"Found":"None")),E?[2,{angle:E.angle,elevation:E.elevation,offset:E.offset,power:E.power}]:[2,null];case 4:return j=N.sent(),console.error("[NPC] Worker pool error:",j),[2,null];case 5:return[2]}}))})).call(this)}},{key:"computeBestShotCooperative",value:function(e){return le((function(){var t,n,i,r,a,o,s,l,c,u,h,d,f,p,v,m,y,g,b,w,k,P,x,S,M,T,E,C,R,A,I,O,B,_,L,j,N,F,D,H,z,G,q,U,V,K,W,X,Y,J,Q,Z,$;return fe(this,(function(ee){switch(ee.label){case 0:if(n=this.readConfig(e),i=this.buildCandidateSet(e),r=i.angles,i.offsets,a=i.elevations,o=i.powers,s=e.table,c=null!==(l=null===(t=e.rules)||void 0===t?void 0:t.cueball)&&void 0!==l?l:s.cueball,(u=s.balls.indexOf(c))<0)return[2,null];h=null,d=null,f=null,p=!this.readConfig(e).avoidKissStrict,v="undefined"!=typeof performance?performance.now():Date.now(),m=8,y=0,g=0,console.log("[NPC Arama Başlangıç]","Top ID: ".concat(c.id),"Renk: #".concat(c.ballmesh.color.getHexString()),"Pozisyon: (".concat(c.pos.x.toFixed(2),", ").concat(c.pos.y.toFixed(2),", ").concat(c.pos.z.toFixed(2),")"),"Diğer toplar:",s.balls.filter((function(e){return e!==c})).map((function(e){return"ID:".concat(e.id," (").concat(e.pos.x.toFixed(2),", ").concat(e.pos.y.toFixed(2),")")})).join(", ")),b=!0,w=!1,k=void 0,ee.label=1;case 1:ee.trys.push([1,24,25,26]),P=r[Symbol.iterator](),ee.label=2;case 2:if(b=(x=P.next()).done)return[3,23];S=x.value,M=!0,T=!1,E=void 0,ee.label=3;case 3:ee.trys.push([3,20,21,22]),C=a[Symbol.iterator](),ee.label=4;case 4:if(M=(R=C.next()).done)return[3,19];A=R.value,I=function(){switch(n.searchDensity){case"low":return 24;case"high":return 96;default:return 48}}(),O=he(n.enabled?[n.minSpin,n.maxSpin]:[0,this.getDefaultConfig(e).maxSpin],2),B=O[0],_=O[1],L=this.buildOffsetsAroundWhiteCenter(A,B,_,I),j=!0,N=!1,F=void 0,ee.label=5;case 5:ee.trys.push([5,16,17,18]),D=L[Symbol.iterator](),ee.label=6;case 6:if(j=(H=D.next()).done)return[3,15];z=H.value,G=!0,q=!1,U=void 0,ee.label=7;case 7:ee.trys.push([7,12,13,14]),V=o[Symbol.iterator](),ee.label=8;case 8:if(G=(K=V.next()).done)return[3,11];if(W=K.value,y++,(X=this.simulateThreeCushion(e,{angle:S,offset:z,elevation:A,power:W,cueIndex:u,cueBallId:c.id})).success){if(g++,J=this.scoreShot({angle:S,offset:z,elevation:A,power:W},X.hadKiss,X.firstBall),Q={angle:S,offset:z,elevation:A,power:W,score:J,hadKiss:X.hadKiss},console.log("[NPC Başarılı Atış #".concat(g,"]"),"Açı: ".concat((180*S/Math.PI).toFixed(1),"°"),"Güç: ".concat(W.toFixed(2)),"Spin X: ".concat(z.x.toFixed(2)),"Spin Y: ".concat(z.y.toFixed(2)),"Elevation: ".concat((180*A/Math.PI).toFixed(1),"°"),"Score: ".concat(J.toFixed(1)),"Kiss: ".concat(X.hadKiss?"Evet":"Hayır")),X.hadKiss)p&&(!d||J>d.score)&&(d=Q);else if((!h||J>h.score)&&(h=Q).score>980)return[2,h]}else Y=this.scoreShot({angle:S,offset:z,elevation:A,power:W},X.hadKiss,X.firstBall),(!f||Y>f.score)&&(f={angle:S,offset:z,elevation:A,power:W,score:Y,hadKiss:X.hadKiss});return("undefined"!=typeof performance?performance.now():Date.now())-v>=m?[4,new Promise((function(e){return"undefined"!=typeof requestAnimationFrame?requestAnimationFrame((function(){return e(null)})):setTimeout(e,0)}))]:[3,10];case 9:ee.sent(),v="undefined"!=typeof performance?performance.now():Date.now(),ee.label=10;case 10:return G=!0,[3,8];case 11:return[3,14];case 12:return Z=ee.sent(),q=!0,U=Z,[3,14];case 13:try{G||null==V.return||V.return()}finally{if(q)throw U}return[7];case 14:return j=!0,[3,6];case 15:return[3,18];case 16:return Z=ee.sent(),N=!0,F=Z,[3,18];case 17:try{j||null==D.return||D.return()}finally{if(N)throw F}return[7];case 18:return M=!0,[3,4];case 19:return[3,22];case 20:return Z=ee.sent(),T=!0,E=Z,[3,22];case 21:try{M||null==C.return||C.return()}finally{if(T)throw E}return[7];case 22:return b=!0,[3,2];case 23:return[3,26];case 24:return Z=ee.sent(),w=!0,k=Z,[3,26];case 25:try{b||null==P.return||P.return()}finally{if(w)throw k}return[7];case 26:return console.log("[NPC Arama Özeti]","Toplam deneme: ".concat(y),"Başarılı: ".concat(g),"Başarı oranı: ".concat(y>0?(g/y*100).toFixed(1):0,"%"),"Sonuç: ".concat(h?"Clean":d?"Kiss":f?"Fallback":"Yok")),[2,null!==($=null!=h?h:d)&&void 0!==$?$:f]}}))})).call(this)}},{key:"findBestThreeCushionShot",value:function(e){var t,n,i=e.table,r=null!==(n=null===(t=e.rules)||void 0===t?void 0:t.cueball)&&void 0!==n?n:i.cueball,a=i.balls.indexOf(r);if(a<0)return null;var o=this.readConfig(e),s=this.buildCandidateSet(e),l=s.angles,c=(s.offsets,s.elevations),u=s.powers,h=null,d=null,f=null,p=0,v=0;console.log("[NPC Arama Başlangıç]","Top ID: ".concat(r.id),"Renk: #".concat(r.ballmesh.color.getHexString()),"Pozisyon: (".concat(r.pos.x.toFixed(2),", ").concat(r.pos.y.toFixed(2),", ").concat(r.pos.z.toFixed(2),")"),"Diğer toplar:",i.balls.filter((function(e){return e!==r})).map((function(e){return"ID:".concat(e.id," (").concat(e.pos.x.toFixed(2),", ").concat(e.pos.y.toFixed(2),")")})).join(", "));var m,y=!0,g=!1,b=void 0;try{for(var w,k=l[Symbol.iterator]();!(y=(w=k.next()).done);y=!0){var P=w.value,x=!0,S=!1,M=void 0;try{for(var T,E=c[Symbol.iterator]();!(x=(T=E.next()).done);x=!0){var C=T.value,R=function(){switch(o.searchDensity){case"low":return 24;case"high":return 96;default:return 48}}(),A=he(o.enabled?[o.minSpin,o.maxSpin]:[0,this.getDefaultConfig(e).maxSpin],2),I=A[0],O=A[1],B=this.buildOffsetsAroundWhiteCenter(C,I,O,R),_=!0,L=!1,j=void 0;try{for(var N,F=B[Symbol.iterator]();!(_=(N=F.next()).done);_=!0){var D=N.value,H=!0,z=!1,G=void 0;try{for(var q,U=u[Symbol.iterator]();!(H=(q=U.next()).done);H=!0){var V=q.value;p++;var K=this.simulateThreeCushion(e,{angle:P,offset:D,elevation:C,power:V,cueIndex:a,cueBallId:r.id});if(K.success){v++;var W=this.scoreShot({angle:P,offset:D,elevation:C,power:V},K.hadKiss,K.firstBall),X={angle:P,offset:D,elevation:C,power:V,score:W,hadKiss:K.hadKiss};console.log("[NPC Başarılı Atış #".concat(v,"]"),"Açı: ".concat((180*P/Math.PI).toFixed(1),"°"),"Güç: ".concat(V.toFixed(2)),"Spin X: ".concat(D.x.toFixed(2)),"Spin Y: ".concat(D.y.toFixed(2)),"Elevation: ".concat((180*C/Math.PI).toFixed(1),"°"),"Score: ".concat(W.toFixed(1)),"Kiss: ".concat(K.hadKiss?"Evet":"Hayır"));var Y=!this.readConfig(e).avoidKissStrict;if(K.hadKiss){if(!Y)continue;(!d||W>d.score)&&(d=X)}else if((!h||W>h.score)&&(h=X).score>980)return h}else{var J=this.scoreShot({angle:P,offset:D,elevation:C,power:V},K.hadKiss,K.firstBall);(!f||J>f.score)&&(f={angle:P,offset:D,elevation:C,power:V,score:J,hadKiss:K.hadKiss})}}}catch(e){z=!0,G=e}finally{try{H||null==U.return||U.return()}finally{if(z)throw G}}}}catch(e){L=!0,j=e}finally{try{_||null==F.return||F.return()}finally{if(L)throw j}}}}catch(e){S=!0,M=e}finally{try{x||null==E.return||E.return()}finally{if(S)throw M}}}}catch(e){g=!0,b=e}finally{try{y||null==k.return||k.return()}finally{if(g)throw b}}return console.log("[NPC Arama Özeti]","Toplam deneme: ".concat(p),"Başarılı: ".concat(v),"Başarı oranı: ".concat(p>0?(v/p*100).toFixed(1):0,"%"),"Sonuç: ".concat(h?"Clean":d?"Kiss":f?"Fallback":"Yok")),null!==(m=null!=h?h:d)&&void 0!==m?m:f}},{key:"scoreShot",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return 1e3-(300*Math.hypot(e.offset.x,e.offset.y)+180*e.elevation/Math.PI*2+.002*e.power+(t?500:0)+60*(n?.1:.9))}},{key:"simulateThreeCushion",value:function(e,t){var n=null;try{var i=e.table.serialise();n=ie.X.fromSerialised(i,{headless:!0}),e.table.balls.forEach((function(e,t){var i=n.balls.find((function(t){return t.id===e.id}))||n.balls[t];i&&(i.physicsContext=e.physicsContext)}));var a=n.balls.find((function(e){return e.id===t.cueBallId}));if(!a)return console.error("[NPC Error] simCueBall bulunamadı! cueBallId: ".concat(t.cueBallId,", sim.balls IDs: ").concat(n.balls.map((function(e){return e.id})).join(", "))),{success:!1,hadKiss:!1,firstBall:!1};n.cueball=a,n.cue.aim.i=n.balls.indexOf(a);var o={angle:t.angle,offset:new r.Pq0(t.offset.x,t.offset.y,0),power:t.power},s=(0,re.Bl)(a,o,t.elevation);(0,re.gI)(a,s);for(var l=0,c=0,u=0,h=new Set,d=new Map,f=0,p=!1,v="none",m=n.balls.filter((function(e){return e!==a})),y=new Set(m.map((function(e){return e.id}))),g=new Map,b=null,w=!1;l<12;){n.advance(ae.C),l+=ae.C;var k=n.outcome.slice(c);c=n.outcome.length;var P=!0,x=!1,S=void 0;try{for(var M,T=k[Symbol.iterator]();!(P=(M=T.next()).done);P=!0){var E=M.value;if(E.type===Y.$.Cushion)E.ballA===a&&("none"===v&&(v="cushion"),u++);else if(E.type===Y.$.Collision){var C=E.ballA,R=E.ballB,A=C===a;if(A||R===a){"none"===v&&(v="ball");var I=A?R:C;if(I&&I!==a){var O,B=I.id;h.add(B),f++;var _=null!==(O=d.get(B))&&void 0!==O?O:0;if(d.set(B,_+1),(_+1>1||f>2)&&(p=!0),g.has(B)?h.size<2&&(p=!0):g.set(B,l),h.size>=2)return{success:u>=3,hadKiss:p||w,firstBall:"ball"===v}}}else C&&R&&y.has(C.id)&&y.has(R.id)&&(null===b&&(b=l),1===g.size&&(w=!0))}}}catch(e){x=!0,S=e}finally{try{P||null==T.return||T.return()}finally{if(x)throw S}}if(n.allStationary())break}var L,j=this.analyzeCaromOutcome(a,n.outcome);return{success:j.success,hadKiss:j.hadKiss||w,firstBall:null!==(L=j.firstBall)&&void 0!==L?L:"ball"===v}}catch(e){return{success:!1,hadKiss:!1,firstBall:!1}}finally{try{n&&Array.isArray(n.balls)&&n.balls.forEach((function(e){try{e.ballmesh&&e.ballmesh.dispose&&e.ballmesh.dispose()}catch(e){}}))}catch(e){}try{if(n&&n.cue){var N=n.cue,F=function(e){try{e&&e.geometry&&e.geometry.dispose&&e.geometry.dispose()}catch(e){}};F(N.mesh),F(N.placerMesh),F(N.hitPointMesh),F(N.virtualCueMesh)}}catch(e){}try{n&&(n.outcome=[])}catch(e){}}}},{key:"analyzeCaromOutcome",value:function(e,t){Y.P.cueBallFirst(e,t);var n=0,i=new Set,r=new Map,a=0,o=!1,s="none",l=new Set(t.flatMap((function(e){return[e.ballA,e.ballB]})).filter(Boolean)),c=new Set(Array.from(l).map((function(e){return e.id})).filter((function(t){return t!==e.id}))),u=new Map,h=!1,d=0,f=!0,p=!1,v=void 0;try{for(var m,y=t[Symbol.iterator]();!(f=(m=y.next()).done);f=!0){var g=m.value;if(d+=1,g.type!==Y.$.Cushion||g.ballA!==e){if(g.type===Y.$.Collision){var b=g.ballA,w=g.ballB;if(b&&w)if(b===e||w===e){"none"===s&&(s="ball");var k=b===e?w:b;if(k&&k!==e){var P,x=k.id;i.add(x),a++;var S=null!==(P=r.get(x))&&void 0!==P?P:0;if(r.set(x,S+1),(S+1>1||a>2)&&(o=!0),u.has(x)?i.size<2&&(o=!0):u.set(x,d),i.size>=2)return{success:n>=3,hadKiss:o||h,firstBall:"ball"===s}}}else c.has(b.id)&&c.has(w.id)&&1===u.size&&(h=!0)}}else"none"===s&&(s="cushion"),n++}}catch(e){p=!0,v=e}finally{try{f||null==y.return||y.return()}finally{if(p)throw v}}return{success:!1,hadKiss:o||h,firstBall:"ball"===s}}}],null&&ce(t.prototype,null),i&&ce(t,i),e}();function ve(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function me(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}ue(pe,"workerPool",[]),ue(pe,"workerPoolSize",0),ue(pe,"WORKER_TIMEOUT_MS",3e4),ue(pe,"workerStats",{lastWorkerCount:0,lastDuration:0,optimalWorkerCount:0,memoryPressure:!1,adaptiveEnabled:!0,callCount:0}),ue(pe,"greyRatio",.75),"undefined"!=typeof window&&(window.addEventListener("beforeunload",(function(){try{pe.cleanupWorkerPool()}catch(e){}})),document.addEventListener("visibilitychange",(function(){if(document.hidden)try{pe.cleanupWorkerPool()}catch(e){}})));var ye=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),me(this,"container",void 0),me(this,"redo",void 0),me(this,"share",void 0),me(this,"replay",void 0),me(this,"camera",void 0),me(this,"npc",null),me(this,"npcMenuPanel",null),me(this,"npcMenuEntry",null),me(this,"npcPanelVisible",!1),me(this,"menuToggle",void 0),me(this,"menuPanel",void 0),me(this,"menuPanelVisible",!1),me(this,"handleOutsideClick",(function(e){if(n.menuPanelVisible){var t=e.target;n.npcMenuPanel&&n.npcMenuPanel.contains(t)||n.setMenuPanelVisibility(!1)}})),me(this,"handleEscapeKey",(function(e){"Escape"===e.key&&n.setMenuPanelVisibility(!1)})),me(this,"handlePanelSelection",(function(){n.setMenuPanelVisibility(!1)})),me(this,"disabled",!0),this.container=t,this.replay=this.getElement("replay"),this.redo=this.getElement("redo"),this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.npc=document.getElementById("npc"),this.menuToggle=document.getElementById("mainMenuToggle"),this.menuPanel=document.getElementById("mainMenuPanel"),this.setupMenuPanel(),this.setupNpcMenu(),this.updateNpcVisibility(),this.camera&&(this.setMenu(!0),this.camera.onclick=function(e){n.adjustCamera()}),this.npc&&(this.npc.onclick=function(e){n.container.table.allStationary()&&(pe.takeShot(n.container),n.setMenuPanelVisibility(!1))})}var t,n;return t=e,n=[{key:"setMenu",value:function(e){this.replay.disabled=e,this.redo.disabled=e,this.share&&(this.share.disabled=e),e&&this.setMenuPanelVisibility(!1)}},{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"replayMode",value:function(e,t){var n=this;if(this.replay){this.setMenu(!1),this.redo.style.display="";var i=this.container.eventQueue;this.bindShare((function(){!function(e,t){if("object"==("undefined"==typeof process?"undefined":(n=process)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n))return t(e);var n,i=new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search;fetch("https://scoreboard-osmane-billiards.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:i})}).then((function(e){return e.json()})).then((function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))}))}(e,(function(e){var t=function(e){var t,n,i,r={title:"Billiards",text:"Replay break",url:e};return(null===(t=(n=navigator).canShare)||void 0===t?void 0:t.call(n,r))?(navigator.share(r).then((function(){return console.log("shared successfully")})).catch((function(e){console.log("Error: "+e)})),"link shared"):(null===(i=navigator.clipboard)||void 0===i||i.writeText(e),'link copied to clipboard <a href="'.concat(e,'">').concat(e,"</a>"))}(e);i.push(new G.b(null,t))}))})),this.redo.onclick=function(e){var i=new ne.W(t.init,t.shots);i.retry=!0,n.interuptEventQueue(i)},this.replay.onclick=function(e){n.interuptEventQueue(t)}}}},{key:"aimMode",value:function(){var e=this;if(this.replay){this.redo.style.display="none";var t=this.canReplayLastShot();this.replay.disabled=!t,this.share.disabled=!0,this.redo.disabled=!0,this.replay.onclick=function(t){e.container.table.allStationary()&&e.replayLastRecordedShot()}}}},{key:"setupMenuPanel",value:function(){var e=this;this.menuToggle&&this.menuPanel&&(this.menuToggle.addEventListener("click",(function(t){t.stopPropagation(),e.toggleMenuPanel()})),this.menuPanel.addEventListener("click",(function(e){e.stopPropagation()})),document.addEventListener("click",this.handleOutsideClick),document.addEventListener("keydown",this.handleEscapeKey),this.menuPanel.querySelectorAll("a, button").forEach((function(t){"true"!==t.getAttribute("data-keep-open")&&(t.addEventListener("click",e.handlePanelSelection),t.addEventListener("keydown",(function(t){"Enter"!==t.key&&" "!==t.key||e.handlePanelSelection()})))})))}},{key:"toggleMenuPanel",value:function(e){var t="boolean"==typeof e?e:!this.menuPanelVisible;this.setMenuPanelVisibility(t)}},{key:"setMenuPanelVisibility",value:function(e){this.menuPanelVisible=e,this.menuPanel&&this.menuToggle&&(this.menuPanel.classList.toggle("is-visible",e),this.menuPanel.setAttribute("aria-hidden",e?"false":"true"),this.menuToggle.setAttribute("aria-expanded",e?"true":"false"))}},{key:"bindShare",value:function(e){var t=this;this.share&&(this.share.onclick=function(n){e(),t.setMenuPanelVisibility(!1)})}},{key:"setupNpcMenu",value:function(){var e=this;if(this.menuPanel){var t=document.createElement("button");t.className="menuPanel__action",t.textContent="NPC Options",t.setAttribute("data-keep-open","true"),t.onclick=function(t){t.stopPropagation(),e.toggleNpcMenuPanel(!0)},this.menuPanel.insertBefore(t,this.menuPanel.firstChild),this.npcMenuEntry=t;var n=document.createElement("div");n.id="npcMenuPanel",n.className="npcPanel",n.setAttribute("aria-hidden","true");var i=document.createElement("div");i.className="menuPanel__link",i.textContent="NPC Ayarları",n.appendChild(i);var r=function(e,t,i){var r=document.createElement("div");r.style.display="flex",r.style.alignItems="center",r.style.gap="8px";var a=document.createElement("span");a.textContent=e,a.style.minWidth="120px",r.appendChild(a),r.appendChild(t),i&&r.appendChild(i),n.appendChild(r)},a=this.getNpcConfig(),o=document.createElement("div");o.style.display="flex",o.style.alignItems="center",o.style.gap="8px";var s=document.createElement("label");s.textContent="Kısıtlamaları etkinleştir";var l=document.createElement("input");l.type="checkbox",l.checked=!0===a.enabled,o.appendChild(s),o.appendChild(l),n.appendChild(o);var c=document.createElement("input");c.type="range",c.min="0",c.max="90",c.step="0.5";var u=document.createElement("input");u.type="range",u.min="0",u.max="90",u.step="0.5";var h=document.createElement("span"),d=document.createElement("span"),f=function(e){return 180*e/Math.PI},p=function(e){return e*Math.PI/180};c.value=f(a.minElevation).toFixed(1),u.value=f(a.maxElevation).toFixed(1),h.textContent="".concat(parseFloat(c.value),"°"),d.textContent="".concat(parseFloat(u.value),"°"),r("Min Elevation",c,h),r("Max Elevation",u,d);var v=function(){var t,n=parseFloat(c.value),i=parseFloat(u.value);n>i&&(n=(t=[i,n])[0],i=t[1]),c.value=n.toFixed(1),u.value=i.toFixed(1),h.textContent="".concat(n,"°"),d.textContent="".concat(i,"°"),a.minElevation=p(n),a.maxElevation=p(i),e.setNpcConfig(a)};c.oninput=v,u.oninput=v;var m=document.createElement("input");m.type="range",m.min="0",m.max="100",m.step="1";var y=document.createElement("input");y.type="range",y.min="0",y.max="100",y.step="1";var g=document.createElement("span"),b=document.createElement("span");m.value=Math.round(100*a.minPowerPct).toString(),y.value=Math.round(100*a.maxPowerPct).toString(),g.textContent="".concat(m.value,"%"),b.textContent="".concat(y.value,"%"),r("Min Power",m,g),r("Max Power",y,b);var w=function(){var t,n=parseInt(m.value,10),i=parseInt(y.value,10);n>i&&(n=(t=[i,n])[0],i=t[1]),m.value=String(n),y.value=String(i),g.textContent="".concat(n,"%"),b.textContent="".concat(i,"%"),a.minPowerPct=n/100,a.maxPowerPct=i/100,e.setNpcConfig(a)};m.oninput=w,y.oninput=w;var k=document.createElement("input");k.type="range",k.min="0",k.max="100",k.step="1";var P=document.createElement("input");P.type="range",P.min="0",P.max="100",P.step="1";var x=document.createElement("span"),S=document.createElement("span");k.value=Math.round(100*a.minSpin).toString(),P.value=Math.round(100*a.maxSpin).toString(),x.textContent="".concat(k.value,"%"),S.textContent="".concat(P.value,"%"),r("Min Spin Dist.",k,x),r("Max Spin Dist.",P,S);var M=function(){var t,n=parseInt(k.value,10),i=parseInt(P.value,10);n>i&&(n=(t=[i,n])[0],i=t[1]),k.value=String(n),P.value=String(i),x.textContent="".concat(n,"%"),S.textContent="".concat(i,"%"),a.minSpin=n/100,a.maxSpin=i/100,e.setNpcConfig(a)};k.oninput=M,P.oninput=M;var T=document.createElement("input");T.type="checkbox",T.checked=!!a.avoidKissStrict;var E=document.createElement("label");E.textContent="Kiss'i yasakla";var C=document.createElement("div");C.style.display="flex",C.style.alignItems="center",C.style.gap="8px",C.appendChild(E),C.appendChild(T),n.appendChild(C),T.onchange=function(){a.avoidKissStrict=T.checked,e.setNpcConfig(a)};var R=document.createElement("div");R.style.display="flex",R.style.alignItems="center",R.style.gap="8px";var A=document.createElement("span");A.textContent="Arama Yoğunluğu";var I=document.createElement("select");["low","medium","high"].forEach((function(e){var t=document.createElement("option");t.value=e,t.text=e,I.appendChild(t)})),I.value=a.searchDensity,I.onchange=function(){a.searchDensity=I.value,e.setNpcConfig(a)},R.appendChild(A),R.appendChild(I),n.appendChild(R);var O=function(e){c.disabled=u.disabled=!e,m.disabled=y.disabled=!e,k.disabled=P.disabled=!e,T.disabled=!e,I.disabled=!e,n.classList.toggle("is-disabled",!e)};O(l.checked),l.onchange=function(){a.enabled=l.checked,e.setNpcConfig(a),O(l.checked)},document.body.appendChild(n),this.npcMenuPanel=n,document.addEventListener("click",(function(t){if(e.npcPanelVisible&&e.npcMenuPanel){var n=t.target;e.npcMenuPanel.contains(n)||e.toggleNpcMenuPanel(!1)}})),document.addEventListener("keydown",(function(t){"Escape"===t.key&&e.npcPanelVisible&&e.toggleNpcMenuPanel(!1)}))}}},{key:"toggleNpcMenuPanel",value:function(e){if(this.npcMenuPanel&&this.menuPanel){var t="boolean"==typeof e?e:!this.npcPanelVisible;if(this.npcPanelVisible=t,this.npcMenuPanel.classList.toggle("is-visible",t),this.npcMenuPanel.setAttribute("aria-hidden",t?"false":"true"),t){var n=this.menuPanel.getBoundingClientRect();this.npcMenuPanel.style.top="".concat(Math.max(6,n.top),"px"),this.npcMenuPanel.style.bottom="auto",this.npcMenuPanel.style.right="auto";var i=n.right+8,r="undefined"!=typeof window?window.innerWidth:1024,a=this.npcMenuPanel.getBoundingClientRect().width,o=a&&a>0?a:360;i+o>r-6&&(i=Math.max(6,n.left-o-8)),this.npcMenuPanel.style.left="".concat(i,"px"),this.npcMenuPanel.style.display="flex"}else this.npcMenuPanel.style.display="none"}}},{key:"getNpcConfig",value:function(){var e;return null!==(e=this.container.npcConfig)&&void 0!==e?e:pe.getDefaultConfig(this.container)}},{key:"setNpcConfig",value:function(e){this.container.npcConfig=e}},{key:"replayLastRecordedShot",value:function(){if(this.canReplayLastShot()){var e=this.container.recorder;if(e){var t=e.lastShot();if(this.isValidShotState(t)){var n=this.buildReplayUrlFromState(t);n&&(window.open(n,"_blank","noopener"),this.setMenuPanelVisibility(!1))}}}}},{key:"isValidShotState",value:function(e){return!!e&&!!e.init&&Array.isArray(e.shots)&&e.shots.length>0}},{key:"canReplayLastShot",value:function(){var e=this.container.recorder;return!(!e||!e.replayUrl)&&e.shots.length>0}},{key:"buildReplayUrlFromState",value:function(e){var t=this.container.recorder,n=null==t?void 0:t.replayUrl;if(!n)return null;var i=JSON.stringify(e),r=J.A.crush(i),a=encodeURIComponent(r).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\!/g,"%21").replace(/\*/g,"%2A");return"".concat(n).concat(a)}},{key:"interuptEventQueue",value:function(e){this.container.table.halt();var t=this.container.eventQueue;t.length=0,t.push(new i.T),t.push(e)}},{key:"getElement",value:function(e){return document.getElementById(e)}},{key:"updateNpcVisibility",value:function(){var e,t=!!(null===(e=this.container)||void 0===e?void 0:e.isSinglePlayer);this.npc&&(this.npc.style.display=t?"":"none"),this.npcMenuEntry&&(this.npcMenuEntry.style.display=t?"":"none"),!t&&this.npcPanelVisible&&this.toggleNpcMenuPanel(!1)}}],n&&ve(t.prototype,n),e}();function ge(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var be=function(){function e(){var t,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n=void 0,(t="element")in this?Object.defineProperty(this,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[t]=n,this.element=this.getElement("snookerScore")}var t,n;return t=e,(n=[{key:"updateBreak",value:function(e){this.element&&(this.element.innerHTML=e>0?"Break</br>"+e:"")}},{key:"getElement",value:function(e){return document.getElementById(e)}}])&&ge(t.prototype,n),e}(),we=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};function ke(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Pe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function xe(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}var Se=function(){function e(){var t=this,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Pe(this,"whiteScore",0),Pe(this,"yellowScore",0),Pe(this,"highlightClass","scoreButton--highlight"),Pe(this,"container",void 0),this.container=n,this.setupToggle("customBtnLeft"),this.setupToggle("customBtnRight"),this.applyScores(),this.setupWindowResize(),this.setupClickOutside(),setTimeout((function(){t.updateVisibilityBasedOnGameMode()}),100)}var t,n;return t=e,n=[{key:"setScores",value:function(e,t){this.whiteScore=e,this.yellowScore=t,this.applyScores()}},{key:"updateGameModeVisibility",value:function(){this.updateVisibilityBasedOnGameMode()}},{key:"reinitializeEventHandlers",value:function(){this.setupToggle("customBtnLeft"),this.setupToggle("customBtnRight")}},{key:"applyScores",value:function(){"undefined"!=typeof document&&(this.updateButton("customBtnLeft",this.whiteScore,"White Score"),this.updateButton("customBtnRight",this.yellowScore,"Yellow Score"))}},{key:"setupToggle",value:function(e){var t,n=this;if("undefined"!=typeof document){var i=document.getElementById(e);if(xe(i,HTMLButtonElement)){var r=i.cloneNode(!0);null===(t=i.parentNode)||void 0===t||t.replaceChild(r,i),r.addEventListener("click",(function(t){t.stopPropagation(),r.classList.contains(n.highlightClass)?(r.classList.remove(n.highlightClass),n.updateHighlightPosition(e,!1)):(n.closeAllHighlights(),r.classList.add(n.highlightClass),n.updateHighlightPosition(e,!0))}))}}}},{key:"updateHighlightPosition",value:function(e,t){if("undefined"!=typeof document){var n="customBtnLeft"===e?"scoreHighlightLeft":"scoreHighlightRight",i=document.getElementById(n),r=document.getElementById(e);if(i&&r)if(t){var a=r.getBoundingClientRect(),o=window.getComputedStyle(r);i.style.display="block",i.style.width="".concat(a.width,"px"),i.style.left="".concat(a.left,"px"),i.style.top="".concat(a.bottom+2,"px"),this.updatePillFonts(n,o)}else i.style.display="none"}}},{key:"updatePillFonts",value:function(e,t){if("undefined"!=typeof document){var n=document.getElementById(e);n&&n.querySelectorAll(".score-buttons-container a.pill").forEach((function(e){e.style.fontSize=t.fontSize,e.style.fontFamily=t.fontFamily,e.style.fontWeight="bold",e.style.lineHeight=t.lineHeight}))}}},{key:"setupWindowResize",value:function(){var e=this;"undefined"!=typeof window&&window.addEventListener("resize",(function(){var t,n,i,r;e.updateHighlightPosition("customBtnLeft",null!==(i=null===(t=document.getElementById("customBtnLeft"))||void 0===t?void 0:t.classList.contains(e.highlightClass))&&void 0!==i&&i),e.updateHighlightPosition("customBtnRight",null!==(r=null===(n=document.getElementById("customBtnRight"))||void 0===n?void 0:n.classList.contains(e.highlightClass))&&void 0!==r&&r)}))}},{key:"setupClickOutside",value:function(){var e=this;if("undefined"!=typeof document){document.addEventListener("click",(function(t){e.closeAllHighlights()}));var t=document.getElementById("scoreHighlightLeft"),n=document.getElementById("scoreHighlightRight");null==t||t.addEventListener("click",(function(e){e.stopPropagation()})),null==n||n.addEventListener("click",(function(e){e.stopPropagation()}))}}},{key:"closeAllHighlights",value:function(){var e=document.getElementById("customBtnLeft"),t=document.getElementById("customBtnRight");e&&(e.classList.remove(this.highlightClass),this.updateHighlightPosition("customBtnLeft",!1)),t&&(t.classList.remove(this.highlightClass),this.updateHighlightPosition("customBtnRight",!1))}},{key:"updateVisibilityBasedOnGameMode",value:function(){var e,t,n=this;if("undefined"!=typeof document){var i="threecushion"===(null===(t=this.container)||void 0===t||null===(e=t.rules)||void 0===e?void 0:e.rulename),r=[document.getElementById("customBtnLeft"),document.getElementById("customBtnRight")],a=[document.getElementById("scoreHighlightLeft"),document.getElementById("scoreHighlightRight")],o=document.getElementById("targetButton"),s=document.getElementById("targetButtonPlaceholder");r.forEach((function(e){if(e){var t=i?"block":"none";e.style.display=t}})),a.forEach((function(e){e&&(e.style.display="none",e.style.visibility=i?"visible":"hidden")}));var l=function(e){s&&(e?(s.classList.add("is-active"),s.style.display="none",s.style.visibility="hidden"):(s.classList.remove("is-active"),s.style.display="inline-block",s.style.visibility="visible"))};if(o)if(o.dataset.toggleSetup){var c="true"===o.dataset.visible;o.style.display=c?"inline-block":"none",o.classList.toggle("is-active",c),l(c)}else{var u,h=function(e,t){var i,r,a,s,c,u,h,d,f;o.dataset.visible=e?"true":"false",o.style.display=e?"inline-block":"none",o.classList.toggle("is-active",e),l(e),e?(null===(r=n.container)||void 0===r||null===(i=r.trajectoryRenderer)||void 0===i||i.setVisible(!0),t&&(null===(a=n.container)||void 0===a||a.updateTrajectoryPrediction())):(null===(c=n.container)||void 0===c||null===(s=c.trajectoryRenderer)||void 0===s||s.setVisible(!1),null===(h=n.container)||void 0===h||null===(u=h.trajectoryRenderer)||void 0===u||u.clearTrajectories(),null===(f=n.container)||void 0===f||null===(d=f.table)||void 0===d||d.cue.updateHelperCurve(null))},d=0,f=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],n="boolean"==typeof e?e:"none"===o.style.display;h(n,t),d=0,u&&(clearTimeout(u),u=void 0)};null==s||s.addEventListener("click",(function(){d+=1,u&&clearTimeout(u),u=window.setTimeout((function(){d=0,u=void 0}),500),d>=4&&f(!0)})),o.addEventListener("click",(function(){f(!1,!1)})),h(!1,!1),o.dataset.toggleSetup="true"}else s&&(s.style.display="inline-block",s.style.visibility="visible",s.classList.remove("is-active"))}}},{key:"updateButton",value:function(e,t,n){var i=document.getElementById(e);xe(i,HTMLButtonElement)&&(i.textContent=t.toString(),i.setAttribute("aria-label","".concat(n,": ").concat(t)))}}],n&&ke(t.prototype,n),e}(),Me=n(1842);function Te(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ee(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}Math.hypot(s.XM,s.XF);var Ce=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ee(this,"maxSimulationTime",60),Ee(this,"timeStep",ae.C),Ee(this,"sampleInterval",ae.i),Ee(this,"maxRetries",100),Ee(this,"COLLISION_BUG_SHORTEN_DISTANCE",50)}var t,n,i;return t=e,n=[{key:"predictTrajectory",value:function(e,t,n,i,a,o){var l=function(e){var t,n=Number.isFinite(null==e?void 0:e.angle)?e.angle:0,i=null!==(t=null==e?void 0:e.offset)&&void 0!==t?t:{x:0,y:0,z:0},a=new r.Pq0(Number.isFinite(i.x)?i.x:0,Number.isFinite(i.y)?i.y:0,Number.isFinite(i.z)?i.z:0),o=Number.isFinite(null==e?void 0:e.power)?e.power:0;return o<=0&&(o=.25),{angle:n,offset:a,power:o}}(t),c=l.angle,u=l.offset,d=l.power,f="undefined"!=typeof performance?Math.round(performance.now()):Date.now(),p=e.cueball;if(e.cue&&e.cue.aim&&void 0!==e.cue.aim.i){var v=e.cue.aim.i;v>=0&&v<e.balls.length&&(p=e.balls[v])}else n&&n.cueball&&(p=n.cueball);var m=Number.isFinite(a)?a:0,y={tableX:h.P.tableX,tableY:h.P.tableY,X:h.P.X,Y:h.P.Y,hasPockets:h.P.hasPockets};n&&n.tableGeometry&&n.tableGeometry();var g=e.serialise(),b=ie.X.fromSerialised(g,{headless:!0});b.balls.forEach((function(t,n){var i,r;t.physicsContext=null!==(r=null===(i=e.balls[n])||void 0===i?void 0:i.physicsContext)&&void 0!==r?r:s.ZZ}));var w=new Map;e.balls.forEach((function(e,t){var n=b.balls[t];n&&w.set(n.id,e.id)}));var k=e.balls.indexOf(p),P=b.balls[k];P||(P=b.cueball);var x=(0,re.Bl)(P,{angle:c,offset:u,power:d},m);(0,re.gI)(P,x);var S=P.pos.clone();(0,X.uP)("helper_shot",{shotId:f,ballId:P.id,pos:{x:P.pos.x,y:P.pos.y,z:P.pos.z},aim:{angle:c,offset:{x:u.x,y:u.y,z:u.z},power:d},elevation:m,cueDir:{x:x.cueDir.x,y:x.cueDir.y,z:x.cueDir.z},hitPointWorld:{x:x.hitPointWorld.x,y:x.hitPointWorld.y,z:x.hitPointWorld.z},engineDt:this.timeStep,table:g,tableGeometry:{tableX:h.P.tableX,tableY:h.P.tableY,X:h.P.X,Y:h.P.Y,hasPockets:h.P.hasPockets}});var M=new Map;b.balls.forEach((function(e){M.set(e.id,[])}));var T=new Map,E=new Map,C=P.id,R=0,A=!1,I=null,O=new r.Pq0(Math.cos(t.angle),Math.sin(t.angle),0);O.lengthSq()>0&&O.normalize();var B=null!=i&&i&&void 0!==a&&a>.2?null:function(){if(0===O.lengthSq())return null;var e=null;return b.balls.forEach((function(t){if(t.id!==C&&t.onTable()){var n=P.radius+t.radius,i=new r.Pq0(S.x,S.y,0),a=new r.Pq0(t.pos.x,t.pos.y,0).sub(i),o=a.dot(O);if(!(o<=0)){var s=O.clone().multiplyScalar(o),l=n*n,c=a.clone().sub(s).lengthSq();if(!(c>l)){var u=o-Math.sqrt(Math.max(0,l-c));u<0?(null===e||0<e)&&(e=0):(null===e||u<e)&&(e=u)}}}})),e}(),_=function(e,t){var n=M.get(e.id);if(!n)return null;var i={x:e.pos.x,y:e.pos.y,z:e.pos.z};if(n.length>0){var r=n[n.length-1],a=i.x-r.position.x,o=i.y-r.position.y,s=i.z-r.position.z,l=a*a+o*o+s*s;if(l<1e-12)return n.length-1;e.id===C&&(R+=Math.sqrt(l))}return n.push({position:i,ballId:e.id,time:t}),n.length-1},L=0,j=0,N=0,F=new Map,D=new Map,H=null;b.balls.forEach((function(e){(e.inMotion()||e===P)&&_(e,0)}));for(var z=o?Math.min(this.maxSimulationTime,5):this.maxSimulationTime,G=0,q=!1,U=!1,V=!1;L<z;)try{b.advance(this.timeStep),L+=this.timeStep,P.inMotion()&&!A&&_(P,L);var K=b.outcome.slice(N);if(N=b.outcome.length,K.forEach((function(e){if(e.type===Y.$.Collision||e.type===Y.$.Cushion){if(e.type===Y.$.Collision){var t,n,i=null===(t=e.ballA)||void 0===t?void 0:t.id,r=null===(n=e.ballB)||void 0===n?void 0:n.id;if(i===C||r===C){var a=i===C?null!=r?r:null:null!=i?i:null;(0,X.uP)("helper_event",{shotId:f,type:"collision",t:L,pos:{x:P.pos.x,y:P.pos.y,z:P.pos.z},otherBallId:a})}}else if(e.type===Y.$.Cushion){var o;(null===(o=e.ballA)||void 0===o?void 0:o.id)===C&&(0,X.uP)("helper_event",{shotId:f,type:"cushion",t:L,pos:{x:P.pos.x,y:P.pos.y,z:P.pos.z}})}if(e.type===Y.$.Cushion){var s,l=null===(s=e.ballA)||void 0===s?void 0:s.id;if(void 0!==l){var c,u=null!==(c=F.get(l))&&void 0!==c?c:0;F.set(l,u+1),D.has(l)||D.set(l,L)}}else if(e.type===Y.$.Collision){var h,d;null===H&&(H=L,null===(h=e.ballA)||void 0===h||h.id,null===(d=e.ballB)||void 0===d||d.id)}var p=[];e.ballA&&p.push(e.ballA),e.type===Y.$.Collision&&e.ballB&&e.ballB!==e.ballA&&p.push(e.ballB),p.forEach((function(e){if(e&&!T.has(e.id)){var t=_(e,L);null!==t&&(T.set(e.id,t),e.id===C&&(A=!0,null===I&&(I=R,E.set(e.id,I))))}}))}})),P.inMotion()?U=!0:U&&!V&&((0,X.uP)("helper_event",{shotId:f,type:"stop",t:L,pos:{x:P.pos.x,y:P.pos.y,z:P.pos.z},distance:R}),V=!0),b.balls.some((function(e){return e.inMotion()})))G=0;else if(++G>100)break;if(L-j>=this.sampleInterval&&(b.balls.forEach((function(e){e.inMotion()&&_(e,L)})),j=L),b.allStationary())break}catch(e){q=!0;break}V||(0,X.uP)("helper_event",{shotId:f,type:"stop",t:L,pos:{x:P.pos.x,y:P.pos.y,z:P.pos.z}});var W=q;if(null===I){var J=R,Q=null!==B?Math.min(J,B):J;I=Q;var Z=M.get(C);if(Z&&Z.length>0&&Z.length<2){var $=Z[0],ee={x:$.position.x+O.x*Q,y:$.position.y+O.y*Q,z:$.position.z},te=P.vel.length(),ne=te>1e-6?Q/te:0;Z.push({position:ee,ballId:C,time:ne}),E.set(C,Q)}}null===I||E.has(C)||E.set(C,I);var ae=[];M.forEach((function(e,t){var n=w.get(t);if(e.length>1&&void 0!==n)try{var i={ballId:n,points:e,hadSimulationError:W},r=T.get(t);void 0!==r&&(i.firstImpactIndex=r);var a=E.get(t);void 0!==a&&(i.firstImpactDistance=a),ae.push(i)}catch(e){}})),h.P.tableX=y.tableX,h.P.tableY=y.tableY,h.P.X=y.X,h.P.Y=y.Y,h.P.hasPockets=y.hasPockets;try{b.balls.forEach((function(e){try{e.ballmesh&&e.ballmesh.dispose&&e.ballmesh.dispose()}catch(e){}}));try{var oe=b.cue,se=function(e){try{e&&e.geometry&&e.geometry.dispose&&e.geometry.dispose()}catch(e){}};se(null==oe?void 0:oe.mesh),se(null==oe?void 0:oe.placerMesh),se(null==oe?void 0:oe.hitPointMesh),se(null==oe?void 0:oe.virtualCueMesh)}catch(e){}b.outcome=[]}catch(e){}return ae}}],i=[{key:"shouldPredict",value:function(e){var t;return!!(null==e?void 0:e.table)&&!!(null==e||null===(t=e.table)||void 0===t?void 0:t.cueball)}}],n&&Te(t.prototype,n),i&&Te(t,i),e}();function Re(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ae(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Ie=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ae(this,"trajectoryLines",new Map),Ae(this,"scene",void 0),this.scene=t}var t,n;return t=e,(n=[{key:"updateTrajectories",value:function(e,t){var n=this;this.clearTrajectories(),e.forEach((function(e){var i=n.createTrajectoryLine(e,t);i&&(n.trajectoryLines.set(e.ballId,i),n.scene.add(i))}))}},{key:"createTrajectoryLine",value:function(e,t){if(e.points.length<2)return null;var n=t.balls.find((function(t){return t.id===e.ballId}));if(!n)return null;var i=n.ballmesh.color,a=new r.LoY,o=new Float32Array(3*e.points.length);e.points.forEach((function(e,t){o[3*t]=e.position.x,o[3*t+1]=e.position.y,o[3*t+2]=e.position.z+.01})),a.setAttribute("position",new r.THS(o,3));for(var s=2;s<o.length;s+=3)o[s]+=1e-4;a.setAttribute("position",new r.THS(o,3));var l=i.clone();l.multiplyScalar(1.5),l.setHSL(l.getHSL({h:0,s:0,l:0}).h,Math.min(1,1.2*l.getHSL({h:0,s:0,l:0}).s),Math.min(.8,1.3*l.getHSL({h:0,s:0,l:0}).l));var c=new r.mrM({color:l,opacity:.7,transparent:!0,depthWrite:!1}),u=new r.N1A(a,c);return u.userData.trajectoryLine=!0,u.renderOrder=10,u}},{key:"clearTrajectories",value:function(){var e=this;this.trajectoryLines.forEach((function(t){var n,i;e.scene.remove(t),t.geometry.dispose(),n=t.material,(null!=(i=r.mrM)&&"undefined"!=typeof Symbol&&i[Symbol.hasInstance]?i[Symbol.hasInstance](n):n instanceof i)&&t.material.dispose()})),this.trajectoryLines.clear()}},{key:"setVisible",value:function(e){this.trajectoryLines.forEach((function(t){t.visible=e}))}},{key:"dispose",value:function(){this.clearTrajectories()}}])&&Re(t.prototype,n),e}(),Oe=n(8090);function Be(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function _e(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Le(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){_e(e,t,n[t])}))}return e}var je={tiles:12,mirroredRepeat:!1,S:1024,grid:6,periodCells:8,freq:70,amp:0,microMix:.5,seed:7084,baseColor:"#0d8c94",hiColor:"#1bb0b6",bleed:0,normalStrength:0,normalScale:.75,roughness:.59,sheen:0,sheenRoughness:1,sheenColor:"#22a8b0"},Ne=function(e){return e*e*(3-2*e)},Fe=function(e){return Math.max(0,Math.min(1,e))};function De(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=374761393*((e=(e%n+n)%n)+i)+668265263*((t=(t%n+n)%n)-i);return(((r=1274126177*(r^r>>>13))^r>>>16)>>>0)/4294967295}function He(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,a=e/n,o=t/n,s=Math.floor(a),l=Math.floor(o),c=a-s,u=o-l,h=s+1,d=l+1,f=De(s,l,i,r),p=De(h,l,i,r),v=De(s,d,i,r),m=De(h,d,i,r),y=Ne(c),g=Ne(u);return(f*(1-y)+p*y)*(1-g)+(v*(1-y)+m*y)*g}function ze(e){var t=e.replace("#",""),n=3===t.length?parseInt(t.split("").map((function(e){return e+e})).join(""),16):parseInt(t,16);return[n>>16&255,n>>8&255,255&n]}function Ge(e){var t=new r.GOR(e);return t.colorSpace=r.er$,t.anisotropy=8,t.needsUpdate=!0,t}var qe=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),_e(this,"params",void 0),_e(this,"clothMaterial",null),_e(this,"cushionMaterial",null),_e(this,"clothMesh",null),_e(this,"cushionMeshes",[]),_e(this,"lightingConfig",Le({},v.h)),_e(this,"diffuseMap",null),_e(this,"normalMap",null),this.params=Le({},je,null!=n?n:{}),this.lightingConfig=v.J.getLightingConfig(),this.setSurfaces(t),v.J.updateLightingConfig(this.lightingConfig)}var t,n;return t=e,n=[{key:"setSurfaces",value:function(e){var t,n;this.clothMesh=null!==(t=null==e?void 0:e.cloth)&&void 0!==t?t:null,this.cushionMeshes=null!==(n=null==e?void 0:e.cushions)&&void 0!==n?n:[],this.clothMesh&&this.applyMaterials()}},{key:"getCurrentSettings",value:function(){return{cloth:Le({},this.params),lighting:Le({},this.lightingConfig)}}},{key:"updateCloth",value:function(e){this.params=Le({},this.params,e),this.applyMaterials()}},{key:"updateLighting",value:function(e){this.lightingConfig=Le({},this.lightingConfig,e),v.J.updateLightingConfig(this.lightingConfig)}},{key:"applyMaterials",value:function(){var e=this;if(this.clothMesh){var t=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(t<=0)return{canvas:e,innerSize:e.width};var n=e.width,i=n+2*t,r=document.createElement("canvas");r.width=r.height=i;var a=r.getContext("2d");return a.drawImage(e,t,t),a.drawImage(e,0,0,n,t,t,0,n,t),a.drawImage(e,0,n-t,n,t,t,n+t,n,t),a.drawImage(e,0,0,t,n,0,t,t,n),a.drawImage(e,n-t,0,t,n,n+t,t,t,n),a.drawImage(e,0,0,t,t,0,0,t,t),a.drawImage(e,n-t,0,t,t,n+t,0,t,t),a.drawImage(e,0,n-t,t,t,0,n+t,t,t),a.drawImage(e,n-t,n-t,t,t,n+t,n+t,t,t),{canvas:r,innerSize:n}}(function(e){var t=e.S,n=e.grid,i=e.periodCells,r=e.freq,a=e.amp,o=e.microMix,s=e.seed,l=e.baseColor,c=e.hiColor,u=document.createElement("canvas");u.width=u.height=t;for(var h=u.getContext("2d",{willReadFrequently:!0}),d=h.createImageData(t,t),f=d.data,p=ze(l),v=ze(c),m=0,y=0;m<t;m++)for(var g=0;g<t;g++,y+=4){var b=He(g,m,n,i,s),w=He(g+1e3,m+1e3,n,i,s),k=g/t,P=m/t,x=Math.sin((k*r+a*(b-.5))*Math.PI*2),S=Math.sin((P*r+a*(w-.5))*Math.PI*2),M=Math.pow(Math.abs(x)*Math.abs(S),.55),T=He(1.7*g,1.7*m,.7*n,i,s),E=Fe(M=M*(1-o)+T*o);f[y]=p[0]*(1-E)+v[0]*E,f[y+1]=p[1]*(1-E)+v[1]*E,f[y+2]=p[2]*(1-E)+v[2]*E,f[y+3]=255}return h.putImageData(d,0,0),u}(this.params),this.params.bleed),n=t.canvas,i=function(e,t){for(var n=e.width,i=e.getContext("2d").getImageData(0,0,n,n).data,r=new Float32Array(n*n),a=0,o=0;a<i.length;a+=4,o++)r[o]=(.2126*i[a]+.7152*i[a+1]+.0722*i[a+2])/255;var s=document.createElement("canvas");s.width=s.height=n;for(var l=s.getContext("2d"),c=l.createImageData(n,n),u=c.data,h=[-1,0,1,-2,0,2,-1,0,1],d=[-1,-2,-1,0,0,0,1,2,1],f=function(e,t){return r[(t+n)%n*n+(e+n)%n]},p=0,v=0;p<n;p++)for(var m=0;m<n;m++,v+=4){for(var y=0,g=0,b=0,w=-1;w<=1;w++)for(var k=-1;k<=1;k++,b++){var P=f(m+k,p+w);y+=P*h[b],g+=P*d[b]}var x=-y*t,S=-g*t,M=1/Math.hypot(x,S,1);u[v]=255*(x*M*.5+.5),u[v+1]=255*(S*M*.5+.5),u[v+2]=255*(1*M*.5+.5),u[v+3]=255}return l.putImageData(c,0,0),s}(n,this.params.normalStrength);this.diffuseMap?(this.diffuseMap.image=n,this.diffuseMap.needsUpdate=!0):this.diffuseMap=Ge(n),this.normalMap?(this.normalMap.image=i,this.normalMap.needsUpdate=!0):this.normalMap=Ge(i);var a=this.params.mirroredRepeat?r.kTW:r.GJx;this.diffuseMap.wrapS=this.diffuseMap.wrapT=a,this.normalMap.wrapS=this.normalMap.wrapT=a;var o=this.computeRepeat();this.diffuseMap.repeat.copy(o),this.normalMap.repeat.copy(o),this.clothMaterial?(this.clothMaterial.map=this.diffuseMap,this.clothMaterial.normalMap=this.normalMap,this.clothMaterial.roughness=this.params.roughness,this.clothMaterial.sheen=this.params.sheen,this.clothMaterial.sheenRoughness=this.params.sheenRoughness,this.clothMaterial.sheenColor.set(this.params.sheenColor),this.clothMaterial.needsUpdate=!0):(this.clothMaterial=new r.uSd({map:this.diffuseMap,normalMap:this.normalMap,roughness:this.params.roughness,sheen:this.params.sheen,sheenRoughness:this.params.sheenRoughness,sheenColor:new r.Q1f(this.params.sheenColor)}),this.clothMesh.material=this.clothMaterial),this.clothMaterial.normalScale.set(this.params.normalScale,this.params.normalScale),this.cushionMaterial?(this.cushionMaterial.map=this.diffuseMap,this.cushionMaterial.normalMap=this.normalMap,this.cushionMaterial.needsUpdate=!0):this.cushionMaterial=new r.uSd({map:this.diffuseMap,normalMap:this.normalMap,roughness:Math.min(1,this.params.roughness+.1),sheen:.5*this.params.sheen,sheenRoughness:Fe(.85*this.params.sheenRoughness),sheenColor:new r.Q1f(this.params.sheenColor).multiplyScalar(.8)}),this.cushionMaterial.normalScale.set(.6*this.params.normalScale,.6*this.params.normalScale),this.cushionMeshes.forEach((function(t){t.material=e.cushionMaterial})),v.J.updateLightingConfig(this.lightingConfig)}}},{key:"computeRepeat",value:function(){var e,t,n,i;(null===(e=this.clothMesh)||void 0===e?void 0:e.geometry.boundingBox)||null===(i=this.clothMesh)||void 0===i||i.geometry.computeBoundingBox();var a=new r.Pq0(1,1,1);null===(n=this.clothMesh)||void 0===n||null===(t=n.geometry.boundingBox)||void 0===t||t.getSize(a);var o=this.params.tiles,s=o*(0!==a.y?a.y/a.x:1);return new r.I9Y(o,s)}}],n&&Be(t.prototype,n),e}();function Ue(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Ve(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ke(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){Ve(e,t,n[t])}))}return e}var We=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Ve(this,"manager",void 0),Ve(this,"container",void 0),Ve(this,"clothParams",void 0),Ve(this,"lightingParams",void 0),this.manager=t,this.clothParams=Ke({},je),this.container=document.getElementById("constants");var n=t.getCurrentSettings();this.clothParams=Ke({},n.cloth),this.lightingParams=Ke({},n.lighting),this.initialisePanel()}var t,n;return t=e,n=[{key:"initialisePanel",value:function(){var e=this;if(this.container){var t=this.container.querySelector("#caromClothControls");t?t.innerHTML="":((t=document.createElement("div")).id="caromClothControls",t.style.borderTop="1px solid #2c2c2c",t.style.paddingTop="8px",t.style.marginTop="12px",t.style.display="grid",t.style.gap="6px",this.container.appendChild(t)),this.createSectionTitle(t,"Three Cushion Cloth"),this.createRange(t,"tiles","Tiles",1,24,1,this.clothParams.tiles,(function(t){e.clothParams.tiles=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createCheckbox(t,"mirroredRepeat","Mirrored Repeat",this.clothParams.mirroredRepeat,(function(t){e.clothParams.mirroredRepeat=Boolean(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createSelect(t,"resolution","Resolution",[256,512,1024],this.clothParams.S,(function(t){e.clothParams.S=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"grid","Grid",4,24,1,this.clothParams.grid,(function(t){e.clothParams.grid=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"periodCells","Period Cells",4,32,1,this.clothParams.periodCells,(function(t){e.clothParams.periodCells=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"freq","Frequency",10,120,1,this.clothParams.freq,(function(t){e.clothParams.freq=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"amp","Amplitude",0,1,.01,this.clothParams.amp,(function(t){e.clothParams.amp=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"microMix","Micro Mix",0,.5,.01,this.clothParams.microMix,(function(t){e.clothParams.microMix=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createColor(t,"baseColor","Base Color",this.clothParams.baseColor,(function(t){e.clothParams.baseColor=String(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createColor(t,"hiColor","Highlight Color",this.clothParams.hiColor,(function(t){e.clothParams.hiColor=String(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createNumber(t,"seed","Seed",0,9999,1,this.clothParams.seed,(function(t){e.clothParams.seed=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"bleed","Bleed",0,16,1,this.clothParams.bleed,(function(t){e.clothParams.bleed=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"normalStrength","Normal Strength",0,2,.05,this.clothParams.normalStrength,(function(t){e.clothParams.normalStrength=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"normalScale","Normal Scale",0,1,.01,this.clothParams.normalScale,(function(t){e.clothParams.normalScale=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"roughness","Roughness",0,1,.01,this.clothParams.roughness,(function(t){e.clothParams.roughness=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"sheen","Sheen",0,1,.01,this.clothParams.sheen,(function(t){e.clothParams.sheen=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createRange(t,"sheenRoughness","Sheen Roughness",0,1,.01,this.clothParams.sheenRoughness,(function(t){e.clothParams.sheenRoughness=Number(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createColor(t,"sheenColor","Sheen Color",this.clothParams.sheenColor,(function(t){e.clothParams.sheenColor=String(t),e.manager.updateCloth(Ke({},e.clothParams))})),this.createSectionTitle(t,"Lighting & Shadows"),this.createRange(t,"lightAngle","Light Angle",0,360,1,this.lightingParams.orbitAngleDeg,(function(t){e.lightingParams.orbitAngleDeg=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"lightElevation","Light Elevation",-45,80,1,this.lightingParams.elevationDeg,(function(t){e.lightingParams.elevationDeg=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"lightDistance","Distance (diameters)",6,400,.5,this.lightingParams.distanceInDiameters,(function(t){e.lightingParams.distanceInDiameters=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"lightIntensity","Intensity",0,10,.1,this.lightingParams.intensity,(function(t){e.lightingParams.intensity=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"lightDecay","Decay",0,5,.1,this.lightingParams.decay,(function(t){e.lightingParams.decay=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"lightCone","Cone (deg)",10,80,1,this.lightingParams.coneDeg,(function(t){e.lightingParams.coneDeg=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createColor(t,"lightColor","Light Color",this.lightingParams.color,(function(t){e.lightingParams.color=String(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"shadowBlur","Shadow Softness",0,1e3,1,this.lightingParams.shadowBlur,(function(t){e.lightingParams.shadowBlur=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createSelect(t,"shadowMapSize","Shadow Map",[1024,2048,4096],this.lightingParams.shadowMapSize,(function(t){e.lightingParams.shadowMapSize=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"shadowSamples","Blur Samples",4,32,1,this.lightingParams.shadowBlurSamples,(function(t){e.lightingParams.shadowBlurSamples=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"shadowBias","Shadow Bias",-.001,0,5e-5,this.lightingParams.shadowBias,(function(t){e.lightingParams.shadowBias=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"shadowNormalBias","Normal Bias",0,.1,.001,this.lightingParams.shadowNormalBias,(function(t){e.lightingParams.shadowNormalBias=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createCheckbox(t,"castShadow","Cast Shadow",this.lightingParams.castShadow,(function(t){e.lightingParams.castShadow=Boolean(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"shadowNear","Shadow Near",.5,30,.1,this.lightingParams.shadowNear,(function(t){e.lightingParams.shadowNear=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))})),this.createRange(t,"shadowFar","Shadow Far",2,80,.5,this.lightingParams.shadowFar,(function(t){e.lightingParams.shadowFar=Number(t),e.manager.updateLighting(Ke({},e.lightingParams))}))}}},{key:"createSectionTitle",value:function(e,t){var n=document.createElement("h4");n.textContent=t,n.style.margin="12px 0 4px",n.style.fontSize="12px",n.style.color="#9de3ff",n.style.textTransform="uppercase",e.appendChild(n)}},{key:"createRange",value:function(e,t,n,i,r,a,o,s){var l=document.createElement("label");l.style.display="flex",l.style.flexDirection="column",l.style.gap="2px";var c,u=(c=a.toString()).includes(".")?c.split(".")[1].length:0,h=document.createElement("span");h.textContent="".concat(n,": ").concat(o.toFixed(u)),h.style.fontSize="11px",l.appendChild(h);var d=document.createElement("input");d.type="range",d.min=String(i),d.max=String(r),d.step=String(a),d.value=String(o),d.id=t,d.addEventListener("input",(function(e){var t=parseFloat(e.target.value);h.textContent="".concat(n,": ").concat(t.toFixed(u)),s(t)})),l.appendChild(d),e.appendChild(l)}},{key:"createCheckbox",value:function(e,t,n,i,r){var a=document.createElement("label");a.style.display="flex",a.style.alignItems="center",a.style.gap="6px";var o=document.createElement("input");o.type="checkbox",o.id=t,o.checked=i,o.addEventListener("change",(function(e){r(e.target.checked)}));var s=document.createElement("span");s.textContent=n,s.style.fontSize="11px",a.appendChild(o),a.appendChild(s),e.appendChild(a)}},{key:"createColor",value:function(e,t,n,i,r){var a=document.createElement("label");a.style.display="flex",a.style.alignItems="center",a.style.justifyContent="space-between",a.style.gap="8px";var o=document.createElement("span");o.textContent=n,o.style.fontSize="11px";var s=document.createElement("input");s.type="color",s.id=t,s.value=i,s.style.flex="0 0 auto",s.addEventListener("input",(function(e){r(e.target.value)})),a.appendChild(o),a.appendChild(s),e.appendChild(a)}},{key:"createNumber",value:function(e,t,n,i,r,a,o,s){var l=document.createElement("label");l.style.display="flex",l.style.alignItems="center",l.style.justifyContent="space-between",l.style.gap="8px";var c=document.createElement("span");c.textContent=n,c.style.fontSize="11px";var u=document.createElement("input");u.type="number",u.id=t,u.value=String(o),u.min=String(i),u.max=String(r),u.step=String(a),u.style.width="70px",u.addEventListener("change",(function(e){s(parseFloat(e.target.value))})),l.appendChild(c),l.appendChild(u),e.appendChild(l)}},{key:"createSelect",value:function(e,t,n,i,r,a){var o=document.createElement("label");o.style.display="flex",o.style.alignItems="center",o.style.justifyContent="space-between",o.style.gap="8px";var s=document.createElement("span");s.textContent=n,s.style.fontSize="11px";var l=document.createElement("select");l.id=t,i.forEach((function(e){var t=document.createElement("option");t.value=String(e),t.textContent=String(e),e===r&&(t.selected=!0),l.appendChild(t)})),l.addEventListener("change",(function(e){a(parseInt(e.target.value,10))})),o.appendChild(s),o.appendChild(l),e.appendChild(o)}}],n&&Ue(t.prototype,n),e}(),Xe=n(3908);function Ye(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function Je(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Qe(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function Ze(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(i=n.next()).done)&&(a.push(i.value),!t||a.length!==t);o=!0);}catch(e){s=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw r}}return a}}(e,t)||et(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function $e(e){return function(e){if(Array.isArray(e))return Ye(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||et(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function et(e,t){if(e){if("string"==typeof e)return Ye(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?Ye(e,t):void 0}}var tt=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Qe(this,"container",void 0),Qe(this,"panelElement",void 0),Qe(this,"buttonElement",void 0),Qe(this,"cueBallElement",void 0),Qe(this,"cueBallCanvas",void 0),Qe(this,"ctx",void 0),Qe(this,"cueElevationElement",void 0),Qe(this,"cuePowerElement",void 0),Qe(this,"radius",0),Qe(this,"cx",0),Qe(this,"cy",0),Qe(this,"pitch",Math.PI/2),Qe(this,"hitPoint",[0,0,1]),Qe(this,"targetPoint",[0,0,1]),Qe(this,"hitPointRatio",.021),Qe(this,"targetPointRatio",.003),Qe(this,"greyRatio",.75),Qe(this,"blendWidth",2*this.hitPointRatio*1.2),Qe(this,"lightDir",[.6,-.7,.4]),Qe(this,"lightNorm",void 0),Qe(this,"ambientLight",.35),Qe(this,"diffuseLight",.65),Qe(this,"isVisible",!1),Qe(this,"togglePanel",(function(){n.isVisible=!n.isVisible,n.isVisible?(n.panelElement.classList.add("is-visible"),n.buttonElement.classList.add("is-active"),setTimeout((function(){n.initializeCanvas()}),50)):(n.panelElement.classList.remove("is-visible"),n.buttonElement.classList.remove("is-active"))})),Qe(this,"isDragging",!1),Qe(this,"onMouseDown",(function(e){n.isDragging=!0,n.updateHitPoint(e)})),Qe(this,"onMouseUp",(function(){n.isDragging=!1})),Qe(this,"onMouseLeave",(function(){n.isDragging=!1})),Qe(this,"onMouseMove",(function(e){n.isDragging&&n.updateHitPoint(e)})),Qe(this,"onClick",(function(e){n.updateHitPoint(e)})),Qe(this,"elevationChanged",(function(e){var t=e.target,i=parseFloat(t.value),r=i*Math.PI/180;n.container.table.cue.elevation=r,n.container.table.cue.aim.elevation=r,n.pitch=Math.PI/2-r,n.hitPoint=n.pushToWhiteArea(n.hitPoint),n.syncHitPointToCue();var a=n.container.table.cue.aimInputs;a&&(a.pitch=n.pitch,a.hitPoint=$e(n.hitPoint),a.cueElevationElement&&(a.cueElevationElement.value=i.toString()),a.drawSphere()),n.drawSphere(),n.container.lastEventTime=performance.now(),n.container.updateTrajectoryPrediction()})),Qe(this,"powerChanged",(function(e){var t=parseFloat(n.cuePowerElement.value);n.container.table.cue.setPower(t);var i=n.container.table.cue.aimInputs;i&&i.cuePowerElement&&(i.cuePowerElement.value=t.toString()),n.container.lastEventTime=performance.now(),n.container.updateTrajectoryPrediction()})),this.container=t,this.panelElement=document.getElementById("precisionPanel"),this.buttonElement=document.getElementById("precisionButton"),this.cueBallElement=document.getElementById("precisionCueBall"),this.cueBallCanvas=document.getElementById("precisionCueBallCanvas"),this.ctx=this.cueBallCanvas.getContext("2d",{alpha:!1}),this.cueElevationElement=document.getElementById("precisionCueElevation"),this.cuePowerElement=document.getElementById("precisionCuePower");var i=Math.sqrt(Math.pow(this.lightDir[0],2)+Math.pow(this.lightDir[1],2)+Math.pow(this.lightDir[2],2));this.lightNorm=[this.lightDir[0]/i,this.lightDir[1]/i,this.lightDir[2]/i],this.initializeCanvas(),this.addListeners()}var t,n;return t=e,n=[{key:"initializeCanvas",value:function(){var e=this.cueBallElement.getBoundingClientRect(),t=Math.min(e.width,e.height);t<=0||(this.cueBallCanvas.width=t,this.cueBallCanvas.height=t,this.cx=t/2,this.cy=t/2,this.radius=Math.floor(.51*t),this.syncFromOriginal(),this.drawSphere())}},{key:"addListeners",value:function(){var e,t,n,i,r,a,o,s;null===(e=this.buttonElement)||void 0===e||e.addEventListener("click",this.togglePanel),null===(t=this.cueBallCanvas)||void 0===t||t.addEventListener("mousedown",this.onMouseDown),null===(n=this.cueBallCanvas)||void 0===n||n.addEventListener("mouseup",this.onMouseUp),null===(i=this.cueBallCanvas)||void 0===i||i.addEventListener("mouseleave",this.onMouseLeave),null===(r=this.cueBallCanvas)||void 0===r||r.addEventListener("mousemove",this.onMouseMove),null===(a=this.cueBallCanvas)||void 0===a||a.addEventListener("click",this.onClick),null===(o=this.cueElevationElement)||void 0===o||o.addEventListener("input",this.elevationChanged),null===(s=this.cuePowerElement)||void 0===s||s.addEventListener("input",this.powerChanged)}},{key:"hide",value:function(){this.isVisible&&(this.isVisible=!1,this.panelElement.classList.remove("is-visible"),this.buttonElement.classList.remove("is-active"))}},{key:"getIsVisible",value:function(){return this.isVisible}},{key:"syncFromOriginal",value:function(){var e=this.container.table.cue,t=e.aimInputs,n=180*e.elevation/Math.PI;this.cueElevationElement.value=n.toString(),this.pitch=Math.PI/2-e.elevation;var i=e.aim.power/e.maxPower;this.cuePowerElement.value=i.toString(),t&&(this.hitPoint=$e(t.hitPoint),this.targetPoint=$e(t.targetPoint)),this.isVisible&&this.drawSphere()}},{key:"syncToOriginal",value:function(){var e=this.container.table.cue.aimInputs;e&&(e.hitPoint=$e(this.hitPoint),e.pitch=this.pitch,e.drawSphere())}},{key:"updateHitPoint",value:function(e){var t=this.cueBallCanvas.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top,a=n-this.cx,o=i-this.cy,s=this.radius*this.radius;if(a*a+o*o<=s){var l=Math.sqrt(Math.max(0,s-a*a-o*o)),c=a/this.radius,u=o/this.radius,h=[c,u,l/this.radius];if(this.isInWhiteArea(h)){this.hitPoint=h;var d=-c,f=-u;this.container.table.cue.setSpin(new r.Pq0(d,f,0),this.container.table),this.syncToOriginal(),this.drawSphere(),this.container.lastEventTime=performance.now(),this.container.updateTrajectoryPrediction()}}}},{key:"syncHitPointToCue",value:function(){var e=-this.hitPoint[0],t=-this.hitPoint[1];this.container.table.cue.setSpin(new r.Pq0(e,t,0),this.container.table),this.syncToOriginal()}},{key:"rotateX",value:function(e,t){var n=Math.sin(t),i=Math.cos(t);return[e[0],i*e[1]-n*e[2],n*e[1]+i*e[2]]}},{key:"smoothstep",value:function(e,t,n){var i=(n-e)/(t-e);return(i=Math.max(0,Math.min(1,i)))*i*(3-2*i)}},{key:"isInWhiteArea",value:function(e){var t=Ze(this.rotateX(e,this.pitch),3),n=(t[0],t[1]);return t[2],.5*(n+1)<1-this.greyRatio}},{key:"pushToWhiteArea",value:function(e){var t=Ze(this.rotateX(e,this.pitch),3),n=t[0],i=t[1],r=t[2],a=.5*(i+1),o=1-this.greyRatio;if(a>=o){var s=2*(o-.02)-1,l=Math.sin(this.pitch),c=Math.cos(this.pitch),u=c*s+l*r,h=-l*s+c*r,d=Math.sqrt(n*n+u*u+h*h);return[n/d,u/d,h/d]}return e}},{key:"applyLighting",value:function(e,t){var n=Math.max(0,t[0]*this.lightNorm[0]+t[1]*this.lightNorm[1]+t[2]*this.lightNorm[2]),i=this.ambientLight+this.diffuseLight*n;return[Math.min(255,e[0]*i),Math.min(255,e[1]*i),Math.min(255,e[2]*i)]}},{key:"drawSphere",value:function(){if(this.ctx){var e=this.cueBallCanvas.width,t=this.cueBallCanvas.height;if(!(e<=0||t<=0)&&isFinite(e)&&isFinite(t)){var n=this.ctx.createLinearGradient(0,0,0,t);n.addColorStop(0,"rgb(0, 64, 94)"),n.addColorStop(1,"#000214"),this.ctx.fillStyle=n,this.ctx.fillRect(0,0,e,t);for(var i=this.ctx.createImageData(e,t),r=i.data,a=this.radius*this.radius,o=[0,64,94],s=0;s<r.length;s+=4)r[s]=o[0],r[s+1]=o[1],r[s+2]=o[2],r[s+3]=255;for(var l=-this.radius;l<=this.radius;l++){var c=l,u=this.cy+c|0;if(!(u<0||u>=t))for(var h=Math.floor(Math.sqrt(Math.max(0,a-c*c))),d=-h;d<=h;d++){var f=d,p=this.cx+f|0,v=Math.sqrt(Math.max(0,a-f*f-c*c)),m=f/this.radius,y=c/this.radius,g=v/this.radius,b=Ze(this.rotateX([m,y,g],this.pitch),3),w=(b[0],b[1]),k=(b[2],m*this.hitPoint[0]+y*this.hitPoint[1]+g*this.hitPoint[2]),P=1-2*this.hitPointRatio,x=m*this.targetPoint[0]+y*this.targetPoint[1]+g*this.targetPoint[2],S=1-2*this.targetPointRatio,M=void 0,T=void 0,E=void 0;if(k>=P){var C=[0,64,94],R=(k-P)/(1-P),A=this.smoothstep(0,.3,R),I=.5*(w+1),O=1-this.greyRatio,B=[217,217,217],_=[144,144,144],L=this.smoothstep(O-this.blendWidth,O,I);M=(B[0]*(1-L)+_[0]*L)*(1-A)+C[0]*A,T=(B[1]*(1-L)+_[1]*L)*(1-A)+C[1]*A,E=(B[2]*(1-L)+_[2]*L)*(1-A)+C[2]*A}else{var j=.5*(w+1),N=1-this.greyRatio,F=[217,217,217],D=[144,144,144],H=this.smoothstep(N-this.blendWidth,N,j);M=F[0]*(1-H)+D[0]*H,T=F[1]*(1-H)+D[1]*H,E=F[2]*(1-H)+D[2]*H}if(x>=S){var z=[255,0,0],G=(x-S)/(1-S),q=.3*this.smoothstep(0,.3,G);M=M*(1-q)+z[0]*q,T=T*(1-q)+z[1]*q,E=E*(1-q)+z[2]*q}var U=this.applyLighting([M,T,E],[m,y,g]);M=U[0],T=U[1],E=U[2];var V=4*(u*e+p);r[V]=0|M,r[V+1]=0|T,r[V+2]=0|E,r[V+3]=255}}this.ctx.putImageData(i,0,0)}}}},{key:"updateTargetPoint",value:function(e){this.targetPoint=e,this.drawSphere()}}],n&&Je(t.prototype,n),e}(),nt=n(8086);function it(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function rt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var at=function(){return"undefined"!=typeof performance?performance.now():Date.now()},ot=function(){function e(t,n,i,r,a,o){var l=this;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),rt(this,"table",void 0),rt(this,"view",void 0),rt(this,"controller",void 0),rt(this,"inputQueue",[]),rt(this,"eventQueue",[]),rt(this,"keyboard",void 0),rt(this,"sound",void 0),rt(this,"chat",void 0),rt(this,"sliders",void 0),rt(this,"recorder",void 0),rt(this,"id",""),rt(this,"isSinglePlayer",!0),rt(this,"rules",void 0),rt(this,"menu",void 0),rt(this,"hud",void 0),rt(this,"lobbyIndicator",void 0),rt(this,"scoreButtons",void 0),rt(this,"trajectoryPredictor",void 0),rt(this,"trajectoryRenderer",void 0),rt(this,"caromClothManager",void 0),rt(this,"clothPanel",void 0),rt(this,"precisionPanel",void 0),rt(this,"frame",void 0),rt(this,"wasMoving",!1),rt(this,"debugModeEnabled",!1),rt(this,"isPaused",!1),rt(this,"pauseResumeCallback",void 0),rt(this,"cameraControlsLocked",!1),rt(this,"isNpcAnimating",!1),rt(this,"last",performance.now()),rt(this,"step",.001953125),rt(this,"currentShotId",void 0),rt(this,"currentCueBallId",void 0),rt(this,"processedOutcomes",0),rt(this,"stopLogged",!1),rt(this,"shotLastPos",void 0),rt(this,"shotTotalDistance",0),rt(this,"broadcast",(function(){})),rt(this,"log",void 0),rt(this,"sendChat",(function(e){l.sendEvent(new G.b(l.id,e))})),rt(this,"throttle",new K(0,(function(e){l.broadcast(e)}))),rt(this,"lastEventTime",performance.now()),this.log=n,this.scoreButtons=new Se(this),this.rules=te.V.create(r,this),this.table=this.rules.table(),"threecushion"===this.rules.rulename&&(this.table.cue=new nt.s(void 0,s.ZZ.R)),this.view=new b(t,this.table,i),this.trajectoryPredictor=new Ce,this.trajectoryRenderer=new Ie(this.view.scene),this.trajectoryRenderer.setVisible(!1),this.table.cue.container=this,this.table.cue.aimInputs=new R(this),this.keyboard=a,this.sound=i.sound,this.chat=new z(this.sendChat,this),this.sliders=new W.r(void 0,this),this.debugModeEnabled=this.sliders.isVisible(),this.view.setDebugMode(this.debugModeEnabled),this.table.showSpin(this.debugModeEnabled),this.table.showTraces(this.debugModeEnabled),this.table.showVirtualCue(this.debugModeEnabled),this.recorder=new ee(this),this.id=o,this.menu=new ye(this),this.table.addToScene(this.view.scene),"threecushion"===this.rules.rulename){var c,u=null!==(c=Xe.o.caromSurfaces)&&void 0!==c?c:null;this.caromClothManager=new qe(u),this.clothPanel=new We(this.caromClothManager),u||setTimeout((function(){var e,t;null===(e=l.caromClothManager)||void 0===e||e.setSurfaces(null!==(t=Xe.o.caromSurfaces)&&void 0!==t?t:null)}),0)}this.hud=new be,this.lobbyIndicator=new we,this.precisionPanel=new tt(this),this.updateController(new w.J(this)),this.wasMoving=!this.table.allStationary();var h=function(){l.table.allStationary()?l.updateTrajectoryPrediction():requestAnimationFrame(h)};requestAnimationFrame(h),"undefined"!=typeof window&&window.addEventListener("keydown",(function(e){"Enter"===e.key&&l.isPaused&&(l.resumePhysics(),e.stopPropagation(),e.preventDefault())}),!0)}var t,n;return t=e,n=[{key:"lockCameraControls",value:function(e){this.cameraControlsLocked=!!e}},{key:"isCameraControlsLocked",value:function(){return this.cameraControlsLocked}},{key:"setNpcAnimating",value:function(e){var t,n,i,r,a,o,s,l,c,u,h,d;this.isNpcAnimating=!!e,e?(null===(n=this.keyboard)||void 0===n||null===(t=n.disableDragControls)||void 0===t||t.call(n),null===(o=this.table)||void 0===o||null===(a=o.cue)||void 0===a||null===(r=a.aimInputs)||void 0===r||null===(i=r.disableInputs)||void 0===i||i.call(r)):(null===(l=this.keyboard)||void 0===l||null===(s=l.enableDragControls)||void 0===s||s.call(l),null===(d=this.table)||void 0===d||null===(h=d.cue)||void 0===h||null===(u=h.aimInputs)||void 0===u||null===(c=u.enableInputs)||void 0===c||c.call(u))}},{key:"sendEvent",value:function(e){this.throttle.send(e)}},{key:"advance",value:function(e){var t;null===(t=this.frame)||void 0===t||t.call(this,e);for(var n=Math.floor(e/this.step),r=n*this.step,a=this.table.allStationary(),o=0;o<n;o++)this.table.advance(this.step);this.logShotEvents(),this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim,this.isNpcAnimating),this.table.cue.update(r),this.updateDynamicCameraTracking(),!a&&this.table.allStationary()&&(this.eventQueue.push(new i.T),this.updateTrajectoryPrediction(),this.currentShotId=void 0,this.currentCueBallId=void 0,this.processedOutcomes=0,this.wasMoving=!1,this.stopLogged=!1,this.shotLastPos=void 0,this.shotTotalDistance=0),this.sound.processOutcomes(this.table.outcome)}},{key:"logShotEvents",value:function(){var e=this;if(void 0!==this.currentShotId&&void 0!==this.currentCueBallId){var t=this.table.balls.find((function(t){return t.id===e.currentCueBallId}));if(t){if(this.shotLastPos){var n=t.pos.x-this.shotLastPos.x,i=t.pos.y-this.shotLastPos.y,r=t.pos.z-this.shotLastPos.z,a=Math.sqrt(n*n+i*i+r*r);Number.isFinite(a)&&a>0&&(this.shotTotalDistance+=a,this.shotLastPos.copy(t.pos))}else this.shotLastPos=t.pos.clone();var o=this.table.outcome.slice(this.processedOutcomes);this.processedOutcomes=this.table.outcome.length,o.forEach((function(n){if(n.type===Y.$.Collision){var i,r,a=null===(i=n.ballA)||void 0===i?void 0:i.id,o=null===(r=n.ballB)||void 0===r?void 0:r.id;if(a===e.currentCueBallId||o===e.currentCueBallId){var s=a===e.currentCueBallId?null!=o?o:null:null!=a?a:null;(0,X.uP)("event",{shotId:e.currentShotId,type:"collision",t:e.last/1e3,pos:{x:t.pos.x,y:t.pos.y,z:t.pos.z},otherBallId:s})}}else if(n.type===Y.$.Cushion){var l;(null===(l=n.ballA)||void 0===l?void 0:l.id)===e.currentCueBallId&&(0,X.uP)("event",{shotId:e.currentShotId,type:"cushion",t:e.last/1e3,pos:{x:t.pos.x,y:t.pos.y,z:t.pos.z}})}})),t.inMotion()?this.wasMoving=!0:this.wasMoving&&!this.stopLogged&&((0,X.uP)("event",{shotId:this.currentShotId,type:"stop",t:this.last/1e3,pos:{x:t.pos.x,y:t.pos.y,z:t.pos.z},distance:this.shotTotalDistance}),this.stopLogged=!0)}}}},{key:"toggleDebugMode",value:function(){this.setDebugMode(!this.debugModeEnabled)}},{key:"setDebugMode",value:function(e){if(this.debugModeEnabled!==e){this.debugModeEnabled=e,this.sliders.setVisible(e),this.table.showSpin(e),this.table.showTraces(e),this.table.showVirtualCue(e),this.view.setDebugMode(e);var t=(0,Oe.lq)();console.log("🔧 Debug Physics Mode: ".concat(t?"ENABLED":"DISABLED"," - Black arrow ").concat(t?"will appear":"hidden"," on next shot")),e||(0,Oe.AL)(this.view.scene)}}},{key:"isDebugModeEnabled",value:function(){return this.debugModeEnabled}},{key:"processEvents",value:function(){var e=this;if(this.keyboard&&!this.isPaused&&this.keyboard.getEvents().forEach((function(t){return e.inputQueue.push(t)})),!this.isPaused)for(;this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this,n=at(),i=(e-this.last)/1e3,r=this.wasMoving,a=Math.max(i,0),o=at();this.isPaused||this.advance(a);var s=at()-o;this.last=e;var l=at();this.processEvents();var c=at()-l,u=0;if(this.isNpcAnimating||e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged()){var h=at();this.view.render(),u=at()-h}var d=at()-n;(0,Me.Hh)({physics:s,process:c,render:u,total:d,dtMs:1e3*a,rawElapsedMs:1e3*a,deltaMs:1e3*a,steps:0,simulatedMs:1e3*a,accumulatorBefore:0,accumulatorAfterAdd:0,accumulatorAfter:0,backlogBefore:0,backlogAfter:0,deltaClamped:!1,accumulatorClamped:!1,hitMaxSubSteps:!1,accumulatorTrimmedPostStep:!1});var f,p=!this.table.allStationary();r&&!p&&(0,Me.Q6)(),!r&&p&&(null===(f=this.precisionPanel)||void 0===f||f.hide()),this.wasMoving=p,this.menu.replay&&"Aim"===F(this.controller)&&(this.menu.replay.disabled=p),requestAnimationFrame((function(e){t.animate(e)}))}},{key:"updateController",value:function(e){e!==this.controller&&(this.log("Transition to "+F(e)),this.controller=e,this.controller.onFirst())}},{key:"updateDynamicCameraTracking",value:function(){var e=this;if(!this.cameraControlsLocked&&this.view.camera.mode===this.view.camera.aimView){var t=this.table.cue.aim;if(this.table.allStationary())this.view.camera.resetDynamicAdjustments(t.pos);else{var n=this.table.balls.filter((function(e){return e.inMotion()}));if(0!==n.length){var i=n.find((function(t){return t===e.table.cueball}))||n[0],r=this.view.worldToScreen(i.pos),o=0;try{var l,c,u,h="undefined"!=typeof document?document.querySelector(".panel"):void 0,d=(null===(l=this.view)||void 0===l?void 0:l.windowHeight)||(null===(u=this.view)||void 0===u||null===(c=u.element)||void 0===c?void 0:c.offsetHeight)||0;h&&d>0&&(o=2*h.offsetHeight/d)}catch(e){}var f,p=-1+o,v=(p+1)/2,m=2*(r.y-v),y=Math.sqrt(r.x*r.x+m*m),g=this.view.camera.camera,b=null!==(f=i.radius)&&void 0!==f?f:s.R,w=g.fov*Math.PI/180,k=2*b/(2*this.view.camera.getCurrentAimDistance()*Math.tan(w/2)),P=3*k,x=p+Math.min(2*k,.3);if(y>P){for(var S=i.pos.clone().sub(t.pos),M=(0,a.FP)(S.y,S.x)-t.angle;M>Math.PI;)M-=2*Math.PI;for(;M<-Math.PI;)M+=2*Math.PI;var T=y-P,E=.7*Math.min(T/P,1);if(r.y<x){var C=x-r.y,R=Math.min(1,2*C);E=Math.min(1,Math.max(E,E*(1+R)))}var A=i.pos.clone().add(i.vel.clone().multiplyScalar(.03)),I=this.view.worldToScreen(A),O=I.x-r.x,B=I.y-r.y,_=Math.sqrt(O*O+B*B),L=Math.max(0,Math.min(1,_/.06)),j=this.view.distanceToScreenEdge(r),N=Math.max(0,2*(j-.5));r.y>=x&&(E*=1-.65*L*N);var F=i.pos.clone().sub(t.pos);F.z=0;var D,H,z=F.length(),G=2*(null!==(D=i.radius)&&void 0!==D?D:s.R)>0?z/(2*(null!==(H=i.radius)&&void 0!==H?H:s.R)):0;r.y>=x&&j>.25&&(E*=1-.5*Math.max(0,Math.min(1,(G-15)/15)));var q=M*E,U=t.pos.clone().lerp(i.pos,E),V=1+.5*E,K=this.view.camera.getBaseAimDistance()*V;if(this.view.camera.adjustTrackingCamera(K,q,U),r.y<x){var W=x-r.y,X=Math.max(.25,.5-.15*W);this.view.camera.setLookAtHeightFactor(X)}else this.view.camera.setLookAtHeightFactor(.5)}else{var Y=this.view.camera.getCurrentAimDistance(),J=this.view.camera.getBaseAimDistance();Y>1.05*J?this.view.camera.adjustAimDistance(J):this.view.camera.resetAimDistance();var Q=this.view.camera.getCurrentRotationOffset();Math.abs(Q)>.01?this.view.camera.adjustRotation(.5*Q,t.pos):this.view.camera.resetRotation(t.pos),this.view.camera.setLookAtHeightFactor(.5);var Z=i.pos.clone().add(i.vel.clone().multiplyScalar(.03)),$=this.view.worldToScreen(Z),ee=$.x-r.x,te=$.y-r.y,ne=Math.sqrt(ee*ee+te*te),ie=Math.max(0,Math.min(1,ne/.06)),re=this.view.distanceToScreenEdge(r),ae=Math.max(0,2*(re-.5));if(ae>.2&&ie>.3){var oe=this.view.camera.getBaseAimDistance()*(1+.5*ie*ae);this.view.camera.adjustAimDistance(oe)}}}else this.view.camera.resetDynamicAdjustments(t.pos)}}}},{key:"adjustCameraForLastGhostBall",value:function(){if(this.view.camera.mode===this.view.camera.aimView){var e=(this.table.cue.ghostBalls||[]).filter((function(e){return e.visible}));if(0!==e.length){var t=e[e.length-1];if(this.view.viewFrustrum().intersectsObject(t))this.view.camera.resetAimDistance();else{var n=this.table.cueball.pos,i=t.position,r=(this.table.cue.aim,i.x-n.x),a=i.y-n.y,o=Math.sqrt(r*r+a*a),s=this.view.camera.camera,l=s.fov*Math.PI/180,c=s.aspect,u=l,h=2*Math.atan(Math.tan(u/2)*c),d=1.3*o/Math.tan(h/2);this.view.camera.adjustAimDistance(d)}}else this.view.camera.resetAimDistance()}else this.view.camera.resetAimDistance()}},{key:"updateTrajectoryPrediction",value:function(){var e,t=document.getElementById("targetButton"),n=null!==(e=null==t?void 0:t.classList.contains("is-active"))&&void 0!==e&&e;if(!Ce.shouldPredict(this)||!this.table.allStationary())return this.trajectoryRenderer.clearTrajectories(),this.table.cue.updateHelperCurve(null),void this.view.camera.resetAimDistance();this.table.cue.aim.power<.01&&(this.table.cue.aim.power=.5*this.table.cue.maxPower);try{var i,a,o,l=this.table.cue.masseMode,c=this.table.cue.elevation,u=null!==(o=null===(i=this.rules)||void 0===i?void 0:i.cueball)&&void 0!==o?o:this.table.cueball;this.table.cue.aim.i=this.table.balls.indexOf(u);var h,d=!n,f=this.trajectoryPredictor.predictTrajectory(this.table,this.table.cue.aim,this.rules,l,c,d),p=30*(null!==(h=null===(a=this.table.cueball)||void 0===a?void 0:a.radius)&&void 0!==h?h:s.R)/.5,v=function(e,t){if(0===e.length)return[];if(t<=0)return[e[0].clone()];for(var n=[e[0].clone()],i=0,r=1;r<e.length;r++){var a=e[r-1],o=e[r],s=o.clone().sub(a),l=s.length();if(0!==l){if(!(i+l<=t)){var c=t-i;if(c>=0){var u=a.clone().add(s.multiplyScalar(c/l));n.push(u)}break}n.push(o.clone()),i+=l}}return n.length<2&&e.length>=2&&n.push(e[1].clone()),n};if(f&&f.length>0){var m,y,g=this.table.cueball.id;if(Number.isInteger(null===(y=this.table.cue)||void 0===y||null===(m=y.aim)||void 0===m?void 0:m.i)){var b,w,k=this.table.cue.aim.i;g=null!==(w=null===(b=this.table.balls[k])||void 0===b?void 0:b.id)&&void 0!==w?w:g}var P=f.find((function(e){return e.ballId===g}));if(P&&P.points.length>=2){var x=P.points.map((function(e){return new r.Pq0(e.position.x,e.position.y,e.position.z)})),S=x;if(void 0!==P.firstImpactIndex&&P.firstImpactIndex>=0){var M=Math.min(P.firstImpactIndex+1,x.length);S=x.slice(0,M)}else void 0!==P.firstImpactDistance?S=v(x,Math.min(P.firstImpactDistance,p)):d&&(S=v(x,p));var T=P.firstImpactDistance,E=p-1e-6,C=void 0!==P.firstImpactIndex||void 0!==T&&T<E,R=f.some((function(e){return e.ballId!==g&&void 0!==e.firstImpactIndex}));this.table.cue.updateHelperCurve(S,C,R)}else this.table.cue.updateHelperCurve(null)}else this.table.cue.updateHelperCurve(null);n?(this.trajectoryRenderer.updateTrajectories(f,this.table),this.trajectoryRenderer.setVisible(!0)):this.trajectoryRenderer.setVisible(!1),this.adjustCameraForLastGhostBall()}catch(e){this.trajectoryRenderer.clearTrajectories(),this.table.cue.updateHelperCurve(null),this.view.camera.resetAimDistance()}}},{key:"pausePhysics",value:function(e){this.isPaused=!0,this.pauseResumeCallback=e,this.log("⏸️  Physics paused (press Enter to continue)")}},{key:"resumePhysics",value:function(){this.isPaused&&(this.isPaused=!1,this.log("▶️  Physics resumed"),this.keyboard&&(this.keyboard.pressed={},this.keyboard.released={}),this.inputQueue=[],this.pauseResumeCallback&&(this.pauseResumeCallback(),this.pauseResumeCallback=void 0))}},{key:"isPhysicsPaused",value:function(){return this.isPaused}}],n&&it(t.prototype,n),e}()},3645:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{$:()=>a,P:()=>o});var a=function(e){return e.Pot="Pot",e.Cushion="Cushion",e.Collision="Collision",e.Hit="Hit",e}({}),o=function(){function e(t,n,i,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=t,this.ballA=n,this.ballB=i,this.incidentSpeed=a,this.timestamp=Date.now()}var t,n;return t=e,n=[{key:"pot",value:function(t,n){return new e("Pot",t,t,n)}},{key:"cushion",value:function(t,n){return new e("Cushion",t,t,n)}},{key:"collision",value:function(t,n,i){return new e("Collision",t,n,i)}},{key:"hit",value:function(t,n){return new e("Hit",t,t,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some((function(t){return"Pot"==t.type&&t.ballA===e}))}},{key:"isBallPottedNoFoul",value:function(t,n){return n.some((function(e){return"Pot"==e.type&&null!==e.ballA}))&&!e.isCueBallPotted(t,n)}},{key:"pots",value:function(e){return e.filter((function(e){return"Pot"==e.type})).map((function(e){return e.ballA}))}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every((function(e){return e.id>6}))}},{key:"firstCollision",value:function(e){var t=e.filter((function(e){return"Collision"===e.type}));return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter((function(e){return e.onTable()}));return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(t,n){n=e.cueBallFirst(t,n).filter((function(e){return e.ballA===t}));var i=new Set,r=0,a=!0,o=!1,s=void 0;try{for(var l,c=n[Symbol.iterator]();!(a=(l=c.next()).done);a=!0){var u=l.value;if("Cushion"===u.type&&r++,"Collision"===u.type&&(i.add(u.ballB),2===i.size))return r>=3}}catch(e){o=!0,s=e}finally{try{a||null==c.return||c.return()}finally{if(o)throw s}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach((function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)})),t}}],null&&i(t.prototype,null),n&&i(t,n),e}()},3908:(e,t,n)=>{n.d(t,{o:()=>c});var i=n(4922),r=n(665),a=n(91),o=n(5418);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"logger",(function(e){})),l(this,"cloth",new i.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),l(this,"cushion",new i.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),l(this,"pocket",new i.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3})),l(this,"frameMaterial",new i.tXL({color:9132587,emissive:new i.Q1f(3085832),emissiveIntensity:.2,shininess:35}))}var t,n;return t=e,n=[{key:"generateTable",value:function(e){var t=this,n=new i.YJl;if(this.addCushions(n,e),e){a.f.knuckles.forEach((function(e){return t.knuckleCylinder(e,n)})),a.f.pocketCenters.forEach((function(e){return t.knuckleCylinder(e,n,t.pocket)}));var r=a.f.pockets.pocketNW.pocket,o=a.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(r.pos.distanceTo(o.pos)-r.radius-o.radius))}return this.addWoodenFrame(n),n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*o.R/.5,t,n).position.setZ(.25*-o.R/.5/2)}},{key:"cylinder",value:function(e,t,n,r,a){var o=new i.Ho_(t,t,n,16),s=new i.eaF(o,a);return s.position.copy(e),s.geometry.applyMatrix4((new i.kn4).identity().makeRotationAxis(new i.Pq0(1,0,0),Math.PI/2)),r.add(s),s}},{key:"addCushions",value:function(t,n){e.caromSurfaces=null;var a=r.P.X,s=r.P.Y,l=1.5*o.R,c=this.plane(new i.Pq0(0,0,-o.R-l/2),2*a,2*s,l,t,this.cloth);if(!n){var u=[],h=1.25*o.R,d=2*o.R,f=-o.R+h/2,p=2*a+2*d,v=2*s;u.push(this.plane(new i.Pq0(0,s+d/2,f),p,d,h,t)),u.push(this.plane(new i.Pq0(0,-s-d/2,f),p,d,h,t)),u.push(this.plane(new i.Pq0(a+d/2,0,f),d,v,h,t)),u.push(this.plane(new i.Pq0(-a-d/2,0,f),d,v,h,t)),e.caromSurfaces={cloth:c,cushions:u}}}},{key:"plane",value:function(e,t,n,r,a){var o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,s=new i.iNn(t,n,r),l=new i.eaF(s,o);return l.receiveShadow=!0,l.position.copy(e),a.add(l),l}},{key:"addWoodenFrame",value:function(e){var t=r.P.X,n=r.P.Y,a=1.25*o.R,s=2*o.R,l=-o.R+a/2,c=2.4*o.R,u=.15*o.R,h=a,d=l,f=n+s+u,p=t+s+u,v=2*(p+c),m=2*(f+c);this.plane(new i.Pq0(0,f+c/2,d),v,c,h,e,this.frameMaterial),this.plane(new i.Pq0(0,-f-c/2,d),v,c,h,e,this.frameMaterial),this.plane(new i.Pq0(p+c/2,0,d),c,m,h,e,this.frameMaterial),this.plane(new i.Pq0(-p-c/2,0,d),c,m,h,e,this.frameMaterial)}}],n&&s(t.prototype,n),e}();l(c,"mesh",void 0),l(c,"caromSurfaces",null)},3982:(e,t,n)=>{n.d(t,{O:()=>s});var i=n(5418),r=n(91);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"pos",void 0),o(this,"radius",void 0),this.pos=t,this.radius=n}var t,n,s;return t=e,s=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<i.R+e.radius}},{key:"findBouncing",value:function(t,n){var i=t.futurePosition(n);return r.f.knuckles.find((function(t){return e.willBounce(t,i)}))}}],(n=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*i.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}])&&a(t.prototype,n),s&&a(t,s),e}()},4005:(e,t,n)=>{n.d(t,{o:()=>c});var i=n(8738),r=n(2765);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=this,i=arguments,n=o(n=t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(n,i||[],o(e).constructor):n.apply(e,i));var e,n,i}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,(i=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new r.J(this.container)}}])&&a(n.prototype,i),t}(i.xI)},4017:(e,t,n)=>{n.d(t,{J:()=>d,h:()=>h});var i=n(4922),r=n(8660),a=n(12),o=n(5418),s=n(7324);function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function u(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){c(e,t,n[t])}))}return e}var h={orbitAngleDeg:270,elevationDeg:80,distanceInDiameters:24,intensity:8.4,decay:1.4,coneDeg:57,color:"#f5f8ff",shadowBias:-5e-5,shadowNormalBias:0,shadowBlur:185,shadowMapSize:2048,shadowBlurSamples:15,shadowNear:.5,shadowFar:2,castShadow:!0},d=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:o.R;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c(this,"mesh",void 0),c(this,"spinAxisArrow",void 0),c(this,"velocityArrow",void 0),c(this,"trace",void 0),c(this,"color",void 0),c(this,"radius",void 0),c(this,"material",void 0),c(this,"dotMeshes",[]),this.color=new i.Q1f(t),this.radius=n,this.material=e.createBallMaterial(this.color),this.mesh=this.createBallMesh(),this.spinAxisArrow=new i.E0M(a.up,a.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.velocityArrow=new i.E0M(a.up,a.v_,2*this.radius,0,.015,.015),this.velocityArrow.visible=!1,this.trace=new s.C(500,t),e.instances.add(this)}var t,n,d;return t=e,n=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.vel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;0!==n&&this.mesh.rotateOnWorldAxis((0,a.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n,i){this.spinAxisArrow.visible&&(this.spinAxisArrow.setLength(this.radius+this.radius*t.length()/2,this.radius,this.radius),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,a.xb)(t)),i===r.U.Rolling?this.spinAxisArrow.setColor(13369344):this.spinAxisArrow.setColor(52224)),this.velocityArrow.visible&&n.lengthSq()>0&&(this.velocityArrow.setLength(2*this.radius,.015,.015),this.velocityArrow.position.copy(e),this.velocityArrow.setDirection((0,a.xb)(n)))}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.spinAxisArrow),e.add(this.velocityArrow),e.add(this.trace.line)}},{key:"removeFromScene",value:function(e){e.remove(this.mesh),e.remove(this.spinAxisArrow),e.remove(this.velocityArrow),e.remove(this.trace.line)}},{key:"clearDots",value:function(){var e=this;this.dotMeshes.forEach((function(t){t.geometry.dispose();var n=t.material;Array.isArray(n)?n.forEach((function(e){return e.dispose()})):n&&n.dispose(),e.mesh.remove(t)})),this.dotMeshes=[]}},{key:"applySymmetricDots",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:16711680,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.089;this.clearDots();var r=this.radius*n;[new i.Pq0(1,0,0),new i.Pq0(-1,0,0),new i.Pq0(0,1,0),new i.Pq0(0,-1,0),new i.Pq0(0,0,1),new i.Pq0(0,0,-1)].forEach((function(n){var a=new i.tcD(r,64),o=new i._4j({color:t,metalness:0,roughness:.35,transparent:!1,side:i.$EB}),s=new i.eaF(a,o),l=(new i.PTz).setFromUnitVectors(new i.Pq0(0,0,1),n.clone().normalize());s.quaternion.copy(l);var c=n.clone().normalize().multiplyScalar(e.radius+.001*e.radius);s.position.copy(c),s.renderOrder=e.mesh.renderOrder+1,e.mesh.add(s),e.dotMeshes.push(s)}))}},{key:"updateRadius",value:function(e){this.radius!==e&&(this.radius=e,this.mesh.geometry.dispose(),this.mesh.geometry=new i.Gu$(this.radius,64,48))}},{key:"dispose",value:function(){this.mesh.geometry.dispose(),this.material.dispose(),this.clearDots(),this.trace.dispose(),e.instances.delete(this)}},{key:"createBallMesh",value:function(){var e=new i.Gu$(this.radius,64,48),t=new i.eaF(e,this.material);return t.name="ball",t.castShadow=!0,t.receiveShadow=!0,t.renderOrder=1,t}}],d=[{key:"getLightingConfig",value:function(){return u({},e.lightingConfig)}},{key:"updateLightingConfig",value:function(t){var n,r,a,o,s,l,c,d,f,p,v,m,y,g,b,w,k=u({},e.lightingConfig,t);e.lightingConfig=(n=k,a=Number.isFinite(n.orbitAngleDeg)?n.orbitAngleDeg:h.orbitAngleDeg,o=Number.isFinite(n.elevationDeg)?n.elevationDeg:h.elevationDeg,s=Number.isFinite(n.distanceInDiameters)?n.distanceInDiameters:h.distanceInDiameters,l=Number.isFinite(n.intensity)?n.intensity:h.intensity,c=Number.isFinite(n.decay)?n.decay:h.decay,d=Number.isFinite(n.coneDeg)?n.coneDeg:h.coneDeg,f=Number.isFinite(n.shadowBias)?n.shadowBias:h.shadowBias,p=Number.isFinite(n.shadowNormalBias)?n.shadowNormalBias:h.shadowNormalBias,v=Number.isFinite(n.shadowBlur)?n.shadowBlur:h.shadowBlur,m=Number.isFinite(n.shadowMapSize)&&n.shadowMapSize>0?n.shadowMapSize:h.shadowMapSize,y=Number.isFinite(n.shadowBlurSamples)?n.shadowBlurSamples:h.shadowBlurSamples,g=Number.isFinite(n.shadowNear)&&n.shadowNear>0?n.shadowNear:h.shadowNear,b=Number.isFinite(n.shadowFar)?n.shadowFar:h.shadowFar,w=Math.pow(2,Math.round(i.cj9.clamp(Math.log2(m),8,12))),{orbitAngleDeg:i.cj9.euclideanModulo(a,360),elevationDeg:i.cj9.clamp(o,-80,85),distanceInDiameters:Math.max(.01,s),intensity:Math.max(0,l),decay:Math.max(0,c),coneDeg:i.cj9.clamp(d,5,90),color:null!==(r=n.color)&&void 0!==r?r:h.color,shadowBias:f,shadowNormalBias:Math.max(0,p),shadowBlur:i.cj9.clamp(v,0,1e3),shadowMapSize:w,shadowBlurSamples:Math.round(i.cj9.clamp(y,1,32)),shadowNear:Math.max(.1,g),shadowFar:Math.max(Math.max(.1,g)+.1,b),castShadow:Boolean(n.castShadow)});var P=e.getLightingConfig();e.lightingListeners.forEach((function(e){return e(P)}))}},{key:"onLightingConfigChanged",value:function(t){return e.lightingListeners.add(t),t(e.getLightingConfig()),function(){e.lightingListeners.delete(t)}}},{key:"createBallMaterial",value:function(e){var t=new i.uSd({color:e.clone(),roughness:.45,metalness:.25,clearcoat:.6,clearcoatRoughness:.15,reflectivity:.45});return t.needsUpdate=!0,t}}],n&&l(t.prototype,n),d&&l(t,d),e}();c(d,"instances",new Set),c(d,"lightingConfig",u({},h)),c(d,"lightingListeners",new Set)},4110:(e,t,n)=>{n.d(t,{x:()=>p});var i=n(5615),r=n(8738),a=n(4853),o=n(5556),s=n(5418),l=n(4922),c=n(363);function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function d(e,t){return d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},d(e,t)}function f(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(f=function(){return!!e})()}var p=function(e){function t(e){var n,i,r,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t,n){return t=h(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,f()?Reflect.construct(t,n||[],h(e).constructor):t.apply(e,n))}(this,t,[e]),i=n,r="placescale",a=.02*s.R,r in i?Object.defineProperty(i,r,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[r]=a,n.container.table.cue.moveTo(n.container.table.cueball.pos),n.container.table.cue.aim.power=0,n.container.view.camera.forceMode(n.container.view.camera.aimView),n}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(t,e),n=t,(i=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&e.pos.copy(this.container.rules.placeBall()),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText("Place\nBall"),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new r.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(0,-e.t*this.placescale*2);break;case"movementYUp":this.moveTo(-e.t*this.placescale*2,0);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),i=this.container.table.cueball.pos.add(n);i.copy(this.container.rules.placeBall(i)),c.l.indicateValid(!this.container.table.overlapsAny(i))}},{key:"placed",value:function(){return this.container.table.overlapsAny(this.container.table.cueball.pos)?this:(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new o.W(this.container.table.shortSerialise())),new a.m(this.container))}}])&&u(n.prototype,i),t}(i.y)},4368:(e,t,n)=>{n.d(t,{Q:()=>c});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(e){var n,i,a,s;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t),s=void 0,(a="json")in(i=n)?Object.defineProperty(i,a,{value:s,enumerable:!0,configurable:!0,writable:!0}):i[a]=s,n.type=r.B.WATCHAIM,n.json=e,n}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){return new t(e)}}],(i=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}])&&a(n.prototype,i),c&&a(n,c),t}(i.F)},4841:(e,t,n)=>{n.d(t,{z:()=>s});var i=n(12),r=n(5418);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(t,n,i,r,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"P",0),o(this,"WzI",0),o(this,"vx",void 0),o(this,"vy",void 0),o(this,"ωx",void 0),o(this,"ωy",void 0),o(this,"ωz",void 0),o(this,"s",void 0),o(this,"φ",void 0),o(this,"sʹ",void 0),o(this,"φʹ",void 0),o(this,"i",0),o(this,"N",100),o(this,"M",void 0),o(this,"R",void 0),o(this,"μs",void 0),o(this,"μw",void 0),o(this,"ee",void 0),this.M=t,this.R=n,this.ee=i,this.μs=r,this.μw=a}var t,n;return t=e,(n=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.ωy*e*r.Z3-this.ωz*e*r.o5,n=-this.vy*r.Z3+this.ωx*e,a=this.vx-this.ωy*e,o=this.vy+this.ωx*e;this.s=(0,i.RZ)((0,i.n7)(t,2)+(0,i.n7)(n,2)),this.φ=(0,i.FP)(n,t),this.φ<0&&(this.φ+=2*Math.PI),this.sʹ=(0,i.RZ)((0,i.n7)(a,2)+(0,i.n7)(o,2)),this.φʹ=(0,i.FP)(o,a),this.φʹ<0&&(this.φʹ+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw new Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.μs,n=this.μw,a=this.M;this.vx-=1/a*(n*(0,i.gn)(this.φ)+t*(0,i.gn)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e,this.vy-=1/a*(r.o5-n*r.Z3*(0,i.F8)(this.φ)+t*(0,i.F8)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.μs,n=this.μw,a=this.M,o=this.R;this.ωx+=-5/(2*a*o)*(n*(0,i.F8)(this.φ)+t*(0,i.F8)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e,this.ωy+=-5/(2*a*o)*(n*(0,i.gn)(this.φ)*r.Z3-t*(0,i.gn)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e,this.ωz+=5/(2*a*o)*(n*(0,i.gn)(this.φ)*r.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,r){this.solve(e*(0,i.gn)(t),e*(0,i.F8)(t),-r*(0,i.F8)(t),r*(0,i.gn)(t),n)}},{key:"solve",value:function(e,t,n,i,r){this.vx=e,this.vy=t,this.ωx=n,this.ωy=i,this.ωz=r,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var a=this.ee*this.ee*this.WzI;this.restitutionPhase(a)}}])&&a(t.prototype,n),e}()},4853:(e,t,n)=>{n.d(t,{m:()=>h});var i=n(8738),r=n(5615),a=n(6940),o=n(1185);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var h=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=(n=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,u()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t,[e])).container.table;i.cue.aimMode(),i.cue.showHelper(!0),i.cueball=n.container.rules.cueball,i.cue.aim.i=i.balls.indexOf(i.cueball),i.cue.moveTo(i.cueball.pos),n.container.view.camera.suggestMode(n.container.view.camera.aimView),i.cue.aimInputs.showOverlap(),n.container.menu.aimMode(),n.container.scoreButtons.updateGameModeVisibility(),setTimeout((function(){n.container.scoreButtons.updateGameModeVisibility(),n.container.scoreButtons.reinitializeEventHandlers()}),100);var r=function(){n.container.table.allStationary()?(n.container.updateTrajectoryPrediction(),setTimeout((function(){n.container.table.allStationary()&&n.container.updateTrajectoryPrediction()}),50)):requestAnimationFrame(r)};return requestAnimationFrame(r),n}var n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,(r=[{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new o.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new i.Qe(this.container.table.serialise());return this.container.sendEvent(e),this.container.recorder.record(e),new a.H(this.container)}}])&&s(n.prototype,r),t}(r.y)},4979:(e,t,n)=>{n.d(t,{v:()=>l});var i=n(4922),r=n(665),a=n(5418);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"viewPoint",value:function(t,n){var o=e.zoomFactor/(2*Math.tan(n*Math.PI/360));if(t>this.portrait){var s=t>e.aspectLimit?2.75*r.P.tableY:2.4*r.P.tableX/t;return new i.Pq0(0,-.01*a.R,o*s)}var l=t>1/e.aspectLimit?4.9*r.P.tableY:1.35*r.P.tableX/t;return new i.Pq0(-.01*a.R,0,o*l)}}],null&&o(t.prototype,null),n&&o(t,n),e}();s(l,"aspectLimit",1.78),s(l,"portrait",.95),s(l,"fov",20),s(l,"zoomFactor",1)},5159:(e,t,n)=>{n.d(t,{T:()=>c});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t)).type=r.B.STATIONARY,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,(i=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}])&&a(n.prototype,i),t}(i.F)},5418:(e,t,n)=>{n.d(t,{$0:()=>F,BY:()=>I,D$:()=>S,I:()=>a,JU:()=>X,KO:()=>w,Mz:()=>i,Nv:()=>v,PK:()=>y,PX:()=>W,Q$:()=>H,Qg:()=>D,R:()=>_,Wv:()=>z,X$:()=>b,XF:()=>C,XM:()=>E,Xf:()=>T,Ys:()=>G,Z3:()=>k,ZZ:()=>B,_m:()=>p,cM:()=>q,dM:()=>m,e:()=>h,ee:()=>d,g:()=>o,g8:()=>Q,gT:()=>c,gf:()=>l,jG:()=>j,kL:()=>u,kM:()=>U,ki:()=>K,ko:()=>V,lt:()=>Y,m:()=>L,mu:()=>s,o5:()=>P,oV:()=>f,oo:()=>A,v3:()=>x,vF:()=>J,wD:()=>M,wK:()=>O,x3:()=>r,xO:()=>g});var i,r,a,o=9.8,s=.00985,l=.16,c=.85,u=.04,h=.86,d=.97,f=.212,p=.12,v=.001,m=.3,y=1.2,g=.3,b=1.2,w=.47,k=.4,P=Math.sqrt(21)/5,x=.06,S=1,M=0,T=.3,E=2.84,C=1.42,R=.028575,A=.03075,I={R,m:.17},O={R:.02625,m:.142},B={R:A,m:.21,mu:.0063,rho:.09,muS:.09,spinStopThreshold:.05,rollingTransition:.1},_=R,L=.17;function j(e){_=e,null==N||N()}function N(){i=s*L*o*2/3*u,r=7/(5*Math.sqrt(2))*_*s*L*o,a=.4*L*_*_}function F(e){var t,n,i=null!==(t=e.mu)&&void 0!==t?t:s,r=null!==(n=e.rho)&&void 0!==n?n:u;return{Mz:i*e.m*o*2/3*r,Mxy:7/(5*Math.sqrt(2))*e.R*i*e.m*o,I:.4*e.m*e.R*e.R}}function D(e){L=e,null==N||N()}function H(e){s=e,N()}function z(e){u=e,N()}function G(e){l=e}function q(e){h=e}function U(e){c=e}function V(e){f=e}function K(e){p=e}function W(e){d=e}function X(e){v=e}function Y(e){m=e}function J(e){y=e}function Q(e){g=e}N()},5556:(e,t,n)=>{n.d(t,{W:()=>u});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(c=function(){return!!e})()}var u=function(e){function t(e,n){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),o(i=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,c()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t),"init",void 0),o(i,"shots",void 0),o(i,"retry",void 0),i.init=e,i.shots=null!=n?n:[],i.type=r.B.BREAK,i}var n,i,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,e),n=t,u=[{key:"fromJson",value:function(e){return new t(e.init,e.shots)}}],(i=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}])&&a(n.prototype,i),u&&a(n,u),t}(i.F)},5597:(e,t,n)=>{n.d(t,{X:()=>b});var i=n(7192),r=n(6763),a=n(3982),o=n(8385),s=n(8086),l=n(8660),c=n(2522),u=n(665),h=n(3645),d=n(91),f=n(8090),p=n(12),v=n(5418),m=n(1842);function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),g(this,"balls",void 0),g(this,"cue",void 0),g(this,"pairs",void 0),g(this,"outcome",[]),g(this,"cueball",void 0),g(this,"cushionModel",f.$8),g(this,"mesh",void 0),n&&n.headless?this.cue=new s.s(void 0,void 0,!0):this.cue=new s.s,this.cueball=t[0],this.initialiseBalls(t)}var t,n,b;return t=e,n=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach((function(t){t.updateMesh(e)}))}},{key:"advance",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(80==++t&&(console.warn("Collision resolution struggling (80 retries), applying emergency separation"),this.emergencySeparateAll()),t>100)throw console.error("Depth exceeded resolving collisions after ".concat(t," retries")),new Error("Depth exceeded resolving collisions");t>10&&console.warn("High collision retry count: ".concat(t)),this.balls.forEach((function(t){t.update(e),t.fround()}))}},{key:"emergencySeparateAll",value:function(){this.pairs.forEach((function(e){var t,n,i=e.a.pos.distanceTo(e.b.pos),r=2*(null!==(n=null===(t=e.a.physicsContext)||void 0===t?void 0:t.R)&&void 0!==n?n:v.R);if(i<r){var a,o=e.b.pos.clone().sub(e.a.pos),s=o.length();s>1e-6?o.multiplyScalar(1/s):o.set(1,0,0);var l,c=.6*(r-i);e.a.pos.addScaledVector(o,-c),e.b.pos.addScaledVector(o,c);var u=null!==(l=null===(a=e.a.physicsContext)||void 0===a?void 0:a.minSeparationSpeed)&&void 0!==l?l:.004;e.a.vel.addScaledVector(o,-u),e.b.vel.addScaledVector(o,u)}}))}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every((function(n){return t.prepareAdvancePair(n.a,n.b,e)}))&&this.balls.every((function(n){return t.prepareAdvanceToCushions(n,e)}))}},{key:"prepareAdvancePair",value:function(e,t,n){var i,a,o=null!==(a=null===(i=e.physicsContext)||void 0===i?void 0:i.R)&&void 0!==a?a:v.R,s=2*o-e.pos.distanceTo(t.pos)>1e-6*o;if(r.F.willCollide(e,t,n,e.physicsContext)){if(!s)return!0;r.F.separateAtImpact(e,t,n,e.physicsContext);var l=r.F.collide(e,t);return this.outcome.push(h.P.collision(e,t,l)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<u.P.tableY&&Math.abs(n.x)<u.P.tableX)return!0;var r=i.q.bounceAny(e,t,u.P.hasPockets,this.cushionModel);if(r)return this.outcome.push(h.P.cushion(e,r)),!1;var s=a.O.findBouncing(e,t);if(s){var l=s.bounce(e);return this.outcome.push(h.P.cushion(e,l)),!1}var c=o.Z.findPocket(d.f.pocketCenters,e,t);if(c){var f=c.fall(e,t);return this.outcome.push(h.P.pot(e,f)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every((function(e){return!e.inMotion()}))}},{key:"inPockets",value:function(){return this.balls.reduce((function(e,t){return t.onTable()?e:e+1}),0)}},{key:"hit",value:function(){(0,m.CH)(),this.cue.hit(this.cueball),this.balls.forEach((function(e){e.ballmesh.trace.reset()}))}},{key:"serialise",value:function(){return{balls:this.balls.map((function(e){return e.serialise()})),aim:this.cue.aim.copy(),cushionModel:this.cushionModel,cueballId:this.cueball.id}}},{key:"updateFromSerialised",value:function(e){var t=this;if(e.balls&&e.balls.forEach((function(e,n){var i=t.balls.find((function(t){return t.id===e.id}))||t.balls[n];i&&l.c.updateFromSerialised(i,e)})),e.aim&&(this.cue.aim=c.w.fromJson(e.aim),void 0!==e.aim.elevation&&(this.cue.elevation=e.aim.elevation)),e.cushionModel&&(this.cushionModel=e.cushionModel),void 0!==e.cueballId){var n=this.balls.find((function(t){return t.id===e.cueballId}));n&&(this.cueball=n)}}},{key:"shortSerialise",value:function(){return this.balls.map((function(e){return[e.pos.x,e.pos.y]})).reduce((function(e,t){return e.concat(t)}),[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach((function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(p.v_),t.rvel.copy(p.v_),t.state=l.U.Stationary}))}},{key:"addToScene",value:function(e){this.balls.forEach((function(t){t.ballmesh.addToScene(e)})),e.add(this.cue.mesh),e.add(this.cue.helperGhostGroup),e.add(this.cue.placerMesh),e.add(this.cue.hitPointMesh),e.add(this.cue.virtualCueMesh)}},{key:"showTraces",value:function(e){this.balls.forEach((function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()}))}},{key:"showSpin",value:function(e){this.balls.forEach((function(t){t.ballmesh.spinAxisArrow.visible=e}))}},{key:"showVirtualCue",value:function(e){this.cue.virtualCueMesh.visible=e}},{key:"halt",value:function(){this.balls.forEach((function(e){e.vel.copy(p.v_),e.rvel.copy(p.v_),e.state=l.U.Stationary}))}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter((function(e){return e!==t})).some((function(t){return t.pos.distanceTo(e)<2*t.radius}))}}],b=[{key:"fromSerialised",value:function(t,n){var i=new e(t.balls.map((function(e){return l.c.fromSerialised(e,n)})),n);return i.updateFromSerialised(t),i}}],n&&y(t.prototype,n),b&&y(t,b),e}()},5615:(e,t,n)=>{n.d(t,{y:()=>h});var i=n(8738),r=n(128),a=n(3645),o=n(4922);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var h=function(e){function t(){var e,n,i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,u()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t,arguments),(i="scale")in(n=e)?Object.defineProperty(n,i,{value:.001,enumerable:!0,configurable:!0,writable:!0}):n[i]=.001,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,(i=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"hit",value:function(){this.container.table.outcome=[a.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale,i=this.container.isCameraControlsLocked&&this.container.isCameraControlsLocked();switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new o.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new o.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new o.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new o.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,r.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":var a;if(i)return!0;var s=(null===(a=this.container.precisionPanel)||void 0===a?void 0:a.getIsVisible())?.5:1;return t.rotateAim(2*n*s,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return i||this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return i||this.container.view.camera.adjustHeight(8*-n),!0;case"KeyOUp":return i||this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyVUp":return this.container.table.cue.toggleVirtualCue(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.toggleDebugMode()}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}])&&s(n.prototype,i),t}(i.xI)},6763:(e,t,n)=>{n.d(t,{F:()=>u});var i=n(8660),r=n(7547),a=n(5418);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=1e-5;function c(e,t,n,i){var r,o=null!==(r=null==i?void 0:i.R)&&void 0!==r?r:a.R,s=e.pos.clone().sub(t.pos),l=e.vel.clone().sub(t.vel),c=2*o,u=l.dot(l),h=2*s.dot(l),d=s.dot(s)-c*c;if(u<=1e-12)return-1;var f=h*h-4*u*d;if(f<0)return-1;var p=Math.sqrt(f),v=(-h-p)/(2*u),m=(-h+p)/(2*u),y=Number.POSITIVE_INFINITY;return v>=0&&v<=n&&(y=Math.min(y,v)),m>=0&&m<=n&&(y=Math.min(y,m)),isFinite(y)?y:-1}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"timeOfImpact",value:function(e,t,n,i){return c(e,t,n,i)}},{key:"willCollide",value:function(e,t,n,i){if(!e.onTable()||!t.onTable())return!1;if(!e.inMotion()&&!t.inMotion())return!1;var r,o=null!==(r=null==i?void 0:i.R)&&void 0!==r?r:a.R;if(c(e,t,n,i)>=0)return!0;var s=e.futurePosition(n),l=t.futurePosition(n),u=s.clone().sub(l);return!(u.lengthSq()>=4*o*o)&&e.vel.clone().sub(t.vel).dot(u)<0}},{key:"separateAtImpact",value:function(e,t,n,i){var r,o=null!==(r=null==i?void 0:i.R)&&void 0!==r?r:a.R,s=2*o,u=c(e,t,n,i),h=e.pos.clone(),d=t.pos.clone();u>=0&&(h.addScaledVector(e.vel,u),d.addScaledVector(t.vel,u));var f=h.clone().sub(d),p=f.length();p<l&&(f.set(1,0,0),p=Math.max(p,l));var v=f.multiplyScalar(1/p),m=s-p;if(!(m<=0)){var y,g=.5*(m+o*(null!==(y=null==i?void 0:i.collisionSeparationBias)&&void 0!==y?y:.01)),b=v.multiplyScalar(g);e.pos.add(b),t.pos.sub(b),e.futurePos.copy(e.pos),t.futurePos.copy(t.pos)}}},{key:"collide",value:function(t,n){return e.updateVelocities(t,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),i=e.vel.clone().sub(t.vel),r=(n-2*a.R)/i.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,r),b:t.pos.clone().addScaledVector(t.vel,r)}}},{key:"updateVelocities",value:function(t,n){var r,a=null!==(r=t.physicsContext)&&void 0!==r?r:n.physicsContext,o=n.pos.clone().sub(t.pos),s=o.length(),l=0;s>1e-6?(o.multiplyScalar(1/s),l=t.vel.clone().sub(n.vel).dot(o)):o.set(0,0,0);var c=e.model.updateVelocities(t,n),u=s>1e-6?t.vel.clone().sub(n.vel).dot(o):0;if(s>1e-6&&u>0){var h=-.5*u;t.vel.addScaledVector(o,h),n.vel.addScaledVector(o,-h)}var d,f=s>1e-6?t.vel.clone().sub(n.vel).dot(o):u,p=null!==(d=null==a?void 0:a.minSeparationSpeed)&&void 0!==d?d:.004;if(s>1e-6&&Math.abs(f)<p){var v=f>=0?-1:1,m=v*p*.5;t.vel.addScaledVector(o,-m),n.vel.addScaledVector(o,m),f=v*p}return e.debugHook&&e.debugHook({relNormalBefore:l,relNormalAfterImpulse:u,relNormalAfterCorrection:f,normalImpulse:e.model.normalImpulse,tangentialImpulse:e.model.tangentialImpulse,distance:s}),t.state=i.U.Sliding,n.state=i.U.Sliding,c}}],null&&o(t.prototype,null),n&&o(t,n),e}();s(u,"debugHook",void 0),s(u,"model",new r.D)},6940:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e){return r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},r(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function o(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(o=function(){return!!e})()}n.d(t,{H:()=>s});var s=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=r(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,o()?Reflect.construct(t,n||[],r(e).constructor):t.apply(e,n))}(this,t,[e])).hit(),n}var n,s;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,(s=[{key:"handleStationary",value:function(e){var t=this.container.table,n=t.outcome,i=this.container.rules.update(n);return this.container.recorder.updateBreak(n),t.cue.aimAtNext(t.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}])&&i(n.prototype,s),t}(n(5615).y)},7009:(e,t,n)=>{n.d(t,{B:()=>i});var i=function(e){return e.BEGIN="BEGIN",e.BREAK="BREAK",e.WATCHAIM="WATCHAIM",e.AIM="AIM",e.HIT="HIT",e.STATIONARY="STATIONARY",e.CHAT="CHAT",e.ABORT="ABORT",e.PLACEBALL="PLACEBALL",e.REJOIN="REJOIN",e.RERACK="RERACK",e.STARTAIM="STARTAIM",e}({})},7192:(e,t,n)=>{n.d(t,{q:()=>s});var i=n(665),r=n(8090),a=n(91);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var s=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"bounceAny",value:function(t,n){var a=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:r.$8,s=t.futurePosition(n);if(e.willBounceLong(s,a)){var l=s.y>i.P.tableY?-Math.PI/2:Math.PI/2;return e.bounceIn(l,t,o)}if(e.willBounceShort(s,a)){var c=s.x>i.P.tableX?0:Math.PI;return e.bounceIn(c,t,o)}}},{key:"willBounceShort",value:function(t,n){return n?e.willBounceShortSegment(a.f.pockets.pocketNW.knuckleSW.pos.y,a.f.pockets.pocketSW.knuckleNW.pos.y,t):e.willBounceShortSegment(i.P.Y,-i.P.Y,t)}},{key:"willBounceLong",value:function(t,n){return n?e.willBounceLongSegment(a.f.pockets.pocketNW.knuckleNE.pos.x,a.f.pockets.pocketN.knuckleNW.pos.x,t)||e.willBounceLongSegment(a.f.pockets.pocketN.knuckleNE.pos.x,a.f.pockets.pocketNE.knuckleNW.pos.x,t):e.willBounceLongSegment(-i.P.X,i.P.X,t)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>i.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>i.P.tableX}},{key:"bounceIn",value:function(e,t,n){try{t.ballmesh&&t.ballmesh.trace&&t.ballmesh.trace.forceTrace&&t.ballmesh.trace.forceTrace(t.futurePos)}catch(e){}var i=(0,r.QK)(e,t.vel,t.rvel,n);return t.vel.add(i.v),t.rvel.add(i.w),i.v.length()}}],null&&o(t.prototype,null),n&&o(t,n),e}()},7236:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{N:()=>a});var a=function(){function e(t,n,i,a){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"clientId",void 0),r(this,"username",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),this.clientId=t,this.username=n,this.tableId=i,this.spectator=a}var t,n;return t=e,n=[{key:"getInstance",value:function(){if(!e.instance)throw new Error("Session not initialized");return e.instance}},{key:"isSpectator",value:function(){return void 0!==e.instance&&e.getInstance().spectator}},{key:"reset",value:function(){e.instance=void 0}},{key:"init",value:function(t,n,i,r){e.instance=new e(t,n,i,r)}}],null&&i(t.prototype,null),n&&i(t,n),e}();r(a,"instance",void 0)},7324:(e,t,n)=>{n.d(t,{C:()=>s});var i=n(4922),r=n(5418);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"line",void 0),o(this,"geometry",void 0),o(this,"positions",void 0),o(this,"lastPos",new i.Pq0),o(this,"lastVel",new i.Pq0),this.geometry=new i.LoY,this.positions=new Float32Array(3*t),this.geometry.setAttribute("position",new i.THS(this.positions,3)),this.reset();var r=new i.mrM({color:n,opacity:.25,linewidth:3,transparent:!0});this.line=new i.N1A(this.geometry,r),this.line.visible=!1}var t,n;return t=e,(n=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"forceTrace",value:function(e){this.lastVel.z=1,this.addTraceGiven(e,this.lastVel,1,.1,1)}},{key:"addTrace",value:function(e,t){if(this.line.visible&&0!==t.length()){var n=this.lastVel.angleTo(t),i=n>Math.PI/32?.01*r.R:r.R,a=this.lastPos.distanceTo(e);this.addTraceGiven(e,t,a,i,n)}}},{key:"addTraceGiven",value:function(e,t,n,i,r){var a=this.geometry.drawRange.count;0!==a&&n<i||(a>1&&r<1e-4&&a--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,a))}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}},{key:"dispose",value:function(){try{this.line&&this.line.geometry&&this.line.geometry.dispose&&this.line.geometry.dispose()}catch(e){}try{var e=this.line&&this.line.material;Array.isArray(e)?e.forEach((function(e){return e&&e.dispose&&e.dispose()})):e&&e.dispose&&e.dispose()}catch(e){}try{this.geometry&&this.geometry.dispose&&this.geometry.dispose()}catch(e){}}}])&&a(t.prototype,n),e}()},7387:(e,t,n)=>{n.d(t,{z:()=>h});var i=n(8279),r=n(7009),a=n(12);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var h=function(e){function t(e,n){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s(i=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,u()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t),"pos",void 0),s(i,"allTable",void 0),i.pos=e,i.allTable=n,i.type=r.B.PLACEBALL,i}var n,i,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,h=[{key:"fromJson",value:function(e){return new t((0,a.t6)(e.pos),e.allTable)}}],(i=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}])&&o(n.prototype,i),h&&o(n,h),t}(i.F)},7547:(e,t,n)=>{n.d(t,{D:()=>c});var i=n(4922),r=n(6763),a=n(5418),o=n(12);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"normalImpulse",void 0),l(this,"tangentialImpulse",void 0)}var t,n;return t=e,(n=[{key:"dynamicFriction",value:function(e){return.01+.108*(0,o.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=r.F.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var o=n.b.sub(n.a).normalize(),s=new i.Pq0(-o.y,o.x,0),l=e.vel.clone().sub(t.vel).add(o.clone().multiplyScalar(-a.R).cross(e.rvel).sub(o.clone().multiplyScalar(a.R).cross(t.rvel))),c=o.dot(l),u=l.addScaledVector(o,-c),h=u.length(),d=s.dot(u),f=this.dynamicFriction(h);this.normalImpulse=-1.99*c/(2/a.m),this.tangentialImpulse=.25*Math.min(f*Math.abs(this.normalImpulse)/h,1/7)*-d;var p=o.clone().multiplyScalar(this.normalImpulse),v=s.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(p,1/a.m).addScaledVector(v,1/a.m),t.vel.addScaledVector(p,-1/a.m).addScaledVector(v,-1/a.m);var m=o.clone().multiplyScalar(-a.R).cross(v),y=o.clone().multiplyScalar(a.R).cross(v);return e.rvel.addScaledVector(m,1/a.I),t.rvel.addScaledVector(y,1/a.I),c}}])&&s(t.prototype,n),e}()},8086:(e,t,n)=>{n.d(t,{s:()=>m});var i=n(665),r=n(12),a=n(2522),o=n(8660),s=n(8090),l=n(363),c=n(4922),u=n(5418),h=n(2899),d=n(9241),f=n(2072);function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function v(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){function e(t,n,r){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),v(this,"mesh",void 0),v(this,"placerMesh",void 0),v(this,"hitPointMesh",void 0),v(this,"virtualCueMesh",void 0),v(this,"helperGhostGroup",void 0),v(this,"helperGhostBalls",[]),v(this,"helperGhostMaterial",void 0),v(this,"helperImpactGhostMaterial",void 0),v(this,"helperGhostSourceGeometryId",void 0),v(this,"helperVisible",!1),v(this,"helperGhostScale",1),v(this,"helperGhostGapDiameterMultiplier",2),v(this,"lastHelperPoints",null),v(this,"lastHelperHasImpact",!1),v(this,"lastHelperImpactIsBall",!1),v(this,"offCenterLimitMasse",.8),v(this,"ballRadius",void 0),v(this,"maxPower",void 0),v(this,"defaultElevation",.17),v(this,"t",0),v(this,"aimInputs",void 0),v(this,"aim",new a.w),v(this,"container",void 0),v(this,"masseMode",!0),v(this,"elevation",.17),v(this,"length",1*i.P.tableX),this.container=t,this.ballRadius=null!=n?n:u.R,this.maxPower=160*this.ballRadius,r?(this.mesh=void 0,this.placerMesh=void 0,this.hitPointMesh=void 0,this.virtualCueMesh=void 0,this.helperGhostGroup=new c.YJl,this.helperGhostGroup.visible=!1,this.helperGhostGroup.name="helperGhostBalls",this.helperGhostGroup.renderOrder=0):(this.mesh=l.l.createCue(.05*this.ballRadius/.5,.15*this.ballRadius/.5,this.length),this.placerMesh=l.l.createPlacer(),this.hitPointMesh=l.l.createHitPoint(),this.virtualCueMesh=l.l.createVirtualCue(),this.helperGhostGroup=new c.YJl,this.helperGhostGroup.visible=!1,this.helperGhostGroup.name="helperGhostBalls",this.helperGhostGroup.renderOrder=0)}var t,n;return t=e,n=[{key:"rotateAim",value:function(e,t){var n;this.aim.angle=this.aim.angle+e,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t),null===(n=this.container)||void 0===n||n.updateTrajectoryPrediction()}},{key:"adjustPower",value:function(e){var t;this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput(),null===(t=this.container)||void 0===t||t.updateTrajectoryPrediction()}},{key:"setPower",value:function(e){var t,n="number"==typeof e?e:parseFloat(e);if(Number.isFinite(n)){var i=Math.max(0,n);this.aim.power=i*this.maxPower,null===(t=this.container)||void 0===t||t.updateTrajectoryPrediction()}}},{key:"hit",value:function(e){var t,n,r,a;this.aim,this.t=0,e.state=o.U.Sliding;var l=(0,h.Bl)(e,{angle:this.aim.angle,offset:this.aim.offset,power:this.aim.power},this.elevation),c="undefined"!=typeof performance?Math.round(performance.now()):Date.now(),u=this.container&&this.container.table&&this.container.table.serialise?this.container.table.serialise():void 0;if((0,f.uP)("shot",{shotId:c,ballId:e.id,pos:{x:e.pos.x,y:e.pos.y,z:e.pos.z},aim:{angle:this.aim.angle,offset:{x:this.aim.offset.x,y:this.aim.offset.y,z:this.aim.offset.z},power:this.aim.power},elevation:this.elevation,cueDir:{x:l.cueDir.x,y:l.cueDir.y,z:l.cueDir.z},hitPointWorld:{x:l.hitPointWorld.x,y:l.hitPointWorld.y,z:l.hitPointWorld.z},engineDt:d.C,table:u,tableGeometry:{tableX:i.P.tableX,tableY:i.P.tableY,X:i.P.X,Y:i.P.Y,hasPockets:i.P.hasPockets}}),(0,h.gI)(e,l),this.container&&(this.container.currentShotId=c,this.container.currentCueBallId=e.id),this.container&&s.kY&&(0,s.jj)(this.container.view.scene,l.hitPointWorld,e.vel,this.ballRadius),this.hitPointMesh.visible=!1,this.mesh.visible=!1,null===(n=this.container)||void 0===n||null===(t=n.trajectoryRenderer)||void 0===t||t.clearTrajectories(),null===(a=this.container)||void 0===a||null===(r=a.view)||void 0===r?void 0:r.camera){var p=this.container.view.camera;p.raiseHeightForTracking(this.ballRadius);var v=p.camera.position.clone(),m=i.P.tableX,y=i.P.tableY;Math.abs(v.x)<m&&Math.abs(v.y)<y&&p.moveBackwardToTableEdge(v,m,y,this.ballRadius)}}},{key:"getActualHitOffset",value:function(e){var t=this.hitPointMesh.position.clone().clone().sub(e).normalize(),n=(0,r.Dz)(this.aim.angle),i=(0,r.KM)(n).normalize(),a=new c.Pq0(n.x,n.y,0).normalize();a.applyAxisAngle(i,-this.elevation);var o=(new c.Pq0).crossVectors(a,i).normalize(),s=t.dot(i),l=t.dot(o);return new c.Pq0(s,l,0)}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,r.xb)(t.pos.clone().sub(e.pos));this.aim.angle=(0,r.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n,i=this.aim.offset.clone().clone().add(e);this.setSpin(i,t),null===(n=this.container)||void 0===n||n.updateTrajectoryPrediction()}},{key:"setSpin",value:function(e,t){var n;this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput(),null===(n=this.container)||void 0===n||n.updateTrajectoryPrediction()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=this.offCenterLimitMasse,n=0;n++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>t&&this.aim.offset.normalize().multiplyScalar(t);n>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n,i;null===(e=this.aimInputs)||void 0===e||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null===(t=this.aimInputs)||void 0===t||t.updatePowerSlider(this.aim.power/this.maxPower),null===(n=this.aimInputs)||void 0===n||n.updateElevationSlider(this.elevation),null===(i=this.aimInputs)||void 0===i||i.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e);var t=(0,r.Dz)(this.aim.angle+Math.PI),n=new c.Pq0(t.x,t.y,0),i=-this.aim.offset.x*Math.PI/2;n.applyAxisAngle(new c.Pq0(0,0,1),i);var a=-this.aim.offset.y*Math.PI/2,o=(0,r.KM)(t).normalize();n.applyAxisAngle(o,a);var s=n.normalize(),l=e.clone().addScaledVector(s,this.ballRadius),u=(0,r.Dz)(this.aim.angle+Math.PI),h=new c.Pq0(u.x*Math.cos(this.elevation),u.y*Math.cos(this.elevation),Math.sin(this.elevation)).normalize(),d=100/30.75*this.ballRadius/2,f=10/30.75*this.ballRadius,p=2.5*this.ballRadius,v=d+f+p+p,m=2*((0,r.F8)(this.t+Math.PI/2)-1)*this.ballRadius*(this.aim.power/this.maxPower),y=l.clone().addScaledVector(h,v).addScaledVector(h,m);this.mesh.position.copy(y);var g=new c.Pq0(0,-1,0),b=new c.PTz;b.setFromUnitVectors(g,h),this.mesh.setRotationFromQuaternion(b),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t,this.updateHitPoint(e),this.updateVirtualCue(e)}},{key:"updateHitPoint",value:function(e){var t=(0,r.Dz)(this.aim.angle+Math.PI),n=new c.Pq0(t.x,t.y,0),i=-Math.asin(Math.max(-1,Math.min(1,this.aim.offset.x)));n.applyAxisAngle(new c.Pq0(0,0,1),i);var a=-Math.asin(Math.max(-1,Math.min(1,this.aim.offset.y))),o=(0,r.KM)(t).normalize();n.applyAxisAngle(o,a);var s=n.normalize(),l=e.clone().addScaledVector(s,this.ballRadius);this.hitPointMesh.position.copy(l);var u=new c.PTz;u.setFromUnitVectors(new c.Pq0(0,0,1),s),this.hitPointMesh.setRotationFromQuaternion(u)}},{key:"updateVirtualCue",value:function(e){var t=(0,r.Dz)(this.aim.angle+Math.PI),n=new c.Pq0(t.x,t.y,0),i=-this.aim.offset.x*Math.PI/2;n.applyAxisAngle(new c.Pq0(0,0,1),i);var a=-this.aim.offset.y*Math.PI/2,o=(0,r.KM)(t).normalize();n.applyAxisAngle(o,a);var s=n.normalize(),l=e.clone().addScaledVector(s,this.ballRadius);this.virtualCueMesh.position.copy(l);var u=(0,r.Dz)(this.aim.angle+Math.PI),h=new c.Pq0(u.x*Math.cos(this.elevation),u.y*Math.cos(this.elevation),Math.sin(this.elevation)).normalize(),d=new c.Pq0(0,-1,0),f=new c.PTz;f.setFromUnitVectors(d,h),this.virtualCueMesh.setRotationFromQuaternion(f)}},{key:"toggleVirtualCue",value:function(){this.virtualCueMesh.visible=!this.virtualCueMesh.visible}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.virtualCueMesh.visible=!1,this.hitPointMesh.visible=!1,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1,this.virtualCueMesh.visible=!1,this.hitPointMesh.visible=!0}},{key:"spinOffset",value:function(){return(0,r.KM)((0,r.Dz)(this.aim.angle)).clone().multiplyScalar(2*this.aim.offset.x*this.ballRadius).setZ(2*this.aim.offset.y*this.ballRadius)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=e.cueball.pos.clone().add(t),i=(0,r.xb)((0,r.Dz)(this.aim.angle+Math.PI).setZ(.1)),a=new c.tBo(n,i),o=e.balls.map((function(e){return e.ballmesh.mesh}));return e.mesh&&o.push(e.mesh),a.intersectObjects(o,!0).length>0}},{key:"showHelper",value:function(e){this.helperVisible=e,e?this.updateHelperGhostBalls(this.lastHelperPoints,this.lastHelperHasImpact,this.lastHelperImpactIsBall):this.hideHelperGhostBalls()}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperVisible)}},{key:"updateHelperCurve",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.lastHelperPoints=e?e.map((function(e){return e.clone()})):null,this.lastHelperHasImpact=t,this.lastHelperImpactIsBall=n,this.helperVisible?this.updateHelperGhostBalls(this.lastHelperPoints,t,n):this.hideHelperGhostBalls()}},{key:"disposeHelperGhostResources",value:function(){var e=this;this.helperGhostBalls.forEach((function(t){t.geometry.dispose(),e.helperGhostGroup.remove(t)})),this.helperGhostBalls=[],this.helperGhostMaterial&&(Array.isArray(this.helperGhostMaterial)?this.helperGhostMaterial.forEach((function(e){return e.dispose()})):this.helperGhostMaterial.dispose()),this.helperImpactGhostMaterial&&(Array.isArray(this.helperImpactGhostMaterial)?this.helperImpactGhostMaterial.forEach((function(e){return e.dispose()})):this.helperImpactGhostMaterial.dispose()),this.helperGhostMaterial=void 0,this.helperImpactGhostMaterial=void 0,this.helperGhostSourceGeometryId=void 0,this.helperGhostGroup.visible=!1}},{key:"configureGhostMaterial",value:function(e){var t,n,i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=e;if("transparent"in r&&(r.transparent=!0),"opacity"in r&&(r.opacity=i?.6:.3),"depthWrite"in r&&(r.depthWrite=!i),"depthTest"in r&&(r.depthTest=!i),"color"in r&&(null===(t=r.color)||void 0===t?void 0:t.clone)){var a=r.color.clone();a.offsetHSL&&a.offsetHSL(0,-.2,.15),r.color.copy(a)}if("emissive"in r&&(null===(n=r.emissive)||void 0===n?void 0:n.clone)){var o,s=r.emissive.clone();s.offsetHSL&&s.offsetHSL(0,-.15,.2),r.emissive.copy(s),"emissiveIntensity"in r&&(r.emissiveIntensity=Math.max(null!==(o=r.emissiveIntensity)&&void 0!==o?o:.35,.35))}return e.needsUpdate=!0,e}},{key:"cloneGhostMaterial",value:function(e){var t=this,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return Array.isArray(e)?e.map((function(e){return t.configureGhostMaterial(e.clone(),n)})):this.configureGhostMaterial(e.clone(),n)}},{key:"ensureHelperGhostResources",value:function(){var e,t,n,i,r=null===(i=this.container)||void 0===i||null===(n=i.table)||void 0===n||null===(t=n.cueball)||void 0===t||null===(e=t.ballmesh)||void 0===e?void 0:e.mesh;if(!r)return!1;var a=r.geometry.uuid;return this.helperGhostSourceGeometryId&&this.helperGhostSourceGeometryId!==a&&this.disposeHelperGhostResources(),this.helperGhostMaterial?this.helperGhostSourceGeometryId||(this.helperGhostSourceGeometryId=a):(this.helperGhostMaterial=this.cloneGhostMaterial(r.material,!1),this.helperImpactGhostMaterial=this.cloneGhostMaterial(r.material,!0),this.helperGhostSourceGeometryId=a),!!this.helperGhostMaterial}},{key:"ensureHelperGhostCount",value:function(e){var t,n,i,r,a=null===(r=this.container)||void 0===r||null===(i=r.table)||void 0===i||null===(n=i.cueball)||void 0===n||null===(t=n.ballmesh)||void 0===t?void 0:t.mesh;if(a&&this.helperGhostMaterial)for(;this.helperGhostBalls.length<e;){var o=a.geometry.clone(),s=this.helperGhostMaterial,l=Array.isArray(s)?s.slice():s,u=new c.eaF(o,l);u.visible=!1,u.castShadow=!1,u.receiveShadow=!1,u.name="helperGhostBall-".concat(this.helperGhostBalls.length),u.renderOrder=this.helperGhostGroup.renderOrder+1,u.scale.setScalar(this.helperGhostScale),this.helperGhostGroup.add(u),this.helperGhostBalls.push(u)}}},{key:"generateStraightHelperPoints",value:function(){var e,t,n=null===(t=this.container)||void 0===t||null===(e=t.table)||void 0===e?void 0:e.cueball;if(!n)return null;var i=(0,r.Dz)(this.aim.angle);if(0===i.lengthSq())return null;var a=i.setZ(0).normalize(),o=n.pos.clone(),s=30*this.ballRadius/.5,l=o.clone().addScaledVector(a,s);return[o,l]}},{key:"computeGhostBallPositions",value:function(e,t){if(e.length<2||t<=0)return[];for(var n=[],i=0,r=t,a=1;a<e.length;a++){var o=e[a-1],s=e[a].clone().sub(o),l=s.length();if(0!==l){for(;i+l>=r;){var c=(r-i)/l,u=o.clone().addScaledVector(s,c);if(n.push(u),r+=t,n.length>256)return n}i+=l}}return n}},{key:"hideHelperGhostBalls",value:function(){this.helperGhostBalls.forEach((function(e){e.visible=!1})),this.helperGhostGroup.visible=!1}},{key:"updateHelperGhostBalls",value:function(e,t,n){var i,r,a;if(this.helperVisible){var o=e,s=t;if((!o||o.length<2)&&(o=this.generateStraightHelperPoints(),s=!1),this.ensureHelperGhostResources()){var l,c=null!==(l=null===(a=this.container)||void 0===a||null===(r=a.table)||void 0===r||null===(i=r.cueball)||void 0===i?void 0:i.radius)&&void 0!==l?l:this.ballRadius,u=c*this.helperGhostScale,h=2*this.helperGhostGapDiameterMultiplier*c,d=Math.max(2*u+h,1e-6),f=this.computeGhostBallPositions(o,d);if(s&&o.length>0){var p=o[o.length-1],v=f[f.length-1];if(v&&v.distanceTo(p)<=1e-4||f.push(p.clone()),f.length>=2){var m=f.length-1,y=m-1;f[y].distanceTo(f[m])<2*u-1e-6&&f.splice(y,1)}}if(0!==f.length){this.ensureHelperGhostCount(f.length);for(var g=s&&f.length>0?f.length-1:-1,b=0;b<this.helperGhostBalls.length;b++){var w=this.helperGhostBalls[b];if(b<f.length){w.position.copy(f[b]),w.visible=!0;var k=b===g,P=k?this.helperImpactGhostMaterial:this.helperGhostMaterial;P&&w.material!==P&&(w.material=Array.isArray(P)?P.slice():P,w.renderOrder=k?this.helperGhostGroup.renderOrder+1e4:this.helperGhostGroup.renderOrder+1)}else w.visible=!1}this.updateGhostBallRenderOrder(),this.helperGhostGroup.visible=!0,this.lastHelperPoints=o.map((function(e){return e.clone()})),this.lastHelperHasImpact=s}else this.hideHelperGhostBalls()}else this.hideHelperGhostBalls()}else this.hideHelperGhostBalls()}},{key:"updateGhostBallRenderOrder",value:function(){var e,t,n,i=null===(n=this.container)||void 0===n||null===(t=n.view)||void 0===t||null===(e=t.camera)||void 0===e?void 0:e.camera;if(i){this.helperGhostGroup.updateMatrixWorld(!0);var r=this.helperGhostGroup.renderOrder+1,a=new c.Pq0,o=this.helperGhostBalls.map((function(e,t){return{mesh:e,index:t,distanceSq:e.visible?i.position.distanceToSquared(e.getWorldPosition(a)):1/0}})).filter((function(e){return e.mesh.visible&&Number.isFinite(e.distanceSq)})).sort((function(e,t){return e.distanceSq-t.distanceSq}));o.forEach((function(e,t){e.mesh.renderOrder=r+t}));var s=r+o.length;this.helperGhostBalls.forEach((function(e,t){e.visible||(e.renderOrder=s+t)}))}}},{key:"ghostBalls",get:function(){return this.helperGhostBalls}}],n&&p(t.prototype,n),e}()},8090:(e,t,n)=>{n.d(t,{$8:()=>G,AL:()=>Y,Gf:()=>K,Gp:()=>j,Iy:()=>E,JD:()=>x,Mq:()=>w,QK:()=>C,QV:()=>z,Qy:()=>V,Un:()=>L,c0:()=>_,jj:()=>X,kY:()=>s,lq:()=>l,lx:()=>S,p2:()=>P,s0:()=>B,t6:()=>W,yO:()=>N});var i=n(4922),r=n(12),a=n(5418),o=n(4841),s=!1;function l(){return s=!s}var c=null,u=.02,h=.5,d=1,f=0,p=-.05,v=0,m=.06,y=.5;function g(e,t,n){return Math.max(t,Math.min(n,e))}var b=new i.Pq0;function w(e,t,n){var i,o=null!==(i=null==n?void 0:n.R)&&void 0!==i?i:a.R;return b.copy(e).addScaledVector((0,r.KM)(t),o)}var k={v:new i.Pq0,w:new i.Pq0};function P(e,t,n){var i,o,s,l=null!==(i=null==n?void 0:n.R)&&void 0!==i?i:a.R,c=null!==(o=null==n?void 0:n.m)&&void 0!==o?o:a.m,u=n?(0,a.$0)(n):{Mz:a.Mz,Mxy:a.x3,I:a.I},h=null!==(s=null==n?void 0:n.muS)&&void 0!==s?s:a.gf,d=function(e,t,n){return w(e,t,n).setZ(0)}(e,t,n);return k.v.copy((0,r.xb)(d).multiplyScalar(-h*a.g)),k.w.copy((0,r.xb)((0,r.KM)(d)).multiplyScalar(2.5*h*a.g/l)),k.w.setZ(u.Mz/(c*l*l)*-2.5*Math.sign(t.z)),k}function x(e,t){var n,r,o=null!==(n=null==t?void 0:t.R)&&void 0!==n?n:a.R,s=null!==(r=null==t?void 0:t.m)&&void 0!==r?r:a.m,l=t?(0,a.$0)(t):{Mz:a.Mz,Mxy:a.x3,I:a.I},c=new i.Pq0(e.x,e.y,0).length(),u=5/7*l.Mxy/(s*o)/c,h=5/7*l.Mxy/(s*o*o)/c;return k.v.set(-u*e.y,u*e.x,0),k.w.set(-h*e.x,-h*e.y,l.Mz/(s*o*o)*-2.5*Math.sign(e.z)),k}function S(e,t,n){var i,o=null!==(i=null==n?void 0:n.R)&&void 0!==i?i:a.R,s=t.z;t.copy((0,r.KM)(e).multiplyScalar(1/o)),t.setZ(s)}Object.freeze(k);var M=new i.Pq0,T=new i.Pq0;function E(e,t){var n,i,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,s=arguments.length>4?arguments[4]:void 0,l=e.length(),c=null!==(n=null==s?void 0:s.m)&&void 0!==n?n:a.m,u=null!==(i=null==s?void 0:s.R)&&void 0!==i?i:a.R;if(l<.1)return M.set(0,0,0);if(t.length()<.1)return M.set(0,0,0);var h=o>u*a.v3,d=Math.pow(Math.sin(r),1),f=a.Nv*d;f*=h?a.PK:a.xO,T.crossVectors(t,e),T.z=0;var p=T.length();if(p<.01)return M.set(0,0,0);var v=f*p/c;return M.copy(T).normalize().multiplyScalar(v),M}function C(e,t,n,i){var a=i(t.clone().applyAxisAngle(r.up,e),n.clone().applyAxisAngle(r.up,e));return a.v.applyAxisAngle(r.up,-e),a.w.applyAxisAngle(r.up,-e),a}var R=.1*a.R,A=Math.asin(R/a.R),I=(0,r.F8)(A),O=(0,r.gn)(A);function B(e,t){return new i.Pq0(e.x*I-e.z*O+a.R*t.y,-e.y-a.R*t.z*O+a.R*t.x*I)}function _(e){return e.x*O}function L(e){var t=3.5/a.m;return e.length()/t}function j(e){var t,n=1/a.m,r=g(.39+.257*(t=new i.Pq0(e/O,0,0)).x-.044*t.x*t.x,0,1);return a.gT*((1+r)*e)/n}function N(e,t){var n=j(_(e));return L(B(e,t))<=n}function F(e,t){return{c:_(e),s:B(e,t),A:3.5/a.m,B:1/a.m}}function D(e,t){var n=F(e,t),i=n.c,r=n.s,o=n.A,s=n.B,l=(1+a.e)*(i/s);return q(-r.x/o*I-l*O,r.y/o,r.x/o*O-l*I)}function H(e,t){var n=F(e,t),r=n.c,o=n.B,s=(1+a.e)*(r/o),l=function(e,t){var n=Math.atan2(Math.abs(e.y),Math.max(1e-6,e.x)),r=B(e,null!=t?t:new i.Pq0(0,0,0)).length();return g(d*a._m+(f+p*n+v*n*n)+m*Math.tanh(r/Math.max(1e-6,y)),u,h)}(e,t),c=Math.atan2(e.y,e.x),b=Math.cos(c),w=Math.sin(c);return q(-l*s*b*O-s*O,l*s*w,l*s*b*O-s*I)}function z(e,t){return N(e,t)?D(e,t):H(e,t)}function G(e,t){var n=D(e,t),i=H(e,t),r=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:i.v.lerp(n.v,r),w:i.w.lerp(n.w,r)}}function q(e,t,n){return{v:new i.Pq0(e/a.m,t/a.m),w:new i.Pq0(-a.R/a.I*t*I,a.R/a.I*(e*I-n*O),a.R/a.I*t*O)}}function U(e,t){var n=new o.z(a.m,a.R,a.ee,a.oV,a._m);n.solve(e.x,e.y,t.x,t.y,t.z);var r=new i.Pq0(n.vx,n.vy,0),s=new i.Pq0(n.ωx,n.ωy,n.ωz);return{v:r.sub(e),w:s.sub(t)}}function V(e,t){return C(Math.PI/2,e,t,U)}function K(e,t,n){var r=(new i.Pq0).subVectors(e,t).clone().normalize();return(new i.Pq0).crossVectors(r,n).multiplyScalar(5/(2*a.R))}function W(e,t){var n=Math.atan2(-e.x,e.y),i=2.5*t.length()*(e.length()*a.R)/(a.R*a.R),o=t.clone().normalize(),l=(0,r.KM)(o),c=l.clone().applyAxisAngle(o,n).multiplyScalar(i);if(s){console.log("🎯 cueToSpin() INPUT | Offset:(".concat(e.x.toFixed(3),",").concat(e.y.toFixed(3),",").concat(e.z.toFixed(3),") | Velocity:(").concat(t.x.toFixed(2),",").concat(t.y.toFixed(2),",").concat(t.z.toFixed(2),") | v.length:").concat(t.length().toFixed(2))),console.log("🔧 INTERMEDIATE | dir:(".concat(o.x.toFixed(3),",").concat(o.y.toFixed(3),",").concat(o.z.toFixed(3),") | upCross(dir):(").concat(l.x.toFixed(3),",").concat(l.y.toFixed(3),",").concat(l.z.toFixed(3),")"));var u=180*n/Math.PI;console.log("🌀 SPIN | spinAxis:".concat(u.toFixed(1),"° | Rate:").concat(i.toFixed(1)," → Result:(").concat(c.x.toFixed(1),",").concat(c.y.toFixed(1),",").concat(c.z.toFixed(1),") | Mag:").concat(c.length().toFixed(1))),console.log("")}return c}function X(e,t,n,r){if(c&&(e.remove(c),c.dispose(),c=null),0!==n.lengthSq()){var a=4*r,o=n.clone().normalize(),s=t.clone().addScaledVector(o,-a);s.clone(),o.clone(),t.clone(),c=new i.E0M(o,s,a,0,.15*a,.1*a),e.add(c)}}function Y(e){c&&(e.remove(c),c.dispose(),c=null)}},8207:(e,t,n)=>{n.d(t,{r:()=>o});var i=n(5418);function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var o=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"element",void 0),a(this,"visible",void 0),a(this,"notify",void 0),a(this,"container",void 0),this.notify=null!=t?t:function(){},this.container=n,this.element=document.getElementById("constants"),this.visible=this.computeInitialVisibility(),this.applyVisibility(),this.initialiseSlider("R",i.R,i.jG),this.initialiseSlider("m",i.m,i.Qg),this.initialiseSlider("e",i.e,i.cM),this.initialiseSlider("mu",i.mu,i.Q$),this.initialiseSlider("muS",i.gf,i.Ys),this.initialiseSlider("muC",i.gT,i.kM),this.initialiseSlider("rho",i.kL,i.Wv),this.initialiseSlider("μs",i.oV,i.ko),this.initialiseSlider("μw",i._m,i.ki),this.initialiseSlider("ee",i.ee,i.PX),this.initialiseSlider("magnusCoeff",i.Nv,i.JU,.02),this.initialiseSlider("tableRestitution",i.dM,i.lt,1),this.initialiseSlider("magnusAirborne",i.PK,i.vF,10),this.initialiseSlider("magnusTable",i.xO,i.g8,2)}var t,n;return t=e,n=[{key:"toggleVisibility",value:function(){this.setVisible(!this.visible)}},{key:"setVisible",value:function(e){this.visible!==e&&(this.visible=e,this.applyVisibility())}},{key:"isVisible",value:function(){return this.visible}},{key:"applyVisibility",value:function(){this.element&&(this.element.style.visibility=this.visible?"visible":"hidden")}},{key:"computeInitialVisibility",value:function(){if(!this.element)return!1;if(this.element.style.visibility)return"hidden"!==this.element.style.visibility;if("undefined"!=typeof window&&window.getComputedStyle){var e=window.getComputedStyle(this.element);return"hidden"!==e.visibility&&"none"!==e.display&&"0"!==e.opacity}return!1}},{key:"getInputElement",value:function(e){var t;return null!==(t=document.getElementById(e))&&void 0!==t?t:{}}},{key:"initialiseSlider",value:function(e,t,n){var i=this,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,a=this.getInputElement(e);a&&a.id?(a.step="0.001",a.min="0.01",a.max="".concat(r),a.value=t,this.showValue(e,t),a.oninput=function(t){var r=parseFloat(t.target.value);n(r),i.showValue(e,r),i.container&&void 0!==i.container.lastEventTime&&(i.container.lastEventTime=performance.now()),i.notify()}):console.warn("Slider not found: ".concat(e))}},{key:"showValue",value:function(e,t){var n=document.querySelector("label[for=".concat(e,"]"));n&&(n.innerHTML="".concat(e,"=").concat(t))}}],n&&r(t.prototype,n),e}()},8279:(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{F:()=>r});var r=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i(this,"type",void 0),i(this,"sequence",void 0),i(this,"clientId",void 0)}},8385:(e,t,n)=>{n.d(t,{Z:()=>l});var i=n(8660),r=n(5418),a=n(12);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"pos",void 0),s(this,"radius",void 0),this.pos=t,this.radius=n}var t,n,l;return t=e,l=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(t,n,i){var r=n.futurePosition(i);return t.find((function(t){return e.willFall(t,r)}))}}],(n=[{key:"fall",value:function(e,t){return e.vel.z=-r.g*t,e.state=i.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(a.up,10*-r.R*t*r.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-r.R){var o=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-r.R/2&&(e.vel.addScaledVector(o,7*r.R*t*r.g),e.rvel.addScaledVector((0,a.KM)(o),7*t*r.g)),e.vel.dot(o)<0&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=o.x*e.vel.length()/2,e.vel.y=o.y*e.vel.length()/2)}var s=this.restingDepth(e);n<s&&0!==e.rvel.length()&&(e.pos.z=s,e.vel.z=-r.R/10,e.rvel.copy(a.v_)),n<s-r.R&&(e.pos.z=s-r.R,e.setStationary(),e.state=i.U.InPocket)}},{key:"restingDepth",value:function(e){return-3*r.R-r.R*e.id/4}}])&&o(t.prototype,n),l&&o(t,l),e}()},8660:(e,t,n)=>{n.d(t,{U:()=>c,c:()=>u});var i=n(12),r=n(8090),a=n(4017),o=n(5418);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(e){return e.Stationary="Stationary",e.Rolling="Rolling",e.Sliding="Sliding",e.Falling="Falling",e.InPocket="InPocket",e}({}),u=function(){function e(t,n,r,s){if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"pos",void 0),l(this,"vel",i.v_.clone()),l(this,"rvel",i.v_.clone()),l(this,"futurePos",i.v_.clone()),l(this,"ballmesh",void 0),l(this,"state","Stationary"),l(this,"pocket",void 0),l(this,"physicsContext",o.BY),l(this,"magnusEnabled",!1),l(this,"magnusElevation",0),l(this,"id",e.id++),this.pos=t.clone(),r&&(this.physicsContext=r),s&&s.headless){var c={updateAll:function(){},updateRadius:function(e){},dispose:function(){},color:void 0,radius:this.physicsContext.R,mesh:void 0,trace:{reset:function(){},forceTrace:function(){},addTrace:function(){},addTraceGiven:function(){},addPoint:function(){},line:{visible:!1}}};this.ballmesh=c}else this.ballmesh=new a.J(n||15658734*Math.random(),this.physicsContext.R)}var t,n,c;return t=e,c=[{key:"fromSerialised",value:function(t,n){return e.updateFromSerialised(new e((0,i.t6)(t.pos),void 0,t.physicsContext,n),t)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!==(n=null==t?void 0:t.vel)&&void 0!==n?n:i.v_),e.rvel.copy(null!==(r=null==t?void 0:t.rvel)&&void 0!==r?r:i.v_),e.state="Stationary",void 0!==t.id&&(e.id=t.id),e}}],(n=[{key:"radius",get:function(){return this.physicsContext.R}},{key:"updatePhysicsContext",value:function(e){this.physicsContext=e,this.ballmesh.updateRadius(e.R)}},{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){if(this.inMotion()){var t=this.physicsContext.R*o.v3,n=this.pos.z>t;if(n||(this.pos.z>0&&(this.pos.z=0),this.vel.z>0&&(this.vel.z=0),this.isRolling()?(this.state="Rolling",(0,r.lx)(this.vel,this.rvel,this.physicsContext),this.addDelta(e,(0,r.JD)(this.rvel,this.physicsContext))):(this.state="Sliding",this.addDelta(e,(0,r.p2)(this.vel,this.rvel,this.physicsContext)))),this.magnusEnabled){var i=(0,r.Iy)(this.vel,this.rvel,this.magnusElevation,this.pos.z,this.physicsContext);this.vel.addScaledVector(i,e)}if(n){this.vel.z-=o.g*e;var a=Math.sqrt(this.vel.x*this.vel.x+this.vel.y*this.vel.y);if(a>.01){var s=this.physicsContext.R,l=Math.PI*s*s,c=this.physicsContext.m,u=.5*o.X$*o.KO*l*a*a/c,h=Math.max(0,1-u*e/a);this.vel.x*=h,this.vel.y*=h}}else if(this.pos.z<0&&(this.pos.z=0),this.vel.z<0){var d=o.dM;Math.abs(this.vel.z)>.1?(this.vel.z=-this.vel.z*d,this.pos.z<t&&(this.pos.z=t),this.vel.x*=.9,this.vel.y*=.9):(this.vel.z=0,this.pos.z=0)}}}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t,n,r=(0,i.rq)(this.vel,e.v),a=(0,i.rq)(this.rvel,e.w),o="Rolling"===this.state?r||a:r&&a,s=this.vel.length(),l=null!==(n=null===(t=this.physicsContext)||void 0===t?void 0:t.spinStopThreshold)&&void 0!==n?n:.01,c=this.rvel.length();return!!((o||s<.001)&&c<l)&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(i.v_),this.rvel.copy(i.v_),this.state="Stationary"}},{key:"isRolling",value:function(){var t,n,i=null!==(n=null===(t=this.physicsContext)||void 0===t?void 0:t.rollingTransition)&&void 0!==n?n:e.transition;return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,r.Mq)(this.vel,this.rvel,this.physicsContext).length()<i}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id,physicsContext:this.physicsContext}}}])&&s(t.prototype,n),c&&s(t,c),e}();l(u,"id",0),l(u,"transition",.05)},8738:(e,t,n)=>{n.d(t,{Qe:()=>r.Q,pd:()=>a.p,wG:()=>i.w,xI:()=>s}),n(3206);var i=n(2522),r=n(2518),a=n(3413);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n(1943),n(5159);var s=function(){function e(t){var n,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=void 0,(n="container")in this?Object.defineProperty(this,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[n]=i,this.container=t}var t,n;return t=e,(n=[{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"onFirst",value:function(){}}])&&o(t.prototype,n),e}()},8765:(e,t,n)=>{n.d(t,{n:()=>T});var i=n(3467),r=n(772),a=n(5556),o=n(4979),s=n(8090),l=n(8790),c=n(4922);function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var d=function(){function e(t){var n,i,r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=void 0,(n="shots")in this?Object.defineProperty(this,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[n]=i,this.shots=t.map((function(e){return r.interpolateAllBalls(e)}))}var t,n;return t=e,n=[{key:"interpolateUntilMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return e.t.length>1&&e.t[1]-e.t[0]>t&&(e.t.splice(1,0,e.t[1]-n),e.x.splice(1,0,e.x[0]),e.y.splice(1,0,e.y[0])),e}},{key:"interpolateAllBalls",value:function(e){var t=this;return e.balls=Object.fromEntries(Object.entries(e.balls).map((function(e){var n,i,r=(i=2,function(e){if(Array.isArray(e))return e}(n=e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,a=[],o=!0,s=!1;try{for(n=n.call(e);!(o=(i=n.next()).done)&&(a.push(i.value),!t||a.length!==t);o=!0);}catch(e){s=!0,r=e}finally{try{o||null==n.return||n.return()}finally{if(s)throw r}}return a}}(n,i)||function(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}(n,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),a=r[0],o=r[1];return[a,t.interpolateUntilMove(o)]}))),e}},{key:"getInterpolatedPosition",value:function(e,t,n){if(!e||0===e.length)return t[0];if(n<=e[0])return t[0];if(n>=e[e.length-1])return t[t.length-1];for(var i=0,r=e.length-1;i<r-1;){var a=Math.floor((i+r)/2);e[a]<n?i=a:r=a}var o=e[i],s=e[r],l=t[i];return l+(n-o)/(s-o)*(t[r]-l)}},{key:"getPositionsAtTime",value:function(e,t){var n=this.shots.find((function(t){return t.shotID===e})),i={};for(var r in n.balls){var a=n.balls[r],o=this.getInterpolatedPosition(a.t,a.x,t),s=this.getInterpolatedPosition(a.t,a.y,t);i[r]={x:o,y:s}}return i}},{key:"realToSim",value:function(e,t){return{x:2.3*(.71-t[e].x/2),y:2.3*(t[e].y/2-.36)}}},{key:"identifyFirstMover",value:function(e){return e.balls[1].t[1]<e.balls[2].t[1]?"1":"2"}},{key:"estimateDirection",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n=this.getPositionsAtTime(e.shotID,.2),i=this.identifyFirstMover(e),r=t[i],a=new c.Pq0(r.x,r.y),o=n[i],s=new c.Pq0(o.x,o.y);return{pos1:t,pos2:n,firstMover:i,speed:2*a.distanceTo(s),angle:new c.Pq0(-1,0).angleTo(s.sub(a))}}},{key:"stateFrom",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n={init:[],shots:[]};for(var i in t){var r=this.realToSim(i,t);n.init.push(r.x),n.init.push(r.y)}var a=this.estimateDirection(e),o="1"==a.firstMover?0:1;return n.shots.push({type:"AIM",offset:{x:-0,y:0,z:0},angle:a.angle,power:a.speed,pos:{x:n.init[2*o],y:n.init[2*o+1],z:0},i:o}),n}}],n&&h(t.prototype,n),e}();function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),p(this,"ctx",void 0),p(this,"canvas",void 0),p(this,"BALL_COLORS",{1:"white",2:"yellow",3:"red"}),p(this,"BALL_DIAMETER",.0615),p(this,"TABLE_WIDTH",2.84),p(this,"PIXELS_PER_METER",void 0),p(this,"ballPaths",{}),this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.PIXELS_PER_METER=this.canvas.width/this.TABLE_WIDTH}var t,n;return t=e,(n=[{key:"drawBall",value:function(e,t,n){var i=this.BALL_DIAMETER/2*this.PIXELS_PER_METER,r=this.canvas.width-e,a=t;this.ctx.beginPath(),this.ctx.arc(r,a,i,0,2*Math.PI),this.ctx.fillStyle=n,this.ctx.fill(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()}},{key:"drawBallPath",value:function(e,t){var n=this,i=this.BALL_COLORS[e];this.ctx.save(),this.ctx.beginPath(),t.forEach((function(e,t){var i=n.canvas.width-e.x*n.PIXELS_PER_METER,r=n.canvas.height-e.y*n.PIXELS_PER_METER;0===t?n.ctx.moveTo(i,r):n.ctx.lineTo(i,r)})),this.ctx.setLineDash([4,4]),this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"drawShot",value:function(e){for(var t in this.ballPaths)this.drawBallPath(t,this.ballPaths[t]);for(var n in e){var i=e[n],r=this.BALL_COLORS[n],a=i.x*this.PIXELS_PER_METER,o=this.canvas.height-i.y*this.PIXELS_PER_METER;this.drawBall(a,o,r)}}},{key:"resetCanvas",value:function(){this.clear(),this.ballPaths={}}},{key:"updateBallPaths",value:function(e,t){this.ballPaths[e]||(this.ballPaths[e]=[]),this.ballPaths[e].push(t)}}])&&f(t.prototype,n),e}(),m=n(1943),y=n(3206);function g(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function b(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){function e(){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),b(this,"aimBall",void 0),b(this,"aimCoordinatesDisplay",void 0),b(this,"aimBallContainer",void 0),b(this,"powerSlider",void 0),b(this,"directionSlider",void 0),b(this,"BALL_CONTAINER_RADIUS",void 0),b(this,"MAX_DISTANCE",.7),b(this,"position",{x:0,y:0}),b(this,"power",5),b(this,"direction",0),this.aimBall=document.getElementById("aim-ball"),this.aimCoordinatesDisplay=document.getElementById("aim-coordinates"),this.aimBallContainer=document.getElementById("aim-ball-container"),this.powerSlider=document.getElementById("power"),this.directionSlider=document.getElementById("direction"),this.BALL_CONTAINER_RADIUS=((null===(t=this.aimBallContainer)||void 0===t?void 0:t.clientWidth)||0)/2,this.addEventListeners()}var t,n;return t=e,(n=[{key:"addEventListeners",value:function(){var e,t,n,i=this;null===(e=this.aimBallContainer)||void 0===e||e.addEventListener("click",(function(e){return i.handleClick(e)})),null===(t=this.powerSlider)||void 0===t||t.addEventListener("input",(function(e){i.power=parseInt(e.target.value)})),null===(n=this.directionSlider)||void 0===n||n.addEventListener("input",(function(e){i.direction=parseInt(e.target.value)}))}},{key:"handleClick",value:function(e){if(this.aimBallContainer&&this.aimBall){var t=this.aimBallContainer.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,i=e.clientY-t.top-t.height/2;if(Math.sqrt(n*n+i*i)>this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS){var r=Math.atan2(i,n);n=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.cos(r),i=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.sin(r)}var a=t.width/2-this.aimBall.offsetWidth/2,o=-a,s=t.height/2-this.aimBall.offsetHeight/2,l=-s,c=Math.max(o,Math.min(a,n)),u=Math.max(l,Math.min(s,i));this.position.x=c/this.BALL_CONTAINER_RADIUS,this.position.y=u/this.BALL_CONTAINER_RADIUS,this.updateDom()}}},{key:"updateDom",value:function(){if(this.aimBall&&this.aimBallContainer){var e=this.aimBallContainer.getBoundingClientRect(),t=this.position.x*this.BALL_CONTAINER_RADIUS,n=this.position.y*this.BALL_CONTAINER_RADIUS;this.aimBall.style.left="".concat(t+e.width/2-this.aimBall.offsetWidth/2,"px"),this.aimBall.style.top="".concat(n+e.height/2-this.aimBall.offsetHeight/2,"px"),this.aimCoordinatesDisplay&&(this.aimCoordinatesDisplay.textContent="x: ".concat(this.position.x.toFixed(2),", y: ").concat(this.position.y.toFixed(2)))}}},{key:"getAim",value:function(){return{offset:{x:this.position.x,y:this.position.y,z:0},angle:this.direction,power:this.power}}},{key:"setAim",value:function(e){this.position.x=e.offset.x,this.position.y=e.offset.y,this.power=e.power,this.powerSlider.value=e.power.toString(),this.direction=e.angle,this.directionSlider.value=e.angle.toString(),this.updateDom()}}])&&g(t.prototype,n),e}();function k(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),P(this,"drawer",void 0),P(this,"aimInputs",void 0),P(this,"fileInput",document.getElementById("fileInput")),P(this,"shotIndexDisplay",document.getElementById("shotIndexDisplay")),P(this,"shotSelector",document.getElementById("shotSelector")),P(this,"replayButton",document.getElementById("replay")),P(this,"myIframe",document.getElementById("myIframe")),P(this,"allShots",[]),P(this,"currentShotIndex",0),P(this,"animationTimer",-2.35),P(this,"isPlaying",!1),P(this,"lastFrameTime",0),P(this,"animationStartTime",0),P(this,"realPosition",null),P(this,"elapsedTime",0),P(this,"container",void 0),this.drawer=new v(t),this.container=n,this.aimInputs=new w,n&&(n.frame=this.advance.bind(this)),this.start()}var t,n;return t=e,n=[{key:"start",value:function(){console.log("real overlay start"),this.loadDefaultData(),this.addEventListeners()}},{key:"addEventListeners",value:function(){var e=this;this.fileInput.addEventListener("change",(function(t){return e.handleFileChange(t)})),this.shotSelector.addEventListener("change",(function(){return e.handleShotSelect()})),this.replayButton.addEventListener("click",(function(){return e.handleReplay()}))}},{key:"handleFileChange",value:function(e){var t=this,n=e.target.files[0];if(n){var i=new FileReader;i.onload=function(e){try{var n=JSON.parse(e.target.result);t.processShots(n)}catch(e){console.error("Error parsing JSON:",e),alert("Error parsing JSON file.")}},i.readAsText(n)}}},{key:"handleShotSelect",value:function(){this.currentShotIndex=parseInt(this.shotSelector.value,10),this.updateDisplay(),this.resetAnimation()}},{key:"loadDefaultData",value:function(){var e=this;fetch("simple_shots.json").then((function(e){if(!e.ok)throw new Error("HTTP error! status: ".concat(e.status));return e.json()})).then((function(t){return e.processShots(t)}))}},{key:"processShots",value:function(e){this.allShots=e,this.realPosition=new d(this.allShots),this.allShots.length>0&&(this.currentShotIndex=0,this.populateShotSelector(),this.updateDisplay(),this.resetAnimation())}},{key:"populateShotSelector",value:function(){var e=this;this.shotSelector.innerHTML="",this.allShots.forEach((function(t,n){var i=document.createElement("option");i.value=n.toString(),i.text="Shot ".concat(n+1," (ID: ").concat(t.shotID,")"),e.shotSelector.appendChild(i)})),this.allShots.length>0&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"updateDisplay",value:function(){this.shotIndexDisplay.textContent="Shot: ".concat(this.currentShotIndex+1),this.allShots[this.currentShotIndex]&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"drawShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.realPosition){var n=this.realPosition.getPositionsAtTime(e.shotID,t);if(n){for(var i in n)this.drawer.updateBallPaths(i,n[i]);this.drawer.clear(),this.drawer.drawShot(n)}}}},{key:"handleReplay",value:function(){this.resetAnimation()}},{key:"resetAnimation",value:function(){this.isPlaying=!1,this.animationTimer=-2.3,this.drawer.resetCanvas(),this.drawShot(this.allShots[this.currentShotIndex],0),this.resetSimulation(this.allShots[this.currentShotIndex])}},{key:"resetSimulation",value:function(e){console.log("reset simulation");var t=this.realPosition.stateFrom(e);this.container.table.updateFromShortSerialised(t.init),this.container.eventQueue.push(new m.h),this.container.eventQueue.push(new y.u),this.container.eventQueue.push(new a.W(t.init,t.shots)),this.aimInputs.setAim(t.shots[0])}},{key:"advance",value:function(e){this.elapsedTime+=e,this.animationTimer+=e;var t=this.allShots[this.currentShotIndex];this.drawShot(t,this.animationTimer)}}],n&&k(t.prototype,n),e}();function S(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function M(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){function e(t,n,i){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),M(this,"container",void 0),M(this,"canvas3d",void 0),M(this,"ruletype",void 0),M(this,"replay",void 0),M(this,"cushionModel",void 0),M(this,"breakState",{init:null,shots:Array()}),M(this,"realOverlay",void 0),M(this,"onAssetsReady",(function(){console.log("diagram ready");var e=document.getElementById("replay");r.replayButton(e);var t=document.getElementById("overlaycanvas");t?r.realOverlay=new x(t,r.container):(r.breakState=JSON.parse(decodeURIComponent(r.replay)),r.container.eventQueue.push(new a.W(r.breakState.init,r.breakState.shots))),r.container.animate(performance.now())})),this.replay=i,this.ruletype=n,this.canvas3d=t,o.v.zoomFactor=.88}var t,n,c;return t=e,c=[{key:"fromDiamgramElement",value:function(t){var n=null==t?void 0:t.getElementsByClassName("topview")[0],i=null==n?void 0:n.getAttribute("data-state"),r=new URLSearchParams(i),a=null==t?void 0:t.getElementsByClassName("description")[0],o=document.getElementById("common"),l=document.createElement("a");l.href="../".concat(i),l.innerHTML="⬀",l.target="_blank",null==a||a.appendChild(l),null==o||o.appendChild(l);var c=document.createElement("button");null==a||a.appendChild(c);var u=new e(n,r.get("ruletype"),r.get("state"));return u.replayButton(c),"bounceHan"==r.get("cushionModel")&&(u.cushionModel=s.QV),u}}],(n=[{key:"start",value:function(){var e=new r.s(this.canvas3d);this.container=new i.m(this.canvas3d,(function(){}),l.s.localAssets(this.ruletype),this.ruletype,e,"diagram"),this.cushionModel&&(this.container.table.cushionModel=this.cushionModel),this.onAssetsReady()}},{key:"replayButton",value:function(e){var t=this;e.innerHTML="↻",e.addEventListener("click",(function(){var e;0==t.container.eventQueue.length&&t.container.eventQueue.push(new a.W(t.breakState.init,t.breakState.shots)),null===(e=t.realOverlay)||void 0===e||e.start()}))}}])&&S(t.prototype,n),c&&S(t,c),e}()},8790:(e,t,n)=>{n.d(t,{s:()=>v});var i=n(4922),r=n(9588),a=n(128);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"listener",void 0),s(this,"audioLoader",void 0),s(this,"ballcollision",void 0),s(this,"cue",void 0),s(this,"cushion",void 0),s(this,"pot",void 0),s(this,"success",void 0),s(this,"lastOutcomeTime",Number.NEGATIVE_INFINITY),s(this,"lastOutcomeIndex",-1),s(this,"lastOutcomeArray",null),s(this,"loadAssets",void 0),this.loadAssets=t,t&&(this.listener=new i.Pf$,this.audioLoader=new i.Am1,this.ballcollision=new i.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new i.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new i.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new i.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new i.fP5(this.listener),this.load("sounds/success.ogg",this.success))}var t,n;return t=e,n=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,(function(e){t.setBuffer(e),t.setLoop(!1)}),(function(e){}),(function(e){}))}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,a,o=i.UtX.getContext();if("suspended"===(null==o?void 0:o.state))return void((null===(a=navigator)||void 0===a||null===(r=a.userActivation)||void 0===r?void 0:r.hasBeenActive)&&o.resume());e.setVolume(t),e.isPlaying&&e.stop(),e.play(i.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/10*10,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10*10,10*e.incidentSpeed-1e3),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/90*10),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30*10)}},{key:"processOutcomes",value:function(e){if(e&&0!==e.length){this.lastOutcomeArray!==e?(this.lastOutcomeArray=e,this.lastOutcomeTime=Number.NEGATIVE_INFINITY,this.lastOutcomeIndex=-1):this.lastOutcomeIndex>=e.length&&(this.lastOutcomeIndex=e.length-1);for(var t=this.lastOutcomeIndex+1;t<e.length;t++){var n=e[t];if(n.timestamp>this.lastOutcomeTime||n.timestamp===this.lastOutcomeTime&&t>this.lastOutcomeIndex){this.lastOutcomeTime=n.timestamp,this.lastOutcomeIndex=t,this.outcomeToSound(n);break}}}}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],n&&o(t.prototype,n),e}(),c=n(3908),u=n(363),h=n(665);function d(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}var v=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),f(this,"ready",void 0),f(this,"rules",void 0),f(this,"background",void 0),f(this,"table",void 0),f(this,"sound",void 0),f(this,"cue",void 0),f(this,"ballGeometry",void 0),this.rules=r.V.create(t,null),this.rules.tableGeometry()}var t,n,o;return t=e,o=[{key:"localAssets",value:function(){var t=new e(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"");return t.creatLocal(),t}}],(n=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new l(!0),this.ballGeometry=new i.Gu$(1,64,32),(0,a.Ro)("models/background.gltf",(function(e){t.background=e.scene,t.done()})),(0,a.Ro)("models/cue.gltf",(function(e){t.cue=e.scene,u.l.mesh=e.scene.children&&e.scene.children[0],t.done()}));var n=this.rules.asset();n&&n.length>0?(0,a.Ro)(n,(function(e){t.table=e.scene;var n=c.o.mesh;if(!n){var r=Array.isArray(t.table.children)?t.table.children:[];n=r.find((function(e){var t=(e.name||"").toLowerCase();return t.includes("cloth")||t.includes("playfield")||t.includes("felt")}))}if(n||t.table.traverse((function(e){if(!n){var t=(e.name||"").toLowerCase();(t.includes("cloth")||t.includes("playfield")||t.includes("felt"))&&(n=e)}})),n||(n=t.table.children&&t.table.children[0]||void 0),!n)throw new Error("Playfield (cloth) mesh not found in GLTF.");n.updateMatrixWorld(!0);var a=(new i.NRn).setFromObject(n),o=new i.Pq0;a.getSize(o);var s=2*h.P.X,l=2*h.P.Y,u=s/(o.x||1),d=l/(o.y||1),f=s/(o.y||1),v=l/(o.x||1),m=Math.abs(u-d)>Math.abs(f-v)?Math.min(f,v):Math.min(u,d);t.table.scale.multiplyScalar(m),t.table.updateMatrixWorld(!0),a=(new i.NRn).setFromObject(n);var y=new i.Pq0;if(a.getCenter(y),t.table.position.x-=y.x,t.table.position.y-=y.y,h.P.hasPockets)c.o.caromSurfaces=null;else{var g=p(n,i.eaF)?n:null;g||n.traverse((function(e){!g&&p(e,i.eaF)&&(g=e)}));var b=[];t.table.traverse((function(e){if(p(e,i.eaF)&&e!==g){var t=(e.name||"").toLowerCase();(t.includes("cushion")||t.includes("rail")||t.includes("bande")||t.includes("bank"))&&b.push(e)}})),b.length||t.table.children.forEach((function(e){p(e,i.eaF)&&e!==g&&b.push(e)})),g&&(c.o.caromSurfaces={cloth:g,cushions:b})}c.o.mesh||(c.o.mesh=e.scene.children&&e.scene.children[0]),t.done()})):(console.log("No GLTF asset path provided. Generating table procedurally."),this.table=(new c.o).generateTable(h.P.hasPockets),this.done())}},{key:"creatLocal",value:function(){this.sound=new l(!1),c.o.mesh=(new c.o).generateTable(h.P.hasPockets),this.table=c.o.mesh,this.ballGeometry=new i.Gu$(1,64,32)}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready&&this.ready()}}])&&d(t.prototype,n),o&&d(t,o),e}()},8938:(e,t,n)=>{n.d(t,{r:()=>l});var i=n(1279);function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function s(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(s=function(){return!!e})()}var l=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=a(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,s()?Reflect.construct(t,n||[],a(e).constructor):t.apply(e,n))}(this,t,[e])).container.table.cueball&&n.container.table.cue.moveTo(n.container.table.cueball.pos),n.container.view.camera.suggestMode(n.container.view.camera.topView),n}var n,l;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}(t,e),n=t,(l=[{key:"handleAim",value:function(e){var t=this.container.table;t.cue.aim=e;var n=t.balls;if(Number.isInteger(e.i)&&e.i>=0&&e.i<n.length){var i=n[e.i];t.cueball!==i&&(t.cueball=i)}return t.cueball.pos.copy(e.pos),void 0!==e.elevation&&Number.isFinite(e.elevation)&&(t.cue.elevation=e.elevation),this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),this.container.table.cueball&&(this.container.rules.cueball=this.container.table.cueball),new i.O(this.container)}}])&&r(n.prototype,l),t}(n(5615).y)},9034:(e,t,n)=>{n.d(t,{p:()=>s});var i=n(4945),r=n.n(i);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"osmane-billiards-network.onrender.com";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"baseURL",void 0),o(this,"websockets",void 0),this.baseURL=t,this.websockets=new Map}var t,n;return t=e,(n=[{key:"subscribe",value:function(e,t){var n="wss://".concat(this.baseURL,"/subscribe/table/").concat(e),i=new WebSocket(n);console.log("Subscribed to ",n),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(n))},i.onclose=function(e){console.log("Disconnected from ".concat(n,":"),e.reason)},this.websockets.set(e,i)}},{key:"publish",value:function(e,t){var n="https://".concat(this.baseURL,"/publish/table/").concat(e);r()(n,{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch((function(e){console.error("Publication error:",e)}))}}])&&a(t.prototype,n),e}()},9241:(e,t,n)=>{n.d(t,{C:()=>i,i:()=>r});var i=1/512,r=.008},9419:(e,t,n)=>{n.d(t,{x:()=>c});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e,n,i,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t),a=void 0,(i="ballinfo")in(n=e)?Object.defineProperty(n,i,{value:a,enumerable:!0,configurable:!0,writable:!0}):n[i]=a,e.type=r.B.RERACK,e}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){var n=new t;return n.ballinfo=e,n}}],(i=[{key:"applyToController",value:function(e){return e.container.table.updateFromSerialised(this.ballinfo),e}}])&&a(n.prototype,i),c&&a(n,c),t}(i.F)},9588:(e,t,n)=>{n.d(t,{V:()=>U});var i=n(4368),r=n(8660),a=n(665),o=n(4922),s=n(12),l=n(5418);function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"jitter",value:function(t){return(0,s.ld)(t.clone().add(new o.Pq0(e.noise*(Math.random()-.5),e.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(t,n){return new r.c(e.jitter(t),16444375,n)}},{key:"diamond",value:function(){var t=new o.Pq0(a.P.tableX/2,0,0),n=[];return n.push(e.cueBall(e.spot,l.BY)),n.push(new r.c(e.jitter(t),14736950,l.BY)),t.add(e.diagonal),n.push(new r.c(e.jitter(t),16751872,l.BY)),t.sub(e.across),n.push(new r.c(e.jitter(t),5380369,l.BY)),t.add(e.diagonal),n.push(new r.c(e.jitter(t),5853696,l.BY)),t.sub(e.across),n.push(new r.c(e.jitter(t),16711680,l.BY)),t.addScaledVector(e.across,2),n.push(new r.c(e.jitter(t),328965,l.BY)),t.add(e.diagonal).sub(e.across),n.push(new r.c(e.jitter(t),685250,l.BY)),t.sub(e.across),n.push(new r.c(e.jitter(t),553728,l.BY)),t.add(e.diagonal),n.push(new r.c(e.jitter(t),4063388,l.BY)),n}},{key:"triangle",value:function(){var t=e.trianglePositions(),n=e.cueBall(e.spot,l.BY),i=t.map((function(t){return new r.c(e.jitter(t),void 0,l.BY)}));return i.unshift(n),i.slice(0,5)}},{key:"trianglePositions",value:function(){var e=[],t=new o.Pq0(a.P.X/2,0,0);return e.push((0,s.t6)(t)),t.add(this.diagonal),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.add(this.diagonal),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.addScaledVector(this.across,2),e.push((0,s.t6)(t)),t.add(this.diagonal),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.sub(this.across),e.push((0,s.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),t.add(this.across),e.push((0,s.t6)(t)),e}},{key:"rerack",value:function(t,n){var i=e.trianglePositions(),a=i.shift();n.balls.filter((function(e){return e!==n.cueball})).filter((function(e){return e!==t})).forEach((function(t){t.pos.copy(e.jitter(i.shift())),t.state=r.U.Stationary})),n.overlapsAny(t.pos,t)&&t.pos.copy(a),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(e.spot)}},{key:"three",value:function(){var t=[],n=a.P.X/2,i=a.P.Y/4,s=e.cueBall(e.jitter(new o.Pq0(-n,-i,0)),l.ZZ);s.ballmesh.applySymmetricDots(16711680);var c=new r.c(e.jitter(new o.Pq0(-n,0,0)),14736950,l.ZZ);c.ballmesh.applySymmetricDots(16711680);var u=new r.c(e.jitter(new o.Pq0(n,0,0)),16711680,l.ZZ);return t.push(s),t.push(c),t.push(u),t}},{key:"snooker",value:function(){var t=[],n=a.P.Y/4;t.push(e.cueBall(e.jitter(new o.Pq0(e.baulk,.5*-n,0)),l.wK));var i=e.snookerColourPositions();return t.push(new r.c(e.jitter(i[0]),15654454,l.wK)),t.push(new r.c(e.jitter(i[1]),824932,l.wK)),t.push(new r.c(e.jitter(i[2]),12415546,l.wK)),t.push(new r.c(e.jitter(i[3]),558062,l.wK)),t.push(new r.c(e.jitter(i[4]),16755404,l.wK)),t.push(new r.c(e.jitter(i[5]),65793,l.wK)),e.trianglePositions().slice(0,15).forEach((function(n){t.push(new r.c(e.jitter(n.add(e.down)),15597568,l.wK))})),t}},{key:"snookerColourPositions",value:function(){var t=a.P.X/2,n=a.P.X-2*a.P.X/11,i=[];return i.push(new o.Pq0(e.baulk,-e.sixth,0)),i.push(new o.Pq0(e.baulk,e.sixth,0)),i.push(new o.Pq0(e.baulk,0,0)),i.push(new o.Pq0(0,0,0)),i.push(new o.Pq0(t,0,0)),i.push(new o.Pq0(n,0,0)),i}}],null&&c(t.prototype,null),n&&c(t,n),e}();u(h,"noise",.0233*l.R),u(h,"gap",2*l.R+2*h.noise),u(h,"up",new o.Pq0(0,0,-1)),u(h,"spot",new o.Pq0(-a.P.X/2,0,0)),u(h,"across",new o.Pq0(0,h.gap,0)),u(h,"down",new o.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,1*Math.PI/3)),u(h,"sixth",2*a.P.Y/6),u(h,"baulk",-1.5*a.P.X*2/5);var d=n(4853),f=n(4110),p=n(8938),v=n(9915),m=n(7387),y=n(3645),g=n(5597),b=n(4005);function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"respot",value:function(t,n){var i=h.snookerColourPositions();return i.push(i[t.id-1]),i.reverse(),i.some((function(e){return!n.overlapsAny(e,t)&&(t.pos.copy(e),t.state=r.U.Stationary,!0)}))||e.respotBehind(i[0],t,n),t}},{key:"respotBehind",value:function(e,t,n){for(var i=e.clone();i.x<a.P.tableX&&n.overlapsAny(i,t);)i.x+=t.radius/8;for(;i.x>-a.P.tableX&&n.overlapsAny(i,t);)i.x-=t.radius/8;t.pos.copy(i),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter((function(e){return e.onTable()})).filter((function(t){return t!==e}));if(0!==n.length){var i=function(t){return e.pos.distanceTo(t.pos)};return n.reduce((function(e,t){return i(e)<i(t)?e:t}),n[0])}}}],null&&w(t.prototype,null),n&&w(t,n),e}(),P=n(2582);function x(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var M=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),S(this,"container",void 0),S(this,"cueball",void 0),S(this,"currentBreak",0),S(this,"previousBreak",0),S(this,"score",0),S(this,"rulename","nineball"),this.container=t}var t,n;return t=e,(n=[{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){return k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){if(e){var t=new o.Pq0(-a.P.X/2,a.P.tableY),n=new o.Pq0(-a.P.tableX,-a.P.tableY);return e.clamp(n,t)}return new o.Pq0(11*-l.R/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){a.P.hasPockets=!0}},{key:"table",value:function(){var e=new g.X(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return h.diamond()}},{key:"update",value:function(e){var t=this.container.table;if(y.P.isCueBallPotted(t.cueball,e))return this.startTurn(),this.container.isSinglePlayer?new f.x(this.container):(this.container.sendEvent(new m.z(s.v_,!0)),new p.r(this.container));if(y.P.isBallPottedNoFoul(t.cueball,e)){var n=y.P.potCount(e);return this.currentBreak+=n,this.score+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e)?(this.container.eventQueue.push(new v.b(null,"game over")),this.container.recorder.wholeGameLink(),new b.o(this.container)):(this.container.sendEvent(new i.Q(t.serialise())),new d.m(this.container))}return this.container.sendEvent(new P.M),this.container.isSinglePlayer?(this.container.sendEvent(new i.Q(t.serialise())),this.startTurn(),new d.m(this.container)):new p.r(this.container)}},{key:"isPartOfBreak",value:function(e){return y.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){var t=this.container.table.balls.filter((function(e){return e.onTable()}));return 1===t.length&&t[0]===this.cueball}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}}])&&x(t.prototype,n),e}();function T(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function E(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function C(e,t,n){return C="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=R(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n||e):r.value}},C(e,t,n||e)}function R(e){return R=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},R(e)}function A(e,t){return A=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},A(e,t)}function I(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(I=function(){return!!e})()}var O=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=R(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,I()?Reflect.construct(t,n||[],R(e).constructor):t.apply(e,n))}(this,t,[e])).rulename="fourteenone",n}var n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&A(e,t)}(t,e),n=t,r=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return h.triangle()}},{key:"update",value:function(e){var n=this.container.table;return this.checkRerack(n),C(R(t.prototype),"update",this).call(this,e)}},{key:"checkRerack",value:function(e){var t,n,r=e.balls.filter((function(e){return e.onTable()})).filter((function(t){return t!==e.cueball}));if(1===r.length){h.rerack(r[0],e),this.container.sound.playSuccess(e.inPockets());var a=e.serialise(),o=new i.Q((t=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){E(e,t,n[t])}))}return e}({},a),n=null!=(n={rerack:!0})?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})),t));this.container.sendEvent(o),this.container.recorder.record(o),this.container.recorder.wholeGameLink()}}}],r&&T(n.prototype,r),t}(M);function B(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var _=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"shotInfo",value:function(t,n,i){var r=y.P.firstCollision(n);return{pots:y.P.potCount(n),firstCollision:r,legalFirstCollision:e.isLegalFirstCollision(t,i,r),whitePotted:y.P.isCueBallPotted(t.cueball,n)}}},{key:"isLegalFirstCollision",value:function(t,n,i){if(!i)return!1;var r=i.ballB.id;return n?r>=7:!(e.coloursOnTable(t).filter((function(e){return e.id<r})).length>0)}},{key:"respotAllPottedColours",value:function(e,t){return y.P.pots(t).filter((function(e){return e.id<7})).filter((function(e){return 0!==e.id})).map((function(t){return k.respot(t,e)}))}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter((function(e){return e.onTable()}))}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter((function(e){return e.onTable()}))}}],null&&B(t.prototype,null),n&&B(t,n),e}();function L(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function N(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var F=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),N(this,"cueball",void 0),N(this,"previousPotRed",!1),N(this,"targetIsRed",!0),N(this,"currentBreak",0),N(this,"previousBreak",0),N(this,"foulPoints",0),N(this,"score",0),N(this,"rulename","snooker"),N(this,"container",void 0),this.container=t}var t,n;return t=e,(n=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=_.shotInfo(this.container.table,e,this.targetIsRed);if(0===t.pots){if(!t.legalFirstCollision){var n,i,r,a=null!==(r=null===(i=t.firstCollision)||void 0===i||null===(n=i.ballB)||void 0===n?void 0:n.id)&&void 0!==r?r:0;this.foulPoints=Math.max(4,a+1)}return this.currentBreak,this.targetIsRed=_.redsOnTable(this.container.table).length>0,this.switchPlayer()}return this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return console.log("applying target red rule"),t.legalFirstCollision&&y.P.onlyRedsPotted(e)?(this.currentBreak+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.container.hud.updateBreak(this.currentBreak),this.continueBreak()):(this.foulPoints=this.foulCalculation(e,t),this.respot(e),t.whitePotted?this.whiteInHand():this.switchPlayer())}},{key:"targetColourRule",value:function(e,t){if(console.log("applying target colour rule"),t.whitePotted)return this.respot(e),this.whiteInHand();if(t.pots>1)return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer();if(y.P.pots(e)[0].id>6)return this.foulPoints=this.foulCalculation(e,t),this.switchPlayer();this.targetIsRed=_.redsOnTable(this.container.table).length>0;var n=y.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak()):_.coloursOnTable(this.container.table).filter((function(e){return e.id<n})).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak())}},{key:"foul",value:function(e,t){return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer()}},{key:"foulCalculation",value:function(e,t){var n,i,r,a,o,s=y.P.pots(e).map((function(e){return e.id})).filter((function(e){return e<7})),l=null!==(a=null===(r=t.firstCollision)||void 0===r||null===(i=r.ballB)||void 0===i?void 0:i.id)&&void 0!==a?a:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return L(e)}(o=s)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(o)||function(e,t){if(e){if("string"==typeof e)return L(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?L(e,t):void 0}}(o)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"tableGeometry",value:function(){a.P.hasPockets=!0}},{key:"table",value:function(){var e=new g.X(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return y.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return e.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=_.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.score+=this.currentBreak,this.currentBreak=0,this.container.hud.updateBreak(this.currentBreak)}},{key:"rack",value:function(){return h.snooker()}},{key:"nextCandidateBall",value:function(){var e=this.container.table,t=_.redsOnTable(e),n=_.coloursOnTable(e);return this.previousPotRed?k.closest(e.cueball,n):t.length>0?k.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new o.Pq0(h.baulk,0,0),n=h.sixth,i=e.distanceTo(t);if(e.x>=h.baulk&&(e.x=h.baulk),i>n){var r=e.clone().sub(t).normalize();return t.add(r.multiplyScalar(n))}return e}return new o.Pq0(h.baulk,-h.sixth/2.6,0)}},{key:"switchPlayer",value:function(){this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),console.log("end of break, switch player");var e=this.container.table;return console.log(e.cue.aim),this.container.sendEvent(new P.M(this.foulPoints)),this.container.isSinglePlayer?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new d.m(this.container)):new p.r(this.container)}},{key:"continueBreak",value:function(){this.container.hud.updateBreak(this.currentBreak);var e=this.container.table;return this.container.sound.playSuccess(e.inPockets()),y.P.isClearTable(e)?(this.container.eventQueue.push(new v.b(null,"game over")),this.container.recorder.wholeGameLink(),new b.o(this.container)):(this.container.sendEvent(new i.Q(e.serialise())),new d.m(this.container))}},{key:"whiteInHand",value:function(){return this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),this.startTurn(),this.container.isSinglePlayer?new f.x(this.container):(this.container.sendEvent(new m.z(s.v_,!0)),new p.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=_.respotAllPottedColours(this.container.table,e);if(t.length>0){var n={balls:t.map((function(e){return e.serialise()})),rerack:!0},r=new i.Q(n);this.container.sendEvent(r),this.container.recorder.record(r)}}}])&&j(t.prototype,n),e}();N(F,"tablemodel","models/d-snooker.min.gltf");var D=n(4979);function H(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function z(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var G=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),z(this,"container",void 0),z(this,"cueball",void 0),z(this,"assignedCueBall",void 0),z(this,"aimSettingsByBallId",new Map),z(this,"currentBreak",0),z(this,"previousBreak",0),z(this,"score",0),z(this,"rulename","threecushion"),z(this,"whiteScore",0),z(this,"yellowScore",0),this.container=t,this.resetScores()}var t,n;return t=e,n=[{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){return k.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return s.v_}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1],this.assignedCueBall=this.cueball,this.container.table.cueball=this.cueball,this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball)}},{key:"tableGeometry",value:function(){a.P.setCaromDimensions(l.XM,l.XF,l.oo),D.v.zoomFactor=.92}},{key:"asset",value:function(){return""}},{key:"table",value:function(){this.tableGeometry();var e=new g.X(this.rack());return this.cueball=e.cueball,this.assignedCueBall=this.cueball,this.resetScores(),e}},{key:"rack",value:function(){return h.three()}},{key:"update",value:function(e){if(this.captureCueSettings(this.cueball),y.P.isThreeCushionPoint(this.cueball,e)){this.container.sound.playSuccess(e.length/3),this.currentBreak++,this.registerPointForCurrentCueBall();var t=this.container.table.serialise();return this.container.sendEvent(new i.Q((n=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){z(e,t,n[t])}))}return e}({},t),r=null!=(r={whiteScore:this.whiteScore,yellowScore:this.yellowScore})?r:{},Object.getOwnPropertyDescriptors?Object.defineProperties(n,Object.getOwnPropertyDescriptors(r)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(r)).forEach((function(e){Object.defineProperty(n,e,Object.getOwnPropertyDescriptor(r,e))})),n))),new d.m(this.container)}var n,r;return this.previousBreak=this.currentBreak,this.currentBreak=0,this.cueball=this.otherPlayersCueBall(),this.container.table.cueball=this.cueball,this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),this.container.isSinglePlayer?new d.m(this.container):(this.container.sendEvent(new P.M),new p.r(this.container))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"prepareForLocalTurn",value:function(){this.assignedCueBall||(this.assignedCueBall=this.cueball),this.assignedCueBall&&(this.cueball=this.assignedCueBall,this.container.table.cueball=this.cueball,this.restoreCueSettingsFor(this.cueball))}},{key:"isPartOfBreak",value:function(e){return y.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){return!1}},{key:"captureCueSettings",value:function(e){var t;if(e){var n=null===(t=this.container)||void 0===t?void 0:t.table,i=null==n?void 0:n.cue;n&&i&&this.aimSettingsByBallId.set(e.id,{power:i.aim.power,angle:i.aim.angle,offset:i.aim.offset.clone(),elevation:i.elevation})}}},{key:"restoreCueSettingsFor",value:function(e){var t;if(e){var n=null===(t=this.container)||void 0===t?void 0:t.table,i=null==n?void 0:n.cue;if(n&&i){var r=this.aimSettingsByBallId.get(e.id);r?(i.aim.power=r.power,i.aim.angle=r.angle,i.aim.offset.copy(r.offset),i.elevation=r.elevation,i.aim.elevation=r.elevation):(i.aim.offset.set(0,0,0),i.aim.power=.5*i.maxPower,i.elevation=i.defaultElevation,i.aim.elevation=i.defaultElevation,this.aimSettingsByBallId.set(e.id,{power:i.aim.power,angle:i.aim.angle,offset:i.aim.offset.clone(),elevation:i.elevation})),i.aim.pos.copy(e.pos),i.aim.i=n.balls.indexOf(e),i.moveTo(e.pos),i.updateAimInput(),this.captureCueSettings(e)}}}},{key:"registerPointForCurrentCueBall",value:function(){var e,t=null===(e=this.container)||void 0===e?void 0:e.table;if(t){var n=t.balls;this.cueball===n[0]?this.whiteScore++:this.cueball===n[1]&&this.yellowScore++}else this.whiteScore++;this.score=this.whiteScore+this.yellowScore,this.updateScoreButtons()}},{key:"resetScores",value:function(){this.whiteScore=0,this.yellowScore=0,this.score=0,this.updateScoreButtons()}},{key:"updateScoreButtons",value:function(){var e,t;null===(t=this.container)||void 0===t||null===(e=t.scoreButtons)||void 0===e||e.setScores(this.whiteScore,this.yellowScore)}},{key:"setScores",value:function(e,t){this.whiteScore=e,this.yellowScore=t,this.score=e+t,this.updateScoreButtons()}},{key:"allowsPlaceBall",value:function(){return!1}}],n&&H(t.prototype,n),e}();function q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var U=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"create",value:function(e,t){switch(e){case"threecushion":return new G(t);case"fourteenone":return new O(t);case"snooker":return new F(t);default:return new M(t)}}}],null&&q(t.prototype,null),n&&q(t,n),e}()},9915:(e,t,n)=>{n.d(t,{b:()=>u});var i=n(8279),r=n(7009);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(c=function(){return!!e})()}var u=function(e){function t(e,n){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),o(i=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,c()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t),"sender",void 0),o(i,"message",void 0),i.sender=e,i.message=n,i.type=r.B.CHAT,i}var n,i,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,e),n=t,u=[{key:"fromJson",value:function(e){return new t(e.sender,e.message)}}],(i=[{key:"applyToController",value:function(e){return e.handleChat(this)}}])&&a(n.prototype,i),u&&a(n,u),t}(i.F)}},e=>{e(e.s=1624)}]);