"use strict";(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[338],{12:(e,t,n)=>{n.d(t,{Dz:()=>p,F8:()=>b,FP:()=>y,KM:()=>l,RZ:()=>w,gn:()=>g,iA:()=>S,ld:()=>v,n7:()=>m,nr:()=>x,oN:()=>k,rq:()=>f,t6:()=>s,up:()=>o,v_:()=>r,xb:()=>u});var i=n(4922),r=new i.Pq0(0,0,0),o=new i.Pq0(0,0,1);function s(e){return new i.Pq0(e.x,e.y,e.z)}var a=new i.Pq0;function l(e){return a.copy(o).cross(e)}var c=new i.Pq0;function u(e){return c.copy(e).normalize()}var h=new i.Pq0;function f(e,t){return h.copy(e).add(t).dot(e)<=0}function p(e){return new i.Pq0(1,0,0).applyAxisAngle(o,e)}function d(e){return Math.sign(e)*Math.floor(1e4*(Math.abs(e)+Number.EPSILON))/1e4}function v(e){return e.x=d(e.x),e.y=d(e.y),e.z=d(e.z),e}function y(e,t){return Math.fround(Math.atan2(e,t))}function m(e,t){return Math.fround(Math.pow(e,t))}function b(e){return Math.fround(Math.sin(e))}function g(e){return Math.fround(Math.cos(e))}function w(e){return Math.fround(Math.sqrt(e))}function k(e){return Math.fround(Math.exp(e))}function x(e,t){var n=e.x-t.x,i=e.y-t.y,r=e.z-t.z;return Math.fround(n*n+i*i+r*r)}var T=[new i.Pq0,new i.Pq0,new i.Pq0,new i.Pq0],P=0;function S(){var e=T[3&P++];return e.set(0,0,0),e}},91:(e,t,n)=>{n.d(t,{f:()=>u});var i=n(4922),r=n(3982),o=n(8385),s=n(665),a=n(5418);function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"scaleToRadius",value:function(t){e.PX=s.P.tableX+1.6*t,e.PY=s.P.tableY+1.6*t,e.knuckleInset=1.6*t/.5,e.knuckleRadius=.31*t/.5,e.middleKnuckleInset=1.385*t/.5,e.middleKnuckleRadius=.2*t/.5,e.cornerRadius=1.1*t/.5,e.middleRadius=.9*t/.5,e.pocketLayout(t),e.enumerateCenters(),e.enumerateKnuckles()}},{key:"enumerateKnuckles",value:function(){e.knuckles=[e.pockets.pocketNW.knuckleNE,e.pockets.pocketNW.knuckleSW,e.pockets.pocketN.knuckleNW,e.pockets.pocketN.knuckleNE,e.pockets.pocketS.knuckleSW,e.pockets.pocketS.knuckleSE,e.pockets.pocketNE.knuckleNW,e.pockets.pocketNE.knuckleSE,e.pockets.pocketSE.knuckleNE,e.pockets.pocketSE.knuckleSW,e.pockets.pocketSW.knuckleSE,e.pockets.pocketSW.knuckleNW]}},{key:"enumerateCenters",value:function(){e.pocketCenters=[e.pockets.pocketNW.pocket,e.pockets.pocketSW.pocket,e.pockets.pocketN.pocket,e.pockets.pocketS.pocket,e.pockets.pocketNE.pocket,e.pockets.pocketSE.pocket]}},{key:"pocketLayout",value:function(t){e.pockets={pocketNW:{pocket:new o.Z(new i.Pq0(-e.PX,e.PY,0),e.cornerRadius),knuckleNE:new r.O(new i.Pq0(-s.P.X+e.knuckleInset,s.P.Y+e.knuckleRadius,0),e.knuckleRadius),knuckleSW:new r.O(new i.Pq0(-s.P.X-e.knuckleRadius,s.P.Y-e.knuckleInset,0),e.knuckleRadius)},pocketN:{pocket:new o.Z(new i.Pq0(0,e.PY+.7*t/.5,0),e.middleRadius),knuckleNE:new r.O(new i.Pq0(e.middleKnuckleInset,s.P.Y+e.middleKnuckleRadius,0),e.middleKnuckleRadius),knuckleNW:new r.O(new i.Pq0(-e.middleKnuckleInset,s.P.Y+e.middleKnuckleRadius,0),e.middleKnuckleRadius)},pocketS:{pocket:new o.Z(new i.Pq0(0,-e.PY-.7*t/.5,0),e.middleRadius),knuckleSE:new r.O(new i.Pq0(e.middleKnuckleInset,-s.P.Y-e.middleKnuckleRadius,0),e.middleKnuckleRadius),knuckleSW:new r.O(new i.Pq0(-e.middleKnuckleInset,-s.P.Y-e.middleKnuckleRadius,0),e.middleKnuckleRadius)},pocketNE:{pocket:new o.Z(new i.Pq0(e.PX,e.PY,0),e.cornerRadius),knuckleNW:new r.O(new i.Pq0(s.P.X-e.knuckleInset,s.P.Y+e.knuckleRadius,0),e.knuckleRadius),knuckleSE:new r.O(new i.Pq0(s.P.X+e.knuckleRadius,s.P.Y-e.knuckleInset,0),e.knuckleRadius)},pocketSE:{pocket:new o.Z(new i.Pq0(e.PX,-e.PY,0),e.cornerRadius),knuckleNE:new r.O(new i.Pq0(s.P.X+e.knuckleRadius,-s.P.Y+e.knuckleInset,0),e.knuckleRadius),knuckleSW:new r.O(new i.Pq0(s.P.X-e.knuckleInset,-s.P.Y-e.knuckleRadius,0),e.knuckleRadius)},pocketSW:{pocket:new o.Z(new i.Pq0(-e.PX,-e.PY,0),e.cornerRadius),knuckleSE:new r.O(new i.Pq0(-s.P.X+e.knuckleInset,-s.P.Y-e.knuckleRadius,0),e.knuckleRadius),knuckleNW:new r.O(new i.Pq0(-s.P.X-e.knuckleRadius,-s.P.Y+e.knuckleInset,0),e.knuckleRadius)}}}}],null&&l(t.prototype,null),n&&l(t,n),e}();c(u,"PX",void 0),c(u,"PY",void 0),c(u,"knuckleInset",void 0),c(u,"knuckleRadius",void 0),c(u,"middleKnuckleInset",void 0),c(u,"middleKnuckleRadius",void 0),c(u,"cornerRadius",void 0),c(u,"middleRadius",void 0),c(u,"pockets",void 0),c(u,"knuckles",void 0),c(u,"pocketCenters",void 0),u.scaleToRadius(a.R)},128:(e,t,n)=>{n.d(t,{KP:()=>Ae,Ro:()=>Me});var i=n(4922);const r={POSITION:["byte","byte normalized","unsigned byte","unsigned byte normalized","short","short normalized","unsigned short","unsigned short normalized"],NORMAL:["byte normalized","short normalized"],TANGENT:["byte normalized","short normalized"],TEXCOORD:["byte","byte normalized","unsigned byte","short","short normalized","unsigned short"]};class o{constructor(){this.textureUtils=null,this.pluginCallbacks=[],this.register((function(e){return new w(e)})),this.register((function(e){return new k(e)})),this.register((function(e){return new S(e)})),this.register((function(e){return new R(e)})),this.register((function(e){return new E(e)})),this.register((function(e){return new O(e)})),this.register((function(e){return new x(e)})),this.register((function(e){return new T(e)})),this.register((function(e){return new P(e)})),this.register((function(e){return new A(e)})),this.register((function(e){return new M(e)})),this.register((function(e){return new I(e)})),this.register((function(e){return new _(e)})),this.register((function(e){return new C(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}setTextureUtils(e){return this.textureUtils=e,this}parse(e,t,n,i){const r=new g,o=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)o.push(this.pluginCallbacks[e](r));r.setPlugins(o),r.setTextureUtils(this.textureUtils),r.writeAsync(e,t,i).catch(n)}parseAsync(e,t){const n=this;return new Promise((function(i,r){n.parse(e,i,r,t)}))}}const s=5120,a=5121,l=5122,c=5123,u=34962,h="KHR_mesh_quantization",f={};f[i.hxR]=9728,f[i.pHI]=9984,f[i.Cfg]=9986,f[i.k6q]=9729,f[i.kRr]=9985,f[i.$_I]=9987,f[i.ghU]=33071,f[i.GJx]=10497,f[i.kTW]=33648;const p={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"},d=new i.Q1f;function v(e,t){return e.length===t.length&&e.every((function(e,n){return e===t[n]}))}function y(e){return 4*Math.ceil(e/4)}function m(e,t=0){const n=y(e.byteLength);if(n!==e.byteLength){const i=new Uint8Array(n);if(i.set(new Uint8Array(e)),0!==t)for(let r=e.byteLength;r<n;r++)i[r]=t;return i.buffer}return e}function b(){return"undefined"==typeof document&&"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(1,1):document.createElement("canvas")}class g{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.extensionsRequired={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter r"+i.sPf}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map},this.textureUtils=null}setPlugins(e){this.plugins=e}setTextureUtils(e){this.textureUtils=e}async writeAsync(e,t,n={}){this.options=Object.assign({binary:!1,trs:!1,onlyVisible:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},n),this.options.animations.length>0&&(this.options.trs=!0),await this.processInputAsync(e),await Promise.all(this.pending);const i=this,r=i.buffers,o=i.json;n=i.options;const s=i.extensionsUsed,a=i.extensionsRequired,l=new Blob(r,{type:"application/octet-stream"}),c=Object.keys(s),u=Object.keys(a);if(c.length>0&&(o.extensionsUsed=c),u.length>0&&(o.extensionsRequired=u),o.buffers&&o.buffers.length>0&&(o.buffers[0].byteLength=l.size),!0===n.binary){const e=new FileReader;e.readAsArrayBuffer(l),e.onloadend=function(){const n=m(e.result),i=new DataView(new ArrayBuffer(8));i.setUint32(0,n.byteLength,!0),i.setUint32(4,5130562,!0);const r=m((s=JSON.stringify(o),(new TextEncoder).encode(s).buffer),32);var s;const a=new DataView(new ArrayBuffer(8));a.setUint32(0,r.byteLength,!0),a.setUint32(4,1313821514,!0);const l=new ArrayBuffer(12),c=new DataView(l);c.setUint32(0,1179937895,!0),c.setUint32(4,2,!0);const u=12+a.byteLength+r.byteLength+i.byteLength+n.byteLength;c.setUint32(8,u,!0);const h=new Blob([l,a,r,i,n],{type:"application/octet-stream"}),f=new FileReader;f.readAsArrayBuffer(h),f.onloadend=function(){t(f.result)}}}else if(o.buffers&&o.buffers.length>0){const e=new FileReader;e.readAsDataURL(l),e.onloadend=function(){const n=e.result;o.buffers[0].uri=n,t(o)}}else t(o)}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const n=this.options,i=this.extensionsUsed;try{const r=JSON.parse(JSON.stringify(e.userData));if(n.includeCustomExtensions&&r.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in r.gltfExtensions)t.extensions[e]=r.gltfExtensions[e],i[e]=!0;delete r.gltfExtensions}Object.keys(r).length>0&&(t.extras=r)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e,t=!1){if(!1===this.uids.has(e)){const t=new Map;t.set(!0,this.uid++),t.set(!1,this.uid++),this.uids.set(e,t)}return this.uids.get(e).get(t)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new i.Pq0;for(let n=0,i=e.count;n<i;n++)if(Math.abs(t.fromBufferAttribute(e,n).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const n=e.clone(),r=new i.Pq0;for(let e=0,t=n.count;e<t;e++)r.fromBufferAttribute(n,e),0===r.x&&0===r.y&&0===r.z?r.setX(1):r.normalize(),n.setXYZ(e,r.x,r.y,r.z);return t.attributesNormalized.set(e,n),n}applyTextureTransform(e,t){let n=!1;const i={};0===t.offset.x&&0===t.offset.y||(i.offset=t.offset.toArray(),n=!0),0!==t.rotation&&(i.rotation=t.rotation,n=!0),1===t.repeat.x&&1===t.repeat.y||(i.scale=t.repeat.toArray(),n=!0),n&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=i,this.extensionsUsed.KHR_texture_transform=!0)}async buildMetalRoughTextureAsync(e,t){if(e===t)return e;function n(e){return e.colorSpace===i.er$?function(e){return e<.04045?.0773993808*e:Math.pow(.9478672986*e+.0521327014,2.4)}:function(e){return e}}e instanceof i.FvD&&(e=await this.decompressTextureAsync(e)),t instanceof i.FvD&&(t=await this.decompressTextureAsync(t));const r=e?e.image:null,o=t?t.image:null,s=Math.max(r?r.width:0,o?o.width:0),a=Math.max(r?r.height:0,o?o.height:0),l=b();l.width=s,l.height=a;const c=l.getContext("2d",{willReadFrequently:!0});c.fillStyle="#00ffff",c.fillRect(0,0,s,a);const u=c.getImageData(0,0,s,a);if(r){c.drawImage(r,0,0,s,a);const t=n(e),i=c.getImageData(0,0,s,a).data;for(let e=2;e<i.length;e+=4)u.data[e]=256*t(i[e]/256)}if(o){c.drawImage(o,0,0,s,a);const e=n(t),i=c.getImageData(0,0,s,a).data;for(let t=1;t<i.length;t+=4)u.data[t]=256*e(i[t]/256)}c.putImageData(u,0,0);const h=(e||t).clone();return h.source=new i.kLi(l),h.colorSpace=i.jf0,h.channel=(e||t).channel,e&&t&&e.channel!==t.channel&&console.warn("THREE.GLTFExporter: UV channels for metalnessMap and roughnessMap textures must match."),console.warn("THREE.GLTFExporter: Merged metalnessMap and roughnessMap textures."),h}async decompressTextureAsync(e,t=1/0){if(null===this.textureUtils)throw new Error("THREE.GLTFExporter: setTextureUtils() must be called to process compressed textures.");return await this.textureUtils.decompress(e,t)}processBuffer(e){const t=this.json,n=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),n.push(e),0}processBufferView(e,t,n,r,o){const h=this.json;let f;switch(h.bufferViews||(h.bufferViews=[]),t){case s:case a:f=1;break;case l:case c:f=2;break;default:f=4}let p=e.itemSize*f;o===u&&(p=4*Math.ceil(p/4));const d=y(r*p),v=new DataView(new ArrayBuffer(d));let m=0;for(let o=n;o<n+r;o++){for(let n=0;n<e.itemSize;n++){let r;e.itemSize>4?r=e.array[o*e.itemSize+n]:(0===n?r=e.getX(o):1===n?r=e.getY(o):2===n?r=e.getZ(o):3===n&&(r=e.getW(o)),!0===e.normalized&&(r=i.cj9.normalize(r,e.array))),5126===t?v.setFloat32(m,r,!0):5124===t?v.setInt32(m,r,!0):5125===t?v.setUint32(m,r,!0):t===l?v.setInt16(m,r,!0):t===c?v.setUint16(m,r,!0):t===s?v.setInt8(m,r):t===a&&v.setUint8(m,r),m+=f}m%p!=0&&(m+=p-m%p)}const b={buffer:this.processBuffer(v.buffer),byteOffset:this.byteOffset,byteLength:d};return void 0!==o&&(b.target=o),o===u&&(b.byteStride=p),this.byteOffset+=d,h.bufferViews.push(b),{id:h.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,n=t.json;return n.bufferViews||(n.bufferViews=[]),new Promise((function(i){const r=new FileReader;r.readAsArrayBuffer(e),r.onloadend=function(){const e=m(r.result),o={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,i(n.bufferViews.push(o)-1)}}))}processAccessor(e,t,n,r){const o=this.json;let h;if(e.array.constructor===Float32Array)h=5126;else if(e.array.constructor===Int32Array)h=5124;else if(e.array.constructor===Uint32Array)h=5125;else if(e.array.constructor===Int16Array)h=l;else if(e.array.constructor===Uint16Array)h=c;else if(e.array.constructor===Int8Array)h=s;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type: "+e.array.constructor.name);h=a}if(void 0===n&&(n=0),void 0!==r&&r!==1/0||(r=e.count),0===r)return null;const f=function(e,t,n){const r={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let o=t;o<t+n;o++)for(let t=0;t<e.itemSize;t++){let n;e.itemSize>4?n=e.array[o*e.itemSize+t]:(0===t?n=e.getX(o):1===t?n=e.getY(o):2===t?n=e.getZ(o):3===t&&(n=e.getW(o)),!0===e.normalized&&(n=i.cj9.normalize(n,e.array))),r.min[t]=Math.min(r.min[t],n),r.max[t]=Math.max(r.max[t],n)}return r}(e,n,r);let p;void 0!==t&&(p=e===t.index?34963:u);const d=this.processBufferView(e,h,n,r,p),v={bufferView:d.id,byteOffset:d.byteOffset,componentType:h,count:r,max:f.max,min:f.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",9:"MAT3",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(v.normalized=!0),o.accessors||(o.accessors=[]),o.accessors.push(v)-1}processImage(e,t,n,r="image/png"){if(null!==e){const o=this,s=o.cache,a=o.json,l=o.options,c=o.pending;s.images.has(e)||s.images.set(e,{});const u=s.images.get(e),h=r+":flipY/"+n.toString();if(void 0!==u[h])return u[h];a.images||(a.images=[]);const f={mimeType:r},p=b();p.width=Math.min(e.width,l.maxTextureSize),p.height=Math.min(e.height,l.maxTextureSize);const d=p.getContext("2d",{willReadFrequently:!0});if(!0===n&&(d.translate(0,p.height),d.scale(1,-1)),void 0!==e.data){t!==i.GWd&&console.error("GLTFExporter: Only RGBAFormat is supported.",t),(e.width>l.maxTextureSize||e.height>l.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const n=new Uint8ClampedArray(e.height*e.width*4);for(let t=0;t<n.length;t+=4)n[t+0]=e.data[t+0],n[t+1]=e.data[t+1],n[t+2]=e.data[t+2],n[t+3]=e.data[t+3];d.putImageData(new ImageData(n,e.width,e.height),0,0)}else{if(!("undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas))throw new Error("THREE.GLTFExporter: Invalid image type. Use HTMLImageElement, HTMLCanvasElement, ImageBitmap or OffscreenCanvas.");d.drawImage(e,0,0,p.width,p.height)}!0===l.binary?c.push(function(e,t){if(void 0!==e.toBlob)return new Promise((n=>e.toBlob(n,t)));let n;return"image/jpeg"===t?n=.92:"image/webp"===t&&(n=.8),e.convertToBlob({type:t,quality:n})}(p,r).then((e=>o.processBufferViewImage(e))).then((e=>{f.bufferView=e}))):f.uri=i.HgN.getDataURL(p,r);const v=a.images.push(f)-1;return u[h]=v,v}throw new Error("THREE.GLTFExporter: No valid image data found. Unable to process texture.")}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const n={magFilter:f[e.magFilter],minFilter:f[e.minFilter],wrapS:f[e.wrapS],wrapT:f[e.wrapT]};return t.samplers.push(n)-1}async processTextureAsync(e){const t=this.options,n=this.cache,r=this.json;if(n.textures.has(e))return n.textures.get(e);r.textures||(r.textures=[]),e instanceof i.FvD&&(e=await this.decompressTextureAsync(e,t.maxTextureSize));let o=e.userData.mimeType;"image/webp"===o&&(o="image/png");const s={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY,o)};e.name&&(s.name=e.name),await this._invokeAllAsync((async function(t){t.writeTexture&&await t.writeTexture(e,s)}));const a=r.textures.push(s)-1;return n.textures.set(e,a),a}async processMaterialAsync(e){const t=this.cache,n=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;n.materials||(n.materials=[]);const r={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const o=e.color.toArray().concat([e.opacity]);if(v(o,[1,1,1,1])||(r.pbrMetallicRoughness.baseColorFactor=o),e.isMeshStandardMaterial?(r.pbrMetallicRoughness.metallicFactor=e.metalness,r.pbrMetallicRoughness.roughnessFactor=e.roughness):(r.pbrMetallicRoughness.metallicFactor=0,r.pbrMetallicRoughness.roughnessFactor=1),e.metalnessMap||e.roughnessMap){const t=await this.buildMetalRoughTextureAsync(e.metalnessMap,e.roughnessMap),n={index:await this.processTextureAsync(t),texCoord:t.channel};this.applyTextureTransform(n,t),r.pbrMetallicRoughness.metallicRoughnessTexture=n}if(e.map){const t={index:await this.processTextureAsync(e.map),texCoord:e.map.channel};this.applyTextureTransform(t,e.map),r.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive;if(Math.max(t.r,t.g,t.b)>0&&(r.emissiveFactor=e.emissive.toArray()),e.emissiveMap){const t={index:await this.processTextureAsync(e.emissiveMap),texCoord:e.emissiveMap.channel};this.applyTextureTransform(t,e.emissiveMap),r.emissiveTexture=t}}if(e.normalMap){const t={index:await this.processTextureAsync(e.normalMap),texCoord:e.normalMap.channel};e.normalScale&&1!==e.normalScale.x&&(t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),r.normalTexture=t}if(e.aoMap){const t={index:await this.processTextureAsync(e.aoMap),texCoord:e.aoMap.channel};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),r.occlusionTexture=t}e.transparent?r.alphaMode="BLEND":e.alphaTest>0&&(r.alphaMode="MASK",r.alphaCutoff=e.alphaTest),e.side===i.$EB&&(r.doubleSided=!0),""!==e.name&&(r.name=e.name),this.serializeUserData(e,r),await this._invokeAllAsync((async function(t){t.writeMaterialAsync&&await t.writeMaterialAsync(e,r)}));const s=n.materials.push(r)-1;return t.materials.set(e,s),s}async processMeshAsync(e){const t=this.cache,n=this.json,r=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,n=e.material.length;t<n;t++)r.push(e.material[t].uuid);else r.push(e.material.uuid);const s=r.join(":");if(t.meshes.has(s))return t.meshes.get(s);const a=e.geometry;let l;l=e.isLineSegments?1:e.isLineLoop?2:e.isLine?3:e.isPoints?0:e.material.wireframe?1:4;const c={},u={},h=[],f=[],p={uv:"TEXCOORD_0",uv1:"TEXCOORD_1",uv2:"TEXCOORD_2",uv3:"TEXCOORD_3",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},d=a.getAttribute("normal");void 0===d||this.isNormalizedNormalAttribute(d)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),a.setAttribute("normal",this.createNormalizedNormalAttribute(d)));let v=null;for(let e in a.attributes){if("morph"===e.slice(0,5))continue;const n=a.attributes[e];if(e=p[e]||e.toUpperCase(),/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),t.attributes.has(this.getUID(n))){u[e]=t.attributes.get(this.getUID(n));continue}v=null;const r=n.array;"JOINTS_0"!==e||r instanceof Uint16Array||r instanceof Uint8Array?(r instanceof Uint32Array||r instanceof Int32Array)&&!e.startsWith("_")&&(console.warn(`GLTFExporter: Attribute "${e}" converted to type FLOAT.`),v=o.Utils.toFloat32BufferAttribute(n)):(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),v=new i.THS(new Uint16Array(r),n.itemSize,n.normalized));const s=this.processAccessor(v||n,a);null!==s&&(e.startsWith("_")||this.detectMeshQuantization(e,n),u[e]=s,t.attributes.set(this.getUID(n),s))}if(void 0!==d&&a.setAttribute("normal",d),0===Object.keys(u).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const n=[],i=[],r={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)r[e.morphTargetDictionary[t]]=t;for(let o=0;o<e.morphTargetInfluences.length;++o){const s={};let l=!1;for(const e in a.morphAttributes){if("position"!==e&&"normal"!==e){l||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),l=!0);continue}const n=a.morphAttributes[e][o],i=e.toUpperCase(),r=a.attributes[e];if(t.attributes.has(this.getUID(n,!0))){s[i]=t.attributes.get(this.getUID(n,!0));continue}const c=n.clone();if(!a.morphTargetsRelative)for(let e=0,t=n.count;e<t;e++)for(let t=0;t<n.itemSize;t++)0===t&&c.setX(e,n.getX(e)-r.getX(e)),1===t&&c.setY(e,n.getY(e)-r.getY(e)),2===t&&c.setZ(e,n.getZ(e)-r.getZ(e)),3===t&&c.setW(e,n.getW(e)-r.getW(e));s[i]=this.processAccessor(c,a),t.attributes.set(this.getUID(r,!0),s[i])}f.push(s),n.push(e.morphTargetInfluences[o]),void 0!==e.morphTargetDictionary&&i.push(r[o])}c.weights=n,i.length>0&&(c.extras={},c.extras.targetNames=i)}const y=Array.isArray(e.material);if(y&&0===a.groups.length)return null;let m=!1;if(y&&null===a.index){const e=[];for(let t=0,n=a.attributes.position.count;t<n;t++)e[t]=t;a.setIndex(e),m=!0}const b=y?e.material:[e.material],g=y?a.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,n=g.length;e<n;e++){const n={mode:l,attributes:u};if(this.serializeUserData(a,n),f.length>0&&(n.targets=f),null!==a.index){let i=this.getUID(a.index);void 0===g[e].start&&void 0===g[e].count||(i+=":"+g[e].start+":"+g[e].count),t.attributes.has(i)?n.indices=t.attributes.get(i):(n.indices=this.processAccessor(a.index,a,g[e].start,g[e].count),t.attributes.set(i,n.indices)),null===n.indices&&delete n.indices}const i=await this.processMaterialAsync(b[g[e].materialIndex]);null!==i&&(n.material=i),h.push(n)}!0===m&&a.setIndex(null),c.primitives=h,n.meshes||(n.meshes=[]),await this._invokeAllAsync((function(t){t.writeMesh&&t.writeMesh(e,c)}));const w=n.meshes.push(c)-1;return t.meshes.set(s,w),w}detectMeshQuantization(e,t){if(this.extensionsUsed[h])return;let n;switch(t.array.constructor){case Int8Array:n="byte";break;case Uint8Array:n="unsigned byte";break;case Int16Array:n="short";break;case Uint16Array:n="unsigned short";break;default:return}t.normalized&&(n+=" normalized");const i=e.split("_",1)[0];r[i]&&r[i].includes(n)&&(this.extensionsUsed[h]=!0,this.extensionsRequired[h]=!0)}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const n=e.isOrthographicCamera,r={type:n?"orthographic":"perspective"};return n?r.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:r.perspective={aspectRatio:e.aspect,yfov:i.cj9.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(r.name=e.type),t.cameras.push(r)-1}processAnimation(e,t){const n=this.json,r=this.nodeMap;n.animations||(n.animations=[]);const s=(e=o.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],l=[];for(let e=0;e<s.length;++e){const n=s[e],o=i.Nwf.parseTrackName(n.name);let c=i.Nwf.findNode(t,o.nodeName);const u=p[o.propertyName];if("bones"===o.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(o.objectIndex):void 0),!c||!u){console.warn('THREE.GLTFExporter: Could not export animation track "%s".',n.name);continue}const h=1;let f,d=n.values.length/n.times.length;u===p.morphTargetInfluences&&(d/=c.morphTargetInfluences.length),!0===n.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(f="CUBICSPLINE",d/=3):f=n.getInterpolation()===i.ljd?"STEP":"LINEAR",l.push({input:this.processAccessor(new i.THS(n.times,h)),output:this.processAccessor(new i.THS(n.values,d)),interpolation:f}),a.push({sampler:l.length-1,target:{node:r.get(c),path:u}})}return n.animations.push({name:e.name||"clip_"+n.animations.length,samplers:l,channels:a}),n.animations.length-1}processSkin(e){const t=this.json,n=this.nodeMap,r=t.nodes[n.get(e)],o=e.skeleton;if(void 0===o)return null;const s=e.skeleton.bones[0];if(void 0===s)return null;const a=[],l=new Float32Array(16*o.bones.length),c=new i.kn4;for(let t=0;t<o.bones.length;++t)a.push(n.get(o.bones[t])),c.copy(o.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new i.THS(l,16)),joints:a,skeleton:n.get(s)}),r.skin=t.skins.length-1}async processNodeAsync(e){const t=this.json,n=this.options,i=this.nodeMap;t.nodes||(t.nodes=[]);const r={};if(n.trs){const t=e.quaternion.toArray(),n=e.position.toArray(),i=e.scale.toArray();v(t,[0,0,0,1])||(r.rotation=t),v(n,[0,0,0])||(r.translation=n),v(i,[1,1,1])||(r.scale=i)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===v(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(r.matrix=e.matrix.elements);if(""!==e.name&&(r.name=String(e.name)),this.serializeUserData(e,r),e.isMesh||e.isLine||e.isPoints){const t=await this.processMeshAsync(e);null!==t&&(r.mesh=t)}else e.isCamera&&(r.camera=this.processCamera(e));e.isSkinnedMesh&&this.skins.push(e);const o=t.nodes.push(r)-1;if(i.set(e,o),e.children.length>0){const t=[];for(let i=0,r=e.children.length;i<r;i++){const r=e.children[i];if(r.visible||!1===n.onlyVisible){const e=await this.processNodeAsync(r);null!==e&&t.push(e)}}t.length>0&&(r.children=t)}return await this._invokeAllAsync((function(t){t.writeNode&&t.writeNode(e,r)})),o}async processSceneAsync(e){const t=this.json,n=this.options;t.scenes||(t.scenes=[],t.scene=0);const i={};""!==e.name&&(i.name=e.name),t.scenes.push(i);const r=[];for(let t=0,i=e.children.length;t<i;t++){const i=e.children[t];if(i.visible||!1===n.onlyVisible){const e=await this.processNodeAsync(i);null!==e&&r.push(e)}}r.length>0&&(i.nodes=r),this.serializeUserData(e,i)}async processObjectsAsync(e){const t=new i.Z58;t.name="AuxScene";for(let n=0;n<e.length;n++)t.children.push(e[n]);await this.processSceneAsync(t)}async processInputAsync(e){const t=this.options;e=e instanceof Array?e:[e],await this._invokeAllAsync((function(t){t.beforeParse&&t.beforeParse(e)}));const n=[];for(let t=0;t<e.length;t++)e[t]instanceof i.Z58?await this.processSceneAsync(e[t]):n.push(e[t]);n.length>0&&await this.processObjectsAsync(n);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);await this._invokeAllAsync((function(t){t.afterParse&&t.afterParse(e)}))}async _invokeAllAsync(e){for(let t=0,n=this.plugins.length;t<n;t++)await e(this.plugins[t])}}class w{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const n=this.writer,i=n.json,r=n.extensionsUsed,o={};e.name&&(o.name=e.name),o.color=e.color.toArray(),o.intensity=e.intensity,e.isDirectionalLight?o.type="directional":e.isPointLight?(o.type="point",e.distance>0&&(o.range=e.distance)):e.isSpotLight&&(o.type="spot",e.distance>0&&(o.range=e.distance),o.spot={},o.spot.innerConeAngle=(1-e.penumbra)*e.angle,o.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),r[this.name]||(i.extensions=i.extensions||{},i.extensions[this.name]={lights:[]},r[this.name]=!0);const s=i.extensions[this.name].lights;s.push(o),t.extensions=t.extensions||{},t.extensions[this.name]={light:s.length-1}}}class k{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}async writeMaterialAsync(e,t){if(!e.isMeshBasicMaterial)return;const n=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},n[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class x{constructor(e){this.writer=e,this.name="KHR_materials_clearcoat"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.clearcoat)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.clearcoatFactor=e.clearcoat,e.clearcoatMap){const t={index:await n.processTextureAsync(e.clearcoatMap),texCoord:e.clearcoatMap.channel};n.applyTextureTransform(t,e.clearcoatMap),r.clearcoatTexture=t}if(r.clearcoatRoughnessFactor=e.clearcoatRoughness,e.clearcoatRoughnessMap){const t={index:await n.processTextureAsync(e.clearcoatRoughnessMap),texCoord:e.clearcoatRoughnessMap.channel};n.applyTextureTransform(t,e.clearcoatRoughnessMap),r.clearcoatRoughnessTexture=t}if(e.clearcoatNormalMap){const t={index:await n.processTextureAsync(e.clearcoatNormalMap),texCoord:e.clearcoatNormalMap.channel};1!==e.clearcoatNormalScale.x&&(t.scale=e.clearcoatNormalScale.x),n.applyTextureTransform(t,e.clearcoatNormalMap),r.clearcoatNormalTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class T{constructor(e){this.writer=e,this.name="KHR_materials_dispersion"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.dispersion)return;const n=this.writer.extensionsUsed,i={};i.dispersion=e.dispersion,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class P{constructor(e){this.writer=e,this.name="KHR_materials_iridescence"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.iridescence)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.iridescenceFactor=e.iridescence,e.iridescenceMap){const t={index:await n.processTextureAsync(e.iridescenceMap),texCoord:e.iridescenceMap.channel};n.applyTextureTransform(t,e.iridescenceMap),r.iridescenceTexture=t}if(r.iridescenceIor=e.iridescenceIOR,r.iridescenceThicknessMinimum=e.iridescenceThicknessRange[0],r.iridescenceThicknessMaximum=e.iridescenceThicknessRange[1],e.iridescenceThicknessMap){const t={index:await n.processTextureAsync(e.iridescenceThicknessMap),texCoord:e.iridescenceThicknessMap.channel};n.applyTextureTransform(t,e.iridescenceThicknessMap),r.iridescenceThicknessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class S{constructor(e){this.writer=e,this.name="KHR_materials_transmission"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.transmissionFactor=e.transmission,e.transmissionMap){const t={index:await n.processTextureAsync(e.transmissionMap),texCoord:e.transmissionMap.channel};n.applyTextureTransform(t,e.transmissionMap),r.transmissionTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class R{constructor(e){this.writer=e,this.name="KHR_materials_volume"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0===e.transmission)return;const n=this.writer,i=n.extensionsUsed,r={};if(r.thicknessFactor=e.thickness,e.thicknessMap){const t={index:await n.processTextureAsync(e.thicknessMap),texCoord:e.thicknessMap.channel};n.applyTextureTransform(t,e.thicknessMap),r.thicknessTexture=t}e.attenuationDistance!==1/0&&(r.attenuationDistance=e.attenuationDistance),r.attenuationColor=e.attenuationColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class E{constructor(e){this.writer=e,this.name="KHR_materials_ior"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1.5===e.ior)return;const n=this.writer.extensionsUsed,i={};i.ior=e.ior,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class O{constructor(e){this.writer=e,this.name="KHR_materials_specular"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||1===e.specularIntensity&&e.specularColor.equals(d)&&!e.specularIntensityMap&&!e.specularColorMap)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.specularIntensityMap){const t={index:await n.processTextureAsync(e.specularIntensityMap),texCoord:e.specularIntensityMap.channel};n.applyTextureTransform(t,e.specularIntensityMap),r.specularTexture=t}if(e.specularColorMap){const t={index:await n.processTextureAsync(e.specularColorMap),texCoord:e.specularColorMap.channel};n.applyTextureTransform(t,e.specularColorMap),r.specularColorTexture=t}r.specularFactor=e.specularIntensity,r.specularColorFactor=e.specularColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class A{constructor(e){this.writer=e,this.name="KHR_materials_sheen"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.sheen)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.sheenRoughnessMap){const t={index:await n.processTextureAsync(e.sheenRoughnessMap),texCoord:e.sheenRoughnessMap.channel};n.applyTextureTransform(t,e.sheenRoughnessMap),r.sheenRoughnessTexture=t}if(e.sheenColorMap){const t={index:await n.processTextureAsync(e.sheenColorMap),texCoord:e.sheenColorMap.channel};n.applyTextureTransform(t,e.sheenColorMap),r.sheenColorTexture=t}r.sheenRoughnessFactor=e.sheenRoughness,r.sheenColorFactor=e.sheenColor.toArray(),t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class M{constructor(e){this.writer=e,this.name="KHR_materials_anisotropy"}async writeMaterialAsync(e,t){if(!e.isMeshPhysicalMaterial||0==e.anisotropy)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.anisotropyMap){const t={index:await n.processTextureAsync(e.anisotropyMap)};n.applyTextureTransform(t,e.anisotropyMap),r.anisotropyTexture=t}r.anisotropyStrength=e.anisotropy,r.anisotropyRotation=e.anisotropyRotation,t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class I{constructor(e){this.writer=e,this.name="KHR_materials_emissive_strength"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.emissiveIntensity)return;const n=this.writer.extensionsUsed,i={};i.emissiveStrength=e.emissiveIntensity,t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}class _{constructor(e){this.writer=e,this.name="EXT_materials_bump"}async writeMaterialAsync(e,t){if(!e.isMeshStandardMaterial||1===e.bumpScale&&!e.bumpMap)return;const n=this.writer,i=n.extensionsUsed,r={};if(e.bumpMap){const t={index:await n.processTextureAsync(e.bumpMap),texCoord:e.bumpMap.channel};n.applyTextureTransform(t,e.bumpMap),r.bumpTexture=t}r.bumpFactor=e.bumpScale,t.extensions=t.extensions||{},t.extensions[this.name]=r,i[this.name]=!0}}class C{constructor(e){this.writer=e,this.name="EXT_mesh_gpu_instancing"}writeNode(e,t){if(!e.isInstancedMesh)return;const n=this.writer,r=e,o=new Float32Array(3*r.count),s=new Float32Array(4*r.count),a=new Float32Array(3*r.count),l=new i.kn4,c=new i.Pq0,u=new i.PTz,h=new i.Pq0;for(let e=0;e<r.count;e++)r.getMatrixAt(e,l),l.decompose(c,u,h),c.toArray(o,3*e),u.toArray(s,4*e),h.toArray(a,3*e);const f={TRANSLATION:n.processAccessor(new i.THS(o,3)),ROTATION:n.processAccessor(new i.THS(s,4)),SCALE:n.processAccessor(new i.THS(a,3))};r.instanceColor&&(f._COLOR_0=n.processAccessor(r.instanceColor)),t.extensions=t.extensions||{},t.extensions[this.name]={attributes:f},n.extensionsUsed[this.name]=!0,n.extensionsRequired[this.name]=!0}}function j(e,t){if(t===i.RJ4)return console.warn("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Geometry already defined as triangles."),e;if(t===i.rYR||t===i.O49){let n=e.getIndex();if(null===n){const t=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<i.count;e++)t.push(e);e.setIndex(t),n=e.getIndex()}const r=n.count-2,o=[];if(t===i.rYR)for(let e=1;e<=r;e++)o.push(n.getX(0)),o.push(n.getX(e)),o.push(n.getX(e+1));else for(let e=0;e<r;e++)e%2==0?(o.push(n.getX(e)),o.push(n.getX(e+1)),o.push(n.getX(e+2))):(o.push(n.getX(e+2)),o.push(n.getX(e+1)),o.push(n.getX(e)));o.length/3!==r&&console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const s=e.clone();return s.setIndex(o),s.clearGroups(),s}return console.error("THREE.BufferGeometryUtils.toTrianglesDrawMode(): Unknown draw mode:",t),e}o.Utils={insertKeyframe:function(e,t){const n=.001,i=e.getValueSize(),r=new e.TimeBufferType(e.times.length+1),o=new e.ValueBufferType(e.values.length+i),s=e.createInterpolant(new e.ValueBufferType(i));let a;if(0===e.times.length){r[0]=t;for(let e=0;e<i;e++)o[e]=0;a=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<n)return 0;r[0]=t,r.set(e.times,1),o.set(s.evaluate(t),0),o.set(e.values,i),a=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<n)return e.times.length-1;r[r.length-1]=t,r.set(e.times,0),o.set(e.values,0),o.set(s.evaluate(t),e.values.length),a=r.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<n)return l;if(e.times[l]<t&&e.times[l+1]>t){r.set(e.times.slice(0,l+1),0),r[l+1]=t,r.set(e.times.slice(l+1),l+2),o.set(e.values.slice(0,(l+1)*i),0),o.set(s.evaluate(t),(l+1)*i),o.set(e.values.slice((l+1)*i),(l+2)*i),a=l+1;break}}return e.times=r,e.values=o,a},mergeMorphTargetTracks:function(e,t){const n=[],r={},o=e.tracks;for(let e=0;e<o.length;++e){let s=o[e];const a=i.Nwf.parseTrackName(s.name),l=i.Nwf.findNode(t,a.nodeName);if("morphTargetInfluences"!==a.propertyName||void 0===a.propertyIndex){n.push(s);continue}if(s.createInterpolant!==s.InterpolantFactoryMethodDiscrete&&s.createInterpolant!==s.InterpolantFactoryMethodLinear){if(s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),s=s.clone(),s.setInterpolation(i.PJ3)}const c=l.morphTargetInfluences.length,u=l.morphTargetDictionary[a.propertyIndex];if(void 0===u)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let h;if(void 0===r[l.uuid]){h=s.clone();const e=new h.ValueBufferType(c*h.times.length);for(let t=0;t<h.times.length;t++)e[t*c+u]=h.values[t];h.name=(a.nodeName||"")+".morphTargetInfluences",h.values=e,r[l.uuid]=h,n.push(h);continue}const f=s.createInterpolant(new s.ValueBufferType(1));h=r[l.uuid];for(let e=0;e<h.times.length;e++)h.values[e*c+u]=f.evaluate(h.times[e]);for(let e=0;e<s.times.length;e++){const t=this.insertKeyframe(h,s.times[e]);h.values[t*c+u]=s.values[e]}}return e.tracks=n,e},toFloat32BufferAttribute:function(e){const t=new i.THS(new Float32Array(e.count*e.itemSize),e.itemSize,!1);if(!e.normalized&&!e.isInterleavedBufferAttribute)return t.array.set(e.array),t;for(let n=0,i=e.count;n<i;n++)for(let i=0;i<e.itemSize;i++)t.setComponent(n,i,e.getComponent(n,i));return t}};class B extends i.aHM{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new D(e)})),this.register((function(e){return new z(e)})),this.register((function(e){return new Q(e)})),this.register((function(e){return new Z(e)})),this.register((function(e){return new $(e)})),this.register((function(e){return new V(e)})),this.register((function(e){return new G(e)})),this.register((function(e){return new K(e)})),this.register((function(e){return new X(e)})),this.register((function(e){return new U(e)})),this.register((function(e){return new W(e)})),this.register((function(e){return new q(e)})),this.register((function(e){return new J(e)})),this.register((function(e){return new Y(e)})),this.register((function(e){return new F(e)})),this.register((function(e){return new ee(e)})),this.register((function(e){return new te(e)}))}load(e,t,n,r){const o=this;let s;if(""!==this.resourcePath)s=this.resourcePath;else if(""!==this.path){const t=i.r6x.extractUrlBase(e);s=i.r6x.resolveURL(t,this.path)}else s=i.r6x.extractUrlBase(e);this.manager.itemStart(e);const a=function(t){r?r(t):console.error(t),o.manager.itemError(e),o.manager.itemEnd(e)},l=new i.Y9S(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(n){try{o.parse(n,s,(function(n){t(n),o.manager.itemEnd(e)}),a)}catch(e){a(e)}}),n,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,n,i){let r;const o={},s={},a=new TextDecoder;if("string"==typeof e)r=JSON.parse(e);else if(e instanceof ArrayBuffer)if(a.decode(new Uint8Array(e,0,4))===ne){try{o[N.KHR_BINARY_GLTF]=new ie(e)}catch(e){return void(i&&i(e))}r=JSON.parse(o[N.KHR_BINARY_GLTF].content)}else r=JSON.parse(a.decode(e));else r=e;if(void 0===r.asset||r.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const l=new Se(r,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});l.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](l);t.name||console.error("THREE.GLTFLoader: Invalid plugin found: missing name"),s[t.name]=t,o[t.name]=!0}if(r.extensionsUsed)for(let e=0;e<r.extensionsUsed.length;++e){const t=r.extensionsUsed[e],n=r.extensionsRequired||[];switch(t){case N.KHR_MATERIALS_UNLIT:o[t]=new H;break;case N.KHR_DRACO_MESH_COMPRESSION:o[t]=new re(r,this.dracoLoader);break;case N.KHR_TEXTURE_TRANSFORM:o[t]=new oe;break;case N.KHR_MESH_QUANTIZATION:o[t]=new se;break;default:n.indexOf(t)>=0&&void 0===s[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}l.setExtensions(o),l.setPlugins(s),l.parse(n,i)}parseAsync(e,t){const n=this;return new Promise((function(i,r){n.parse(e,t,i,r)}))}}function L(){let e={};return{get:function(t){return e[t]},add:function(t,n){e[t]=n},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const N={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_DISPERSION:"KHR_materials_dispersion",KHR_MATERIALS_IOR:"KHR_materials_ior",KHR_MATERIALS_SHEEN:"KHR_materials_sheen",KHR_MATERIALS_SPECULAR:"KHR_materials_specular",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_IRIDESCENCE:"KHR_materials_iridescence",KHR_MATERIALS_ANISOTROPY:"KHR_materials_anisotropy",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_MATERIALS_VOLUME:"KHR_materials_volume",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",KHR_MATERIALS_EMISSIVE_STRENGTH:"KHR_materials_emissive_strength",EXT_MATERIALS_BUMP:"EXT_materials_bump",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_TEXTURE_AVIF:"EXT_texture_avif",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression",EXT_MESH_GPU_INSTANCING:"EXT_mesh_gpu_instancing"};class F{constructor(e){this.parser=e,this.name=N.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n];i.extensions&&i.extensions[this.name]&&void 0!==i.extensions[this.name].light&&e._addNodeRef(this.cache,i.extensions[this.name].light)}}_loadLight(e){const t=this.parser,n="light:"+e;let r=t.cache.get(n);if(r)return r;const o=t.json,s=((o.extensions&&o.extensions[this.name]||{}).lights||[])[e];let a;const l=new i.Q1f(16777215);void 0!==s.color&&l.setRGB(s.color[0],s.color[1],s.color[2],i.Zr2);const c=void 0!==s.range?s.range:0;switch(s.type){case"directional":a=new i.ZyN(l),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new i.HiM(l),a.distance=c;break;case"spot":a=new i.nCl(l),a.distance=c,s.spot=s.spot||{},s.spot.innerConeAngle=void 0!==s.spot.innerConeAngle?s.spot.innerConeAngle:0,s.spot.outerConeAngle=void 0!==s.spot.outerConeAngle?s.spot.outerConeAngle:Math.PI/4,a.angle=s.spot.outerConeAngle,a.penumbra=1-s.spot.innerConeAngle/s.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+s.type)}return a.position.set(0,0,0),ge(a,s),void 0!==s.intensity&&(a.intensity=s.intensity),a.name=t.createUniqueName(s.name||"light_"+e),r=Promise.resolve(a),t.cache.add(n,r),r}getDependency(e,t){if("light"===e)return this._loadLight(t)}createNodeAttachment(e){const t=this,n=this.parser,i=n.json.nodes[e],r=(i.extensions&&i.extensions[this.name]||{}).light;return void 0===r?null:this._loadLight(r).then((function(e){return n._getNodeRef(t.cache,r,e)}))}}class H{constructor(){this.name=N.KHR_MATERIALS_UNLIT}getMaterialType(){return i.V9B}extendParams(e,t,n){const r=[];e.color=new i.Q1f(1,1,1),e.opacity=1;const o=t.pbrMetallicRoughness;if(o){if(Array.isArray(o.baseColorFactor)){const t=o.baseColorFactor;e.color.setRGB(t[0],t[1],t[2],i.Zr2),e.opacity=t[3]}void 0!==o.baseColorTexture&&r.push(n.assignTexture(e,"map",o.baseColorTexture,i.er$))}return Promise.all(r)}}class U{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_EMISSIVE_STRENGTH}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name].emissiveStrength;return void 0!==i&&(t.emissiveIntensity=i),Promise.resolve()}}class D{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const o=[],s=r.extensions[this.name];if(void 0!==s.clearcoatFactor&&(t.clearcoat=s.clearcoatFactor),void 0!==s.clearcoatTexture&&o.push(n.assignTexture(t,"clearcoatMap",s.clearcoatTexture)),void 0!==s.clearcoatRoughnessFactor&&(t.clearcoatRoughness=s.clearcoatRoughnessFactor),void 0!==s.clearcoatRoughnessTexture&&o.push(n.assignTexture(t,"clearcoatRoughnessMap",s.clearcoatRoughnessTexture)),void 0!==s.clearcoatNormalTexture&&(o.push(n.assignTexture(t,"clearcoatNormalMap",s.clearcoatNormalTexture)),void 0!==s.clearcoatNormalTexture.scale)){const e=s.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new i.I9Y(e,e)}return Promise.all(o)}}class z{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_DISPERSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.dispersion=void 0!==i.dispersion?i.dispersion:0,Promise.resolve()}}class q{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_IRIDESCENCE}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];return void 0!==o.iridescenceFactor&&(t.iridescence=o.iridescenceFactor),void 0!==o.iridescenceTexture&&r.push(n.assignTexture(t,"iridescenceMap",o.iridescenceTexture)),void 0!==o.iridescenceIor&&(t.iridescenceIOR=o.iridescenceIor),void 0===t.iridescenceThicknessRange&&(t.iridescenceThicknessRange=[100,400]),void 0!==o.iridescenceThicknessMinimum&&(t.iridescenceThicknessRange[0]=o.iridescenceThicknessMinimum),void 0!==o.iridescenceThicknessMaximum&&(t.iridescenceThicknessRange[1]=o.iridescenceThicknessMaximum),void 0!==o.iridescenceThicknessTexture&&r.push(n.assignTexture(t,"iridescenceThicknessMap",o.iridescenceThicknessTexture)),Promise.all(r)}}class V{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_SHEEN}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const o=[];t.sheenColor=new i.Q1f(0,0,0),t.sheenRoughness=0,t.sheen=1;const s=r.extensions[this.name];if(void 0!==s.sheenColorFactor){const e=s.sheenColorFactor;t.sheenColor.setRGB(e[0],e[1],e[2],i.Zr2)}return void 0!==s.sheenRoughnessFactor&&(t.sheenRoughness=s.sheenRoughnessFactor),void 0!==s.sheenColorTexture&&o.push(n.assignTexture(t,"sheenColorMap",s.sheenColorTexture,i.er$)),void 0!==s.sheenRoughnessTexture&&o.push(n.assignTexture(t,"sheenRoughnessMap",s.sheenRoughnessTexture)),Promise.all(o)}}class G{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];return void 0!==o.transmissionFactor&&(t.transmission=o.transmissionFactor),void 0!==o.transmissionTexture&&r.push(n.assignTexture(t,"transmissionMap",o.transmissionTexture)),Promise.all(r)}}class K{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_VOLUME}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const o=[],s=r.extensions[this.name];t.thickness=void 0!==s.thicknessFactor?s.thicknessFactor:0,void 0!==s.thicknessTexture&&o.push(n.assignTexture(t,"thicknessMap",s.thicknessTexture)),t.attenuationDistance=s.attenuationDistance||1/0;const a=s.attenuationColor||[1,1,1];return t.attenuationColor=(new i.Q1f).setRGB(a[0],a[1],a[2],i.Zr2),Promise.all(o)}}class X{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_IOR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=n.extensions[this.name];return t.ior=void 0!==i.ior?i.ior:1.5,Promise.resolve()}}class W{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_SPECULAR}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,r=n.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();const o=[],s=r.extensions[this.name];t.specularIntensity=void 0!==s.specularFactor?s.specularFactor:1,void 0!==s.specularTexture&&o.push(n.assignTexture(t,"specularIntensityMap",s.specularTexture));const a=s.specularColorFactor||[1,1,1];return t.specularColor=(new i.Q1f).setRGB(a[0],a[1],a[2],i.Zr2),void 0!==s.specularColorTexture&&o.push(n.assignTexture(t,"specularColorMap",s.specularColorTexture,i.er$)),Promise.all(o)}}class Y{constructor(e){this.parser=e,this.name=N.EXT_MATERIALS_BUMP}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];return t.bumpScale=void 0!==o.bumpFactor?o.bumpFactor:1,void 0!==o.bumpTexture&&r.push(n.assignTexture(t,"bumpMap",o.bumpTexture)),Promise.all(r)}}class J{constructor(e){this.parser=e,this.name=N.KHR_MATERIALS_ANISOTROPY}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?i.uSd:null}extendMaterialParams(e,t){const n=this.parser,i=n.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];return void 0!==o.anisotropyStrength&&(t.anisotropy=o.anisotropyStrength),void 0!==o.anisotropyRotation&&(t.anisotropyRotation=o.anisotropyRotation),void 0!==o.anisotropyTexture&&r.push(n.assignTexture(t,"anisotropyMap",o.anisotropyTexture)),Promise.all(r)}}class Q{constructor(e){this.parser=e,this.name=N.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,n=t.json,i=n.textures[e];if(!i.extensions||!i.extensions[this.name])return null;const r=i.extensions[this.name],o=t.options.ktx2Loader;if(!o){if(n.extensionsRequired&&n.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r.source,o)}}class Z{constructor(e){this.parser=e,this.name=N.EXT_TEXTURE_WEBP}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],s=i.images[o.source];let a=n.textureLoader;if(s.uri){const e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class ${constructor(e){this.parser=e,this.name=N.EXT_TEXTURE_AVIF}loadTexture(e){const t=this.name,n=this.parser,i=n.json,r=i.textures[e];if(!r.extensions||!r.extensions[t])return null;const o=r.extensions[t],s=i.images[o.source];let a=n.textureLoader;if(s.uri){const e=n.options.manager.getHandler(s.uri);null!==e&&(a=e)}return n.loadTextureImage(e,o.source,a)}}class ee{constructor(e){this.name=N.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,n=t.bufferViews[e];if(n.extensions&&n.extensions[this.name]){const e=n.extensions[this.name],i=this.parser.getDependency("buffer",e.buffer),r=this.parser.options.meshoptDecoder;if(!r||!r.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return i.then((function(t){const n=e.byteOffset||0,i=e.byteLength||0,o=e.count,s=e.byteStride,a=new Uint8Array(t,n,i);return r.decodeGltfBufferAsync?r.decodeGltfBufferAsync(o,s,a,e.mode,e.filter).then((function(e){return e.buffer})):r.ready.then((function(){const t=new ArrayBuffer(o*s);return r.decodeGltfBuffer(new Uint8Array(t),o,s,a,e.mode,e.filter),t}))}))}return null}}class te{constructor(e){this.name=N.EXT_MESH_GPU_INSTANCING,this.parser=e}createNodeMesh(e){const t=this.parser.json,n=t.nodes[e];if(!n.extensions||!n.extensions[this.name]||void 0===n.mesh)return null;const r=t.meshes[n.mesh];for(const e of r.primitives)if(e.mode!==ue.TRIANGLES&&e.mode!==ue.TRIANGLE_STRIP&&e.mode!==ue.TRIANGLE_FAN&&void 0!==e.mode)return null;const o=n.extensions[this.name].attributes,s=[],a={};for(const e in o)s.push(this.parser.getDependency("accessor",o[e]).then((t=>(a[e]=t,a[e]))));return s.length<1?null:(s.push(this.parser.createNodeMesh(e)),Promise.all(s).then((e=>{const t=e.pop(),n=t.isGroup?t.children:[t],r=e[0].count,o=[];for(const e of n){const t=new i.kn4,n=new i.Pq0,s=new i.PTz,l=new i.Pq0(1,1,1),c=new i.ZLX(e.geometry,e.material,r);for(let e=0;e<r;e++)a.TRANSLATION&&n.fromBufferAttribute(a.TRANSLATION,e),a.ROTATION&&s.fromBufferAttribute(a.ROTATION,e),a.SCALE&&l.fromBufferAttribute(a.SCALE,e),c.setMatrixAt(e,t.compose(n,s,l));for(const t in a)if("_COLOR_0"===t){const e=a[t];c.instanceColor=new i.uWO(e.array,e.itemSize,e.normalized)}else"TRANSLATION"!==t&&"ROTATION"!==t&&"SCALE"!==t&&e.geometry.setAttribute(t,a[t]);i.B69.prototype.copy.call(c,e),this.parser.assignFinalMaterial(c),o.push(c)}return t.isGroup?(t.clear(),t.add(...o),t):o[0]})))}}const ne="glTF";class ie{constructor(e){this.name=N.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12),n=new TextDecoder;if(this.header={magic:n.decode(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==ne)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const i=this.header.length-12,r=new DataView(e,12);let o=0;for(;o<i;){const t=r.getUint32(o,!0);o+=4;const i=r.getUint32(o,!0);if(o+=4,1313821514===i){const i=new Uint8Array(e,12+o,t);this.content=n.decode(i)}else if(5130562===i){const n=12+o;this.body=e.slice(n,n+t)}o+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class re{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=N.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const n=this.json,r=this.dracoLoader,o=e.extensions[this.name].bufferView,s=e.extensions[this.name].attributes,a={},l={},c={};for(const e in s){const t=ve[e]||e.toLowerCase();a[t]=s[e]}for(const t in e.attributes){const i=ve[t]||t.toLowerCase();if(void 0!==s[t]){const r=n.accessors[e.attributes[t]],o=he[r.componentType];c[i]=o.name,l[i]=!0===r.normalized}}return t.getDependency("bufferView",o).then((function(e){return new Promise((function(t,n){r.decodeDracoFile(e,(function(e){for(const t in e.attributes){const n=e.attributes[t],i=l[t];void 0!==i&&(n.normalized=i)}t(e)}),a,c,i.Zr2,n)}))}))}}class oe{constructor(){this.name=N.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&t.texCoord!==e.channel||void 0!==t.offset||void 0!==t.rotation||void 0!==t.scale?(e=e.clone(),void 0!==t.texCoord&&(e.channel=t.texCoord),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0,e):e}}class se{constructor(){this.name=N.KHR_MESH_QUANTIZATION}}class ae extends i.lGw{constructor(e,t,n,i){super(e,t,n,i)}copySampleValue_(e){const t=this.resultBuffer,n=this.sampleValues,i=this.valueSize,r=e*i*3+i;for(let e=0;e!==i;e++)t[e]=n[r+e];return t}interpolate_(e,t,n,i){const r=this.resultBuffer,o=this.sampleValues,s=this.valueSize,a=2*s,l=3*s,c=i-t,u=(n-t)/c,h=u*u,f=h*u,p=e*l,d=p-l,v=-2*f+3*h,y=f-h,m=1-v,b=y-h+u;for(let e=0;e!==s;e++){const t=o[d+e+s],n=o[d+e+a]*c,i=o[p+e+s],l=o[p+e]*c;r[e]=m*t+b*n+v*i+y*l}return r}}const le=new i.PTz;class ce extends ae{interpolate_(e,t,n,i){const r=super.interpolate_(e,t,n,i);return le.fromArray(r).normalize().toArray(r),r}}const ue={FLOAT:5126,FLOAT_MAT3:35675,FLOAT_MAT4:35676,FLOAT_VEC2:35664,FLOAT_VEC3:35665,FLOAT_VEC4:35666,LINEAR:9729,REPEAT:10497,SAMPLER_2D:35678,POINTS:0,LINES:1,LINE_LOOP:2,LINE_STRIP:3,TRIANGLES:4,TRIANGLE_STRIP:5,TRIANGLE_FAN:6,UNSIGNED_BYTE:5121,UNSIGNED_SHORT:5123},he={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},fe={9728:i.hxR,9729:i.k6q,9984:i.pHI,9985:i.kRr,9986:i.Cfg,9987:i.$_I},pe={33071:i.ghU,33648:i.kTW,10497:i.GJx},de={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},ve={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv1",TEXCOORD_2:"uv2",TEXCOORD_3:"uv3",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},ye={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},me={CUBICSPLINE:void 0,LINEAR:i.PJ3,STEP:i.ljd};function be(e,t,n){for(const i in n.extensions)void 0===e[i]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[i]=n.extensions[i])}function ge(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function we(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let n=0,i=t.weights.length;n<i;n++)e.morphTargetInfluences[n]=t.weights[n];if(t.extras&&Array.isArray(t.extras.targetNames)){const n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(let t=0,i=n.length;t<i;t++)e.morphTargetDictionary[n[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function ke(e){let t;const n=e.extensions&&e.extensions[N.KHR_DRACO_MESH_COMPRESSION];if(t=n?"draco:"+n.bufferView+":"+n.indices+":"+xe(n.attributes):e.indices+":"+xe(e.attributes)+":"+e.mode,void 0!==e.targets)for(let n=0,i=e.targets.length;n<i;n++)t+=":"+xe(e.targets[n]);return t}function xe(e){let t="";const n=Object.keys(e).sort();for(let i=0,r=n.length;i<r;i++)t+=n[i]+":"+e[n[i]]+";";return t}function Te(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}const Pe=new i.kn4;class Se{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new L,this.associations=new Map,this.primitiveCache={},this.nodeCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.sourceCache={},this.textureCache={},this.nodeNamesUsed={};let n=!1,r=-1,o=!1,s=-1;if("undefined"!=typeof navigator){const e=navigator.userAgent;n=!0===/^((?!chrome|android).)*safari/i.test(e);const t=e.match(/Version\/(\d+)/);r=n&&t?parseInt(t[1],10):-1,o=e.indexOf("Firefox")>-1,s=o?e.match(/Firefox\/([0-9]+)\./)[1]:-1}"undefined"==typeof createImageBitmap||n&&r<17||o&&s<98?this.textureLoader=new i.Tap(this.options.manager):this.textureLoader=new i.Kzg(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new i.Y9S(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const n=this,i=this.json,r=this.extensions;this.cache.removeAll(),this.nodeCache={},this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([n.getDependencies("scene"),n.getDependencies("animation"),n.getDependencies("camera")])})).then((function(t){const o={scene:t[0][i.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:i.asset,parser:n,userData:{}};return be(r,o,i),ge(o,i),Promise.all(n._invokeAll((function(e){return e.afterRoot&&e.afterRoot(o)}))).then((function(){for(const e of o.scenes)e.updateMatrixWorld();e(o)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],n=this.json.meshes||[];for(let n=0,i=t.length;n<i;n++){const i=t[n].joints;for(let t=0,n=i.length;t<n;t++)e[i[t]].isBone=!0}for(let t=0,i=e.length;t<i;t++){const i=e[t];void 0!==i.mesh&&(this._addNodeRef(this.meshCache,i.mesh),void 0!==i.skin&&(n[i.mesh].isSkinnedMesh=!0)),void 0!==i.camera&&this._addNodeRef(this.cameraCache,i.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,n){if(e.refs[t]<=1)return n;const i=n.clone(),r=(e,t)=>{const n=this.associations.get(e);null!=n&&this.associations.set(t,n);for(const[n,i]of e.children.entries())r(i,t.children[n])};return r(n,i),i.name+="_instance_"+e.uses[t]++,i}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let n=0;n<t.length;n++){const i=e(t[n]);if(i)return i}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const n=[];for(let i=0;i<t.length;i++){const r=e(t[i]);r&&n.push(r)}return n}getDependency(e,t){const n=e+":"+t;let i=this.cache.get(n);if(!i){switch(e){case"scene":i=this.loadScene(t);break;case"node":i=this._invokeOne((function(e){return e.loadNode&&e.loadNode(t)}));break;case"mesh":i=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":i=this.loadAccessor(t);break;case"bufferView":i=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":i=this.loadBuffer(t);break;case"material":i=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":i=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":i=this.loadSkin(t);break;case"animation":i=this._invokeOne((function(e){return e.loadAnimation&&e.loadAnimation(t)}));break;case"camera":i=this.loadCamera(t);break;default:if(i=this._invokeOne((function(n){return n!=this&&n.getDependency&&n.getDependency(e,t)})),!i)throw new Error("Unknown type: "+e)}this.cache.add(n,i)}return i}getDependencies(e){let t=this.cache.get(e);if(!t){const n=this,i=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(i.map((function(t,i){return n.getDependency(e,i)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],n=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[N.KHR_BINARY_GLTF].body);const r=this.options;return new Promise((function(e,o){n.load(i.r6x.resolveURL(t.uri,r.path),e,void 0,(function(){o(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const n=t.byteLength||0,i=t.byteOffset||0;return e.slice(i,i+n)}))}loadAccessor(e){const t=this,n=this.json,r=this.json.accessors[e];if(void 0===r.bufferView&&void 0===r.sparse){const e=de[r.type],t=he[r.componentType],n=!0===r.normalized,o=new t(r.count*e);return Promise.resolve(new i.THS(o,e,n))}const o=[];return void 0!==r.bufferView?o.push(this.getDependency("bufferView",r.bufferView)):o.push(null),void 0!==r.sparse&&(o.push(this.getDependency("bufferView",r.sparse.indices.bufferView)),o.push(this.getDependency("bufferView",r.sparse.values.bufferView))),Promise.all(o).then((function(e){const o=e[0],s=de[r.type],a=he[r.componentType],l=a.BYTES_PER_ELEMENT,c=l*s,u=r.byteOffset||0,h=void 0!==r.bufferView?n.bufferViews[r.bufferView].byteStride:void 0,f=!0===r.normalized;let p,d;if(h&&h!==c){const e=Math.floor(u/h),n="InterleavedBuffer:"+r.bufferView+":"+r.componentType+":"+e+":"+r.count;let c=t.cache.get(n);c||(p=new a(o,e*h,r.count*h/l),c=new i.eB$(p,h/l),t.cache.add(n,c)),d=new i.eHs(c,s,u%h/l,f)}else p=null===o?new a(r.count*s):new a(o,u,r.count*s),d=new i.THS(p,s,f);if(void 0!==r.sparse){const t=de.SCALAR,n=he[r.sparse.indices.componentType],l=r.sparse.indices.byteOffset||0,c=r.sparse.values.byteOffset||0,u=new n(e[1],l,r.sparse.count*t),h=new a(e[2],c,r.sparse.count*s);null!==o&&(d=new i.THS(d.array.slice(),d.itemSize,d.normalized)),d.normalized=!1;for(let e=0,t=u.length;e<t;e++){const t=u[e];if(d.setX(t,h[e*s]),s>=2&&d.setY(t,h[e*s+1]),s>=3&&d.setZ(t,h[e*s+2]),s>=4&&d.setW(t,h[e*s+3]),s>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}d.normalized=f}return d}))}loadTexture(e){const t=this.json,n=this.options,i=t.textures[e].source,r=t.images[i];let o=this.textureLoader;if(r.uri){const e=n.manager.getHandler(r.uri);null!==e&&(o=e)}return this.loadTextureImage(e,i,o)}loadTextureImage(e,t,n){const r=this,o=this.json,s=o.textures[e],a=o.images[t],l=(a.uri||a.bufferView)+":"+s.sampler;if(this.textureCache[l])return this.textureCache[l];const c=this.loadImageSource(t,n).then((function(t){t.flipY=!1,t.name=s.name||a.name||"",""===t.name&&"string"==typeof a.uri&&!1===a.uri.startsWith("data:image/")&&(t.name=a.uri);const n=(o.samplers||{})[s.sampler]||{};return t.magFilter=fe[n.magFilter]||i.k6q,t.minFilter=fe[n.minFilter]||i.$_I,t.wrapS=pe[n.wrapS]||i.GJx,t.wrapT=pe[n.wrapT]||i.GJx,t.generateMipmaps=!t.isCompressedTexture&&t.minFilter!==i.hxR&&t.minFilter!==i.k6q,r.associations.set(t,{textures:e}),t})).catch((function(){return null}));return this.textureCache[l]=c,c}loadImageSource(e,t){const n=this.json,r=this.options;if(void 0!==this.sourceCache[e])return this.sourceCache[e].then((e=>e.clone()));const o=n.images[e],s=self.URL||self.webkitURL;let a=o.uri||"",l=!1;if(void 0!==o.bufferView)a=this.getDependency("bufferView",o.bufferView).then((function(e){l=!0;const t=new Blob([e],{type:o.mimeType});return a=s.createObjectURL(t),a}));else if(void 0===o.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const c=Promise.resolve(a).then((function(e){return new Promise((function(n,o){let s=n;!0===t.isImageBitmapLoader&&(s=function(e){const t=new i.gPd(e);t.needsUpdate=!0,n(t)}),t.load(i.r6x.resolveURL(e,r.path),s,void 0,o)}))})).then((function(e){var t;return!0===l&&s.revokeObjectURL(a),ge(e,o),e.userData.mimeType=o.mimeType||((t=o.uri).search(/\.jpe?g($|\?)/i)>0||0===t.search(/^data\:image\/jpeg/)?"image/jpeg":t.search(/\.webp($|\?)/i)>0||0===t.search(/^data\:image\/webp/)?"image/webp":t.search(/\.ktx2($|\?)/i)>0||0===t.search(/^data\:image\/ktx2/)?"image/ktx2":"image/png"),e})).catch((function(e){throw console.error("THREE.GLTFLoader: Couldn't load texture",a),e}));return this.sourceCache[e]=c,c}assignTexture(e,t,n,i){const r=this;return this.getDependency("texture",n.index).then((function(o){if(!o)return null;if(void 0!==n.texCoord&&n.texCoord>0&&((o=o.clone()).channel=n.texCoord),r.extensions[N.KHR_TEXTURE_TRANSFORM]){const e=void 0!==n.extensions?n.extensions[N.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=r.associations.get(o);o=r.extensions[N.KHR_TEXTURE_TRANSFORM].extendTexture(o,e),r.associations.set(o,t)}}return void 0!==i&&(o.colorSpace=i),e[t]=o,o}))}assignFinalMaterial(e){const t=e.geometry;let n=e.material;const r=void 0===t.attributes.tangent,o=void 0!==t.attributes.color,s=void 0===t.attributes.normal;if(e.isPoints){const e="PointsMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new i.BH$,i.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,t.sizeAttenuation=!1,this.cache.add(e,t)),n=t}else if(e.isLine){const e="LineBasicMaterial:"+n.uuid;let t=this.cache.get(e);t||(t=new i.mrM,i.imn.prototype.copy.call(t,n),t.color.copy(n.color),t.map=n.map,this.cache.add(e,t)),n=t}if(r||o||s){let e="ClonedMaterial:"+n.uuid+":";r&&(e+="derivative-tangents:"),o&&(e+="vertex-colors:"),s&&(e+="flat-shading:");let t=this.cache.get(e);t||(t=n.clone(),o&&(t.vertexColors=!0),s&&(t.flatShading=!0),r&&(t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(n))),n=t}e.material=n}getMaterialType(){return i._4j}loadMaterial(e){const t=this,n=this.json,r=this.extensions,o=n.materials[e];let s;const a={},l=[];if((o.extensions||{})[N.KHR_MATERIALS_UNLIT]){const e=r[N.KHR_MATERIALS_UNLIT];s=e.getMaterialType(),l.push(e.extendParams(a,o,t))}else{const n=o.pbrMetallicRoughness||{};if(a.color=new i.Q1f(1,1,1),a.opacity=1,Array.isArray(n.baseColorFactor)){const e=n.baseColorFactor;a.color.setRGB(e[0],e[1],e[2],i.Zr2),a.opacity=e[3]}void 0!==n.baseColorTexture&&l.push(t.assignTexture(a,"map",n.baseColorTexture,i.er$)),a.metalness=void 0!==n.metallicFactor?n.metallicFactor:1,a.roughness=void 0!==n.roughnessFactor?n.roughnessFactor:1,void 0!==n.metallicRoughnessTexture&&(l.push(t.assignTexture(a,"metalnessMap",n.metallicRoughnessTexture)),l.push(t.assignTexture(a,"roughnessMap",n.metallicRoughnessTexture))),s=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),l.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,a)}))))}!0===o.doubleSided&&(a.side=i.$EB);const c=o.alphaMode||"OPAQUE";if("BLEND"===c?(a.transparent=!0,a.depthWrite=!1):(a.transparent=!1,"MASK"===c&&(a.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&s!==i.V9B&&(l.push(t.assignTexture(a,"normalMap",o.normalTexture)),a.normalScale=new i.I9Y(1,1),void 0!==o.normalTexture.scale)){const e=o.normalTexture.scale;a.normalScale.set(e,e)}if(void 0!==o.occlusionTexture&&s!==i.V9B&&(l.push(t.assignTexture(a,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(a.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&s!==i.V9B){const e=o.emissiveFactor;a.emissive=(new i.Q1f).setRGB(e[0],e[1],e[2],i.Zr2)}return void 0!==o.emissiveTexture&&s!==i.V9B&&l.push(t.assignTexture(a,"emissiveMap",o.emissiveTexture,i.er$)),Promise.all(l).then((function(){const n=new s(a);return o.name&&(n.name=o.name),ge(n,o),t.associations.set(n,{materials:e}),o.extensions&&be(r,n,o),n}))}createUniqueName(e){const t=i.Nwf.sanitizeNodeName(e||"");return t in this.nodeNamesUsed?t+"_"+ ++this.nodeNamesUsed[t]:(this.nodeNamesUsed[t]=0,t)}loadGeometries(e){const t=this,n=this.extensions,r=this.primitiveCache;function o(e){return n[N.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(n){return Re(n,e,t)}))}const s=[];for(let n=0,a=e.length;n<a;n++){const a=e[n],l=ke(a),c=r[l];if(c)s.push(c.promise);else{let e;e=a.extensions&&a.extensions[N.KHR_DRACO_MESH_COMPRESSION]?o(a):Re(new i.LoY,a,t),r[l]={primitive:a,promise:e},s.push(e)}}return Promise.all(s)}loadMesh(e){const t=this,n=this.json,r=this.extensions,o=n.meshes[e],s=o.primitives,a=[];for(let e=0,t=s.length;e<t;e++){const t=void 0===s[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new i._4j({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:i.hB5})),l.DefaultMaterial):this.getDependency("material",s[e].material);a.push(t)}var l;return a.push(t.loadGeometries(s)),Promise.all(a).then((function(n){const a=n.slice(0,n.length-1),l=n[n.length-1],c=[];for(let n=0,u=l.length;n<u;n++){const u=l[n],h=s[n];let f;const p=a[n];if(h.mode===ue.TRIANGLES||h.mode===ue.TRIANGLE_STRIP||h.mode===ue.TRIANGLE_FAN||void 0===h.mode)f=!0===o.isSkinnedMesh?new i.I46(u,p):new i.eaF(u,p),!0===f.isSkinnedMesh&&f.normalizeSkinWeights(),h.mode===ue.TRIANGLE_STRIP?f.geometry=j(f.geometry,i.O49):h.mode===ue.TRIANGLE_FAN&&(f.geometry=j(f.geometry,i.rYR));else if(h.mode===ue.LINES)f=new i.DXC(u,p);else if(h.mode===ue.LINE_STRIP)f=new i.N1A(u,p);else if(h.mode===ue.LINE_LOOP)f=new i.FCc(u,p);else{if(h.mode!==ue.POINTS)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);f=new i.ONl(u,p)}Object.keys(f.geometry.morphAttributes).length>0&&we(f,o),f.name=t.createUniqueName(o.name||"mesh_"+e),ge(f,o),h.extensions&&be(r,f,h),t.assignFinalMaterial(f),c.push(f)}for(let n=0,i=c.length;n<i;n++)t.associations.set(c[n],{meshes:e,primitives:n});if(1===c.length)return o.extensions&&be(r,c[0],o),c[0];const u=new i.YJl;o.extensions&&be(r,u,o),t.associations.set(u,{meshes:e});for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u}))}loadCamera(e){let t;const n=this.json.cameras[e],r=n[n.type];if(r)return"perspective"===n.type?t=new i.ubm(i.cj9.radToDeg(r.yfov),r.aspectRatio||1,r.znear||1,r.zfar||2e6):"orthographic"===n.type&&(t=new i.qUd(-r.xmag,r.xmag,r.ymag,-r.ymag,r.znear,r.zfar)),n.name&&(t.name=this.createUniqueName(n.name)),ge(t,n),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],n=[];for(let e=0,i=t.joints.length;e<i;e++)n.push(this._loadNodeShallow(t.joints[e]));return void 0!==t.inverseBindMatrices?n.push(this.getDependency("accessor",t.inverseBindMatrices)):n.push(null),Promise.all(n).then((function(e){const n=e.pop(),r=e,o=[],s=[];for(let e=0,a=r.length;e<a;e++){const a=r[e];if(a){o.push(a);const t=new i.kn4;null!==n&&t.fromArray(n.array,16*e),s.push(t)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}return new i.EAD(o,s)}))}loadAnimation(e){const t=this.json,n=this,r=t.animations[e],o=r.name?r.name:"animation_"+e,s=[],a=[],l=[],c=[],u=[];for(let e=0,t=r.channels.length;e<t;e++){const t=r.channels[e],n=r.samplers[t.sampler],i=t.target,o=i.node,h=void 0!==r.parameters?r.parameters[n.input]:n.input,f=void 0!==r.parameters?r.parameters[n.output]:n.output;void 0!==i.node&&(s.push(this.getDependency("node",o)),a.push(this.getDependency("accessor",h)),l.push(this.getDependency("accessor",f)),c.push(n),u.push(i))}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l),Promise.all(c),Promise.all(u)]).then((function(e){const t=e[0],r=e[1],s=e[2],a=e[3],l=e[4],c=[];for(let e=0,i=t.length;e<i;e++){const i=t[e],o=r[e],u=s[e],h=a[e],f=l[e];if(void 0===i)continue;i.updateMatrix&&i.updateMatrix();const p=n._createAnimationTracks(i,o,u,h,f);if(p)for(let e=0;e<p.length;e++)c.push(p[e])}return new i.tz3(o,void 0,c)}))}createNodeMesh(e){const t=this.json,n=this,i=t.nodes[e];return void 0===i.mesh?null:n.getDependency("mesh",i.mesh).then((function(e){const t=n._getNodeRef(n.meshCache,i.mesh,e);return void 0!==i.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,n=i.weights.length;t<n;t++)e.morphTargetInfluences[t]=i.weights[t]})),t}))}loadNode(e){const t=this,n=this.json.nodes[e],i=t._loadNodeShallow(e),r=[],o=n.children||[];for(let e=0,n=o.length;e<n;e++)r.push(t.getDependency("node",o[e]));const s=void 0===n.skin?Promise.resolve(null):t.getDependency("skin",n.skin);return Promise.all([i,Promise.all(r),s]).then((function(e){const t=e[0],n=e[1],i=e[2];null!==i&&t.traverse((function(e){e.isSkinnedMesh&&e.bind(i,Pe)}));for(let e=0,i=n.length;e<i;e++)t.add(n[e]);return t}))}_loadNodeShallow(e){const t=this.json,n=this.extensions,r=this;if(void 0!==this.nodeCache[e])return this.nodeCache[e];const o=t.nodes[e],s=o.name?r.createUniqueName(o.name):"",a=[],l=r._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return l&&a.push(l),void 0!==o.camera&&a.push(r.getDependency("camera",o.camera).then((function(e){return r._getNodeRef(r.cameraCache,o.camera,e)}))),r._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){a.push(e)})),this.nodeCache[e]=Promise.all(a).then((function(t){let a;if(a=!0===o.isBone?new i.$Kf:t.length>1?new i.YJl:1===t.length?t[0]:new i.B69,a!==t[0])for(let e=0,n=t.length;e<n;e++)a.add(t[e]);if(o.name&&(a.userData.name=o.name,a.name=s),ge(a,o),o.extensions&&be(n,a,o),void 0!==o.matrix){const e=new i.kn4;e.fromArray(o.matrix),a.applyMatrix4(e)}else void 0!==o.translation&&a.position.fromArray(o.translation),void 0!==o.rotation&&a.quaternion.fromArray(o.rotation),void 0!==o.scale&&a.scale.fromArray(o.scale);if(r.associations.has(a)){if(void 0!==o.mesh&&r.meshCache.refs[o.mesh]>1){const e=r.associations.get(a);r.associations.set(a,{...e})}}else r.associations.set(a,{});return r.associations.get(a).nodes=e,a})),this.nodeCache[e]}loadScene(e){const t=this.extensions,n=this.json.scenes[e],r=this,o=new i.YJl;n.name&&(o.name=r.createUniqueName(n.name)),ge(o,n),n.extensions&&be(t,o,n);const s=n.nodes||[],a=[];for(let e=0,t=s.length;e<t;e++)a.push(r.getDependency("node",s[e]));return Promise.all(a).then((function(e){for(let t=0,n=e.length;t<n;t++)o.add(e[t]);return r.associations=(e=>{const t=new Map;for(const[e,n]of r.associations)(e instanceof i.imn||e instanceof i.gPd)&&t.set(e,n);return e.traverse((e=>{const n=r.associations.get(e);null!=n&&t.set(e,n)})),t})(o),o}))}_createAnimationTracks(e,t,n,r,o){const s=[],a=e.name?e.name:e.uuid,l=[];let c;switch(ye[o.path]===ye.weights?e.traverse((function(e){e.morphTargetInfluences&&l.push(e.name?e.name:e.uuid)})):l.push(a),ye[o.path]){case ye.weights:c=i.Hit;break;case ye.rotation:c=i.MBL;break;case ye.translation:case ye.scale:c=i.RiT;break;default:c=1===n.itemSize?i.Hit:i.RiT}const u=void 0!==r.interpolation?me[r.interpolation]:i.PJ3,h=this._getArrayFromAccessor(n);for(let e=0,n=l.length;e<n;e++){const n=new c(l[e]+"."+ye[o.path],t.array,h,u);"CUBICSPLINE"===r.interpolation&&this._createCubicSplineTrackInterpolant(n),s.push(n)}return s}_getArrayFromAccessor(e){let t=e.array;if(e.normalized){const e=Te(t.constructor),n=new Float32Array(t.length);for(let i=0,r=t.length;i<r;i++)n[i]=t[i]*e;t=n}return t}_createCubicSplineTrackInterpolant(e){e.createInterpolant=function(e){return new(this instanceof i.MBL?ce:ae)(this.times,this.values,this.getValueSize()/3,e)},e.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0}}function Re(e,t,n){const r=t.attributes,o=[];function s(t,i){return n.getDependency("accessor",t).then((function(t){e.setAttribute(i,t)}))}for(const t in r){const n=ve[t]||t.toLowerCase();n in e.attributes||o.push(s(r[t],n))}if(void 0!==t.indices&&!e.index){const i=n.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));o.push(i)}return i.ppV.workingColorSpace!==i.Zr2&&"COLOR_0"in r&&console.warn(`THREE.GLTFLoader: Converting vertex colors from "srgb-linear" to "${i.ppV.workingColorSpace}" not supported.`),ge(e,t),function(e,t,n){const r=t.attributes,o=new i.NRn;if(void 0===r.POSITION)return;{const e=n.json.accessors[r.POSITION],t=e.min,s=e.max;if(void 0===t||void 0===s)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(o.set(new i.Pq0(t[0],t[1],t[2]),new i.Pq0(s[0],s[1],s[2])),e.normalized){const t=Te(he[e.componentType]);o.min.multiplyScalar(t),o.max.multiplyScalar(t)}}const s=t.targets;if(void 0!==s){const e=new i.Pq0,t=new i.Pq0;for(let i=0,r=s.length;i<r;i++){const r=s[i];if(void 0!==r.POSITION){const i=n.json.accessors[r.POSITION],o=i.min,s=i.max;if(void 0!==o&&void 0!==s){if(t.setX(Math.max(Math.abs(o[0]),Math.abs(s[0]))),t.setY(Math.max(Math.abs(o[1]),Math.abs(s[1]))),t.setZ(Math.max(Math.abs(o[2]),Math.abs(s[2]))),i.normalized){const e=Te(he[i.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}o.expandByVector(e)}e.boundingBox=o;const a=new i.iyt;o.getCenter(a.center),a.radius=o.min.distanceTo(o.max)/2,e.boundingSphere=a}(e,t,n),Promise.all(o).then((function(){return void 0!==t.targets?function(e,t,n){let i=!1,r=!1,o=!1;for(let e=0,n=t.length;e<n;e++){const n=t[e];if(void 0!==n.POSITION&&(i=!0),void 0!==n.NORMAL&&(r=!0),void 0!==n.COLOR_0&&(o=!0),i&&r&&o)break}if(!i&&!r&&!o)return Promise.resolve(e);const s=[],a=[],l=[];for(let c=0,u=t.length;c<u;c++){const u=t[c];if(i){const t=void 0!==u.POSITION?n.getDependency("accessor",u.POSITION):e.attributes.position;s.push(t)}if(r){const t=void 0!==u.NORMAL?n.getDependency("accessor",u.NORMAL):e.attributes.normal;a.push(t)}if(o){const t=void 0!==u.COLOR_0?n.getDependency("accessor",u.COLOR_0):e.attributes.color;l.push(t)}}return Promise.all([Promise.all(s),Promise.all(a),Promise.all(l)]).then((function(t){const n=t[0],s=t[1],a=t[2];return i&&(e.morphAttributes.position=n),r&&(e.morphAttributes.normal=s),o&&(e.morphAttributes.color=a),e.morphTargetsRelative=!0,e}))}(e,t.targets,n):e}))}var Ee=n(5418),Oe=console.error;function Ae(e){(new o).parse(e,(function(e){var t,n;console.log(e),t=e,(n=document.createElement("a")).setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(t))),n.setAttribute("download","scene.gltf"),document.body.appendChild(n),n.click(),n.remove()}),Oe)}function Me(e,t){(new B).load(e,(function(n){n.scene.scale.set(Ee.R/.5,Ee.R/.5,Ee.R/.5),n.scene.matrixAutoUpdate=!1,n.scene.updateMatrix(),n.scene.updateMatrixWorld(),n.scene.name=e,t(n)}),(function(t){return console.log(e+" "+t.loaded+" bytes loaded")}),Oe)}},363:(e,t,n)=>{n.d(t,{l:()=>l});var i=n(5418),r=n(12),o=n(4922);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"indicateValid",value:function(t){e.placermaterial.color.setHex(t?13434828:16711680)}},{key:"createHelper",value:function(){var e=new o.Ho_(i.R,i.R,30*i.R/.5,12,1,!0),t=new o.eaF(e,this.helpermaterial);return t.geometry.applyMatrix4((new o.kn4).identity().makeRotationAxis(r.up,-Math.PI/2)).applyMatrix4((new o.kn4).identity().makeTranslation(15*i.R/.5,0,.01*-i.R/.5)),t.visible=!1,t.renderOrder=-1,t.material.depthTest=!1,t}},{key:"createPlacer",value:function(){var t=new o.Ho_(.01*i.R/.5,i.R,i.R,4),n=new o.eaF(t,e.placermaterial);return n.geometry.applyMatrix4((new o.kn4).identity().makeRotationAxis(new o.Pq0(1,0,0),-Math.PI/2)).applyMatrix4((new o.kn4).identity().makeTranslation(0,0,.7*i.R/.5)),n.visible=!1,n}},{key:"createCue",value:function(t,n,s){var a=new o.Ho_(t,n,s,11),l=new o.eaF(a,e.material);return l.castShadow=!1,l.geometry.applyMatrix4((new o.kn4).identity().makeRotationAxis(new o.Pq0(1,0,0),-.17)).applyMatrix4((new o.kn4).identity().makeRotationAxis(r.up,-Math.PI/2)).applyMatrix4((new o.kn4).identity().makeTranslation(-s/2-i.R,0,s/2*Math.sin(.17)+.25*i.R)),l}}],null&&s(t.prototype,null),n&&s(t,n),e}();a(l,"mesh",void 0),a(l,"material",new o.tXL({color:8934775,wireframe:!1,flatShading:!1})),a(l,"placermaterial",new o.tXL({color:13434828,wireframe:!1,flatShading:!1,transparent:!0,opacity:.5})),a(l,"helpermaterial",new o.BKk({uniforms:{lightDirection:{value:new o.Pq0(0,0,1)}},vertexShader:"\n      varying vec2 vUv;\n      varying vec3 vNormal;  \n      void main() {\n        vNormal = normal;\n        vUv = uv;\n        gl_Position = projectionMatrix * modelViewMatrix * vec4(position,1.0);\n      }\n    ",fragmentShader:"\n      varying vec2 vUv;\n      varying vec3 vNormal;\n      uniform vec3 lightDirection;\n      void main() {\n        float intensity = dot(vNormal, lightDirection);\n        vec3 color = vec3(1.0, 1.0, 1.0);\n        vec3 finalColor = color * intensity;\n        gl_FragColor = vec4(finalColor, 0.05 * (1.0-vUv.y));\n      }\n    ",wireframe:!1,transparent:!0}))},665:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e){var t=43*e,n=21*e;return{tableX:t,tableY:n,X:t+e,Y:n+e}}n.d(t,{P:()=>a});var s=o(n(5418).R),a=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"scaleToRadius",value:function(t){var n=o(t);e.tableX=n.tableX,e.tableY=n.tableY,e.X=n.X,e.Y=n.Y,e.hasPockets=!0}},{key:"setCaromDimensions",value:function(e,t,n){this.hasPockets=!1,this.X=e/2,this.Y=t/2,this.tableX=this.X-n,this.tableY=this.Y-n}}],null&&i(t.prototype,null),n&&i(t,n),e}();r(a,"tableX",s.tableX),r(a,"tableY",s.tableY),r(a,"X",s.X),r(a,"Y",s.Y),r(a,"hasPockets",!0)},772:(e,t,n)=>{n.d(t,{s:()=>l});var i=n(3413),r=n(2617),o=n.n(r);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"pressed",{}),a(this,"released",{}),a(this,"keydown",(function(e){null==n.pressed[e.code]&&(n.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()})),a(this,"keyup",(function(e){n.released[e.code]=performance.now()-n.pressed[e.code],delete n.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()})),a(this,"mousetouch",(function(e){var t,i,r=n.released,o=e.client.y<e.rect.height/2||e.ctrlKey?.5:1,s=e.dx*o,a=.8*e.dy;r.movementY=(null!==(t=r.movementY)&&void 0!==t?t:0)+a,r.movementX=(null!==(i=r.movementX)&&void 0!==i?i:0)+s,Math.abs(r.movementX)>Math.abs(r.movementY)&&(r.movementY=0)})),this.addHandlers(t),/Android|iPhone/i.test(navigator.userAgent)||(t.contentEditable="true")}var t,n;return t=e,(n=[{key:"getEvents",value:function(){var e=this,t=Object.keys(this.pressed).filter((function(e){return!/Shift/.test(e)})).filter((function(e){return!/Control/.test(e)})),n=Object.keys(this.pressed).some((function(e){return/Shift/.test(e)})),r=Object.keys(this.pressed).some((function(e){return/Control/.test(e)})),o=[];return t.forEach((function(t){var s=performance.now()-e.pressed[t];o.push(new i.p(r?s/3:s,n?"Shift"+t:t)),"Space"!=t&&(e.pressed[t]=performance.now())})),Object.keys(this.released).forEach((function(t){return o.push(new i.p(e.released[t],t+"Up"))})),this.released={},o}},{key:"addHandlers",value:function(e){var t=this;e.addEventListener("keydown",this.keydown),e.addEventListener("keyup",this.keyup),e.focus(),o()(e).draggable({listeners:{move:function(e){t.mousetouch(e)}}}),o()(e).gesturable({onmove:function(e){e.dx/=3,t.mousetouch(e)}})}}])&&s(t.prototype,n),e}()},803:(e,t,n)=>{n.d(t,{d:()=>T});var i=n(7009),r=n(2522),o=n(4368),s=n(2518),a=n(1943),l=n(5556),c=n(3206),u=n(9915);function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function d(e,t){return d=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},d(e,t)}function v(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(v=function(){return!!e})()}var y=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"",r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),f(e=function(e,t,n){return t=p(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,v()?Reflect.construct(t,n||[],p(e).constructor):t.apply(e,n))}(this,t),"clientResendFrom",void 0),f(e,"serverResendFrom",void 0),e.type=i.B.REJOIN,e.clientResendFrom=n,e.serverResendFrom=r,e}var n,r,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&d(e,t)}(t,e),n=t,o=[{key:"fromJson",value:function(e){return new t(e.clientResendFrom,e.serverResendFrom)}}],(r=[{key:"applyToController",value:function(e){return e.handleRejoin(this)}}])&&h(n.prototype,r),o&&h(n,o),t}(n(8279).F),m=n(7387),b=n(9419),g=n(2582);function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function x(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){k(e,t,n[t])}))}return e}var T=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"q",value:function(e,t){return Math.round(e*t)/t}},{key:"packVec2",value:function(t){return[e.q(t.x,100),e.q(t.y,100)]}},{key:"unpackVec2",value:function(e){return{x:e[0],y:e[1],z:0}}},{key:"deltaAim",value:function(e,t){if(!e)return{full:!0,payload:t};var n={t:"a"};return Math.abs(e.a-t.a)>.002&&(n.a=t.a),Math.abs(e.w-t.w)>.002&&(n.w=t.w),e.p[0]===t.p[0]&&e.p[1]===t.p[1]||(n.p=t.p),e.o[0]===t.o[0]&&e.o[1]===t.o[1]||(n.o=t.o),e.i!==t.i&&(n.i=t.i),void 0!==t.sequence&&(n.sequence=t.sequence),void 0!==t.clientId&&(n.clientId=t.clientId),Object.keys(n).length>1?{full:!1,payload:n}:{full:!1,payload:{t:"z"}}}},{key:"compactAim",value:function(t){var n;return{t:"A",p:e.packVec2(t.pos),o:e.packVec2(t.offset),a:e.q(t.angle,1e3),w:e.q(t.power,100),i:null!==(n=t.i)&&void 0!==n?n:0,sequence:t.sequence,clientId:t.clientId}}},{key:"expandAim",value:function(t){var n={type:"AIM",pos:e.unpackVec2(t.p),offset:e.unpackVec2(t.o),angle:t.a,power:t.w,i:t.i};return"sequence"in t&&(n.sequence=t.sequence),"clientId"in t&&(n.clientId=t.clientId),n}},{key:"serialise",value:function(t){try{var n;if("AIM"===(null==t?void 0:t.type)){var i,r=null!==(i=t.clientId)&&void 0!==i?i:"local",o=e.lastAimSentByClient.get(r),s=e.compactAim(t),a=e.deltaAim(o,s),l=a.full,c=a.payload;return e.lastAimSentByClient.set(r,s),JSON.stringify(l?s:c)}if("WATCHAIM"===(null==t?void 0:t.type)&&"AIM"===(null==t||null===(n=t.json)||void 0===n?void 0:n.type)){var u=e.compactAim(t.json);return JSON.stringify({t:"W",j:u,sequence:t.sequence,clientId:t.clientId})}}catch(e){}var h,f=x({},t);return f.type=null!==(h=t.type)&&void 0!==h?h:f.type,JSON.stringify(f)}},{key:"fromJson",value:function(e){switch(e.type){case i.B.AIM:return r.w.fromJson(e);case i.B.WATCHAIM:return o.Q.fromJson(e);case i.B.HIT:return s.Q.fromJson(e);case i.B.BREAK:return l.W.fromJson(e);case i.B.CHAT:return u.b.fromJson(e);case i.B.REJOIN:return y.fromJson(e);case i.B.PLACEBALL:return m.z.fromJson(e);case i.B.RERACK:return b.x.fromJson(e);case i.B.STARTAIM:return g.M.fromJson(e);case i.B.ABORT:return"function"==typeof a.h.fromJson?a.h.fromJson(e):new a.h;default:return new c.u}}},{key:"fromSerialised",value:function(t){if(t&&"{"===t[0])try{var n=JSON.parse(t);if("z"===n.t)return new c.u;if("a"===n.t){var i,r=null!==(i=n.clientId)&&void 0!==i?i:"remote",o=x({},e.lastAimRecvByClient.get(r)||{t:"A",p:[0,0],o:[0,0],a:0,w:0,i:0},n);e.lastAimRecvByClient.set(r,o);var s=e.expandAim(o);return e.fromJson(s)}if("A"===n.t){var a,l=e.expandAim(n),u=null!==(a=n.clientId)&&void 0!==a?a:"remote";return e.lastAimRecvByClient.set(u,n),e.fromJson(l)}if("W"===n.t){var h=e.expandAim(n.j);return e.fromJson(x({type:"WATCHAIM"},h))}var f=e.fromJson(n);return"sequence"in n&&(f.sequence=n.sequence),"clientId"in n&&(f.clientId=n.clientId),f}catch(e){}return new c.u}}],null&&w(t.prototype,null),n&&w(t,n),e}();k(T,"lastAimSentByClient",new Map),k(T,"lastAimRecvByClient",new Map)},1185:(e,t,n)=>{n.d(t,{e:()=>b});var i=n(2518),r=n(5615),o=n(2522),s=n(5556),a=n(4853),l=n(7009),c=n(9419),u=n(4005);function h(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function d(e){return d=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},d(e)}function v(e,t){return v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},v(e,t)}function y(e){return function(e){if(Array.isArray(e))return h(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return h(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?h(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function m(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(m=function(){return!!e})()}var b=function(e){function t(e,n,i){var r,o=arguments.length>3&&void 0!==arguments[3]&&arguments[3],a=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1500;if(function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),p(r=function(e,t,n){return t=d(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,m()?Reflect.construct(t,n||[],d(e).constructor):t.apply(e,n))}(this,t,[e]),"delay",void 0),p(r,"shots",void 0),p(r,"firstShot",void 0),p(r,"timer",void 0),p(r,"init",void 0),r.init=n,r.shots=y(i),r.firstShot=r.shots[0],r.delay=a,r.container.table.showTraces(!0),r.container.table.updateFromShortSerialised(r.init),o){var l=new s.W(n,i);l.retry=!0,r.container.eventQueue.push(l)}else r.container.view.camera.forceMode(r.container.view.camera.topView),r.playNextShot(1.5*r.delay);return r}var n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(t,e),n=t,(r=[{key:"playNextShot",value:function(e){var t=this,n=this.shots.shift();if((null==n?void 0:n.type)===l.B.RERACK)return c.x.fromJson(n.ballinfo).applyToController(this),void(this.shots.length>0&&this.playNextShot(e));var r=o.w.fromJson(n);this.container.table.cueball=this.container.table.balls[r.i],console.log(this.container.table.cueball.pos.distanceTo(r.pos)),this.container.table.cueball.pos.copy(r.pos),this.container.table.cue.aim=r,this.container.table.cue.updateAimInput(),this.container.table.cue.t=1,clearTimeout(this.timer),this.timer=setTimeout((function(){t.container.eventQueue.push(new i.Q(t.container.table.cue.aim)),t.timer=void 0}),e)}},{key:"handleHit",value:function(e){return this.hit(),this}},{key:"handleStationary",value:function(e){return this.shots.length>0&&void 0===this.timer&&this.playNextShot(this.delay),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}},{key:"handleBreak",value:function(e){return this.container.table.updateFromShortSerialised(e.init),this.shots=y(e.shots),this.container.table.showSpin(!0),e.retry?this.retry():(this.playNextShot(this.delay),this)}},{key:"handleAbort",value:function(e){return console.log("Replay aborted"),new u.o(this.container)}},{key:"retry",value:function(){clearTimeout(this.timer),this.timer=void 0,this.container.table.updateFromShortSerialised(this.init);var e=o.w.fromJson(this.firstShot);return this.container.table.cueball=this.container.table.balls[e.i],this.container.rules.cueball=this.container.table.cueball,this.container.table.cueball.pos.copy(e.pos),this.container.table.cue.aim=e,this.container.view.camera.forceMode(this.container.view.camera.aimView),new a.m(this.container)}}])&&f(n.prototype,r),t}(r.y)},1279:(e,t,n)=>{n.d(t,{O:()=>h});var i=n(4853),r=n(8938),o=n(5615),s=n(4110);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var h=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,u()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t,[e])).container.table.outcome=[],n.container.table.hit(),n}var n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,(o=[{key:"handleStartAim",value:function(e){return new i.m(this.container)}},{key:"handlePlaceBall",value:function(e){return new s.x(this.container)}},{key:"handleWatch",value:function(e){return"rerack"in e.json?(console.log("Respot"),this.container.table.updateFromSerialised(e.json),this):new r.r(this.container)}}])&&a(n.prototype,o),t}(o.y)},1943:(e,t,n)=>{n.d(t,{h:()=>c});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t)).type=r.B.ABORT,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,(i=[{key:"applyToController",value:function(e){return e.handleAbort(this)}}])&&o(n.prototype,i),t}(i.F)},2518:(e,t,n)=>{n.d(t,{Q:()=>c});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(e){var n,i,o,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t),a=void 0,(o="tablejson")in(i=n)?Object.defineProperty(i,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[o]=a,n.type=r.B.HIT,n.tablejson=e,n}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){return new t(e.tablejson)}}],(i=[{key:"applyToController",value:function(e){return e.handleHit(this)}}])&&o(n.prototype,i),c&&o(n,c),t}(i.F)},2522:(e,t,n)=>{n.d(t,{w:()=>f});var i=n(8279),r=n(7009),o=n(12),s=n(4922);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function c(e){return c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},c(e)}function u(e,t){return u=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},u(e,t)}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(h=function(){return!!e})()}var f=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),l(e=function(e,t,n){return t=c(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,h()?Reflect.construct(t,n||[],c(e).constructor):t.apply(e,n))}(this,t),"offset",new s.Pq0(0,0,0)),l(e,"angle",0),l(e,"power",0),l(e,"pos",new s.Pq0(0,0,0)),l(e,"i",0),e.type=r.B.AIM,e}var n,i,f;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&u(e,t)}(t,e),n=t,f=[{key:"fromJson",value:function(e){var n=new t;return n.pos=(0,o.t6)(e.pos),n.angle=e.angle,n.offset=(0,o.t6)(e.offset),n.power=e.power,e.i&&(n.i=e.i),n}}],(i=[{key:"applyToController",value:function(e){return e.handleAim(this)}},{key:"copy",value:function(){return t.fromJson(this)}}])&&a(n.prototype,i),f&&a(n,f),t}(i.F)},2582:(e,t,n)=>{n.d(t,{M:()=>c});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e,n,i,o=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t),(i="foul")in(n=e)?Object.defineProperty(n,i,{value:0,enumerable:!0,configurable:!0,writable:!0}):n[i]=0,e.type=r.B.STARTAIM,e.foul=o,e}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){return new t(e.foul)}}],(i=[{key:"applyToController",value:function(e){return e.handleStartAim(this)}}])&&o(n.prototype,i),c&&o(n,c),t}(i.F)},2651:(e,t,n)=>{n.d(t,{c:()=>y,U:()=>v});var i=n(12),r=n(8090),o=n(4922),s=n(5418);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"line",void 0),l(this,"geometry",void 0),l(this,"positions",void 0),l(this,"lastPos",new o.Pq0),l(this,"lastVel",new o.Pq0),this.geometry=new o.LoY,this.positions=new Float32Array(3*t),this.geometry.setAttribute("position",new o.THS(this.positions,3)),this.reset();var i=new o.mrM({color:n,opacity:.25,linewidth:3,transparent:!0});this.line=new o.N1A(this.geometry,i),this.line.visible=!1}var t,n;return t=e,(n=[{key:"reset",value:function(){this.geometry.setDrawRange(0,0),this.lastVel.setZ(1)}},{key:"forceTrace",value:function(e){this.lastVel.z=1,this.addTraceGiven(e,this.lastVel,1,.1,1)}},{key:"addTrace",value:function(e,t){if(0!==t.length()){var n=this.lastVel.angleTo(t),i=n>Math.PI/32?.01*s.R:s.R,r=this.lastPos.distanceTo(e);this.addTraceGiven(e,t,r,i,n)}}},{key:"addTraceGiven",value:function(e,t,n,i,r){var o=this.geometry.drawRange.count;0!==o&&n<i||(o>1&&r<1e-4&&o--,this.lastPos.copy(e),this.lastVel.copy(t),this.addPoint(e,o))}},{key:"addPoint",value:function(e,t){var n=3*t;n>this.positions.length||(this.positions[n++]=e.x,this.positions[n++]=e.y,this.positions[n]=e.z,this.geometry.setDrawRange(0,t+1),this.line.geometry.attributes.position.needsUpdate=!0)}}])&&a(t.prototype,n),e}();function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var f=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),h(this,"mesh",void 0),h(this,"shadow",void 0),h(this,"spinAxisArrow",void 0),h(this,"trace",void 0),h(this,"color",void 0),h(this,"m",new o.kn4),this.color=new o.Q1f(t),this.initialiseMesh(t)}var t,n;return t=e,(n=[{key:"updateAll",value:function(e,t){this.updatePosition(e.pos),this.updateArrows(e.pos,e.rvel,e.state),0!==e.rvel.lengthSq()&&(this.updateRotation(e.rvel,t),this.trace.addTrace(e.pos,e.vel))}},{key:"updatePosition",value:function(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}},{key:"updateRotation",value:function(e,t){var n=e.length()*t;this.mesh.rotateOnWorldAxis((0,i.xb)(e),n)}},{key:"updateArrows",value:function(e,t,n){this.spinAxisArrow.setLength(s.R+s.R*t.length()/2,s.R,s.R),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection((0,i.xb)(t)),n==v.Rolling?this.spinAxisArrow.setColor(13369344):this.spinAxisArrow.setColor(52224)}},{key:"initialiseMesh",value:function(e){var t=new o.WBB(s.R,4),n=new o.tXL({emissive:0,flatShading:!1,vertexColors:!0,forceSinglePass:!0,shininess:25,specular:5592371});this.addDots(t,e),this.mesh=new o.eaF(t,n),this.mesh.name="ball",this.updateRotation((new o.Pq0).random(),100);var r=new o.tcD(.9*s.R,9);r.applyMatrix4((new o.kn4).identity().makeTranslation(0,0,.99*-s.R));var a=new o.V9B({color:1118498});this.shadow=new o.eaF(r,a),this.spinAxisArrow=new o.E0M(i.up,i.v_,2,0,.01,.01),this.spinAxisArrow.visible=!1,this.trace=new c(500,e)}},{key:"addDots",value:function(e,t){var n=this,i=e.attributes.position.count,r=new o.Q1f(t),s=new o.Q1f(11149858);e.setAttribute("color",new o.THS(new Float32Array(3*i),3));for(var a=e.attributes.color,l=0;l<i/3;l++)this.colorVerticesForFace(l,a,this.scaleNoise(r.r),this.scaleNoise(r.g),this.scaleNoise(r.b));[0,96,111,156,186,195].forEach((function(e){n.colorVerticesForFace(e/3,a,s.r,s.g,s.b)}))}},{key:"addToScene",value:function(e){e.add(this.mesh),e.add(this.shadow),e.add(this.spinAxisArrow),e.add(this.trace.line)}},{key:"colorVerticesForFace",value:function(e,t,n,i,r){t.setXYZ(3*e+0,n,i,r),t.setXYZ(3*e+1,n,i,r),t.setXYZ(3*e+2,n,i,r)}},{key:"scaleNoise",value:function(e){return(1-.25*Math.random())*e}}])&&u(t.prototype,n),e}();function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(e){return e.Stationary="Stationary",e.Rolling="Rolling",e.Sliding="Sliding",e.Falling="Falling",e.InPocket="InPocket",e}({}),y=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),d(this,"pos",void 0),d(this,"vel",i.v_.clone()),d(this,"rvel",i.v_.clone()),d(this,"futurePos",i.v_.clone()),d(this,"ballmesh",void 0),d(this,"state","Stationary"),d(this,"pocket",void 0),d(this,"id",e.id++),this.pos=t.clone(),this.ballmesh=new f(n||15658734*Math.random())}var t,n,o;return t=e,o=[{key:"fromSerialised",value:function(t){return e.updateFromSerialised(new e((0,i.t6)(t.pos)),t)}},{key:"updateFromSerialised",value:function(e,t){var n,r;return e.pos.copy(t.pos),e.vel.copy(null!==(n=null==t?void 0:t.vel)&&void 0!==n?n:i.v_),e.rvel.copy(null!==(r=null==t?void 0:t.rvel)&&void 0!==r?r:i.v_),e.state="Stationary",e}}],(n=[{key:"update",value:function(e){this.updatePosition(e),"Falling"==this.state?this.pocket.updateFall(this,e):this.updateVelocity(e)}},{key:"updateMesh",value:function(e){this.ballmesh.updateAll(this,e)}},{key:"updatePosition",value:function(e){this.pos.addScaledVector(this.vel,e)}},{key:"updateVelocity",value:function(e){this.inMotion()&&(this.isRolling()?(this.state="Rolling",(0,r.lx)(this.vel,this.rvel),this.addDelta(e,(0,r.JD)(this.rvel))):(this.state="Sliding",this.addDelta(e,(0,r.p2)(this.vel,this.rvel))))}},{key:"addDelta",value:function(e,t){t.v.multiplyScalar(e),t.w.multiplyScalar(e),this.passesZero(t)||(this.vel.add(t.v),this.rvel.add(t.w))}},{key:"passesZero",value:function(e){var t=(0,i.rq)(this.vel,e.v),n=(0,i.rq)(this.rvel,e.w);return!!(("Rolling"===this.state?t||n:t&&n)&&Math.abs(this.rvel.z)<.01)&&(this.setStationary(),!0)}},{key:"setStationary",value:function(){this.vel.copy(i.v_),this.rvel.copy(i.v_),this.state="Stationary"}},{key:"isRolling",value:function(){return 0!==this.vel.lengthSq()&&0!==this.rvel.lengthSq()&&(0,r.Mq)(this.vel,this.rvel).length()<e.transition}},{key:"onTable",value:function(){return"Falling"!==this.state&&"InPocket"!==this.state}},{key:"inMotion",value:function(){return"Rolling"===this.state||"Sliding"===this.state||this.isFalling()}},{key:"isFalling",value:function(){return"Falling"===this.state}},{key:"futurePosition",value:function(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}},{key:"fround",value:function(){this.pos.x=Math.fround(this.pos.x),this.pos.y=Math.fround(this.pos.y),this.vel.x=Math.fround(this.vel.x),this.vel.y=Math.fround(this.vel.y),this.rvel.x=Math.fround(this.rvel.x),this.rvel.y=Math.fround(this.rvel.y),this.rvel.z=Math.fround(this.rvel.z)}},{key:"serialise",value:function(){return{pos:this.pos.clone(),id:this.id}}}])&&p(t.prototype,n),o&&p(t,o),e}();d(y,"id",0),d(y,"transition",.05)},2765:(e,t,n)=>{n.d(t,{J:()=>T});var i=n(4368),r=n(8938),o=n(5615),s=n(4110),a=n(1185),l=n(7236),c=n(8738),u=n(803);function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}function d(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function v(e,t){return v=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},v(e,t)}function y(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(y=function(){return!!e})()}var m=function(e){function t(e,n,i){var r;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),f(r=function(e,t,n){return t=p(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,y()?Reflect.construct(t,n||[],p(e).constructor):t.apply(e,n))}(this,t,[e]),"messageRelay",void 0),f(r,"tableId",void 0),f(r,"messages",[]),r.messageRelay=n,r.tableId=i,r.messageRelay.subscribe(r.tableId,(function(e){console.log(e);var t=u.d.fromSerialised(e);r.messages.push(t),(d(t,c.Qe)||d(t,c.wG))&&r.container.eventQueue.push(t)})),console.log("Spectate"),r}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&v(e,t)}(t,e),n=t,(i=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return console.log("Spectate Hit"),this.container.table.updateFromSerialised(e.tablejson),this.container.table.outcome=[],this.container.table.hit(),this}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}])&&h(n.prototype,i),t}(o.y),b=n(9034);function g(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function w(e){return w=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},w(e)}function k(e,t){return k=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},k(e,t)}function x(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(x=function(){return!!e})()}var T=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=this,i=arguments,n=w(n=t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,x()?Reflect.construct(n,i||[],w(e).constructor):n.apply(e,i));var e,n,i}var n,o;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&k(e,t)}(t,e),n=t,(o=[{key:"handleBegin",value:function(e){return l.N.isSpectator()?new m(this.container,new b.p,l.N.getInstance().tableId):(this.container.chat.showMessage("Start"),this.container.sendEvent(new i.Q(this.container.table.serialise())),new s.x(this.container))}},{key:"handleWatch",value:function(e){return this.container.chat.showMessage("Opponent to break"),this.container.rules.secondToPlay(),this.container.table.updateFromSerialised(e.json),new r.r(this.container)}},{key:"handleBreak",value:function(e){return e.init?(this.container.table.updateFromShortSerialised(e.init),this.container.chat.showMessage("Replay"),new a.e(this.container,e.init,e.shots)):new s.x(this.container)}}])&&g(n.prototype,o),t}(o.y)},3206:(e,t,n)=>{n.d(t,{u:()=>c});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t)).type=r.B.BEGIN,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,(i=[{key:"applyToController",value:function(e){return e.handleBegin(this)}}])&&o(n.prototype,i),t}(i.F)},3276:(e,t,n)=>{var i=n(8090),r=n(4922);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"canvas",void 0),s(this,"context",void 0),s(this,"endx",100),s(this,"endy",100),s(this,"scale",2e3),s(this,"r",20),t.firstElementChild.innerHTML=n,this.canvas=t.lastElementChild,this.context=this.canvas.getContext("2d")}var t,n;return t=e,n=[{key:"drawBall",value:function(){this.context.beginPath(),this.context.strokeStyle="lightgray",this.context.fillStyle="beige",this.context.arc(this.endx,this.endy,this.r,0,2*Math.PI,!1),this.context.fill(),this.context.stroke()}},{key:"drawCushion",value:function(){var e=this.context.createLinearGradient(10,90,200,90);e.addColorStop(0,"lightgray"),e.addColorStop(.75,"white"),this.context.fillStyle=e,this.context.fillRect(this.endx+this.r,10,200,250)}},{key:"plot",value:function(e,t,n,r,o){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.drawCushion(),this.drawBall();for(var s=e;s<=t;s+=n){var a=r(s),l=o(s),c=(0,i.yO)(a,l)?[]:[2,2];this.context.setLineDash(c);var u=101*(s+360)%360;this.context.strokeStyle="hsl(".concat(u,",50%,50%)"),this.drawArrow(this.endx-a.x*this.scale,this.endy-a.y*this.scale,this.endx,this.endy);var h=(0,i.QK)(0,a,l,i.Qy);a.add(h.v),this.drawArrow(this.endx,this.endy,this.endx+a.x*this.scale,this.endy+a.y*this.scale)}}},{key:"drawArrow",value:function(e,t,n,i){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:.9,o={x:(n-e)*r+e,y:(i-t)*r+t},s=n-o.x,a=i-o.y;this.context.beginPath(),this.context.moveTo(e,t),this.context.lineTo(o.x,o.y),this.context.moveTo(o.x+.5*a,o.y-.5*s),this.context.lineTo(o.x-.5*a,o.y+.5*s),this.context.lineTo(n,i),this.context.closePath(),this.context.stroke()}}],n&&o(t.prototype,n),e}();function l(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function h(e){return function(e){if(Array.isArray(e))return l(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||function(e,t){if(e){if("string"==typeof e)return l(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?l(e,t):void 0}}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}var f=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),u(this,"canvas",void 0),u(this,"ctx",void 0),u(this,"xAxis",void 0),u(this,"yAxis",void 0),u(this,"gutter",20),this.canvas=document.getElementById(t),this.ctx=this.canvas.getContext("2d"),this.canvas.previousElementSibling.innerHTML=n,this.canvas.nextElementSibling.innerHTML=i}var t,n;return t=e,(n=[{key:"plot",value:function(e,t,n){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.shadowColor="grey",this.ctx.shadowBlur=2;var i=h(t).concat(h(n));i.push(0),this.xAxis=this.axisInfo(e,this.canvas.width),this.yAxis=this.axisInfo(i,this.canvas.height),this.drawXAxis(e),this.drawYAxis(i),this.plotLine(e,t,"blue"),this.plotLine(e,n,"red")}},{key:"plotLine",value:function(e,t,n){this.ctx.beginPath();for(var i=0;i<e.length;i++){var r=this.scale(e[i],this.xAxis),o=this.canvas.height-.8*this.scale(t[i],this.yAxis)-this.gutter;0===i?this.ctx.moveTo(r,o):this.ctx.lineTo(r,o)}this.ctx.strokeStyle=n,this.ctx.stroke()}},{key:"drawXAxis",value:function(e){var t=this.canvas.height-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,t),this.ctx.lineTo(this.canvas.width,t),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.font="8px Arial",this.ctx.strokeStyle="grey";for(var n=!1,i=2;i<e.length-2;i++){var r=this.scale(e[i],this.xAxis);this.ctx.beginPath(),this.ctx.moveTo(r,t),this.ctx.lineTo(r,t+4),this.ctx.stroke(),n||this.ctx.fillText(e[i],r-5,t+10),n=!n}}},{key:"drawYAxis",value:function(e){var t,n=(t=Math).max.apply(t,h(e)),i=this.canvas.height-.8*this.scale(n,this.yAxis)-this.gutter,r=this.canvas.height-.8*this.scale(0,this.yAxis)-this.gutter;this.ctx.beginPath(),this.ctx.moveTo(0,r),this.ctx.lineTo(0,i),this.ctx.strokeStyle="grey",this.ctx.stroke(),this.ctx.fillText("".concat((0).toFixed(3)),0,r),this.ctx.fillText("".concat(n.toFixed(3)),0,i)}},{key:"scale",value:function(e,t){return(e-t.min)*t.scale}},{key:"axisInfo",value:function(e,t){var n,i,r=(n=Math).min.apply(n,h(e)),o=(i=Math).max.apply(i,h(e));return{min:r,max:o,scale:t/(o-r||1)}}}])&&c(t.prototype,n),e}(),p=n(2651),d=n(5418),v=n(12);function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b,g,w,k,x,T,P,S,R,E=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),m(this,"ball",void 0),m(this,"theta",0),m(this,"canvas",void 0),m(this,"ctx",void 0),m(this,"step",.01),this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.ball=new p.c(v.v_),this.ball.vel.copy(new r.Pq0(32*d.R,0,0)),this.ball.rvel.copy(new r.Pq0(0,-2*this.ball.vel.x/d.R,0)),this.ball.state=p.U.Sliding}var t,n;return t=e,n=[{key:"drawBall",value:function(e,t,n){var i=this.canvas.width,r=this.canvas.height,o=i/(27*d.R);this.ctx.beginPath(),this.ctx.strokeStyle=n,this.ctx.fillStyle=n;var s=e*o+2*d.R*o,a=t*o+r/2,l=d.R*o;this.ctx.ellipse(s,a,l,l,0,0,2*Math.PI),this.ctx.stroke();var c=s+d.R*-Math.sin(this.theta)*o,u=a+d.R*Math.cos(this.theta)*o;this.ctx.beginPath(),this.ctx.strokeStyle="black",this.ctx.moveTo(s,a),this.ctx.lineTo(c,u),this.ctx.stroke(),this.ctx.beginPath(),this.ctx.fillStyle="black",this.ctx.arc(c,u,3,0,2*Math.PI),this.ctx.fill()}},{key:"advance",value:function(e){this.ball.update(e);var t=this.ball.rvel.length()*e;this.theta+=t}},{key:"draw",value:function(e){this.ctx.clearRect(0,0,1,1);for(var t=0;t<e;){var n="blue";this.ball.isRolling()?n="red":this.ball.inMotion()&&(n="green"),this.drawBall(this.ball.pos.x,0,n),this.advance(this.step),t+=this.step}}}],n&&y(t.prototype,n),e}(),O=n(8207),A=n(8765),M=n(8086),I=3*d.R;function _(e){I=e}function C(){b&&(function(){function e(e){return function(t){return B(0,0,e)}}var t=function(e){return B(function(e){return Math.cos(e*Math.PI/180)}(e),function(e){return Math.sin(e*Math.PI/180)}(e),0)};b.plot(10,80,10,t,(function(e){return B(0,0,0)})),g.plot(10,80,10,t,e(-40)),w.plot(10,80,10,t,e(40)),k.plot(-6,6,1,(function(e){return B(.7,.7,0)}),(function(e){return B(0,0,6*e)})),x.plot(-6,6,1,(function(e){return B(2,2,0)}),(function(e){return B(0,0,6*e)}))}(),function(){for(var e=[],t=[],n=[],o=-180;o<=180;o+=30){e.push(o);var s=new r.Pq0(.2*d.R,0,0),a=new r.Pq0(0,0,o*d.R);t.push((0,i.Gp)((0,i.c0)(s))),n.push((0,i.Un)((0,i.s0)(s,a)))}T.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],o=-180;o<=180;o+=30){e.push(o);var s=new r.Pq0(150*d.R,0,0),a=new r.Pq0(0,o*d.R,0);t.push((0,i.Gp)((0,i.c0)(s))),n.push((0,i.Un)((0,i.s0)(s,a)))}P.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],o=-80;o<=80;o+=10){e.push(o);var s=o*Math.PI/180,a=new r.Pq0(Math.cos(s)*d.R,Math.sin(s)*d.R,0);a.multiplyScalar(I);var l=new r.Pq0(0,0,-10*d.R);t.push((0,i.Gp)((0,i.c0)(a))),n.push((0,i.Un)((0,i.s0)(a,l)))}S.plot(e,t,n)}(),function(){for(var e=[],t=[],n=[],o=0;o<=88;o+=2){e.push(o);var s=o*Math.PI/180,a=new r.Pq0(Math.cos(s)*d.R,Math.sin(s)*d.R,0),l=new r.Pq0(0,0,50*d.R),c=(0,i.QV)(a,l),u=a.clone().add(c.v),h=180*-Math.atan2(-u.y,-u.x)/Math.PI;t.push(h);var f=(0,i.$8)(a,l),p=a.clone().add(f.v),v=180*-Math.atan2(-p.y,-p.x)/Math.PI;n.push(v)}R.plot(e,t,n)}())}function j(e){return document.getElementById(e)}function B(e,t,n){return new r.Pq0(e*d.R,t*d.R,n*d.R)}document.addEventListener("DOMContentLoaded",(function(){for(var e=document.getElementsByClassName("replaydiagram"),t=0;t<e.length;t++){var n=e.item(t);A.n.fromDiamgramElement(n).start()}var o,s,l,c=j("rollcanvas");c?new E(c).draw(5):(j("cushion1")&&(b=new a(j("cushion1"),"stun shot"),g=new a(j("cushion2"),"running side"),w=new a(j("cushion3"),"check side"),k=new a(j("cushion4"),"varying side"),x=new a(j("cushion5"),"varying side high vel"),T=new f("plot1","Top spin ball played slow directly into cushion","top/back spin w.y"),P=new f("plot2","Top spin ball played hard directly into cushion","top/back spin w.y"),S=new f("plot3","Right hand spinning ball with varying incident angleand speed s","Incident angle (degrees) of ball to cushion with right side"),R=new f("plot4","Bounce angle of ball with check side (y-axis outward angle)","Incident angle (degrees) of ball to cushion, 0=perpendicular, 90=parallel. Blue=Han2005 Red=Blend"),C()),new O.r(C).initialiseSlider("s",I,_,4),j("derived")&&(o=j("derived"),s=new r.Pq0((new M.s).maxPower,0,0),l=(0,i.t6)(new r.Pq0(.5),s),o.innerHTML+="Mx,My    = ".concat(d.x3.toFixed(6),"\n"),o.innerHTML+="Mz       = ".concat(d.Mz.toFixed(6),"\n"),o.innerHTML+="I        = ".concat(d.I.toFixed(6),"\n"),o.innerHTML+="Max vel  = ".concat(s.length().toFixed(6),"\n"),o.innerHTML+="Max rvel = ".concat(l.length().toFixed(4),"\n")))}))},3413:(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{p:()=>r});var r=function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i(this,"t",void 0),i(this,"key",void 0),this.t=t,this.key=n}},3645:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{P:()=>o});var o=function(){function e(t,n,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"type",void 0),r(this,"timestamp",void 0),r(this,"ballA",null),r(this,"ballB",null),r(this,"incidentSpeed",void 0),this.type=t,this.ballA=n,this.ballB=i,this.incidentSpeed=o,this.timestamp=Date.now()}var t,n;return t=e,n=[{key:"pot",value:function(t,n){return new e("Pot",t,t,n)}},{key:"cushion",value:function(t,n){return new e("Cushion",t,t,n)}},{key:"collision",value:function(t,n,i){return new e("Collision",t,n,i)}},{key:"hit",value:function(t,n){return new e("Hit",t,t,n)}},{key:"isCueBallPotted",value:function(e,t){return t.some((function(t){return"Pot"==t.type&&t.ballA===e}))}},{key:"isBallPottedNoFoul",value:function(t,n){return n.some((function(e){return"Pot"==e.type&&null!==e.ballA}))&&!e.isCueBallPotted(t,n)}},{key:"pots",value:function(e){return e.filter((function(e){return"Pot"==e.type})).map((function(e){return e.ballA}))}},{key:"potCount",value:function(e){return this.pots(e).length}},{key:"onlyRedsPotted",value:function(e){return this.pots(e).every((function(e){return e.id>6}))}},{key:"firstCollision",value:function(e){var t=e.filter((function(e){return"Collision"===e.type}));return t.length>0?t[0]:void 0}},{key:"isClearTable",value:function(e){var t=e.balls.filter((function(e){return e.onTable()}));return 1===t.length&&t[0]===e.cueball}},{key:"isThreeCushionPoint",value:function(t,n){n=e.cueBallFirst(t,n).filter((function(e){return e.ballA===t}));var i=new Set,r=0,o=!0,s=!1,a=void 0;try{for(var l,c=n[Symbol.iterator]();!(o=(l=c.next()).done);o=!0){var u=l.value;if("Cushion"===u.type&&r++,"Collision"===u.type&&(i.add(u.ballB),2===i.size))return r>=3}}catch(e){s=!0,a=e}finally{try{o||null==c.return||c.return()}finally{if(s)throw a}}return!1}},{key:"cueBallFirst",value:function(e,t){return t.forEach((function(t){"Collision"===t.type&&t.ballB===e&&(t.ballB=t.ballA,t.ballA=e)})),t}}],null&&i(t.prototype,null),n&&i(t,n),e}()},3894:(e,t,n)=>{n.d(t,{F:()=>d});var i=n(2651),r=n(4922),o=n(5418),s=n(12);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var c=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),l(this,"normalImpulse",void 0),l(this,"tangentialImpulse",void 0)}var t,n;return t=e,(n=[{key:"dynamicFriction",value:function(e){return.01+.108*(0,s.oN)(-1.088*e)}},{key:"updateVelocities",value:function(e,t){var n=d.positionsAtContact(e,t);e.ballmesh.trace.forceTrace(n.a),t.ballmesh.trace.forceTrace(n.b);var i=n.b.sub(n.a).normalize(),s=new r.Pq0(-i.y,i.x,0),a=e.vel.clone().sub(t.vel).add(i.clone().multiplyScalar(-o.R).cross(e.rvel).sub(i.clone().multiplyScalar(o.R).cross(t.rvel))),l=i.dot(a),c=a.addScaledVector(i,-l),u=c.length(),h=s.dot(c),f=this.dynamicFriction(u);this.normalImpulse=-1.99*l/(2/o.m),this.tangentialImpulse=.25*Math.min(f*Math.abs(this.normalImpulse)/u,1/7)*-h;var p=i.clone().multiplyScalar(this.normalImpulse),v=s.clone().multiplyScalar(this.tangentialImpulse);e.vel.addScaledVector(p,1/o.m).addScaledVector(v,1/o.m),t.vel.addScaledVector(p,-1/o.m).addScaledVector(v,-1/o.m);var y=i.clone().multiplyScalar(-o.R).cross(v),m=i.clone().multiplyScalar(o.R).cross(v);return e.rvel.addScaledVector(y,1/o.I),t.rvel.addScaledVector(m,1/o.I),l}}])&&a(t.prototype,n),e}();function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var h,f,p,d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"willCollide",value:function(e,t,n){return(e.inMotion()||t.inMotion())&&e.onTable()&&t.onTable()&&(0,s.nr)(e.futurePosition(n),t.futurePosition(n))<4*o.R*o.R}},{key:"collide",value:function(t,n){return e.updateVelocities(t,n)}},{key:"positionsAtContact",value:function(e,t){var n=e.pos.distanceTo(t.pos),i=e.vel.clone().sub(t.vel),r=(n-2*o.R)/i.length()||0;return{a:e.pos.clone().addScaledVector(e.vel,r),b:t.pos.clone().addScaledVector(t.vel,r)}}},{key:"updateVelocities",value:function(t,n){var r=e.model.updateVelocities(t,n);return t.state=i.U.Sliding,n.state=i.U.Sliding,r}}],null&&u(t.prototype,null),n&&u(t,n),e}();h=d,f="model",p=new c,f in h?Object.defineProperty(h,f,{value:p,enumerable:!0,configurable:!0,writable:!0}):h[f]=p},3982:(e,t,n)=>{n.d(t,{O:()=>a});var i=n(5418),r=n(91);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"pos",void 0),s(this,"radius",void 0),this.pos=t,this.radius=n}var t,n,a;return t=e,a=[{key:"willBounce",value:function(e,t){return t.distanceTo(e.pos)<i.R+e.radius}},{key:"findBouncing",value:function(t,n){var i=t.futurePosition(n);return r.f.knuckles.find((function(t){return e.willBounce(t,i)}))}}],(n=[{key:"bounce",value:function(e){var t=e.pos.clone().sub(this.pos).normalize(),n=t.dot(e.vel);return e.vel.addScaledVector(t,-2*i.e*n),e.rvel.multiplyScalar(.5),Math.abs(n)}}])&&o(t.prototype,n),a&&o(t,a),e}()},4005:(e,t,n)=>{n.d(t,{o:()=>c});var i=n(8738),r=n(2765);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=this,i=arguments,n=s(n=t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(n,i||[],s(e).constructor):n.apply(e,i));var e,n,i}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,(i=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"handleBegin",value:function(e){return new r.J(this.container)}}])&&o(n.prototype,i),t}(i.xI)},4110:(e,t,n)=>{n.d(t,{x:()=>d});var i=n(5615),r=n(8738),o=n(4853),s=n(5556),a=n(5418),l=n(4922),c=n(363);function u(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function h(e){return h=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},h(e)}function f(e,t){return f=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},f(e,t)}function p(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(p=function(){return!!e})()}var d=function(e){function t(e){var n,i,r,o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t,n){return t=h(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,p()?Reflect.construct(t,n||[],h(e).constructor):t.apply(e,n))}(this,t,[e]),i=n,r="placescale",o=.02*a.R,r in i?Object.defineProperty(i,r,{value:o,enumerable:!0,configurable:!0,writable:!0}):i[r]=o,n.container.table.cue.moveTo(n.container.table.cueball.pos),n.container.table.cue.aim.power=0,n.container.view.camera.forceMode(n.container.view.camera.aimView),n}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&f(e,t)}(t,e),n=t,(i=[{key:"onFirst",value:function(){var e=this.container.table.cueball;this.container.rules.allowsPlaceBall()&&e.pos.copy(this.container.rules.placeBall()),e.setStationary(),e.updateMesh(0),this.container.table.cue.placeBallMode(),this.container.table.cue.showHelper(!1),this.container.table.cue.moveTo(this.container.table.cueball.pos),this.container.table.cue.aimInputs.setButtonText("Place\nBall"),this.container.rules.allowsPlaceBall()||this.container.inputQueue.push(new r.pd(1,"SpaceUp"))}},{key:"handleInput",value:function(e){var t=this.container.table.cueball.pos;switch(e.key){case"ArrowLeft":case"KeyI":this.moveTo(0,e.t*this.placescale);break;case"ArrowRight":case"KeyK":this.moveTo(0,-e.t*this.placescale);break;case"movementXUp":this.moveTo(0,-e.t*this.placescale*2);break;case"movementYUp":this.moveTo(-e.t*this.placescale*2,0);break;case"KeyJ":this.moveTo(-e.t*this.placescale,0);break;case"KeyL":this.moveTo(e.t*this.placescale,0);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(t),this.container.view.camera.forceMove(this.container.table.cue.aim),this.container.sendEvent(this.container.table.cue.aim),this}},{key:"moveTo",value:function(e,t){var n=new l.Pq0(e,t),i=this.container.table.cueball.pos.add(n);i.copy(this.container.rules.placeBall(i)),c.l.indicateValid(!this.container.table.overlapsAny(i))}},{key:"placed",value:function(){return this.container.table.overlapsAny(this.container.table.cueball.pos)?this:(this.container.table.cue.aimInputs.setButtonText("Hit"),this.container.sound.playNotify(),this.container.sendEvent(new s.W(this.container.table.shortSerialise())),new o.m(this.container))}}])&&u(n.prototype,i),t}(i.y)},4314:(e,t,n)=>{n.d(t,{m:()=>oe});var i=n(5159),r=n(4922),o=n(12),s=n(4979),a=n(5418);function l(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function c(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var u=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),c(this,"camera",void 0),c(this,"mode",this.topView),c(this,"mainMode",this.aimView),c(this,"height",8*a.R),c(this,"elapsed",void 0),this.camera=new r.ubm(45,t,a.R,1e3*a.R)}var t,n;return t=e,n=[{key:"update",value:function(e,t){this.elapsed=e,this.mode(t)}},{key:"topView",value:function(e){this.camera.fov=s.v.fov,this.camera.position.lerp(s.v.viewPoint(this.camera.aspect,this.camera.fov),.9),this.camera.up=o.up,this.camera.lookAt(o.v_)}},{key:"aimView",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.08,n=this.height,i=this.camera.aspect<.8;if(this.camera.fov=i?60:40,n<10*a.R){var r=100*(10*a.R-n);this.camera.fov-=r*(i?3:1)}this.camera.position.lerp((0,o.iA)().copy(e.pos).addScaledVector((0,o.Dz)(e.angle),18*-a.R),t),this.camera.position.z=n,this.camera.up=o.up,this.camera.lookAt((0,o.iA)().copy(e.pos).addScaledVector(o.up,n/2))}},{key:"adjustHeight",value:function(e){e=this.height<10*a.R?e/8:e,this.height=r.cj9.clamp(this.height+e,6*a.R,120*a.R),this.height>110*a.R&&this.suggestMode(this.topView),this.height<105*a.R&&this.suggestMode(this.aimView)}},{key:"suggestMode",value:function(e){this.mainMode===this.aimView&&(this.mode=e)}},{key:"forceMode",value:function(e){this.mode=e,this.mainMode=e}},{key:"forceMove",value:function(e){this.mode===this.aimView&&this.aimView(e,1)}},{key:"toggleMode",value:function(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}],n&&l(t.prototype,n),e}(),h=n(665);function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"createMarkings",value:function(){return h.P.hasPockets?this.createPoolGrid():this.createCaromDiamonds()}},{key:"createPoolGrid",value:function(){return new r.YJl}},{key:"createCaromDiamonds",value:function(){for(var e=new r.YJl,t=h.P.X,n=h.P.Y,i=2*a.R,o=new r.V9B({color:16776960}),s=new r.tcD(a.R/4,16),l=1.25*a.R,c=-a.R+l+.001,u=function(t,n){var i=new r.eaF(s,o);i.position.set(t,n,c),e.add(i)},f=n+i/2,p=-4;p<=4;p++){var d=p/4,v=Math.abs(p)/4*.009,y=t*d-Math.sign(p)*v;u(y,f),u(y,-f)}for(var m=t+i/2,b=-2;b<=2;b++){var g=b/2,w=Math.abs(b)/2*.001,k=n*g-Math.sign(b)*w;u(m,k),u(-m,k)}for(var x=new r.V9B({color:16777215,transparent:!0,opacity:.051}),T=-a.R,P=-4;P<=4;P++){var S=t*(P/4),R=new r.iNn(.004,2*n,.001),E=new r.eaF(R,x);E.position.set(S,0,T),e.add(E)}for(var O=-2;O<=2;O++){var A=n*(O/2),M=new r.iNn(2*t,.004,.001),I=new r.eaF(M,x);I.position.set(0,A,T),e.add(I)}return e}}],null&&f(t.prototype,null),n&&f(t,n),e}(),d=n(9437);function v(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function y(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var m=function(){function e(t,n,i){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),y(this,"scene",new r.Z58),y(this,"renderer",void 0),y(this,"camera",void 0),y(this,"windowWidth",1),y(this,"windowHeight",1),y(this,"resizeDirty",!0),y(this,"_frustum",new r.PPD),y(this,"_projView",new r.kn4),y(this,"element",void 0),y(this,"table",void 0),y(this,"loadAssets",!0),y(this,"assets",void 0),y(this,"ballToCheck",0),this.element=t,this.table=n,this.assets=i,this.renderer=function(e){if("undefined"==typeof process){var t=new d.JeP({antialias:!0});t.shadowMap.enabled=!1,t.autoClear=!1,t.setSize(e.offsetWidth,e.offsetHeight);var n=window.__SPECTATOR_DPR||.75*window.devicePixelRatio;return t.setPixelRatio(n),e.appendChild(t.domElement),t}}(t),this.camera=new u(t?t.offsetWidth/t.offsetHeight:1),this.initialiseScene()}var t,n;return t=e,n=[{key:"update",value:function(e,t){this.camera.update(e,t)}},{key:"sizeChanged",value:function(){var e,t;return this.windowWidth!=(null===(e=this.element)||void 0===e?void 0:e.offsetWidth)||this.windowHeight!=(null===(t=this.element)||void 0===t?void 0:t.offsetHeight)}},{key:"updateSize",value:function(){var e,t,n=this.sizeChanged();return n&&(this.windowWidth=null===(e=this.element)||void 0===e?void 0:e.offsetWidth,this.windowHeight=null===(t=this.element)||void 0===t?void 0:t.offsetHeight),n}},{key:"render",value:function(){this.isInMotionNotVisible()&&this.camera.suggestMode(this.camera.topView),this.renderCamera(this.camera)}},{key:"renderCamera",value:function(e){var t;if(this.updateSize()){var n,i,r,o,s=this.windowWidth,a=this.windowHeight;this.resizeDirty?(null===(n=this.renderer)||void 0===n||n.setSize(s,a),null===(i=this.renderer)||void 0===i||i.setViewport(0,0,s,a),null===(r=this.renderer)||void 0===r||r.setScissor(0,0,s,a),null===(o=this.renderer)||void 0===o||o.setScissorTest(!0),e.camera.aspect=s/a,this.resizeDirty=!1):e.camera.aspect=s/a}e.camera.updateProjectionMatrix(),null===(t=this.renderer)||void 0===t||t.render(this.scene,e.camera)}},{key:"initialiseScene",value:function(){this.scene.add(new r.$p8(39202,.3)),this.assets.background&&this.scene.add(this.assets.background),this.scene.add(this.assets.table),this.table.mesh=this.assets.table,this.scene.add(p.createMarkings())}},{key:"isInMotionNotVisible",value:function(){var e=this.viewFrustrum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}},{key:"viewFrustrum",value:function(){var e=this.camera.camera,t=new r.PPD;return t.setFromProjectionMatrix((new r.kn4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}}],n&&v(t.prototype,n),e}(),b=n(2765),g=n(3413);function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function k(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var x=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),k(this,"line",new r.cZY),k(this,"balls",void 0),this.balls=t}var t,n;return t=e,(n=[{key:"getFirst",value:function(e,t){var n=this;this.line.set(e.pos,(0,o.xb)(t).multiplyScalar(4*h.P.X).add(e.pos));var i=new r.Pq0,s=this.balls.map((function(t){return n.line.closestPointToPoint(t.pos,!0,i),{ball:t,perpendicular:i.distanceTo(t.pos),distance:i.distanceTo(e.pos)}})).filter((function(e){return e.perpendicular<2*a.R})).filter((function(t){return t.ball!==e}));return s.reduce((function(e,t){return e.distance<t.distance?e:t}),s[0])}},{key:"getOverlapOffset",value:function(e,t){var n=this.getFirst(e,t);if(n){var i=n.ball.pos.clone().sub(e.pos),r=n.perpendicular*Math.sign(i.cross(t).z)/a.R;return{ball:n.ball,overlap:r}}}}])&&w(t.prototype,n),e}();function T(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function P(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var S=function(){function e(t){var n,i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),P(this,"cueBallElement",void 0),P(this,"cueTipElement",void 0),P(this,"cuePowerElement",void 0),P(this,"cueHitElement",void 0),P(this,"objectBallStyle",void 0),P(this,"container",void 0),P(this,"overlap",void 0),P(this,"ballWidth",void 0),P(this,"ballHeight",void 0),P(this,"tipRadius",void 0),P(this,"rafScheduled",!1),P(this,"lastMoveEvt",null),P(this,"mousemove",(function(e){1===e.buttons&&(i.lastMoveEvt=e,i.rafScheduled||(i.rafScheduled=!0,requestAnimationFrame((function(){i.lastMoveEvt&&i.adjustSpin(i.lastMoveEvt),i.rafScheduled=!1}))))})),P(this,"powerChanged",(function(e){i.container.table.cue.setPower(i.cuePowerElement.value)})),P(this,"hit",(function(e){var t;i.container.table.cue.setPower(null===(t=i.cuePowerElement)||void 0===t?void 0:t.value),i.container.inputQueue.push(new g.p(0,"SpaceUp"))})),P(this,"mousewheel",(function(e){i.cuePowerElement&&(i.cuePowerElement.value-=Math.sign(e.deltaY)/10,i.container.table.cue.setPower(i.cuePowerElement.value),i.container.lastEventTime=performance.now())})),this.container=t,this.cueBallElement=document.getElementById("cueBall"),this.cueTipElement=document.getElementById("cueTip"),this.cuePowerElement=document.getElementById("cuePower"),this.cueHitElement=document.getElementById("cueHit"),this.objectBallStyle=null===(n=document.getElementById("objectBall"))||void 0===n?void 0:n.style,this.overlap=new x(this.container.table.balls),this.addListeners()}var t,n;return t=e,(n=[{key:"addListeners",value:function(){var e,t,n,i,r,o=this;null===(e=this.cueBallElement)||void 0===e||e.addEventListener("pointermove",this.mousemove),null===(t=this.cueBallElement)||void 0===t||t.addEventListener("click",(function(e){o.adjustSpin(e)})),null===(n=this.cueHitElement)||void 0===n||n.addEventListener("click",this.hit),null===(i=this.cuePowerElement)||void 0===i||i.addEventListener("change",this.powerChanged),"ontouchstart"in window||null===(r=document.getElementById("viewP1"))||void 0===r||r.addEventListener("dblclick",this.hit),document.addEventListener("wheel",this.mousewheel)}},{key:"setButtonText",value:function(e){this.cueHitElement&&(this.cueHitElement.innerText=e)}},{key:"readDimensions",value:function(){var e,t,n;this.ballWidth=null===(e=this.cueBallElement)||void 0===e?void 0:e.offsetWidth,this.ballHeight=null===(t=this.cueBallElement)||void 0===t?void 0:t.offsetHeight,this.tipRadius=(null===(n=this.cueTipElement)||void 0===n?void 0:n.offsetWidth)/2}},{key:"adjustSpin",value:function(e){this.readDimensions(),this.container.table.cue.setSpin(new r.Pq0(-(e.offsetX-this.ballWidth/2)/this.ballWidth,-(e.offsetY-this.ballHeight/2)/this.ballHeight),this.container.table),this.container.lastEventTime=performance.now()}},{key:"updateVisualState",value:function(e,t){var n;this.readDimensions();var i=null===(n=this.cueTipElement)||void 0===n?void 0:n.style;i&&(i.left=(.5-e)*this.ballWidth-this.tipRadius+"px",i.top=(.5-t)*this.ballHeight-this.tipRadius+"px"),this.showOverlap()}},{key:"showOverlap",value:function(){if(this.objectBallStyle){var e=this.container.table,t=(0,o.Dz)(e.cue.aim.angle),n=this.overlap.getOverlapOffset(e.cueball,t);n?(this.readDimensions(),this.objectBallStyle.visibility="visible",this.objectBallStyle.left=5+n.overlap*this.ballWidth/2+"px",this.objectBallStyle.backgroundColor=new r.Q1f(0,0,0).lerp(n.ball.ballmesh.color,.5).getStyle()):this.objectBallStyle.visibility="hidden"}}},{key:"updatePowerSlider",value:function(e){var t;e>0&&(null===(t=this.cuePowerElement)||void 0===t?void 0:t.value)&&(this.cuePowerElement.value=e)}}])&&T(t.prototype,n),e}(),R=n(4853),E=n(8938),O=n(6940),A=n(1279),M=n(1185),I=n(4005),_=n(4110);function C(e,t){return null!=t&&"undefined"!=typeof Symbol&&t[Symbol.hasInstance]?!!t[Symbol.hasInstance](e):e instanceof t}function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var L=function(){function e(t){var n,i=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),B(this,"chatoutput",void 0),B(this,"chatInput",void 0),B(this,"chatSend",void 0),B(this,"chatInputText",void 0),B(this,"send",void 0),B(this,"sendClicked",(function(e){var t,n;i.send(null===(t=i.chatInputText)||void 0===t?void 0:t.value),i.showMessage(null===(n=i.chatInputText)||void 0===n?void 0:n.value)})),this.chatoutput=document.getElementById("chatoutput"),this.chatInputText=document.getElementById("chatinputtext"),this.chatSend=document.getElementById("chatsend"),null===(n=this.chatSend)||void 0===n||n.addEventListener("click",this.sendClicked),this.send=t}var t,n;return t=e,(n=[{key:"showMessage",value:function(e){this.chatoutput&&(this.chatoutput.innerHTML+=e),this.updateScroll()}},{key:"updateScroll",value:function(){this.chatoutput&&(this.chatoutput.scrollTop=this.chatoutput.scrollHeight)}}])&&j(t.prototype,n),e}(),N=n(9915),F=n(7009);function H(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function U(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var D=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),U(this,"lastSent",null),U(this,"period",void 0),U(this,"pending",null),U(this,"sentTime",0),U(this,"apply",(function(e){})),this.period=t,this.apply=n}var t,n;return t=e,(n=[{key:"flush",value:function(){this.pending&&(this.apply(this.pending),this.pending=null)}},{key:"send",value:function(t){try{if("AIM"===(null==t?void 0:t.type)&&this.lastSent){var n,i,r,o,s=this.lastSent,a=t,l=Math.abs((null!==(n=s.angle)&&void 0!==n?n:0)-(null!==(i=a.angle)&&void 0!==i?i:0)),c=Math.abs((null!==(r=s.power)&&void 0!==r?r:0)-(null!==(o=a.power)&&void 0!==o?o:0)),u=s.pos&&a.pos?s.pos.distanceTo?s.pos.distanceTo(a.pos):Math.hypot(s.pos.x-a.pos.x,s.pos.y-a.pos.y):999,h=s.offset&&a.offset?s.offset.distanceTo?s.offset.distanceTo(a.offset):Math.hypot(s.offset.x-a.offset.x,s.offset.y-a.offset.y):999;if(l<e.EPS.angle&&c<e.EPS.power&&u<e.EPS.pos&&h<e.EPS.offset)return void(this.pending=t)}}catch(e){}if(performance.now()>this.sentTime+this.period||t.type!==F.B.AIM)return this.flush(),this.apply(t),this.lastSent=t,void(this.sentTime=performance.now());this.pending=t}}])&&H(t.prototype,n),e}();U(D,"EPS",{angle:.0025,power:.002,pos:.15,offset:.02});var z=n(8207),q=n(3645),V=n(8192),G=n(9419);function K(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function X(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var W=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),X(this,"container",void 0),X(this,"shots",[]),X(this,"states",[]),X(this,"start",Date.now()),X(this,"breakStart",void 0),X(this,"breakStartTime",void 0),X(this,"replayUrl",void 0),X(this,"hiScoreUrl","https://scoreboard-osmane-billiards.vercel.app/hiscore.html"),this.container=t}var t,n;return t=e,n=[{key:"record",value:function(e){e.type===F.B.WATCHAIM&&"rerack"in e.json&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(G.x.fromJson({balls:e.json.balls}))),e.type===F.B.HIT&&(this.states.push(this.container.table.shortSerialise()),this.shots.push(e.tablejson.aim))}},{key:"wholeGame",value:function(){return this.state(this.states[0],this.shots,this.start,this.container.rules.score,!0)}},{key:"last",value:function(){var e=this.states.length-1;return e>0&&"RERACK"===this.shots[e].type&&e--,e}},{key:"lastShot",value:function(){var e=this.last();return this.state(this.states[e],[this.shots[e]])}},{key:"currentBreak",value:function(){if(void 0!==this.breakStart)return this.state(this.states[this.breakStart],this.shots.slice(this.breakStart),this.breakStartTime,this.container.rules.previousBreak)}},{key:"state",value:function(e,t){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,i=arguments.length>4&&void 0!==arguments[4]&&arguments[4];return{init:e,shots:t,start:arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,now:Date.now(),score:n,wholeGame:i,v:1}}},{key:"updateBreak",value:function(e){var t=this.container.rules.isPartOfBreak(e),n=this.container.rules.isEndOfGame(e),i=q.P.potCount(e);t||this.breakLink(n),this.lastShotLink(t||n,i,q.P.pots(e)),n&&this.breakLink(n),t?void 0===this.breakStart&&(this.breakStart=this.last(),this.breakStartTime=Date.now()):this.breakStart=void 0}},{key:"lastShotLink",value:function(e,t,n){var i=t>1?t-1:0,r="#000000";n.length>0&&n.forEach((function(e){r="#"+e.ballmesh.color.getHexString()}));var o="⚈".repeat(i)+(e?"⚈":"⚆"),s=JSON.stringify(this.lastShot());this.generateLink(o,s,r)}},{key:"breakLink",value:function(e){var t=this.currentBreak();if(t&&(e||t.shots.pop(),1!==t.shots.length)){var n=0===this.container.rules.currentBreak?this.container.rules.previousBreak:this.container.rules.currentBreak;t.score=n;var i="break(".concat(n,")"),r=JSON.stringify(t),o=V.A.crush(r);this.generateLink(i,o,"black"),n>=2&&this.generateHiScoreLink(o)}}},{key:"wholeGameLink",value:function(){var e=this.wholeGame(),t="frame(".concat(this.shotCount(e.shots)," shots)"),n=JSON.stringify(e),i=V.A.crush(n);this.generateLink(t,i,"black")}},{key:"shotCount",value:function(e){return e.filter((function(e){return"RERACK"!==e.type})).length}},{key:"generateLink",value:function(e,t,n){var i="".concat(this.replayUrl).concat(this.fullyEncodeURI(t)),r='<a class="pill" style="color: '.concat(n,'" target="_blank" href="').concat(i,'">').concat(e,"</a>");this.container.eventQueue.push(new N.b(null,"".concat(r)))}},{key:"generateHiScoreLink",value:function(e){var t="".concat(this.hiScoreUrl,"?ruletype=").concat(this.container.rules.rulename,"&state=").concat(this.fullyEncodeURI(e)),n='<a class="pill" target="_blank" href="'.concat(t,'">').concat("hi score 🏆","</a>");this.container.eventQueue.push(new N.b(null,"".concat(n)))}},{key:"fullyEncodeURI",value:function(e){return encodeURIComponent(e).replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\!/g,"%21").replace(/\*/g,"%2A")}}],n&&K(t.prototype,n),e}(),Y=n(7327),J=n(5556);function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Z(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){function e(t){var n=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Z(this,"container",void 0),Z(this,"redo",void 0),Z(this,"share",void 0),Z(this,"replay",void 0),Z(this,"camera",void 0),Z(this,"disabled",!0),this.container=t,this.replay=this.getElement("replay"),this.redo=this.getElement("redo"),this.share=this.getElement("share"),this.camera=this.getElement("camera"),this.camera&&(this.setMenu(!0),this.camera.onclick=function(e){n.adjustCamera()})}var t,n;return t=e,(n=[{key:"setMenu",value:function(e){this.replay.disabled=e,this.redo.disabled=e,this.share.disabled=e}},{key:"adjustCamera",value:function(){this.container.view.camera.toggleMode(),this.container.lastEventTime=performance.now()}},{key:"replayMode",value:function(e,t){var n=this;if(this.replay){this.setMenu(!1);var i=this.container.eventQueue;this.share.onclick=function(t){!function(e,t){if("object"==("undefined"==typeof process?"undefined":(n=process)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n))return t(e);var n,i=new URL(e.replaceAll("(","%28").replaceAll(")","%29").replaceAll("!","%21").replaceAll("*","%2A")).search;fetch("https://scoreboard-osmane-billiards.vercel.app/api/shorten",{method:"POST",mode:"cors",headers:{"Content-Type":"application/json"},body:JSON.stringify({input:i})}).then((function(e){return e.json()})).then((function(n){"shortUrl"in n?t(n.shortUrl):(console.log("Could not shorten url:"),console.log(n),t(e))}))}(e,(function(e){var t=function(e){var t,n,i,r={title:"Billiards",text:"Replay break",url:e};return(null===(t=(n=navigator).canShare)||void 0===t?void 0:t.call(n,r))?(navigator.share(r).then((function(){return console.log("shared successfully")})).catch((function(e){console.log("Error: "+e)})),"link shared"):(null===(i=navigator.clipboard)||void 0===i||i.writeText(e),'link copied to clipboard <a href="'.concat(e,'">').concat(e,"</a>"))}(e);i.push(new N.b(null,t))}))},this.redo.onclick=function(e){var i=new J.W(t.init,t.shots);i.retry=!0,n.interuptEventQueue(i)},this.replay.onclick=function(e){n.interuptEventQueue(t)}}}},{key:"interuptEventQueue",value:function(e){this.container.table.halt();var t=this.container.eventQueue;t.length=0,t.push(new i.T),t.push(e)}},{key:"getElement",value:function(e){return document.getElementById(e)}}])&&Q(t.prototype,n),e}();function ee(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var te=function(){function e(){var t,n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),n=void 0,(t="element")in this?Object.defineProperty(this,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):this[t]=n,this.element=this.getElement("snookerScore")}var t,n;return t=e,(n=[{key:"updateBreak",value:function(e){this.element&&(this.element.innerHTML=e>0?"Break</br>"+e:"")}},{key:"getElement",value:function(e){return document.getElementById(e)}}])&&ee(t.prototype,n),e}(),ne=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)};function ie(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function re(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var oe=function(){function e(t,n,i,r,o,s){var a=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),re(this,"table",void 0),re(this,"view",void 0),re(this,"controller",void 0),re(this,"inputQueue",[]),re(this,"eventQueue",[]),re(this,"keyboard",void 0),re(this,"sound",void 0),re(this,"chat",void 0),re(this,"sliders",void 0),re(this,"recorder",void 0),re(this,"id",""),re(this,"isSinglePlayer",!0),re(this,"rules",void 0),re(this,"menu",void 0),re(this,"hud",void 0),re(this,"lobbyIndicator",void 0),re(this,"frame",void 0),re(this,"last",performance.now()),re(this,"step",.001953125),re(this,"broadcast",(function(){})),re(this,"log",void 0),re(this,"sendChat",(function(e){a.sendEvent(new N.b(a.id,e))})),re(this,"throttle",new D(0,(function(e){a.broadcast(e)}))),re(this,"lastEventTime",performance.now()),this.log=n,this.rules=Y.V.create(r,this),this.table=this.rules.table(),this.view=new m(t,this.table,i),this.table.cue.aimInputs=new S(this),this.keyboard=o,this.sound=i.sound,this.chat=new L(this.sendChat),this.sliders=new z.r,this.recorder=new W(this),this.id=s,this.menu=new $(this),this.table.addToScene(this.view.scene),this.hud=new te,this.lobbyIndicator=new ne,this.updateController(new b.J(this))}var t,n;return t=e,n=[{key:"sendEvent",value:function(e){this.throttle.send(e)}},{key:"advance",value:function(e){var t;null===(t=this.frame)||void 0===t||t.call(this,e);for(var n=Math.floor(e/this.step),r=n*this.step,o=this.table.allStationary(),s=0;s<n;s++)this.table.advance(this.step);this.table.updateBallMesh(r),this.view.update(r,this.table.cue.aim),this.table.cue.update(r),!o&&this.table.allStationary()&&this.eventQueue.push(new i.T),this.sound.processOutcomes(this.table.outcome)}},{key:"processEvents",value:function(){var e=this;for(this.keyboard&&this.keyboard.getEvents().forEach((function(t){return e.inputQueue.push(t)}));this.inputQueue.length>0;){this.lastEventTime=this.last;var t=this.inputQueue.shift();t&&this.updateController(this.controller.handleInput(t))}if(this.table.allStationary()){var n=this.eventQueue.shift();n&&(this.lastEventTime=performance.now(),this.updateController(n.applyToController(this.controller)))}}},{key:"animate",value:function(e){var t=this;this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),(e<this.lastEventTime+12e3||!this.table.allStationary()||this.view.sizeChanged())&&this.view.render(),requestAnimationFrame((function(e){t.animate(e)}))}},{key:"updateController",value:function(e){var t;e!==this.controller&&(this.log("Transition to "+(C(t=e,b.J)?"Init":C(t,_.x)?"PlaceBall":C(t,R.m)?"Aim":C(t,E.r)?"WatchAim":C(t,O.H)?"PlayShot":C(t,A.O)?"WatchShot":C(t,M.e)?"Replay":C(t,I.o)?"End":"UNKNOWN")),this.controller=e,this.controller.onFirst())}}],n&&ie(t.prototype,n),e}()},4368:(e,t,n)=>{n.d(t,{Q:()=>c});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(e){var n,i,o,a;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),n=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t),a=void 0,(o="json")in(i=n)?Object.defineProperty(i,o,{value:a,enumerable:!0,configurable:!0,writable:!0}):i[o]=a,n.type=r.B.WATCHAIM,n.json=e,n}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){return new t(e)}}],(i=[{key:"applyToController",value:function(e){return e.handleWatch(this)}}])&&o(n.prototype,i),c&&o(n,c),t}(i.F)},4841:(e,t,n)=>{n.d(t,{z:()=>a});var i=n(12),r=n(5418);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(t,n,i,r,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"P",0),s(this,"WzI",0),s(this,"vx",void 0),s(this,"vy",void 0),s(this,"ωx",void 0),s(this,"ωy",void 0),s(this,"ωz",void 0),s(this,"s",void 0),s(this,"φ",void 0),s(this,"sʹ",void 0),s(this,"φʹ",void 0),s(this,"i",0),s(this,"N",100),s(this,"M",void 0),s(this,"R",void 0),s(this,"μs",void 0),s(this,"μw",void 0),s(this,"ee",void 0),this.M=t,this.R=n,this.ee=i,this.μs=r,this.μw=o}var t,n;return t=e,(n=[{key:"updateSlipSpeedsAndAngles",value:function(){var e=this.R,t=this.vx+this.ωy*e*r.Z3-this.ωz*e*r.o5,n=-this.vy*r.Z3+this.ωx*e,o=this.vx-this.ωy*e,s=this.vy+this.ωx*e;this.s=(0,i.RZ)((0,i.n7)(t,2)+(0,i.n7)(n,2)),this.φ=(0,i.FP)(n,t),this.φ<0&&(this.φ+=2*Math.PI),this.sʹ=(0,i.RZ)((0,i.n7)(o,2)+(0,i.n7)(s,2)),this.φʹ=(0,i.FP)(s,o),this.φʹ<0&&(this.φʹ+=2*Math.PI)}},{key:"compressionPhase",value:function(){for(var e=Math.max(this.M*this.vy/this.N,.001);this.vy>0;)this.updateSingleStep(e)}},{key:"restitutionPhase",value:function(e){var t=Math.max(e/this.N,.001);for(this.WzI=0;this.WzI<e;)this.updateSingleStep(t)}},{key:"updateSingleStep",value:function(e){if(this.updateSlipSpeedsAndAngles(),this.updateVelocity(e),this.updateAngularVelocity(e),this.updateWorkDone(e),this.i++>10*this.N)throw new Error("Solution not found")}},{key:"updateVelocity",value:function(e){var t=this.μs,n=this.μw,o=this.M;this.vx-=1/o*(n*(0,i.gn)(this.φ)+t*(0,i.gn)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e,this.vy-=1/o*(r.o5-n*r.Z3*(0,i.F8)(this.φ)+t*(0,i.F8)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e}},{key:"updateAngularVelocity",value:function(e){var t=this.μs,n=this.μw,o=this.M,s=this.R;this.ωx+=-5/(2*o*s)*(n*(0,i.F8)(this.φ)+t*(0,i.F8)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e,this.ωy+=-5/(2*o*s)*(n*(0,i.gn)(this.φ)*r.Z3-t*(0,i.gn)(this.φʹ)*(r.Z3+n*(0,i.F8)(this.φ)*r.o5))*e,this.ωz+=5/(2*o*s)*(n*(0,i.gn)(this.φ)*r.o5)*e}},{key:"updateWorkDone",value:function(e){var t=e*Math.abs(this.vy);this.WzI+=t,this.P+=e}},{key:"solvePaper",value:function(e,t,n,r){this.solve(e*(0,i.gn)(t),e*(0,i.F8)(t),-r*(0,i.F8)(t),r*(0,i.gn)(t),n)}},{key:"solve",value:function(e,t,n,i,r){this.vx=e,this.vy=t,this.ωx=n,this.ωy=i,this.ωz=r,this.WzI=0,this.P=0,this.i=0,this.compressionPhase();var o=this.ee*this.ee*this.WzI;this.restitutionPhase(o)}}])&&o(t.prototype,n),e}()},4853:(e,t,n)=>{n.d(t,{m:()=>h});var i=n(8738),r=n(5615),o=n(6940),s=n(1185);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var h=function(e){function t(e){var n;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t);var i=(n=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,u()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t,[e])).container.table;return i.cue.aimMode(),i.cue.showHelper(!0),i.cueball=n.container.rules.cueball,i.cue.moveTo(i.cueball.pos),n.container.view.camera.suggestMode(n.container.view.camera.aimView),i.cue.aimInputs.showOverlap(),n}var n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,(r=[{key:"handleInput",value:function(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.playShot();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}},{key:"handleBreak",value:function(e){return new s.e(this.container,e.init,e.shots,e.retry)}},{key:"playShot",value:function(){var e=new i.Qe(this.container.table.serialise());return this.container.sendEvent(e),this.container.recorder.record(e),new o.H(this.container)}}])&&a(n.prototype,r),t}(r.y)},4979:(e,t,n)=>{n.d(t,{v:()=>l});var i=n(4922),r=n(665),o=n(5418);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"viewPoint",value:function(t,n){var s=e.zoomFactor/(2*Math.tan(n*Math.PI/360));if(t>this.portrait){var a=t>e.aspectLimit?2.75*r.P.tableY:2.4*r.P.tableX/t;return new i.Pq0(0,-.01*o.R,s*a)}var l=t>1/e.aspectLimit?4.9*r.P.tableY:1.35*r.P.tableX/t;return new i.Pq0(-.01*o.R,0,s*l)}}],null&&s(t.prototype,null),n&&s(t,n),e}();a(l,"aspectLimit",1.78),a(l,"portrait",.95),a(l,"fov",20),a(l,"zoomFactor",1)},5159:(e,t,n)=>{n.d(t,{T:()=>c});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(e=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t)).type=r.B.STATIONARY,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,(i=[{key:"applyToController",value:function(e){return e.handleStationary(this)}}])&&o(n.prototype,i),t}(i.F)},5418:(e,t,n)=>{n.d(t,{I:()=>o,Mz:()=>i,PX:()=>_,Qg:()=>P,R:()=>k,Wv:()=>R,XF:()=>g,XM:()=>b,Ys:()=>E,Z3:()=>y,_m:()=>v,cM:()=>O,e:()=>f,ee:()=>p,g:()=>s,gT:()=>c,gf:()=>l,jG:()=>x,kL:()=>u,kM:()=>A,ki:()=>I,ko:()=>M,m:()=>h,mu:()=>a,o5:()=>m,oV:()=>d,oo:()=>w,x3:()=>r,xO:()=>S});var i,r,o,s=9.8,a=.00985,l=.16,c=.85,u=.034,h=.23,f=.86,p=.98,d=.212,v=.14,y=.4,m=Math.sqrt(21)/5,b=2.84,g=1.42,w=.03075,k=.028575;function x(e){k=e}function T(){i=a*h*s*2/3*u,r=7/(5*Math.sqrt(2))*k*a*h*s,o=.4*h*k*k}function P(e){h=e,T()}function S(e){a=e,T()}function R(e){u=e,T()}function E(e){l=e}function O(e){f=e}function A(e){c=e}function M(e){d=e}function I(e){v=e}function _(e){p=e}T()},5556:(e,t,n)=>{n.d(t,{W:()=>u});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(c=function(){return!!e})()}var u=function(e){function t(e,n){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s(i=function(e,t,n){return t=a(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,c()?Reflect.construct(t,n||[],a(e).constructor):t.apply(e,n))}(this,t),"init",void 0),s(i,"shots",void 0),s(i,"retry",void 0),i.init=e,i.shots=n,i.type=r.B.BREAK,i}var n,i,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,e),n=t,u=[{key:"fromJson",value:function(e){return new t(e.init,e.shots)}}],(i=[{key:"applyToController",value:function(e){return e.handleBreak(this)}}])&&o(n.prototype,i),u&&o(n,u),t}(i.F)},5615:(e,t,n)=>{n.d(t,{y:()=>f});var i=n(8738),r=n(128),o=n(3645),s=n(4922);function a(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(e){return e&&"undefined"!=typeof Symbol&&e.constructor===Symbol?"symbol":typeof e}function h(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(h=function(){return!!e})()}var f=function(e){function t(){var e,n,i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(i="scale")in(n=e=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!==u(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}(e,h()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t,arguments))?Object.defineProperty(n,i,{value:.001,enumerable:!0,configurable:!0,writable:!0}):n[i]=.001,e}var n,i;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,(i=[{key:"handleChat",value:function(e){var t=e.sender?"".concat(e.sender,":"):"",n="".concat(t," ").concat(e.message);return this.container.chat.showMessage(n),this}},{key:"hit",value:function(){this.container.table.outcome=[o.P.hit(this.container.table.cueball,this.container.table.cue.aim.power)],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.aimView),this.container.table.cue.showHelper(!1)}},{key:"commonKeyHandler",value:function(e){var t=this.container.table.cue,n=e.t*this.scale;switch(e.key){case"ArrowLeft":return t.rotateAim(-n,this.container.table),!0;case"ArrowRight":return t.rotateAim(n,this.container.table),!0;case"ArrowDown":return t.adjustSpin(new s.Pq0(0,-n),this.container.table),!0;case"ArrowUp":return t.adjustSpin(new s.Pq0(0,n),this.container.table),!0;case"ShiftArrowLeft":return t.adjustSpin(new s.Pq0(n,0),this.container.table),!0;case"ShiftArrowRight":return t.adjustSpin(new s.Pq0(-n,0),this.container.table),!0;case"KeyPUp":return(0,r.KP)(this.container.view.scene),!0;case"KeyHUp":return t.toggleHelper(),!0;case"movementXUp":return t.rotateAim(2*n,this.container.table),!0;case"movementYUp":case"NumpadSubtract":return this.container.view.camera.adjustHeight(8*n),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(8*-n),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;case"KeyDUp":return this.togglePanel(),!0;case"KeyFUp":return this.toggleFullscreen(),!0;default:return!1}}},{key:"togglePanel",value:function(){this.container.sliders.toggleVisibility(),this.container.table.showSpin(!0),this.container.table.showTraces(!0),"object"!==("undefined"==typeof process?"undefined":u(process))&&console.log(this.container.table.serialise())}},{key:"toggleFullscreen",value:function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen()}}])&&a(n.prototype,i),t}(i.xI)},6162:(e,t,n)=>{n.d(t,{s:()=>b});var i=n(4922),r=n(7327),o=n(128);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"wantsResume",!1),a(this,"listener",void 0),a(this,"audioLoader",void 0),a(this,"ballcollision",void 0),a(this,"cue",void 0),a(this,"cushion",void 0),a(this,"pot",void 0),a(this,"success",void 0),a(this,"lastOutcomeTime",0),a(this,"loadAssets",void 0),this.loadAssets=t,t&&(this.listener=new i.Pf$,this.audioLoader=new i.Am1,this.ballcollision=new i.fP5(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new i.fP5(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new i.fP5(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new i.fP5(this.listener),this.load("sounds/pot.ogg",this.pot),this.success=new i.fP5(this.listener),this.load("sounds/success.ogg",this.success))}var t,n;return t=e,n=[{key:"addCameraToListener",value:function(e){e.add(this.listener)}},{key:"load",value:function(e,t){this.audioLoader.load(e,(function(e){t.setBuffer(e),t.setLoop(!1)}),(function(e){}),(function(e){}))}},{key:"play",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(this.loadAssets){var r,o,s=i.UtX.getContext();if(s&&"suspended"===s.state){if(null===(o=navigator)||void 0===o||null===(r=o.userActivation)||void 0===r?void 0:r.hasBeenActive)try{s.resume()}catch(e){}else if(!this.wantsResume){this.wantsResume=!0;var a=function(){try{s.resume()}catch(e){}window.removeEventListener("pointerdown",a),window.removeEventListener("keydown",a)};window.addEventListener("pointerdown",a,{once:!0}),window.addEventListener("keydown",a,{once:!0})}}else e.setVolume(t),e.isPlaying&&e.stop(),e.play(i.cj9.randFloat(0,.01)),e.setDetune(n)}}},{key:"outcomeToSound",value:function(e){"Collision"===e.type&&this.play(this.ballcollision,e.incidentSpeed/80,5*e.incidentSpeed),"Pot"===e.type&&this.play(this.pot,e.incidentSpeed/10,10*e.incidentSpeed-1e3),"Cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/70),"Hit"===e.type&&this.play(this.cue,e.incidentSpeed/30)}},{key:"processOutcomes",value:function(e){var t=this;e.every((function(e){return!(e.timestamp>t.lastOutcomeTime&&(t.lastOutcomeTime=e.timestamp,t.outcomeToSound(e),1))}))}},{key:"playNotify",value:function(){this.play(this.pot,1)}},{key:"playSuccess",value:function(e){this.play(this.success,.1,100*e-2200)}}],n&&s(t.prototype,n),e}(),c=n(665),u=n(91),h=n(5418);function f(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function p(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var d=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),p(this,"logger",(function(e){})),p(this,"cloth",new i.tXL({color:4478393,wireframe:!1,flatShading:!0,transparent:!1})),p(this,"cushion",new i.tXL({color:5531065,wireframe:!1,flatShading:!0,transparent:!1})),p(this,"pocket",new i.tXL({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3}))}var t,n;return t=e,n=[{key:"generateTable",value:function(e){var t=this,n=new i.YJl,r=new i.HiM(15790312,22);if(r.position.set(0,0,50*h.R),n.add(r),this.addCushions(n,e),e){u.f.knuckles.forEach((function(e){return t.knuckleCylinder(e,n)})),u.f.pocketCenters.forEach((function(e){return t.knuckleCylinder(e,n,t.pocket)}));var o=u.f.pockets.pocketNW.pocket,s=u.f.pockets.pocketNW.knuckleNE;this.logger("knuckle-pocket gap = "+(o.pos.distanceTo(s.pos)-o.radius-s.radius))}return n}},{key:"knuckleCylinder",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this.cloth;this.cylinder(e.pos,e.radius,.75*h.R/.5,t,n).position.setZ(.25*-h.R/.5/2)}},{key:"cylinder",value:function(e,t,n,r,o){var s=new i.Ho_(t,t,n,16),a=new i.eaF(s,o);return a.position.copy(e),a.geometry.applyMatrix4((new i.kn4).identity().makeRotationAxis(new i.Pq0(1,0,0),Math.PI/2)),r.add(a),a}},{key:"addCushions",value:function(e,t){var n=c.P.X,r=c.P.Y,o=1.5*h.R;if(this.plane(new i.Pq0(0,0,-h.R-o/2),2*n,2*r,o,e,this.cloth),t);else{var s=1.25*h.R,a=2*h.R,l=-h.R+s/2,u=2*n+2*a,f=2*r;this.plane(new i.Pq0(0,r+a/2,l),u,a,s,e),this.plane(new i.Pq0(0,-r-a/2,l),u,a,s,e),this.plane(new i.Pq0(n+a/2,0,l),a,f,s,e),this.plane(new i.Pq0(-n-a/2,0,l),a,f,s,e)}}},{key:"plane",value:function(e,t,n,r,o){var s=arguments.length>5&&void 0!==arguments[5]?arguments[5]:this.cushion,a=new i.iNn(t,n,r),l=new i.eaF(a,s);l.receiveShadow=!0,l.position.copy(e),o.add(l)}}],n&&f(t.prototype,n),e}();p(d,"mesh",void 0);var v=n(363);function y(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function m(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var b=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),m(this,"ready",void 0),m(this,"rules",void 0),m(this,"background",void 0),m(this,"table",void 0),m(this,"sound",void 0),m(this,"cue",void 0),m(this,"ballGeometry",void 0),this.rules=r.V.create(t,null),this.rules.tableGeometry()}var t,n,s;return t=e,s=[{key:"localAssets",value:function(){var t=new e(arguments.length>0&&void 0!==arguments[0]?arguments[0]:"");return t.creatLocal(),t}}],(n=[{key:"loadFromWeb",value:function(e){var t=this;this.ready=e,this.sound=new l(!0),this.ballGeometry=new i.Gu$(1,64,32),(0,o.Ro)("models/background.gltf",(function(e){t.background=e.scene,t.done()})),(0,o.Ro)("models/cue.gltf",(function(e){t.cue=e.scene,v.l.mesh=e.scene.children&&e.scene.children[0],t.done()}));var n=this.rules.asset();n&&n.length>0?(0,o.Ro)(n,(function(e){t.table=e.scene;var n=d.mesh;if(!n){var r=Array.isArray(t.table.children)?t.table.children:[];n=r.find((function(e){var t=(e.name||"").toLowerCase();return t.includes("cloth")||t.includes("playfield")||t.includes("felt")}))}if(n||t.table.traverse((function(e){if(!n){var t=(e.name||"").toLowerCase();(t.includes("cloth")||t.includes("playfield")||t.includes("felt"))&&(n=e)}})),n||(n=t.table.children&&t.table.children[0]||void 0),!n)throw new Error("Playfield (cloth) mesh not found in GLTF.");n.updateMatrixWorld(!0);var o=(new i.NRn).setFromObject(n),s=new i.Pq0;o.getSize(s);var a=2*c.P.X,l=2*c.P.Y,u=a/(s.x||1),h=l/(s.y||1),f=a/(s.y||1),p=l/(s.x||1),v=Math.abs(u-h)>Math.abs(f-p)?Math.min(f,p):Math.min(u,h);t.table.scale.multiplyScalar(v),t.table.updateMatrixWorld(!0),o=(new i.NRn).setFromObject(n);var y=new i.Pq0;o.getCenter(y),t.table.position.x-=y.x,t.table.position.y-=y.y,d.mesh||(d.mesh=e.scene.children&&e.scene.children[0]),t.done()})):(console.log("No GLTF asset path provided. Generating table procedurally."),this.table=(new d).generateTable(c.P.hasPockets),this.done())}},{key:"creatLocal",value:function(){this.sound=new l(!1),d.mesh=(new d).generateTable(c.P.hasPockets),this.table=d.mesh,this.ballGeometry=new i.Gu$(1,64,32)}},{key:"done",value:function(){this.background&&this.table&&this.cue&&this.ready&&this.ready()}}])&&y(t.prototype,n),s&&y(t,s),e}()},6940:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e){return r=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},r(e)}function o(e,t){return o=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},o(e,t)}function s(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(s=function(){return!!e})()}n.d(t,{H:()=>a});var a=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=r(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,s()?Reflect.construct(t,n||[],r(e).constructor):t.apply(e,n))}(this,t,[e])).hit(),n}var n,a;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&o(e,t)}(t,e),n=t,(a=[{key:"handleStationary",value:function(e){var t=this.container.table,n=t.outcome,i=this.container.rules.update(n);return this.container.recorder.updateBreak(n),t.cue.aimAtNext(t.cueball,this.container.rules.nextCandidateBall()),i}},{key:"handleInput",value:function(e){return this.commonKeyHandler(e),this}}])&&i(n.prototype,a),t}(n(5615).y)},7009:(e,t,n)=>{n.d(t,{B:()=>i});var i=function(e){return e.BEGIN="BEGIN",e.BREAK="BREAK",e.WATCHAIM="WATCHAIM",e.AIM="AIM",e.HIT="HIT",e.STATIONARY="STATIONARY",e.CHAT="CHAT",e.ABORT="ABORT",e.PLACEBALL="PLACEBALL",e.REJOIN="REJOIN",e.RERACK="RERACK",e.STARTAIM="STARTAIM",e}({})},7236:(e,t,n)=>{function i(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{N:()=>o});var o=function(){function e(t,n,i,o){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),r(this,"clientId",void 0),r(this,"username",void 0),r(this,"tableId",void 0),r(this,"spectator",void 0),this.clientId=t,this.username=n,this.tableId=i,this.spectator=o}var t,n;return t=e,n=[{key:"getInstance",value:function(){if(!e.instance)throw new Error("Session not initialized");return e.instance}},{key:"isSpectator",value:function(){return void 0!==e.instance&&e.getInstance().spectator}},{key:"reset",value:function(){e.instance=void 0}},{key:"init",value:function(t,n,i,r){e.instance=new e(t,n,i,r)}}],null&&i(t.prototype,null),n&&i(t,n),e}();r(o,"instance",void 0)},7327:(e,t,n)=>{n.d(t,{V:()=>te});var i=n(4368),r=n(2651),o=n(665),s=n(4922),a=n(12),l=n(5418);function c(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function u(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var h=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"jitter",value:function(t){return(0,a.ld)(t.clone().add(new s.Pq0(e.noise*(Math.random()-.5),e.noise*(Math.random()-.5),0)))}},{key:"cueBall",value:function(t){return new r.c(e.jitter(t),16444375)}},{key:"diamond",value:function(){var t=new s.Pq0(o.P.tableX/2,0,0),n=[];return n.push(e.cueBall(e.spot)),n.push(new r.c(e.jitter(t),14736950)),t.add(e.diagonal),n.push(new r.c(e.jitter(t),16751872)),t.sub(e.across),n.push(new r.c(e.jitter(t),5380369)),t.add(e.diagonal),n.push(new r.c(e.jitter(t),5853696)),t.sub(e.across),n.push(new r.c(e.jitter(t),16711680)),t.addScaledVector(e.across,2),n.push(new r.c(e.jitter(t),328965)),t.add(e.diagonal).sub(e.across),n.push(new r.c(e.jitter(t),685250)),t.sub(e.across),n.push(new r.c(e.jitter(t),553728)),t.add(e.diagonal),n.push(new r.c(e.jitter(t),4063388)),n}},{key:"triangle",value:function(){var t=e.trianglePositions(),n=e.cueBall(e.spot),i=t.map((function(t){return new r.c(e.jitter(t))}));return i.unshift(n),i.slice(0,5)}},{key:"trianglePositions",value:function(){var e=[],t=new s.Pq0(o.P.X/2,0,0);return e.push((0,a.t6)(t)),t.add(this.diagonal),e.push((0,a.t6)(t)),t.sub(this.across),e.push((0,a.t6)(t)),t.add(this.diagonal),e.push((0,a.t6)(t)),t.sub(this.across),e.push((0,a.t6)(t)),t.addScaledVector(this.across,2),e.push((0,a.t6)(t)),t.add(this.diagonal),e.push((0,a.t6)(t)),t.sub(this.across),e.push((0,a.t6)(t)),t.sub(this.across),e.push((0,a.t6)(t)),t.sub(this.across),e.push((0,a.t6)(t)),t.add(this.diagonal).sub(this.across),e.push((0,a.t6)(t)),t.add(this.across),e.push((0,a.t6)(t)),t.add(this.across),e.push((0,a.t6)(t)),t.add(this.across),e.push((0,a.t6)(t)),t.add(this.across),e.push((0,a.t6)(t)),e}},{key:"rerack",value:function(t,n){var i=e.trianglePositions(),o=i.shift();n.balls.filter((function(e){return e!==n.cueball})).filter((function(e){return e!==t})).forEach((function(t){t.pos.copy(e.jitter(i.shift())),t.state=r.U.Stationary})),n.overlapsAny(t.pos,t)&&t.pos.copy(o),n.overlapsAny(n.cueball.pos)&&n.cueball.pos.copy(e.spot)}},{key:"three",value:function(){var t=[],n=o.P.X/2,i=o.P.Y/4;return t.push(e.cueBall(e.jitter(new s.Pq0(-n,-i,0)))),t.push(new r.c(e.jitter(new s.Pq0(-n,0,0)),14736950)),t.push(new r.c(e.jitter(new s.Pq0(n,0,0)),16711680)),t}},{key:"snooker",value:function(){var t=[],n=o.P.Y/4;t.push(e.cueBall(e.jitter(new s.Pq0(e.baulk,.5*-n,0))));var i=e.snookerColourPositions();return t.push(new r.c(e.jitter(i[0]),15654454)),t.push(new r.c(e.jitter(i[1]),824932)),t.push(new r.c(e.jitter(i[2]),12415546)),t.push(new r.c(e.jitter(i[3]),558062)),t.push(new r.c(e.jitter(i[4]),16755404)),t.push(new r.c(e.jitter(i[5]),65793)),e.trianglePositions().slice(0,15).forEach((function(n){t.push(new r.c(e.jitter(n.add(e.down)),15597568))})),t}},{key:"snookerColourPositions",value:function(){var t=o.P.X/2,n=o.P.X-2*o.P.X/11,i=[];return i.push(new s.Pq0(e.baulk,-e.sixth,0)),i.push(new s.Pq0(e.baulk,e.sixth,0)),i.push(new s.Pq0(e.baulk,0,0)),i.push(new s.Pq0(0,0,0)),i.push(new s.Pq0(t,0,0)),i.push(new s.Pq0(n,0,0)),i}}],null&&c(t.prototype,null),n&&c(t,n),e}();u(h,"noise",.0233*l.R),u(h,"gap",2*l.R+2*h.noise),u(h,"up",new s.Pq0(0,0,-1)),u(h,"spot",new s.Pq0(-o.P.X/2,0,0)),u(h,"across",new s.Pq0(0,h.gap,0)),u(h,"down",new s.Pq0(h.gap,0,0)),u(h,"diagonal",h.across.clone().applyAxisAngle(h.up,1*Math.PI/3)),u(h,"sixth",2*o.P.Y/6),u(h,"baulk",-1.5*o.P.X*2/5);var f=n(4853),p=n(4110),d=n(8938),v=n(9915),y=n(7387),m=n(3645),b=n(8090),g=n(91);function w(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var k=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"bounceAny",value:function(t,n){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:b.$8,s=t.futurePosition(n);if(e.willBounceLong(s,i)){var a=s.y>o.P.tableY?-Math.PI/2:Math.PI/2;return e.bounceIn(a,t,r)}if(e.willBounceShort(s,i)){var l=s.x>o.P.tableX?0:Math.PI;return e.bounceIn(l,t,r)}}},{key:"willBounceShort",value:function(t,n){return n?e.willBounceShortSegment(g.f.pockets.pocketNW.knuckleSW.pos.y,g.f.pockets.pocketSW.knuckleNW.pos.y,t):e.willBounceShortSegment(o.P.Y,-o.P.Y,t)}},{key:"willBounceLong",value:function(t,n){return n?e.willBounceLongSegment(g.f.pockets.pocketNW.knuckleNE.pos.x,g.f.pockets.pocketN.knuckleNW.pos.x,t)||e.willBounceLongSegment(g.f.pockets.pocketN.knuckleNE.pos.x,g.f.pockets.pocketNE.knuckleNW.pos.x,t):e.willBounceLongSegment(-o.P.X,o.P.X,t)}},{key:"willBounceLongSegment",value:function(e,t,n){return n.x>e&&n.x<t&&Math.abs(n.y)>o.P.tableY}},{key:"willBounceShortSegment",value:function(e,t,n){return n.y>t&&n.y<e&&Math.abs(n.x)>o.P.tableX}},{key:"bounceIn",value:function(e,t,n){t.ballmesh.trace.forceTrace(t.futurePos);var i=(0,b.QK)(e,t.vel,t.rvel,n);return t.vel.add(i.v),t.rvel.add(i.w),i.v.length()}}],null&&w(t.prototype,null),n&&w(t,n),e}(),x=n(3894),T=n(3982),P=n(8385),S=n(8086),R=n(2522);function E(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function O(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var A=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),O(this,"balls",void 0),O(this,"cue",new S.s),O(this,"pairs",void 0),O(this,"outcome",[]),O(this,"cueball",void 0),O(this,"cushionModel",b.$8),O(this,"mesh",void 0),this.cueball=t[0],this.initialiseBalls(t)}var t,n,i;return t=e,n=[{key:"initialiseBalls",value:function(e){this.balls=e,this.pairs=[];for(var t=0;t<e.length;t++)for(var n=0;n<e.length;n++)t<n&&this.pairs.push({a:e[t],b:e[n]})}},{key:"updateBallMesh",value:function(e){this.balls.forEach((function(t){t.updateMesh(e)}))}},{key:"advance",value:function(e){for(var t=1/180,n=Math.min(Math.max(e,0),.25);n>0;){var i=n>t?t:n;this._advanceStep(i),n-=i}}},{key:"_advanceStep",value:function(e){for(var t=0;!this.prepareAdvanceAll(e);)if(t++>100)throw new Error("Depth exceeded resolving collisions");this.balls.forEach((function(t){t.update(e),t.fround()}))}},{key:"prepareAdvanceAll",value:function(e){var t=this;return this.pairs.every((function(n){return t.prepareAdvancePair(n.a,n.b,e)}))&&this.balls.every((function(n){return t.prepareAdvanceToCushions(n,e)}))}},{key:"prepareAdvancePair",value:function(e,t,n){if(x.F.willCollide(e,t,n)){var i=x.F.collide(e,t);return this.outcome.push(m.P.collision(e,t,i)),!1}return!0}},{key:"prepareAdvanceToCushions",value:function(e,t){if(!e.onTable())return!0;var n=e.futurePosition(t);if(Math.abs(n.y)<o.P.tableY&&Math.abs(n.x)<o.P.tableX)return!0;var i=k.bounceAny(e,t,o.P.hasPockets,this.cushionModel);if(i)return this.outcome.push(m.P.cushion(e,i)),!1;var r=T.O.findBouncing(e,t);if(r){var s=r.bounce(e);return this.outcome.push(m.P.cushion(e,s)),!1}var a=P.Z.findPocket(g.f.pocketCenters,e,t);if(a){var l=a.fall(e,t);return this.outcome.push(m.P.pot(e,l)),!1}return!0}},{key:"allStationary",value:function(){return this.balls.every((function(e){return!e.inMotion()}))}},{key:"inPockets",value:function(){return this.balls.reduce((function(e,t){return t.onTable()?e:e+1}),0)}},{key:"hit",value:function(){this.cue.hit(this.cueball),this.balls.forEach((function(e){e.ballmesh.trace.reset()}))}},{key:"serialise",value:function(){return{balls:this.balls.map((function(e){return e.serialise()})),aim:this.cue.aim.copy()}}},{key:"updateFromSerialised",value:function(e){var t=this;e.balls&&e.balls.forEach((function(e){return r.c.updateFromSerialised(t.balls[e.id],e)})),e.aim&&(this.cue.aim=R.w.fromJson(e.aim))}},{key:"shortSerialise",value:function(){return this.balls.map((function(e){return[e.pos.x,e.pos.y]})).reduce((function(e,t){return e.concat(t)}),[])}},{key:"updateFromShortSerialised",value:function(e){this.balls.forEach((function(t,n){t.pos.x=e[2*n],t.pos.y=e[2*n+1],t.pos.z=0,t.vel.copy(a.v_),t.rvel.copy(a.v_),t.state=r.U.Stationary}))}},{key:"addToScene",value:function(e){this.balls.forEach((function(t){t.ballmesh.addToScene(e)})),e.add(this.cue.mesh),e.add(this.cue.helperMesh),e.add(this.cue.placerMesh)}},{key:"showTraces",value:function(e){this.balls.forEach((function(t){t.ballmesh.trace.line.visible=e,t.ballmesh.trace.reset()}))}},{key:"showSpin",value:function(e){this.balls.forEach((function(t){t.ballmesh.spinAxisArrow.visible=e}))}},{key:"halt",value:function(){this.balls.forEach((function(e){e.vel.copy(a.v_),e.rvel.copy(a.v_),e.state=r.U.Stationary}))}},{key:"roundCueBallPosition",value:function(){var e=this.cueball.pos.clone();this.overlapsAny(e)||this.cueball.pos.copy(e)}},{key:"overlapsAny",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.cueball;return this.balls.filter((function(e){return e!==t})).some((function(t){return t.pos.distanceTo(e)<2*l.R}))}}],i=[{key:"fromSerialised",value:function(t){var n=new e(t.balls.map((function(e){return r.c.fromSerialised(e)})));return n.updateFromSerialised(t),n}}],n&&E(t.prototype,n),i&&E(t,i),e}(),M=n(4005);function I(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var _=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"respot",value:function(t,n){var i=h.snookerColourPositions();return i.push(i[t.id-1]),i.reverse(),i.some((function(e){return!n.overlapsAny(e,t)&&(t.pos.copy(e),t.state=r.U.Stationary,!0)}))||e.respotBehind(i[0],t,n),t}},{key:"respotBehind",value:function(e,t,n){for(var i=e.clone();i.x<o.P.tableX&&n.overlapsAny(i,t);)i.x+=l.R/8;for(;i.x>-o.P.tableX&&n.overlapsAny(i,t);)i.x-=l.R/8;t.pos.copy(i),t.state=r.U.Stationary}},{key:"closest",value:function(e,t){var n=t.filter((function(e){return e.onTable()})).filter((function(t){return t!==e}));if(0!==n.length){var i=function(t){return e.pos.distanceTo(t.pos)};return n.reduce((function(e,t){return i(e)<i(t)?e:t}),n[0])}}}],null&&I(t.prototype,null),n&&I(t,n),e}(),C=n(2582);function j(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function B(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var L=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),B(this,"container",void 0),B(this,"cueball",void 0),B(this,"currentBreak",0),B(this,"previousBreak",0),B(this,"score",0),B(this,"rulename","nineball"),this.container=t}var t,n;return t=e,(n=[{key:"startTurn",value:function(){this.previousBreak=this.currentBreak,this.currentBreak=0}},{key:"nextCandidateBall",value:function(){return _.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){if(e){var t=new s.Pq0(-o.P.X/2,o.P.tableY),n=new s.Pq0(-o.P.tableX,-o.P.tableY);return e.clamp(n,t)}return new s.Pq0(11*-l.R/.5,0,0)}},{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"tableGeometry",value:function(){o.P.hasPockets=!0}},{key:"table",value:function(){var e=new A(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return h.diamond()}},{key:"update",value:function(e){var t=this.container.table;if(m.P.isCueBallPotted(t.cueball,e))return this.startTurn(),this.container.isSinglePlayer?new p.x(this.container):(this.container.sendEvent(new y.z(a.v_,!0)),new d.r(this.container));if(m.P.isBallPottedNoFoul(t.cueball,e)){var n=m.P.potCount(e);return this.currentBreak+=n,this.score+=n,this.container.sound.playSuccess(t.inPockets()),this.isEndOfGame(e)?(this.container.eventQueue.push(new v.b(null,"game over")),this.container.recorder.wholeGameLink(),new M.o(this.container)):(this.container.sendEvent(new i.Q(t.serialise())),new f.m(this.container))}return this.container.sendEvent(new C.M),this.container.isSinglePlayer?(this.container.sendEvent(new i.Q(t.serialise())),this.startTurn(),new f.m(this.container)):new d.r(this.container)}},{key:"isPartOfBreak",value:function(e){return m.P.isBallPottedNoFoul(this.container.table.cueball,e)}},{key:"isEndOfGame",value:function(e){var t=this.container.table.balls.filter((function(e){return e.onTable()}));return 1===t.length&&t[0]===this.cueball}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"allowsPlaceBall",value:function(){return!0}}])&&j(t.prototype,n),e}();function N(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function F(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function H(e,t,n){return H="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function(e,t,n){var i=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=U(e)););return e}(e,t);if(i){var r=Object.getOwnPropertyDescriptor(i,t);return r.get?r.get.call(n||e):r.value}},H(e,t,n||e)}function U(e){return U=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},U(e)}function D(e,t){return D=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},D(e,t)}function z(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(z=function(){return!!e})()}var q=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=U(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,z()?Reflect.construct(t,n||[],U(e).constructor):t.apply(e,n))}(this,t,[e])).rulename="fourteenone",n}var n,r;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&D(e,t)}(t,e),n=t,r=[{key:"asset",value:function(){return"models/p8.min.gltf"}},{key:"rack",value:function(){return h.triangle()}},{key:"update",value:function(e){var n=this.container.table;return this.checkRerack(n),H(U(t.prototype),"update",this).call(this,e)}},{key:"checkRerack",value:function(e){var t,n,r=e.balls.filter((function(e){return e.onTable()})).filter((function(t){return t!==e.cueball}));if(1===r.length){h.rerack(r[0],e),this.container.sound.playSuccess(e.inPockets());var o=e.serialise(),s=new i.Q((t=function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{},i=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(i=i.concat(Object.getOwnPropertySymbols(n).filter((function(e){return Object.getOwnPropertyDescriptor(n,e).enumerable})))),i.forEach((function(t){F(e,t,n[t])}))}return e}({},o),n=null!=(n={rerack:!0})?n:{},Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):function(e){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t.push.apply(t,n)}return t}(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))})),t));this.container.sendEvent(s),this.container.recorder.record(s),this.container.recorder.wholeGameLink()}}}],r&&N(n.prototype,r),t}(L);function V(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var G=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"shotInfo",value:function(t,n,i){var r=m.P.firstCollision(n);return{pots:m.P.potCount(n),firstCollision:r,legalFirstCollision:e.isLegalFirstCollision(t,i,r),whitePotted:m.P.isCueBallPotted(t.cueball,n)}}},{key:"isLegalFirstCollision",value:function(t,n,i){if(!i)return!1;var r=i.ballB.id;return n?r>=7:!(e.coloursOnTable(t).filter((function(e){return e.id<r})).length>0)}},{key:"respotAllPottedColours",value:function(e,t){return m.P.pots(t).filter((function(e){return e.id<7})).filter((function(e){return 0!==e.id})).map((function(t){return _.respot(t,e)}))}},{key:"redsOnTable",value:function(e){return e.balls.slice(7).filter((function(e){return e.onTable()}))}},{key:"coloursOnTable",value:function(e){return e.balls.slice(1,7).filter((function(e){return e.onTable()}))}}],null&&V(t.prototype,null),n&&V(t,n),e}();function K(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function X(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function W(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var Y=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),W(this,"cueball",void 0),W(this,"previousPotRed",!1),W(this,"targetIsRed",!0),W(this,"currentBreak",0),W(this,"previousBreak",0),W(this,"foulPoints",0),W(this,"score",0),W(this,"rulename","snooker"),W(this,"container",void 0),this.container=t}var t,n;return t=e,(n=[{key:"snookerrule",value:function(e){this.foulPoints=0;var t=G.shotInfo(this.container.table,e,this.targetIsRed);if(0===t.pots){if(!t.legalFirstCollision){var n,i,r,o=null!==(r=null===(i=t.firstCollision)||void 0===i||null===(n=i.ballB)||void 0===n?void 0:n.id)&&void 0!==r?r:0;this.foulPoints=Math.max(4,o+1)}return this.currentBreak,this.targetIsRed=G.redsOnTable(this.container.table).length>0,this.switchPlayer()}return this.targetIsRed?this.targetRedRule(e,t):this.targetColourRule(e,t)}},{key:"targetRedRule",value:function(e,t){return console.log("applying target red rule"),t.legalFirstCollision&&m.P.onlyRedsPotted(e)?(this.currentBreak+=t.pots,this.targetIsRed=!1,this.previousPotRed=!0,this.container.hud.updateBreak(this.currentBreak),this.continueBreak()):(this.foulPoints=this.foulCalculation(e,t),this.respot(e),t.whitePotted?this.whiteInHand():this.switchPlayer())}},{key:"targetColourRule",value:function(e,t){if(console.log("applying target colour rule"),t.whitePotted)return this.respot(e),this.whiteInHand();if(t.pots>1)return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer();if(m.P.pots(e)[0].id>6)return this.foulPoints=this.foulCalculation(e,t),this.switchPlayer();this.targetIsRed=G.redsOnTable(this.container.table).length>0;var n=m.P.pots(e)[0].id;return n!==t.firstCollision.ballB.id?this.foul(e,t):this.previousPotRed?(this.respot(e),this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak()):G.coloursOnTable(this.container.table).filter((function(e){return e.id<n})).length>0?this.foul(e,t):(this.currentBreak+=n+1,this.previousPotRed=!1,this.continueBreak())}},{key:"foul",value:function(e,t){return this.foulPoints=this.foulCalculation(e,t),this.respot(e),this.switchPlayer()}},{key:"foulCalculation",value:function(e,t){var n,i,r,o,s,a=m.P.pots(e).map((function(e){return e.id})).filter((function(e){return e<7})),l=null!==(o=null===(r=t.firstCollision)||void 0===r||null===(i=r.ballB)||void 0===i?void 0:i.id)&&void 0!==o?o:0;return l>6&&(l=0),(n=Math).max.apply(n,[3,l].concat(function(e){if(Array.isArray(e))return K(e)}(s=a)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(s)||function(e,t){if(e){if("string"==typeof e)return K(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?K(e,t):void 0}}(s)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()))+1}},{key:"tableGeometry",value:function(){o.P.hasPockets=!0}},{key:"table",value:function(){var e=new A(this.rack());return this.cueball=e.cueball,e}},{key:"otherPlayersCueBall",value:function(){return this.cueball}},{key:"secondToPlay",value:function(){}},{key:"isPartOfBreak",value:function(e){return this.currentBreak>0}},{key:"isEndOfGame",value:function(e){return m.P.isClearTable(this.container.table)&&this.currentBreak>0}},{key:"allowsPlaceBall",value:function(){return!0}},{key:"asset",value:function(){return e.tablemodel}},{key:"startTurn",value:function(){this.previousPotRed=!1,this.targetIsRed=G.redsOnTable(this.container.table).length>0,this.previousBreak=this.currentBreak,this.score+=this.currentBreak,this.currentBreak=0,this.container.hud.updateBreak(this.currentBreak)}},{key:"rack",value:function(){return h.snooker()}},{key:"nextCandidateBall",value:function(){var e=this.container.table,t=G.redsOnTable(e),n=G.coloursOnTable(e);return this.previousPotRed?_.closest(e.cueball,n):t.length>0?_.closest(e.cueball,t):n.length>0?n[0]:void 0}},{key:"placeBall",value:function(e){if(e){var t=new s.Pq0(h.baulk,0,0),n=h.sixth,i=e.distanceTo(t);if(e.x>=h.baulk&&(e.x=h.baulk),i>n){var r=e.clone().sub(t).normalize();return t.add(r.multiplyScalar(n))}return e}return new s.Pq0(h.baulk,-h.sixth/2.6,0)}},{key:"switchPlayer",value:function(){this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),console.log("end of break, switch player");var e=this.container.table;return console.log(e.cue.aim),this.container.sendEvent(new C.M(this.foulPoints)),this.container.isSinglePlayer?(this.container.sendEvent(new i.Q(e.serialise())),this.startTurn(),new f.m(this.container)):new d.r(this.container)}},{key:"continueBreak",value:function(){this.container.hud.updateBreak(this.currentBreak);var e=this.container.table;return this.container.sound.playSuccess(e.inPockets()),m.P.isClearTable(e)?(this.container.eventQueue.push(new v.b(null,"game over")),this.container.recorder.wholeGameLink(),new M.o(this.container)):(this.container.sendEvent(new i.Q(e.serialise())),new f.m(this.container))}},{key:"whiteInHand",value:function(){return this.foulPoints>0&&console.log("foul, ".concat(this.foulPoints," to opponent")),this.startTurn(),this.container.isSinglePlayer?new p.x(this.container):(this.container.sendEvent(new y.z(a.v_,!0)),new d.r(this.container))}},{key:"update",value:function(e){return this.snookerrule(e)}},{key:"respot",value:function(e){var t=G.respotAllPottedColours(this.container.table,e);if(t.length>0){var n={balls:t.map((function(e){return e.serialise()})),rerack:!0},r=new i.Q(n);this.container.sendEvent(r),this.container.recorder.record(r)}}}])&&X(t.prototype,n),e}();W(Y,"tablemodel","models/d-snooker.min.gltf");var J=n(4979);function Q(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Z(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var $=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),Z(this,"container",void 0),Z(this,"cueball",void 0),Z(this,"currentBreak",0),Z(this,"previousBreak",0),Z(this,"score",0),Z(this,"rulename","threecushion"),this.container=t}var t,n;return t=e,(n=[{key:"startTurn",value:function(){}},{key:"nextCandidateBall",value:function(){return _.closest(this.container.table.cueball,this.container.table.balls)}},{key:"placeBall",value:function(e){return a.v_}},{key:"secondToPlay",value:function(){this.cueball=this.container.table.balls[1]}},{key:"tableGeometry",value:function(){(0,l.jG)(l.oo),o.P.setCaromDimensions(l.XM,l.XF,l.oo),J.v.zoomFactor=.92}},{key:"asset",value:function(){return""}},{key:"table",value:function(){this.tableGeometry(),J.v.zoomFactor=.92;var e=new A(this.rack());return this.cueball=e.cueball,e}},{key:"rack",value:function(){return h.three()}},{key:"update",value:function(e){return m.P.isThreeCushionPoint(this.cueball,e)?(this.container.sound.playSuccess(e.length/3),this.container.sendEvent(new i.Q(this.container.table.serialise())),this.currentBreak++,this.score++,new f.m(this.container)):(this.previousBreak=this.currentBreak,this.currentBreak=0,this.container.isSinglePlayer?(this.cueball=this.otherPlayersCueBall(),this.container.table.cue.aim.i=this.container.table.balls.indexOf(this.cueball),new f.m(this.container)):(this.container.sendEvent(new C.M),new d.r(this.container)))}},{key:"otherPlayersCueBall",value:function(){var e=this.container.table.balls;return this.cueball===e[0]?e[1]:e[0]}},{key:"isPartOfBreak",value:function(e){return m.P.isThreeCushionPoint(this.cueball,e)}},{key:"isEndOfGame",value:function(e){return!1}},{key:"allowsPlaceBall",value:function(){return!1}}])&&Q(t.prototype,n),e}();function ee(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var te=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e)}var t,n;return t=e,n=[{key:"create",value:function(e,t){switch(e){case"threecushion":return new $(t);case"fourteenone":return new q(t);case"snooker":return new Y(t);default:return new L(t)}}}],null&&ee(t.prototype,null),n&&ee(t,n),e}()},7387:(e,t,n)=>{n.d(t,{z:()=>h});var i=n(8279),r=n(7009),o=n(12);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function l(e){return l=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},l(e)}function c(e,t){return c=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},c(e,t)}function u(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(u=function(){return!!e})()}var h=function(e){function t(e,n){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),a(i=function(e,t,n){return t=l(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,u()?Reflect.construct(t,n||[],l(e).constructor):t.apply(e,n))}(this,t),"pos",void 0),a(i,"allTable",void 0),i.pos=e,i.allTable=n,i.type=r.B.PLACEBALL,i}var n,i,h;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&c(e,t)}(t,e),n=t,h=[{key:"fromJson",value:function(e){return new t((0,o.t6)(e.pos),e.allTable)}}],(i=[{key:"applyToController",value:function(e){return e.handlePlaceBall(this)}}])&&s(n.prototype,i),h&&s(n,h),t}(i.F)},8086:(e,t,n)=>{n.d(t,{s:()=>p});var i=n(665),r=n(12),o=n(2522),s=n(2651),a=n(8090),l=n(363),c=n(4922),u=n(5418);function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var p=function(){function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),f(this,"mesh",void 0),f(this,"helperMesh",void 0),f(this,"placerMesh",void 0),f(this,"offCenterLimit",.3),f(this,"maxPower",160*u.R),f(this,"t",0),f(this,"aimInputs",void 0),f(this,"aim",new o.w),f(this,"length",1*i.P.tableX),this.mesh=l.l.createCue(.05*u.R/.5,.15*u.R/.5,this.length),this.helperMesh=l.l.createHelper(),this.placerMesh=l.l.createPlacer()}var t,n;return t=e,(n=[{key:"rotateAim",value:function(e,t){this.aim.angle=this.aim.angle+e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle,this.aimInputs.showOverlap(),this.avoidCueTouchingOtherBall(t)}},{key:"adjustPower",value:function(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e),this.updateAimInput()}},{key:"setPower",value:function(e){this.aim.power=e*this.maxPower}},{key:"hit",value:function(e){var t=this.aim;this.t=0,e.state=s.U.Sliding,e.vel.copy((0,r.Dz)(t.angle).multiplyScalar(t.power)),e.rvel.copy((0,a.t6)(t.offset,e.vel))}},{key:"aimAtNext",value:function(e,t){if(t){var n=(0,r.xb)(t.pos.clone().sub(e.pos));this.aim.angle=(0,r.FP)(n.y,n.x)}}},{key:"adjustSpin",value:function(e,t){var n=this.aim.offset.clone().clone().add(e);this.setSpin(n,t)}},{key:"setSpin",value:function(e,t){e.length()>this.offCenterLimit&&e.normalize().multiplyScalar(this.offCenterLimit),this.aim.offset.copy(e),this.avoidCueTouchingOtherBall(t),this.updateAimInput()}},{key:"avoidCueTouchingOtherBall",value:function(e){for(var t=0;t++<20&&this.intersectsAnything(e);)this.aim.offset.y+=.1,this.aim.offset.length()>this.offCenterLimit&&this.aim.offset.normalize().multiplyScalar(this.offCenterLimit);t>1&&this.updateAimInput()}},{key:"updateAimInput",value:function(){var e,t,n;null===(e=this.aimInputs)||void 0===e||e.updateVisualState(this.aim.offset.x,this.aim.offset.y),null===(t=this.aimInputs)||void 0===t||t.updatePowerSlider(this.aim.power/this.maxPower),null===(n=this.aimInputs)||void 0===n||n.showOverlap()}},{key:"moveTo",value:function(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle;var t=this.spinOffset(),n=2*((0,r.F8)(this.t+Math.PI/2)-1)*u.R*(this.aim.power/this.maxPower),i=(0,r.Dz)(this.aim.angle).clone().multiplyScalar(n);this.mesh.position.copy(e.clone().add(t).add(i)),this.helperMesh.position.copy(e),this.placerMesh.position.copy(e),this.placerMesh.rotation.z=this.t}},{key:"update",value:function(e){this.t+=e,this.moveTo(this.aim.pos)}},{key:"placeBallMode",value:function(){this.mesh.visible=!1,this.placerMesh.visible=!0,this.aim.angle=0}},{key:"aimMode",value:function(){this.mesh.visible=!0,this.placerMesh.visible=!1}},{key:"spinOffset",value:function(){return(0,r.KM)((0,r.Dz)(this.aim.angle)).multiplyScalar(2*this.aim.offset.x*u.R).setZ(2*this.aim.offset.y*u.R)}},{key:"intersectsAnything",value:function(e){var t=this.spinOffset(),n=e.cueball.pos.clone().add(t),i=(0,r.xb)((0,r.Dz)(this.aim.angle+Math.PI).setZ(.1)),o=new c.tBo(n,i),s=e.balls.map((function(e){return e.ballmesh.mesh}));return e.mesh&&s.push(e.mesh),o.intersectObjects(s,!0).length>0}},{key:"showHelper",value:function(e){this.helperMesh.visible=e}},{key:"toggleHelper",value:function(){this.showHelper(!this.helperMesh.visible)}}])&&h(t.prototype,n),e}()},8090:(e,t,n)=>{n.d(t,{$8:()=>A,Gp:()=>T,JD:()=>h,Mq:()=>l,QK:()=>v,QV:()=>O,Qy:()=>_,Un:()=>x,c0:()=>k,lx:()=>f,p2:()=>u,s0:()=>w,t6:()=>C,yO:()=>P});var i=n(4922),r=n(12),o=n(5418),s=n(4841),a=new i.Pq0;function l(e,t){return a.copy(e).addScaledVector((0,r.KM)(t),o.R)}var c={v:new i.Pq0,w:new i.Pq0};function u(e,t){var n=function(e,t){return l(e,t).setZ(0)}(e,t);return c.v.copy((0,r.xb)(n).multiplyScalar(-o.gf*o.g)),c.w.copy((0,r.xb)((0,r.KM)(n)).multiplyScalar(2.5*o.gf*o.g/o.R)),c.w.setZ(o.Mz/(o.m*o.R*o.R)*-2.5*Math.sign(t.z)),c}function h(e){var t=new i.Pq0(e.x,e.y,0).length(),n=5/7*o.x3/(o.m*o.R)/t,r=5/7*o.x3/(o.m*o.R*o.R)/t;return c.v.set(-n*e.y,n*e.x,0),c.w.set(-r*e.x,-r*e.y,o.Mz/(o.m*o.R*o.R)*-2.5*Math.sign(e.z)),c}function f(e,t){var n=t.z;t.copy((0,r.KM)(e).multiplyScalar(1/o.R)),t.setZ(n)}Object.freeze(c);var p=new i.Pq0,d=new i.Pq0;function v(e,t,n,i){var o=i(p.copy(t).applyAxisAngle(r.up,e),d.copy(n).applyAxisAngle(r.up,e));return o.v.applyAxisAngle(r.up,-e),o.w.applyAxisAngle(r.up,-e),o}var y=.1*o.R,m=Math.asin(y/o.R),b=(0,r.F8)(m),g=(0,r.gn)(m);function w(e,t){return new i.Pq0(e.x*b-e.z*g+o.R*t.y,-e.y-o.R*t.z*g+o.R*t.x*b)}function k(e){return e.x*g}function x(e){var t=3.5/o.m;return e.length()/t}function T(e){var t,n=1/o.m,r=.39+.257*(t=new i.Pq0(e/g,0,0)).x-.044*t.x*t.x;return o.gT*((1+r)*e)/n}function P(e,t){var n=T(k(e));return x(w(e,t))<=n}function S(e,t){return{c:k(e),s:w(e,t),A:3.5/o.m,B:1/o.m}}function R(e,t){var n=S(e,t),i=n.c,r=n.s,s=n.A,a=n.B,l=(1+o.e)*(i/a);return M(-r.x/s*b-l*g,r.y/s,r.x/s*g-l*b)}function E(e,t){var n=S(e,t),i=n.c,r=n.B,s=(1+o.e)*(i/r),a=function(e){return.471-.241*Math.atan2(Math.abs(e.y),e.x)}(e),l=Math.atan2(e.y,e.x),c=Math.cos(l),u=Math.sin(l);return M(-a*s*c*g-s*g,a*s*u,a*s*c*g-s*b)}function O(e,t){return P(e,t)?R(e,t):E(e,t)}function A(e,t){var n=R(e,t),i=E(e,t),r=Math.sign(e.y)===Math.sign(t.z)?Math.cos(Math.atan2(e.y,e.x)):1;return{v:i.v.lerp(n.v,r),w:i.w.lerp(n.w,r)}}function M(e,t,n){return{v:new i.Pq0(e/o.m,t/o.m),w:new i.Pq0(-o.R/o.I*t*b,o.R/o.I*(e*b-n*g),o.R/o.I*t*g)}}function I(e,t){var n=new s.z(o.m,o.R,o.ee,o.oV,o._m+.1);n.solve(e.x,e.y,t.x,t.y,t.z);var r=new i.Pq0(n.vx,n.vy,0),a=new i.Pq0(n.ωx,n.ωy,n.ωz);return{v:r.sub(e),w:a.sub(t)}}function _(e,t){return v(Math.PI/2,e,t,I)}function C(e,t){var n=Math.atan2(-e.x,e.y),i=2.5*t.length()*(e.length()*o.R)/(o.R*o.R),s=t.clone().normalize();return(0,r.KM)(s).applyAxisAngle(s,n).multiplyScalar(i)}},8207:(e,t,n)=>{n.d(t,{r:()=>s});var i=n(5418);function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var s=function(){function e(t){var n,r;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),o(this,"style",void 0),o(this,"notify",void 0),this.notify=null!=t?t:function(){},this.style=null!==(r=null===(n=document.getElementById("constants"))||void 0===n?void 0:n.style)&&void 0!==r?r:{},this.initialiseSlider("R",i.R,i.jG),this.initialiseSlider("m",i.m,i.Qg),this.initialiseSlider("e",i.e,i.cM),this.initialiseSlider("mu",i.mu,i.xO),this.initialiseSlider("muS",i.gf,i.Ys),this.initialiseSlider("muC",i.gT,i.kM),this.initialiseSlider("rho",i.kL,i.Wv),this.initialiseSlider("μs",i.oV,i.ko),this.initialiseSlider("μw",i._m,i.ki),this.initialiseSlider("ee",i.ee,i.PX)}var t,n;return t=e,n=[{key:"toggleVisibility",value:function(){this.style.visibility="visible"===this.style.visibility?"hidden":"visible"}},{key:"getInputElement",value:function(e){var t;return null!==(t=document.getElementById(e))&&void 0!==t?t:{}}},{key:"initialiseSlider",value:function(e,t,n){var i=this,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,o=this.getInputElement(e);o&&(o.step="0.001",o.min="0.01",o.max="".concat(r),o.value=t,this.showValue(e,t),o.oninput=function(t){var r=parseFloat(t.target.value);n(r),i.showValue(e,r),i.notify()})}},{key:"showValue",value:function(e,t){var n=document.querySelector("label[for=".concat(e,"]"));n&&(n.innerHTML="".concat(e,"=").concat(t))}}],n&&r(t.prototype,n),e}()},8279:(e,t,n)=>{function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}n.d(t,{F:()=>r});var r=function e(){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i(this,"type",void 0),i(this,"sequence",void 0),i(this,"clientId",void 0)}},8385:(e,t,n)=>{n.d(t,{Z:()=>l});var i=n(2651),r=n(5418),o=n(12);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function a(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var l=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),a(this,"pos",void 0),a(this,"radius",void 0),this.pos=t,this.radius=n}var t,n,l;return t=e,l=[{key:"willFall",value:function(e,t){return t.distanceTo(e.pos)<e.radius}},{key:"findPocket",value:function(t,n,i){var r=n.futurePosition(i);return t.find((function(t){return e.willFall(t,r)}))}}],(n=[{key:"fall",value:function(e,t){return e.vel.z=-r.g*t,e.state=i.U.Falling,e.pocket=this,e.vel.length()}},{key:"updateFall",value:function(e,t){e.vel.addScaledVector(o.up,10*-r.R*t*r.g);var n=e.pos.z;if(e.pos.clone().setZ(0).distanceTo(this.pos)>this.radius-r.R){var s=this.pos.clone().sub(e.pos).normalize().setZ(0);n>-r.R/2&&(e.vel.addScaledVector(s,7*r.R*t*r.g),e.rvel.addScaledVector((0,o.KM)(s),7*t*r.g)),e.vel.dot(s)<0&&(e.ballmesh.trace.forceTrace(e.pos),e.vel.x=s.x*e.vel.length()/2,e.vel.y=s.y*e.vel.length()/2)}var a=this.restingDepth(e);n<a&&0!==e.rvel.length()&&(e.pos.z=a,e.vel.z=-r.R/10,e.rvel.copy(o.v_)),n<a-r.R&&(e.pos.z=a-r.R,e.setStationary(),e.state=i.U.InPocket)}},{key:"restingDepth",value:function(e){return-3*r.R-r.R*e.id/4}}])&&s(t.prototype,n),l&&s(t,l),e}()},8738:(e,t,n)=>{n.d(t,{Qe:()=>r.Q,pd:()=>o.p,wG:()=>i.w,xI:()=>a}),n(3206);var i=n(2522),r=n(2518),o=n(3413);function s(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}n(1943),n(5159);var a=function(){function e(t){var n,i;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=void 0,(n="container")in this?Object.defineProperty(this,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[n]=i,this.container=t}var t,n;return t=e,(n=[{key:"handleInput",value:function(e){return this}},{key:"handleBegin",value:function(e){return this}},{key:"handleBreak",value:function(e){return this}},{key:"handleStartAim",value:function(e){return this}},{key:"handleAim",value:function(e){return this}},{key:"handleHit",value:function(e){return this}},{key:"handleAbort",value:function(e){return this}},{key:"handleWatch",value:function(e){return this}},{key:"handlePlaceBall",value:function(e){return this}},{key:"handleStationary",value:function(e){return this}},{key:"handleChat",value:function(e){return this}},{key:"handleRejoin",value:function(e){return this}},{key:"onFirst",value:function(){}}])&&s(t.prototype,n),e}()},8765:(e,t,n)=>{n.d(t,{n:()=>R});var i=n(4314),r=n(772),o=n(5556),s=n(4979),a=n(8090),l=n(6162),c=n(4922);function u(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function h(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}var f=function(){function e(t){var n,i,r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),i=void 0,(n="shots")in this?Object.defineProperty(this,n,{value:i,enumerable:!0,configurable:!0,writable:!0}):this[n]=i,this.shots=t.map((function(e){return r.interpolateAllBalls(e)}))}var t,n;return t=e,n=[{key:"interpolateUntilMove",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:.3,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1e-5;return e.t.length>1&&e.t[1]-e.t[0]>t&&(e.t.splice(1,0,e.t[1]-n),e.x.splice(1,0,e.x[0]),e.y.splice(1,0,e.y[0])),e}},{key:"interpolateAllBalls",value:function(e){var t=this;return e.balls=Object.fromEntries(Object.entries(e.balls).map((function(e){var n,i,r=(i=2,function(e){if(Array.isArray(e))return e}(n=e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var i,r,o=[],s=!0,a=!1;try{for(n=n.call(e);!(s=(i=n.next()).done)&&(o.push(i.value),!t||o.length!==t);s=!0);}catch(e){a=!0,r=e}finally{try{s||null==n.return||n.return()}finally{if(a)throw r}}return o}}(n,i)||function(e,t){if(e){if("string"==typeof e)return u(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(n):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?u(e,t):void 0}}(n,i)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()),o=r[0],s=r[1];return[o,t.interpolateUntilMove(s)]}))),e}},{key:"getInterpolatedPosition",value:function(e,t,n){if(!e||0===e.length)return t[0];if(n<=e[0])return t[0];if(n>=e[e.length-1])return t[t.length-1];for(var i=0,r=e.length-1;i<r-1;){var o=Math.floor((i+r)/2);e[o]<n?i=o:r=o}var s=e[i],a=e[r],l=t[i];return l+(n-s)/(a-s)*(t[r]-l)}},{key:"getPositionsAtTime",value:function(e,t){var n=this.shots.find((function(t){return t.shotID===e})),i={};for(var r in n.balls){var o=n.balls[r],s=this.getInterpolatedPosition(o.t,o.x,t),a=this.getInterpolatedPosition(o.t,o.y,t);i[r]={x:s,y:a}}return i}},{key:"realToSim",value:function(e,t){return{x:2.3*(.71-t[e].x/2),y:2.3*(t[e].y/2-.36)}}},{key:"identifyFirstMover",value:function(e){return console.log(e),e.balls[1].t[1]<e.balls[2].t[1]?"1":"2"}},{key:"estimateDirection",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n=this.getPositionsAtTime(e.shotID,.2),i=this.identifyFirstMover(e),r=t[i],o=new c.Pq0(r.x,r.y),s=n[i],a=new c.Pq0(s.x,s.y);return{pos1:t,pos2:n,firstMover:i,speed:2*o.distanceTo(a),angle:new c.Pq0(-1,0).angleTo(a.sub(o))}}},{key:"stateFrom",value:function(e){var t=this.getPositionsAtTime(e.shotID,0),n={init:[],shots:[]};for(var i in t){var r=this.realToSim(i,t);n.init.push(r.x),n.init.push(r.y)}var o=this.estimateDirection(e);console.log("estimated",o);var s="1"==o.firstMover?0:1;return console.log(o),n.shots.push({type:"AIM",offset:{x:-0,y:0,z:0},angle:o.angle,power:o.speed,pos:{x:n.init[2*s],y:n.init[2*s+1],z:0},i:s}),n}}],n&&h(t.prototype,n),e}();function p(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function d(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var v=function(){function e(t){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),d(this,"ctx",void 0),d(this,"canvas",void 0),d(this,"BALL_COLORS",{1:"white",2:"yellow",3:"red"}),d(this,"BALL_DIAMETER",.0615),d(this,"TABLE_WIDTH",2.84),d(this,"PIXELS_PER_METER",void 0),d(this,"ballPaths",{}),this.canvas=t,this.ctx=this.canvas.getContext("2d"),this.PIXELS_PER_METER=this.canvas.width/this.TABLE_WIDTH}var t,n;return t=e,(n=[{key:"drawBall",value:function(e,t,n){var i=this.BALL_DIAMETER/2*this.PIXELS_PER_METER,r=this.canvas.width-e,o=t;this.ctx.beginPath(),this.ctx.arc(r,o,i,0,2*Math.PI),this.ctx.fillStyle=n,this.ctx.fill(),this.ctx.strokeStyle="black",this.ctx.lineWidth=1,this.ctx.stroke()}},{key:"drawBallPath",value:function(e,t){var n=this,i=this.BALL_COLORS[e];this.ctx.save(),this.ctx.beginPath(),t.forEach((function(e,t){var i=n.canvas.width-e.x*n.PIXELS_PER_METER,r=n.canvas.height-e.y*n.PIXELS_PER_METER;0===t?n.ctx.moveTo(i,r):n.ctx.lineTo(i,r)})),this.ctx.setLineDash([4,4]),this.ctx.strokeStyle=i,this.ctx.lineWidth=1,this.ctx.stroke(),this.ctx.restore()}},{key:"clear",value:function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height)}},{key:"drawShot",value:function(e){for(var t in this.ballPaths)this.drawBallPath(t,this.ballPaths[t]);for(var n in e){var i=e[n],r=this.BALL_COLORS[n],o=i.x*this.PIXELS_PER_METER,s=this.canvas.height-i.y*this.PIXELS_PER_METER;this.drawBall(o,s,r)}}},{key:"resetCanvas",value:function(){this.clear(),this.ballPaths={}}},{key:"updateBallPaths",value:function(e,t){this.ballPaths[e]||(this.ballPaths[e]=[]),this.ballPaths[e].push(t)}}])&&p(t.prototype,n),e}(),y=n(1943),m=n(3206);function b(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function g(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var w=function(){function e(){var t;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),g(this,"aimBall",void 0),g(this,"aimCoordinatesDisplay",void 0),g(this,"aimBallContainer",void 0),g(this,"powerSlider",void 0),g(this,"directionSlider",void 0),g(this,"BALL_CONTAINER_RADIUS",void 0),g(this,"MAX_DISTANCE",.7),g(this,"position",{x:0,y:0}),g(this,"power",5),g(this,"direction",0),this.aimBall=document.getElementById("aim-ball"),this.aimCoordinatesDisplay=document.getElementById("aim-coordinates"),this.aimBallContainer=document.getElementById("aim-ball-container"),this.powerSlider=document.getElementById("power"),this.directionSlider=document.getElementById("direction"),this.BALL_CONTAINER_RADIUS=((null===(t=this.aimBallContainer)||void 0===t?void 0:t.clientWidth)||0)/2,this.addEventListeners()}var t,n;return t=e,(n=[{key:"addEventListeners",value:function(){var e,t,n,i=this;null===(e=this.aimBallContainer)||void 0===e||e.addEventListener("click",(function(e){return i.handleClick(e)})),null===(t=this.powerSlider)||void 0===t||t.addEventListener("input",(function(e){i.power=parseInt(e.target.value)})),null===(n=this.directionSlider)||void 0===n||n.addEventListener("input",(function(e){i.direction=parseInt(e.target.value)}))}},{key:"handleClick",value:function(e){if(this.aimBallContainer&&this.aimBall){var t=this.aimBallContainer.getBoundingClientRect(),n=e.clientX-t.left-t.width/2,i=e.clientY-t.top-t.height/2;if(Math.sqrt(n*n+i*i)>this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS){var r=Math.atan2(i,n);n=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.cos(r),i=this.MAX_DISTANCE*this.BALL_CONTAINER_RADIUS*Math.sin(r)}var o=t.width/2-this.aimBall.offsetWidth/2,s=-o,a=t.height/2-this.aimBall.offsetHeight/2,l=-a,c=Math.max(s,Math.min(o,n)),u=Math.max(l,Math.min(a,i));this.position.x=c/this.BALL_CONTAINER_RADIUS,this.position.y=u/this.BALL_CONTAINER_RADIUS,this.updateDom()}}},{key:"updateDom",value:function(){if(this.aimBall&&this.aimBallContainer){var e=this.aimBallContainer.getBoundingClientRect(),t=this.position.x*this.BALL_CONTAINER_RADIUS,n=this.position.y*this.BALL_CONTAINER_RADIUS;this.aimBall.style.left="".concat(t+e.width/2-this.aimBall.offsetWidth/2,"px"),this.aimBall.style.top="".concat(n+e.height/2-this.aimBall.offsetHeight/2,"px"),this.aimCoordinatesDisplay&&(this.aimCoordinatesDisplay.textContent="x: ".concat(this.position.x.toFixed(2),", y: ").concat(this.position.y.toFixed(2)))}}},{key:"getAim",value:function(){return{offset:{x:this.position.x,y:this.position.y,z:0},angle:this.direction,power:this.power}}},{key:"setAim",value:function(e){this.position.x=e.offset.x,this.position.y=e.offset.y,this.power=e.power,this.powerSlider.value=e.power.toString(),this.direction=e.angle,this.directionSlider.value=e.angle.toString(),console.log("set aim",e),this.updateDom()}}])&&b(t.prototype,n),e}();function k(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function x(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var T=function(){function e(t,n){!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),x(this,"drawer",void 0),x(this,"aimInputs",void 0),x(this,"fileInput",document.getElementById("fileInput")),x(this,"shotIndexDisplay",document.getElementById("shotIndexDisplay")),x(this,"shotSelector",document.getElementById("shotSelector")),x(this,"replayButton",document.getElementById("replay")),x(this,"myIframe",document.getElementById("myIframe")),x(this,"allShots",[]),x(this,"currentShotIndex",0),x(this,"animationTimer",-2.35),x(this,"isPlaying",!1),x(this,"lastFrameTime",0),x(this,"animationStartTime",0),x(this,"realPosition",null),x(this,"elapsedTime",0),x(this,"container",void 0),this.drawer=new v(t),this.container=n,this.aimInputs=new w,n&&(n.frame=this.advance.bind(this)),this.start()}var t,n;return t=e,n=[{key:"start",value:function(){console.log("real overlay start"),this.loadDefaultData(),this.addEventListeners()}},{key:"addEventListeners",value:function(){var e=this;this.fileInput.addEventListener("change",(function(t){return e.handleFileChange(t)})),this.shotSelector.addEventListener("change",(function(){return e.handleShotSelect()})),this.replayButton.addEventListener("click",(function(){return e.handleReplay()}))}},{key:"handleFileChange",value:function(e){var t=this,n=e.target.files[0];if(n){var i=new FileReader;i.onload=function(e){try{var n=JSON.parse(e.target.result);t.processShots(n)}catch(e){console.error("Error parsing JSON:",e),alert("Error parsing JSON file.")}},i.readAsText(n)}}},{key:"handleShotSelect",value:function(){this.currentShotIndex=parseInt(this.shotSelector.value,10),this.updateDisplay(),this.resetAnimation()}},{key:"loadDefaultData",value:function(){var e=this;fetch("simple_shots.json").then((function(e){if(!e.ok)throw new Error("HTTP error! status: ".concat(e.status));return e.json()})).then((function(t){return e.processShots(t)}))}},{key:"processShots",value:function(e){this.allShots=e,this.realPosition=new f(this.allShots),this.allShots.length>0&&(this.currentShotIndex=0,this.populateShotSelector(),this.updateDisplay(),this.resetAnimation())}},{key:"populateShotSelector",value:function(){var e=this;this.shotSelector.innerHTML="",this.allShots.forEach((function(t,n){var i=document.createElement("option");i.value=n.toString(),i.text="Shot ".concat(n+1," (ID: ").concat(t.shotID,")"),e.shotSelector.appendChild(i)})),this.allShots.length>0&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"updateDisplay",value:function(){this.shotIndexDisplay.textContent="Shot: ".concat(this.currentShotIndex+1),this.allShots[this.currentShotIndex]&&(this.shotSelector.value=this.currentShotIndex.toString())}},{key:"drawShot",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;if(this.realPosition){var n=this.realPosition.getPositionsAtTime(e.shotID,t);if(n){for(var i in n)this.drawer.updateBallPaths(i,n[i]);this.drawer.clear(),this.drawer.drawShot(n)}}}},{key:"handleReplay",value:function(){this.resetAnimation()}},{key:"resetAnimation",value:function(){this.isPlaying=!1,this.animationTimer=-2.3,this.drawer.resetCanvas(),this.drawShot(this.allShots[this.currentShotIndex],0),this.resetSimulation(this.allShots[this.currentShotIndex])}},{key:"resetSimulation",value:function(e){console.log("reset simulation");var t=this.realPosition.stateFrom(e);this.container.table.updateFromShortSerialised(t.init),this.container.eventQueue.push(new y.h),this.container.eventQueue.push(new m.u),this.container.eventQueue.push(new o.W(t.init,t.shots)),this.aimInputs.setAim(t.shots[0])}},{key:"advance",value:function(e){this.elapsedTime+=e,this.animationTimer+=e;var t=this.allShots[this.currentShotIndex];this.drawShot(t,this.animationTimer)}}],n&&k(t.prototype,n),e}();function P(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function S(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var R=function(){function e(t,n,i){var r=this;!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),S(this,"container",void 0),S(this,"canvas3d",void 0),S(this,"ruletype",void 0),S(this,"replay",void 0),S(this,"cushionModel",void 0),S(this,"breakState",{init:null,shots:Array()}),S(this,"realOverlay",void 0),S(this,"onAssetsReady",(function(){console.log("diagram ready");var e=document.getElementById("replay");r.replayButton(e);var t=document.getElementById("overlaycanvas");t?r.realOverlay=new T(t,r.container):(r.breakState=JSON.parse(decodeURIComponent(r.replay)),r.container.eventQueue.push(new o.W(r.breakState.init,r.breakState.shots))),r.container.animate(performance.now())})),this.replay=i,this.ruletype=n,this.canvas3d=t,s.v.zoomFactor=.88}var t,n,c;return t=e,c=[{key:"fromDiamgramElement",value:function(t){var n=null==t?void 0:t.getElementsByClassName("topview")[0],i=null==n?void 0:n.getAttribute("data-state"),r=new URLSearchParams(i),o=null==t?void 0:t.getElementsByClassName("description")[0],s=document.getElementById("common"),l=document.createElement("a");l.href="../".concat(i),l.innerHTML="⬀",l.target="_blank",null==o||o.appendChild(l),null==s||s.appendChild(l);var c=document.createElement("button");null==o||o.appendChild(c);var u=new e(n,r.get("ruletype"),r.get("state"));return u.replayButton(c),"bounceHan"==r.get("cushionModel")&&(u.cushionModel=a.QV),u}}],(n=[{key:"start",value:function(){var e=new r.s(this.canvas3d);this.container=new i.m(this.canvas3d,console.log,l.s.localAssets(this.ruletype),this.ruletype,e,"diagram"),this.cushionModel&&(this.container.table.cushionModel=this.cushionModel),this.onAssetsReady()}},{key:"replayButton",value:function(e){var t=this;e.innerHTML="↻",e.addEventListener("click",(function(){var e;0==t.container.eventQueue.length&&t.container.eventQueue.push(new o.W(t.breakState.init,t.breakState.shots)),null===(e=t.realOverlay)||void 0===e||e.start()}))}}])&&P(t.prototype,n),c&&P(t,c),e}()},8938:(e,t,n)=>{n.d(t,{r:()=>l});var i=n(1279);function r(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function o(e){return o=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},o(e)}function s(e,t){return s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},s(e,t)}function a(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(a=function(){return!!e})()}var l=function(e){function t(e){var n;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),(n=function(e,t,n){return t=o(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,a()?Reflect.construct(t,n||[],o(e).constructor):t.apply(e,n))}(this,t,[e])).container.table.cueball=n.container.rules.otherPlayersCueBall(),n.container.table.cue.moveTo(n.container.table.cueball.pos),n.container.view.camera.suggestMode(n.container.view.camera.topView),n}var n,l;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}(t,e),n=t,(l=[{key:"handleAim",value:function(e){return this.container.table.cue.aim=e,this.container.table.cueball.pos.copy(e.pos),this}},{key:"handleHit",value:function(e){return this.container.table.updateFromSerialised(e.tablejson),new i.O(this.container)}}])&&r(n.prototype,l),t}(n(5615).y)},9034:(e,t,n)=>{n.d(t,{p:()=>a});var i=n(4945),r=n.n(i);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var a=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"osmane-billiards-network.onrender.com";!function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,e),s(this,"baseURL",void 0),s(this,"rateLimitPerSec",void 0),s(this,"burst",void 0),s(this,"tokens",void 0),s(this,"queue",void 0),s(this,"lastRefill",void 0),s(this,"websockets",void 0),this.baseURL=t,this.rateLimitPerSec=30,this.burst=45,this.tokens=this.burst,this.queue=[],this.lastRefill=performance.now(),this.websockets=new Map}var t,n;return t=e,(n=[{key:"pump",value:function(){var e=this,t=performance.now(),n=(t-this.lastRefill)/1e3;for(n>0&&(this.tokens=Math.min(this.burst,this.tokens+n*this.rateLimitPerSec),this.lastRefill=t);this.tokens>=1&&this.queue.length;){var i=this.queue.shift();this.tokens-=1,this._publishNow(i.channel,i.message)}this.queue.length&&setTimeout((function(){return e.pump()}),20)}},{key:"subscribe",value:function(e,t){var n="wss://".concat(this.baseURL,"/subscribe/table/").concat(e),i=new WebSocket(n);console.log("Subscribed to ",n),i.onmessage=function(e){try{var n=e.data;t(n)}catch(e){console.error("Error parsing message:",e)}},i.onerror=function(e){console.error("WebSocket error:",e)},i.onopen=function(){console.log("Connected to ".concat(n))},i.onclose=function(e){console.log("Disconnected from ".concat(n,":"),e.reason)},this.websockets.set(e,i)}},{key:"publish",value:function(e,t){this.queue.push({channel:e,message:t}),this.pump()}},{key:"_publishNow",value:function(e,t){var n="https://".concat(this.baseURL,"/publish/table/").concat(e);r()(n,{method:"POST",headers:{"Content-Type":"application/json"},body:t}).catch((function(e){console.error("Publication error:",e)}))}}])&&o(t.prototype,n),e}()},9419:(e,t,n)=>{n.d(t,{x:()=>c});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e){return s=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},s(e)}function a(e,t){return a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},a(e,t)}function l(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(l=function(){return!!e})()}var c=function(e){function t(){var e,n,i,o;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),e=function(e,t,n){return t=s(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,l()?Reflect.construct(t,n||[],s(e).constructor):t.apply(e,n))}(this,t),o=void 0,(i="ballinfo")in(n=e)?Object.defineProperty(n,i,{value:o,enumerable:!0,configurable:!0,writable:!0}):n[i]=o,e.type=r.B.RERACK,e}var n,i,c;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(t,e),n=t,c=[{key:"fromJson",value:function(e){var n=new t;return n.ballinfo=e,n}}],(i=[{key:"applyToController",value:function(e){return e.container.table.updateFromSerialised(this.ballinfo),e}}])&&o(n.prototype,i),c&&o(n,c),t}(i.F)},9915:(e,t,n)=>{n.d(t,{b:()=>u});var i=n(8279),r=n(7009);function o(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function s(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e){return a=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},a(e)}function l(e,t){return l=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},l(e,t)}function c(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(c=function(){return!!e})()}var u=function(e){function t(e,n){var i;return function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}(this,t),s(i=function(e,t,n){return t=a(t),function(e,t){return!t||"object"!=((n=t)&&"undefined"!=typeof Symbol&&n.constructor===Symbol?"symbol":typeof n)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t;var n}(e,c()?Reflect.construct(t,n||[],a(e).constructor):t.apply(e,n))}(this,t),"sender",void 0),s(i,"message",void 0),i.sender=e,i.message=n,i.type=r.B.CHAT,i}var n,i,u;return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&l(e,t)}(t,e),n=t,u=[{key:"fromJson",value:function(e){return new t(e.sender,e.message)}}],(i=[{key:"applyToController",value:function(e){return e.handleChat(this)}}])&&o(n.prototype,i),u&&o(n,u),t}(i.F)}},e=>{e(e.s=3276)}]);